<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portfolio Strategy Analytics</title>
    
    <!-- Plotly.js for interactive charts -->
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    
    <!-- Bootstrap for styling -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Azure Application Insights JavaScript SDK -->
    <script type="text/javascript">
        var appInsights=window.appInsights||function(config){
            function r(config){t[config]=function(){var i=arguments;t.queue.push(function(){t[config].apply(t,i)})}}var t={config:config},u=document,e=window,o="script",s=u.createElement(o),i,f;for(s.src=config.url||"https://az416426.vo.msecnd.net/scripts/a/ai.0.js",u.getElementsByTagName(o)[0].parentNode.appendChild(s),t.cookie=u.cookie,t.queue=[],i=["Event","Exception","Metric","PageView","Trace","Dependency"];i.length;)r("track"+i.pop());return r("setAuthenticatedUserContext"),r("clearAuthenticatedUserContext"),config.disableExceptionTracking||(i="onerror",r("_"+i),f=e[i],e[i]=function(config,r,u,e,o){var s=f&&f(config,r,u,e,o);return s!==!0&&t["_"+i](config,r,u,e,o),s}),t
        }({
            instrumentationKey: "{{ app_insights_key }}"
        });
        window.appInsights=appInsights,appInsights.queue&&0===appInsights.queue.length&&appInsights.trackPageView();
    </script>
    
    <style>
        :root {
            --primary-color: #6366f1;
            --primary-hover: #5b59f0;
            --primary-dark: #4f46e5;
            --secondary-color: #8b5cf6;
            --success-color: #10b981;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
            --info-color: #06b6d4;
            
            /* Dark theme colors (default) */
            --bg-primary: #0f0f0f;
            --bg-secondary: #1a1a1a;
            --bg-tertiary: #262626;
            --bg-card: #1e1e1e;
            --bg-elevated: #2a2a2a;
            
            --text-primary: #ffffff;
            --text-secondary: #a3a3a3;
            --text-muted: #737373;
            
            --border-color: #404040;
            --border-subtle: #2a2a2a;
            
            /* Glassmorphism */
            --glass-bg: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
            --glass-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        
        /* Light theme colors */
        [data-theme="light"] {
            --bg-primary: #f8fafc;
            --bg-secondary: #f1f5f9;
            --bg-tertiary: #e2e8f0;
            --bg-card: #ffffff;
            --bg-elevated: #f8fafc;
            
            --text-primary: #1e293b;
            --text-secondary: #475569;
            --text-muted: #64748b;
            
            --border-color: #cbd5e1;
            --border-subtle: #e2e8f0;
            
            /* Light theme glassmorphism */
            --glass-bg: rgba(0, 0, 0, 0.05);
            --glass-border: rgba(0, 0, 0, 0.1);
            --glass-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        * {
            box-sizing: border-box;
        }

        body {
            background: var(--bg-primary);
            background-image: 
                radial-gradient(circle at 20% 80%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 119, 198, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(120, 199, 198, 0.3) 0%, transparent 50%);
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
        }

        /* Light theme background */
        [data-theme="light"] body {
            background: var(--bg-primary);
            background-image: 
                radial-gradient(circle at 20% 80%, rgba(99, 102, 241, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(139, 92, 246, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(16, 185, 129, 0.1) 0%, transparent 50%);
        }

        /* Custom container width - use 95% of screen width to reduce left margin */
        .container {
            max-width: 95% !important;
            width: 95%;
            padding-left: 10px;
            padding-right: 10px;
            overflow-x: hidden; /* Prevent horizontal overflow */
        }

        /* Responsive adjustments for smaller screens */
        @media (max-width: 1200px) {
            .container {
                max-width: 85% !important;
                width: 85%;
            }
        }

        @media (max-width: 768px) {
            .container {
                max-width: 95% !important;
                width: 95%;
                padding-left: 1rem;
                padding-right: 1rem;
            }
        }

        /* Light theme (for theme toggle) */
        [data-theme="light"] {
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc;
            --bg-tertiary: #e2e8f0;
            --bg-card: #ffffff;
            --bg-elevated: #f1f5f9;
            
            --text-primary: #1e293b;
            --text-secondary: #475569;
            --text-muted: #64748b;
            
            --border-color: #e2e8f0;
            --border-subtle: #f1f5f9;
            
            --glass-bg: rgba(255, 255, 255, 0.8);
            --glass-border: rgba(0, 0, 0, 0.1);
            --glass-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        [data-theme="light"] body {
            background: var(--bg-primary);
            background-image: 
                radial-gradient(circle at 20% 80%, rgba(99, 102, 241, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(139, 92, 246, 0.1) 0%, transparent 50%);
            color: var(--text-primary);
        }
        
        /* Navigation */
        .navbar {
            background: var(--glass-bg) !important;
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--glass-border);
            padding: 1rem 0;
            z-index: 1030;
            position: relative;
            overflow: visible;
        }

        .navbar .container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            max-width: 100%;
            overflow: visible;
        }

        /* Right-aligned user section */
        .navbar-nav {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-left: auto;
            justify-content: flex-end;
            overflow: visible;
            position: relative;
        }

        .navbar-brand {
            font-weight: 700;
            font-size: 1.25rem;
            color: var(--text-primary) !important;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex-shrink: 0;
            white-space: nowrap;
        }

        .navbar-brand i {
            color: var(--primary-color);
            font-size: 1.5rem;
        }

        .version-info {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-left: 1rem;
            font-size: 0.75rem;
            font-weight: 400;
        }

        .version-text {
            color: var(--text-muted);
            font-family: 'JetBrains Mono', monospace;
            background: var(--bg-tertiary);
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            border: 1px solid var(--border-color);
        }

        .badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            font-size: 0.65rem;
            font-weight: 600;
            line-height: 1;
            text-align: center;
            white-space: nowrap;
            vertical-align: baseline;
            border-radius: 0.25rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .badge-success {
            background-color: #10b981;
            color: white;
        }

        .badge-warning {
            background-color: #f59e0b;
            color: white;
        }

        .badge-danger {
            background-color: #ef4444;
            color: white;
        }

        .badge-info {
            background-color: #3b82f6;
            color: white;
        }

        .badge-secondary {
            background-color: #6b7280;
            color: white;
        }

        /* Responsive version display */
        @media (max-width: 768px) {
            .version-info {
                margin-left: 0.5rem;
                font-size: 0.7rem;
            }
            
            .version-text {
                padding: 0.2rem 0.4rem;
            }
            
            .badge {
                padding: 0.2rem 0.4rem;
                font-size: 0.6rem;
            }
        }

        .nav-stats {
            color: var(--text-secondary);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.875rem;
            flex-shrink: 0;
            white-space: nowrap;
        }

        .nav-filename {
            color: var(--text-secondary);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            max-width: 600px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            text-align: left;
            justify-content: flex-start;
            flex: 1;
            min-width: 0;
        }

        .nav-filename i {
            color: var(--info-color);
            flex-shrink: 0;
        }

        .nav-filename span {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            flex: 1;
            min-width: 0;
            max-width: none;
        }

        .theme-toggle {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            color: var(--text-primary);
            border-radius: 50px;
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s ease;
        }

        .theme-toggle:hover {
            background: var(--bg-elevated);
            transform: translateY(-1px);
        }

        /* User authentication styling */
        .user-info {
            color: var(--text-secondary);
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex-shrink: 0;
            white-space: nowrap;
            text-align: right;
            justify-content: flex-end;
        }

        .dropdown {
            position: relative;
            overflow: visible;
        }

        .dropdown-menu {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 0.5rem;
            box-shadow: var(--glass-shadow);
            backdrop-filter: blur(20px);
            z-index: 1050 !important;
            position: absolute !important;
            min-width: 200px;
            max-width: 300px;
            overflow: visible;
            right: 0;
            left: auto;
        }

        .dropdown-item {
            color: var(--text-primary);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .dropdown-item:hover {
            background: var(--glass-bg);
            color: var(--text-primary);
        }

        .dropdown-item i {
            width: 16px;
            text-align: center;
        }

        .oauth-buttons {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            padding: 0.5rem;
        }

        .btn-oauth {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            border: none;
            font-weight: 500;
            transition: all 0.3s ease;
            text-decoration: none;
            color: white;
        }

        .btn-oauth:hover {
            transform: translateY(-1px);
            color: white;
        }

        .btn-discord {
            background: #5865F2;
        }

        .btn-discord:hover {
            background: #4752C4;
        }

        .btn-google {
            background: #4285F4;
        }

        .btn-google:hover {
            background: #3367D6;
        }

        .btn-guest {
            background: var(--secondary-color);
        }

        .btn-guest:hover {
            background: var(--primary-color);
        }

        /* Login loading indicator */
        .login-loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            backdrop-filter: blur(5px);
        }

        .login-loading-content {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 2rem;
            text-align: center;
            box-shadow: var(--glass-shadow);
            max-width: 400px;
            width: 90%;
        }

        .login-loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1s ease-in-out infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .login-loading-text {
            color: var(--text-primary);
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
        }

        .login-loading-subtext {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .user-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            object-fit: cover;
        }

        /* Dropdown positioning fixes */
        .dropdown {
            position: relative;
            z-index: 1040;
        }

        .dropdown-toggle {
            z-index: 1041;
        }

        .dropdown-menu.show {
            z-index: 1050 !important;
            position: absolute !important;
            top: 100% !important;
            transform: none !important;
        }

        /* Ensure cards don't interfere */
        .card {
            z-index: 1;
            position: relative;
        }

        /* File management section specific */
        .saved-files-section {
            z-index: 1;
            position: relative;
        }
        
        /* Cards */
        .card {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            box-shadow: var(--glass-shadow);
            margin-bottom: 1.5rem;
            transition: all 0.3s ease;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);
        }

        .card-body {
            padding: 1.5rem;
        }
        
        .metric-card {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            border: none;
            position: relative;
            overflow: hidden;
            height: 70px; /* Fixed height for compactness */
        }

        .metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, transparent 100%);
        }

        .metric-card .card-body {
            position: relative;
            z-index: 1;
            padding: 0.4rem 0.6rem; /* Reduced padding */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100%;
            text-align: center;
        }
        
        .metric-value {
            font-size: clamp(0.8rem, 1.8vw, 1rem); /* Smaller font */
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
            margin-bottom: 0.1rem; /* Reduced margin */
            line-height: 1;
            word-break: break-word;
            hyphens: auto;
        }

        .metric-title {
            font-size: clamp(0.6rem, 1.2vw, 0.7rem); /* Smaller font */
            font-weight: 500;
            opacity: 0.9;
            text-transform: uppercase;
            letter-spacing: 0.03em; /* Reduced letter spacing */
            line-height: 1.1; /* Tighter line height */
            margin-bottom: 0.1rem; /* Reduced margin */
        }
        
        /* Upload Area */
        .upload-area {
            border: 2px dashed var(--border-color);
            border-radius: 16px;
            padding: 2rem;
            text-align: center;
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            transition: all 0.3s ease;
            cursor: pointer;
            min-height: 140px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        .upload-area::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent 49%, rgba(99, 102, 241, 0.1) 50%, transparent 51%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .upload-area:hover {
            border-color: var(--primary-color);
            background: var(--glass-bg);
            transform: translateY(-2px);
        }

        .upload-area:hover::before {
            opacity: 1;
        }
        
        .upload-area.dragover {
            border-color: var(--success-color);
            background: rgba(16, 185, 129, 0.1);
        }

        .upload-content {
            text-align: center;
            z-index: 1;
            position: relative;
        }

        .upload-content i {
            font-size: 2.5rem;
            color: var(--primary-color);
            margin-bottom: 1rem;
        }
        
        .saved-files-section {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            padding: 1.5rem;
            min-height: 140px;
        }
        
        /* Buttons */
        .btn {
            border-radius: 12px;
            font-weight: 500;
            padding: 0.75rem 1.5rem;
            border: none;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
            color: white;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, var(--primary-hover) 0%, var(--primary-color) 100%);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(99, 102, 241, 0.4);
        }

        .btn-outline-primary {
            border: 2px solid var(--primary-color);
            color: var(--primary-color);
            background: transparent;
        }

        .btn-outline-primary:hover {
            background: var(--primary-color);
            color: white;
            transform: translateY(-1px);
        }

        .btn-chart {
            margin: 0.375rem;
            min-width: 200px;
            width: calc(16.66% - 0.75rem);
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            color: var(--text-primary);
            border-radius: 12px;
            padding: 0.875rem 1.25rem;
            font-size: 0.9rem;
            font-weight: 500;
            display: inline-block;
        }
        
        .btn-chart:hover {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
            transform: translateY(-2px);
        }

        .btn-chart.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        /* Ensure body and html can expand vertically */
        html, body {
            height: auto !important;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Main container auto-sizing */
        .container {
            min-height: auto !important;
            height: auto !important;
        }
        
        /* Chart Container */
        .chart-container {
            min-height: 800px; /* Increased from 600px to give more vertical space */
            height: auto;
            max-height: none;
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 1rem;
            border: 1px solid var(--glass-border);
            position: relative;
            overflow: visible;
        }

        /* Ensure charts fit properly within their containers */
        .chart-container .js-plotly-plot {
            width: 100% !important;
            height: auto !important; /* Changed from 100% to auto */
        }

        .chart-container .plotly-graph-div {
            width: 100% !important;
            height: auto !important; /* Changed from 100% to auto */
        }

        /* Force chart containers to fill available space */
        #drawdownChart {
            width: 100% !important;
            height: auto !important; /* Changed from 100% to auto */
        }

        #drawdownChart .js-plotly-plot {
            width: 100% !important;
            height: auto !important; /* Changed from 100% to auto */
        }

        /* Ensure content within chart containers can expand */
        .chart-container .card,
        .chart-container .card-body,
        .chart-container .row,
        .chart-container .col-md-6,
        .chart-container .col-md-12 {
            overflow: visible !important;
        }

        /* Prevent content cutoff in chart containers */
        .chart-container .table-responsive {
            overflow-x: auto;
            overflow-y: visible;
        }

        /* Responsive chart sizing */
        .chart-container {
            transition: all 0.3s ease;
        }

        /* Ensure charts resize on window resize */
        @media (max-width: 1200px) {
            .chart-container {
                min-height: 750px; /* Increased from 700px */
            }
        }

        @media (max-width: 768px) {
            .chart-container {
                min-height: 650px; /* Increased from 600px */
            }
        }



        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .chart-selector {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        #chartButtons {
            background: transparent;
        }
        
        /* Sidebar chart selector styling */
        .sidebar-chart-selector .card-body {
            padding: 0.5rem;
        }
        
        .sidebar-chart-selector .card-header {
            padding: 0.5rem 0.75rem;
        }
        
        .sidebar-chart-selector .btn {
            font-size: 0.8rem;
            padding: 0.4rem 0.6rem;
            text-align: left;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            border-radius: 6px;
        }
        
        .sidebar-chart-selector {
            width: auto; /* Auto-size to content */
            min-width: fit-content; /* Ensure it fits the content */
        }
        
        .sidebar-chart-selector .card-body {
            padding: 0.25rem !important; /* Reduce padding */
        }
        
        .sidebar-chart-selector .d-grid {
            gap: 0.25rem !important; /* Reduce gap between buttons */
        }
        
        .sidebar-chart-selector .btn {
            padding: 0.375rem 0.5rem !important; /* Reduce button padding */
            font-size: 0.875rem !important; /* Slightly smaller font */
            text-align: left;
        }
        
        /* Strategy Performance table styling */
        #strategyTable {
            min-width: 2000px; /* Ensure table has enough width for all columns */
        }
        
        #strategyTable th,
        #strategyTable td {
            white-space: nowrap; /* Prevent text wrapping */
            padding: 0.5rem 0.75rem; /* Compact padding */
        }
        
        /* Sticky first column for Strategy Performance table */
        #strategyTable th:first-child,
        #strategyTable td:first-child {
            position: sticky;
            left: 0;
            z-index: 2; /* Ensure it stays above other scrolling content */
            background-color: var(--bg-tertiary); /* Match header background */
            border-right: 1px solid var(--border-color); /* Visual separation */
        }
        
        #strategyTable td:first-child {
            background-color: var(--bg-card); /* Match row background */
        }
        
        /* Ensure sticky column has proper background in light theme */
        [data-theme="light"] #strategyTable th:first-child {
            background-color: var(--bg-tertiary) !important;
        }
        
        [data-theme="light"] #strategyTable td:first-child {
            background-color: var(--bg-card) !important;
        }
        
        /* Table styling for dark theme */
        .table {
            color: var(--text-primary) !important;
            background-color: var(--bg-card) !important;
        }
        
        .table th {
            color: var(--text-primary) !important;
            background-color: var(--bg-tertiary) !important;
            border-color: var(--border-color) !important;
        }
        
        .table td {
            color: var(--text-primary) !important;
            background-color: var(--bg-card) !important;
            border-color: var(--border-color) !important;
        }
        
        .table-hover tbody tr:hover {
            color: var(--text-primary) !important;
            background-color: var(--bg-elevated) !important;
        }
        
        .table-dark {
            color: var(--text-primary) !important;
            background-color: var(--bg-tertiary) !important;
        }
        
        .table-dark th {
            color: var(--text-primary) !important;
            background-color: var(--bg-tertiary) !important;
            border-color: var(--border-color) !important;
        }
        
        .table-dark td {
            color: var(--text-primary) !important;
            background-color: var(--bg-card) !important;
            border-color: var(--border-color) !important;
        }
        
        /* Additional table elements */
        .table-striped tbody tr:nth-of-type(odd) {
            background-color: var(--bg-secondary) !important;
            color: var(--text-primary) !important;
        }
        
        .table-striped tbody tr:nth-of-type(even) {
            background-color: var(--bg-card) !important;
            color: var(--text-primary) !important;
        }
        
        /* Card backgrounds for tables */
        .card {
            background-color: var(--bg-card) !important;
            border-color: var(--border-color) !important;
        }
        
        .card-body {
            background-color: var(--bg-card) !important;
            color: var(--text-primary) !important;
        }
        
        .card-header {
            background-color: var(--bg-tertiary) !important;
            color: var(--text-primary) !important;
            border-color: var(--border-color) !important;
        }
        
        /* Ensure all text elements are visible */
        p, span, div, label, small, strong, em {
            color: var(--text-primary) !important;
        }
        
        /* Form elements */
        .form-control, .form-select {
            background-color: var(--bg-secondary) !important;
            color: var(--text-primary) !important;
            border-color: var(--border-color) !important;
        }
        
        .form-label {
            color: var(--text-primary) !important;
        }
        
        /* Portfolio Overview Dynamic Layout */
        .portfolio-overview-container {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            justify-content: flex-start;
            align-items: stretch;
        }
        
        .metric-card-wrapper {
            flex: 1 1 auto;
            min-width: 120px;
            max-width: 200px;
        }
        
        .metric-card {
            height: 100%;
            min-height: 80px;
        }
        
        .metric-card .card-body {
            padding: 0.75rem;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100%;
        }
        
        .metric-title {
            font-size: 0.75rem;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 0.25rem;
            line-height: 1.2;
        }
        
        .metric-value {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 0.25rem;
            line-height: 1.2;
        }
        
        .metric-subtitle {
            font-size: 0.7rem;
            color: var(--text-muted);
            line-height: 1.2;
        }
        
        /* Responsive adjustments */
        @media (max-width: 1200px) {
            .metric-card-wrapper {
                min-width: 110px;
                max-width: 180px;
            }
            
            .metric-value {
                font-size: 1rem;
            }
        }
        
        @media (max-width: 768px) {
            .portfolio-overview-container {
                gap: 0.5rem;
            }
            
            .metric-card-wrapper {
                min-width: 100px;
                max-width: 150px;
            }
            
            .metric-title {
                font-size: 0.7rem;
            }
            
            .metric-value {
                font-size: 0.9rem;
            }
        }
        
        /* Light theme specific overrides */
        [data-theme="light"] .table {
            color: var(--text-primary) !important;
            background-color: var(--bg-card) !important;
        }
        
        [data-theme="light"] .table th {
            color: var(--text-primary) !important;
            background-color: var(--bg-tertiary) !important;
            border-color: var(--border-color) !important;
        }
        
        [data-theme="light"] .table td {
            color: var(--text-primary) !important;
            background-color: var(--bg-card) !important;
            border-color: var(--border-color) !important;
        }
        
        [data-theme="light"] .table-hover tbody tr:hover {
            color: var(--text-primary) !important;
            background-color: var(--bg-elevated) !important;
        }
        
        [data-theme="light"] .table-dark {
            color: var(--text-primary) !important;
            background-color: var(--bg-tertiary) !important;
        }
        
        [data-theme="light"] .table-dark th {
            color: var(--text-primary) !important;
            background-color: var(--bg-tertiary) !important;
            border-color: var(--border-color) !important;
        }
        
        [data-theme="light"] .table-dark td {
            color: var(--text-primary) !important;
            background-color: var(--bg-card) !important;
            border-color: var(--border-color) !important;
        }
        
        [data-theme="light"] .table-striped tbody tr:nth-of-type(odd) {
            background-color: var(--bg-secondary) !important;
            color: var(--text-primary) !important;
        }
        
        [data-theme="light"] .table-striped tbody tr:nth-of-type(even) {
            background-color: var(--bg-card) !important;
            color: var(--text-primary) !important;
        }
        
        [data-theme="light"] .card {
            background-color: var(--bg-card) !important;
            border-color: var(--border-color) !important;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1) !important;
        }
        
        [data-theme="light"] .card-body {
            background-color: var(--bg-card) !important;
            color: var(--text-primary) !important;
        }
        
        [data-theme="light"] .card-header {
            background-color: var(--bg-tertiary) !important;
            color: var(--text-primary) !important;
            border-color: var(--border-color) !important;
        }
        
        [data-theme="light"] .form-control, 
        [data-theme="light"] .form-select {
            background-color: var(--bg-card) !important;
            color: var(--text-primary) !important;
            border-color: var(--border-color) !important;
        }
        
        [data-theme="light"] .form-control:focus, 
        [data-theme="light"] .form-select:focus {
            background-color: var(--bg-card) !important;
            color: var(--text-primary) !important;
            border-color: var(--primary-color) !important;
            box-shadow: 0 0 0 0.2rem rgba(99, 102, 241, 0.25) !important;
        }
        
        /* Prevent horizontal overflow on zoom */
        body {
            overflow-x: hidden;
        }
        
        /* Ensure flex containers don't overflow */
        .d-flex {
            min-width: 0;
        }
        
        /* Responsive container adjustments for zoom */
        @media (min-resolution: 1.25dppx) {
            .container {
                max-width: 90% !important;
                width: 90%;
            }
        }
        
        @media (min-resolution: 1.5dppx) {
            .container {
                max-width: 85% !important;
                width: 85%;
            }
        }
            border: 2px dashed var(--border-color);
            border-radius: 12px;
            padding: 1rem;
            min-height: 60px;
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            align-items: center;
            justify-content: center;
        }
        
        /* Tables */
        .table {
            color: var(--text-primary) !important;
            --bs-table-bg: transparent;
        }

        .table thead th {
            background: var(--bg-elevated);
            color: var(--text-primary) !important;
            border-color: var(--border-color);
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.05em;
            padding: 1rem 0.75rem;
        }

        .table tbody td {
            color: var(--text-primary) !important;
            border-color: var(--border-subtle);
            padding: 0.875rem 0.75rem;
            vertical-align: middle;
        }

        .table tbody tr {
            color: var(--text-primary) !important;
        }

        .table-hover tbody tr:hover {
            background: var(--glass-bg);
            color: var(--text-primary) !important;
        }

        .table-hover tbody tr:hover td {
            color: var(--text-primary) !important;
        }

        .table-striped > tbody > tr:nth-of-type(odd) > td {
            background: rgba(255, 255, 255, 0.02);
            color: var(--text-primary) !important;
        }

        .table-striped > tbody > tr:nth-of-type(even) > td {
            color: var(--text-primary) !important;
        }

        /* Ensure all table text is visible in dark mode */
        .table th,
        .table td,
        .table thead th,
        .table tbody td,
        .table tfoot td {
            color: var(--text-primary) !important;
        }

        /* Dark theme specific table styling */
        [data-theme="dark"] .table {
            color: #ffffff !important;
        }

        [data-theme="dark"] .table th,
        [data-theme="dark"] .table td,
        [data-theme="dark"] .table thead th,
        [data-theme="dark"] .table tbody td,
        [data-theme="dark"] .table tfoot td {
            color: #ffffff !important;
        }

        [data-theme="dark"] .table-dark {
            --bs-table-color: #ffffff !important;
            --bs-table-bg: var(--bg-elevated) !important;
        }

        [data-theme="dark"] .table-dark th,
        [data-theme="dark"] .table-dark td {
            color: #ffffff !important;
        }

        .strategy-table {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
        }
        
        /* Typography */
        .section-title {
            color: var(--text-primary);
            font-weight: 700;
            font-size: 1.5rem;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .section-title::after {
            content: '';
            flex: 1;
            height: 2px;
            background: linear-gradient(90deg, var(--primary-color), transparent);
        }

        /* Override for section titles with buttons */
        .section-title.d-flex {
            justify-content: space-between;
        }

        .section-title.d-flex::after {
            display: none;
        }

        /* Sortable table headers */
        .sortable-header {
            cursor: pointer;
            user-select: none;
            transition: background-color 0.2s;
        }

        .sortable-header:hover {
            background-color: rgba(0, 0, 0, 0.1);
        }

        .sortable-header:active {
            background-color: rgba(0, 0, 0, 0.2);
        }

        .section-title i {
            color: var(--primary-color);
            font-size: 1.25rem;
        }

        /* Form Controls */
        .form-control, .form-select {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            color: var(--text-primary) !important;
            border-radius: 12px;
            padding: 0.75rem 1rem;
        }

        .form-control:focus, .form-select:focus {
            background: var(--bg-card);
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(99, 102, 241, 0.25);
            color: var(--text-primary) !important;
        }

        .form-label {
            color: var(--text-secondary) !important;
            font-weight: 500;
            margin-bottom: 0.5rem;
        }

        /* Dark mode form controls */
        [data-theme="dark"] .form-control,
        [data-theme="dark"] .form-select {
            color: #ffffff !important;
            background: var(--bg-card);
        }

        [data-theme="dark"] .form-control:focus,
        [data-theme="dark"] .form-select:focus {
            color: #ffffff !important;
        }

        [data-theme="dark"] .form-label {
            color: var(--text-secondary) !important;
        }

        [data-theme="dark"] .form-control::placeholder {
            color: var(--text-muted) !important;
        }

        /* Alerts */
        .alert {
            border: none;
            border-radius: 12px;
            padding: 1rem 1.5rem;
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
        }

        .alert-info {
            color: var(--info-color);
            background: rgba(6, 182, 212, 0.1);
            border-color: rgba(6, 182, 212, 0.2);
        }

        .alert-success {
            color: var(--success-color);
            background: rgba(16, 185, 129, 0.1);
            border-color: rgba(16, 185, 129, 0.2);
        }

        .alert-danger {
            color: var(--danger-color);
            background: rgba(239, 68, 68, 0.1);
            border-color: rgba(239, 68, 68, 0.2);
        }

        .alert-warning {
            color: var(--warning-color);
            background: rgba(245, 158, 11, 0.1);
            border-color: rgba(245, 158, 11, 0.2);
        }
        
        /* Status Colors */
        .positive {
            color: var(--success-color) !important;
            font-weight: 600;
        }
        
        .negative {
            color: var(--danger-color) !important;
            font-weight: 600;
        }

        .text-success {
            color: var(--success-color) !important;
        }

        .text-danger {
            color: var(--danger-color) !important;
        }

        .text-warning {
            color: var(--warning-color) !important;
        }

        .text-info {
            color: var(--info-color) !important;
        }

        .text-muted {
            color: var(--text-muted) !important;
        }

        /* Ensure colored text in tables remains visible */
        .table .positive,
        .table .negative,
        .table .text-success,
        .table .text-danger,
        .table .text-warning,
        .table .text-info {
            font-weight: 600;
        }

        /* Dark mode table text overrides */
        [data-theme="dark"] .table .fw-bold {
            color: #ffffff !important;
        }

        [data-theme="dark"] .table .text-success.fw-bold {
            color: var(--success-color) !important;
        }

        [data-theme="dark"] .table .text-danger.fw-bold {
            color: var(--danger-color) !important;
        }

        /* Custom tooltip styles */
        .custom-tooltip {
            position: relative;
            cursor: help !important;
        }

        .custom-tooltip::after {
            display: none !important;
        }

        .custom-tooltip::before {
            display: none !important;
        }

        /* All CSS-based tooltips disabled - using JavaScript only */
        
        /* Sortable table headers */
        .sortable {
            cursor: pointer !important;
            user-select: none;
            transition: background-color 0.2s ease;
        }
        
        .sortable:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }
        
        .sortable i {
            margin-left: 5px;
            opacity: 0.6;
            transition: opacity 0.2s ease;
        }
        
        .sortable:hover i {
            opacity: 1;
        }
        
        /* Compact table styling for P&L by Day of Week */
        #pnlByDayTable {
            font-size: 0.9rem;
        }
        
        #pnlByDayTable th {
            padding: 0.5rem 0.3rem;
            font-size: 0.85rem;
        }
        
        #pnlByDayTable td {
            padding: 0.4rem 0.3rem;
            white-space: nowrap;
        }
        
        #pnlByDayTable .table-responsive {
            border: 1px solid var(--border-color);
            border-radius: 0.375rem;
        }

        /* Price Movement Range Slider */
        .range-slider-container {
            position: relative;
            margin: 10px 0;
        }
        
        .range-slider-container input[type="range"] {
            width: 100%;
            margin: 5px 0;
        }
        
        .range-slider-container input[type="range"]:first-child {
            margin-bottom: 0;
        }
        
        .range-slider-container input[type="range"]:last-child {
            margin-top: 0;
        }

        /* Portfolio Balance Analysis & Position Sizing text visibility */
        .card h6,
        .card h5,
        .card h4,
        .card p,
        .card span,
        .card div,
        .card small,
        .card strong {
            color: var(--text-primary) !important;
        }

        /* Alert text visibility */
        .alert p,
        .alert div,
        .alert span,
        .alert strong,
        .alert small {
            color: inherit !important;
        }

        /* Card body text visibility */
        .card-body h6,
        .card-body h5,
        .card-body h4,
        .card-body p,
        .card-body span,
        .card-body div,
        .card-body small,
        .card-body strong,
        .card-body ul,
        .card-body li {
            color: var(--text-primary) !important;
        }

        /* Specific dark mode overrides */
        [data-theme="dark"] .card,
        [data-theme="dark"] .card-body,
        [data-theme="dark"] .card h6,
        [data-theme="dark"] .card h5,
        [data-theme="dark"] .card h4,
        [data-theme="dark"] .card p,
        [data-theme="dark"] .card span,
        [data-theme="dark"] .card div,
        [data-theme="dark"] .card small,
        [data-theme="dark"] .card strong,
        [data-theme="dark"] .card ul,
        [data-theme="dark"] .card li {
            color: #ffffff !important;
        }

        /* Modal text visibility */
        [data-theme="dark"] .modal-body,
        [data-theme="dark"] .modal-body p,
        [data-theme="dark"] .modal-body div,
        [data-theme="dark"] .modal-body span,
        [data-theme="dark"] .modal-body strong,
        [data-theme="dark"] .modal-body small {
            color: #ffffff !important;
        }

        /* Chart container text */
        [data-theme="dark"] .chart-container,
        [data-theme="dark"] .chart-container p,
        [data-theme="dark"] .chart-container h4,
        [data-theme="dark"] .chart-container div {
            color: #ffffff !important;
        }

        /* Upload area text */
        [data-theme="dark"] .upload-content,
        [data-theme="dark"] .upload-content h6,
        [data-theme="dark"] .upload-content small {
            color: #ffffff !important;
        }

        /* Balance analysis specific */
        [data-theme="dark"] #balanceAnalysis,
        [data-theme="dark"] #balanceAnalysis p,
        [data-theme="dark"] #balanceAnalysis div,
        [data-theme="dark"] #balanceAnalysis h6,
        [data-theme="dark"] #balanceAnalysis strong,
        [data-theme="dark"] #balanceAnalysis small,
        [data-theme="dark"] #balanceAnalysis ul,
        [data-theme="dark"] #balanceAnalysis li {
            color: #ffffff !important;
        }


        /* Trade summary specific */
        [data-theme="dark"] #tradeSummary,
        [data-theme="dark"] #tradeSummary p,
        [data-theme="dark"] #tradeSummary div,
        [data-theme="dark"] #tradeSummary h5,
        [data-theme="dark"] #tradeSummary strong,
        [data-theme="dark"] #tradeSummary small {
            color: #ffffff !important;
        }

        /* General dark mode text override */
        [data-theme="dark"] .text-center,
        [data-theme="dark"] .text-left,
        [data-theme="dark"] .text-right {
            color: #ffffff !important;
        }

        /* Button text visibility */
        [data-theme="dark"] .btn-outline-secondary,
        [data-theme="dark"] .btn-outline-info,
        [data-theme="dark"] .btn-link {
            color: var(--text-primary) !important;
        }

        [data-theme="dark"] .btn-outline-secondary:hover,
        [data-theme="dark"] .btn-outline-info:hover {
            color: #ffffff !important;
        }

        /* Small text elements */
        [data-theme="dark"] .small,
        [data-theme="dark"] small {
            color: var(--text-muted) !important;
        }

        /* Details and summary elements */
        [data-theme="dark"] details,
        [data-theme="dark"] summary {
            color: #ffffff !important;
        }

        /* Pagination text */
        [data-theme="dark"] .pagination-info,
        [data-theme="dark"] .pagination-info span {
            color: #ffffff !important;
        }

        /* Badge text */
        [data-theme="dark"] .badge {
            color: #ffffff !important;
        }

        /* Footer text */
        [data-theme="dark"] footer,
        [data-theme="dark"] footer p {
            color: var(--text-muted) !important;
        }

        /* Progress bar labels */
        [data-theme="dark"] .progress-bar {
            color: #ffffff !important;
        }

        /* Dropdown and select options */
        [data-theme="dark"] .form-select option {
            background: var(--bg-card);
            color: #ffffff;
        }

        /* Navigation stats */
        [data-theme="dark"] .nav-stats {
            color: var(--text-secondary) !important;
        }

        /* Chart selector text */
        [data-theme="dark"] .chart-selector h5,
        [data-theme="dark"] .chart-selector h6 {
            color: #ffffff !important;
        }

        /* File info text */
        [data-theme="dark"] #selectedFileInfo,
        [data-theme="dark"] #selectedFileInfo div {
            color: #ffffff !important;
        }

        /* Any remaining black text */
        [data-theme="dark"] * {
            border-color: var(--border-color);
        }

        /* Comprehensive text color fix */
        [data-theme="dark"] body,
        [data-theme="dark"] .container,
        [data-theme="dark"] .row,
        [data-theme="dark"] .col-md-6,
        [data-theme="dark"] .col-md-8,
        [data-theme="dark"] .col-md-4,
        [data-theme="dark"] h5,
        [data-theme="dark"] .table,
        [data-theme="dark"] .table th,
        [data-theme="dark"] .table td,
        [data-theme="dark"] .table-hover tbody tr:hover,
        [data-theme="dark"] .table-dark,
        [data-theme="dark"] .table-dark th,
        [data-theme="dark"] .table-dark td,
        [data-theme="dark"] h6 {
            color: #ffffff !important;
        }
        
        /* Loading Animation */
        .loading {
            display: none;
            text-align: center;
            padding: 2rem;
        }

        .spinner-border {
            color: var(--primary-color);
        }
        
        /* Modal */
        .modal-content {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            backdrop-filter: blur(20px);
        }

        .modal-header {
            border-bottom: 1px solid var(--border-color);
        }

        .modal-footer {
            border-top: 1px solid var(--border-color);
        }

        .modal-title {
            color: var(--text-primary);
        }

        .btn-close {
            filter: invert(1);
        }

        /* Progress bars */
        .progress {
            background: var(--bg-tertiary);
            border-radius: 8px;
            height: 8px;
        }

        .progress-bar {
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            border-radius: 8px;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }

        /* Enhanced responsive design */
        @media (max-width: 1200px) {
            .metric-value {
                font-size: clamp(1rem, 2.8vw, 1.35rem);
            }
        }

        @media (max-width: 992px) {
            .metric-value {
                font-size: clamp(0.95rem, 2.5vw, 1.25rem);
            }
            
            .metric-title {
                font-size: clamp(0.7rem, 1.8vw, 0.8rem);
            }
        }

        @media (max-width: 992px) {
            .btn-chart {
                width: calc(33.33% - 0.75rem);
                min-width: 160px;
            }
        }

        @media (max-width: 768px) {
            .metric-value {
                font-size: clamp(0.9rem, 2.2vw, 1.15rem);
            }

            .metric-title {
                font-size: clamp(0.65rem, 1.5vw, 0.75rem);
            }

            .section-title {
                font-size: 1.25rem;
            }

            .card-body {
                padding: 1rem;
            }

            .btn-chart {
                min-width: 140px;
                width: calc(50% - 0.75rem);
                font-size: 0.8rem;
                padding: 0.75rem 1rem;
            }
        }

        @media (max-width: 576px) {
            .metric-value {
                font-size: clamp(0.9rem, 2vw, 1.1rem);
            }
            
            .metric-title {
                font-size: clamp(0.6rem, 1.2vw, 0.7rem);
                letter-spacing: 0.03em;
            }
            
            .metric-card .card-body {
                padding: 1rem 0.75rem;
            }
        }

        /* Animation keyframes */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .card {
            animation: fadeInUp 0.6s ease-out;
        }

        /* Custom badges */
        .badge {
            border-radius: 8px;
            font-weight: 500;
            padding: 0.5rem 0.75rem;
        }

        .bg-success {
            background: var(--success-color) !important;
        }

        .bg-danger {
            background: var(--danger-color) !important;
        }

        /* Glassmorphism hover effects */
        .card:hover .metric-card {
            transform: scale(1.02);
        }

        /* Enhanced table responsiveness */
        .table-responsive {
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }

        /* Footer */
        footer {
            color: var(--text-muted);
            margin-top: 3rem;
            padding: 2rem 0;
            border-top: 1px solid var(--border-subtle);
        }

        /* Files Overview Table */
        #filesOverviewTable {
            background: var(--bg-card);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--glass-shadow);
        }

        #filesOverviewTable thead th {
            background: var(--bg-elevated);
            border-bottom: 2px solid var(--border-color);
            color: var(--text-primary);
            font-weight: 600;
            padding: 1rem 0.75rem;
            font-size: 0.9rem;
        }

        #filesOverviewTable tbody td {
            padding: 1rem 0.75rem;
            border-bottom: 1px solid var(--border-subtle);
            vertical-align: middle;
        }

        #filesOverviewTable tbody tr:hover {
            background: var(--bg-elevated);
            transition: background-color 0.2s ease;
        }

        #filesOverviewTable .file-row {
            cursor: pointer;
        }

        #filesOverviewTable .badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
        }

        #filesOverviewTable .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.8rem;
        }

        /* Responsive table adjustments */
        @media (max-width: 768px) {
            #filesOverviewTable {
                font-size: 0.85rem;
            }
            
            #filesOverviewTable thead th,
            #filesOverviewTable tbody td {
                padding: 0.5rem 0.25rem;
            }
        }

        /* Wide tooltip styling for Bootstrap tooltips */
        .wide-tooltip {
            max-width: 500px !important;
            text-align: left !important;
        }
        
        .wide-tooltip .tooltip-inner {
            max-width: 500px !important;
            text-align: left !important;
            white-space: normal !important;
        }

        /* Fix text color in blackout dates textarea */
        #dateListDisplay {
            color: #000000 !important;
            background-color: #f8f9fa !important;
        }
        
        /* Ensure text is visible in both light and dark themes */
        [data-theme="dark"] #dateListDisplay {
            color: #000000 !important;
            background-color: #f8f9fa !important;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-chart-line"></i>
                Portfolio Strategy Analytics
                <span class="version-info" onclick="showVersionModal()" style="cursor: pointer;" title="Click for build details">
                    <span class="version-text">{{ version_string }}</span>
                    {{ build_badge|safe }}
                </span>
            </a>
            <div class="navbar-nav">
                <span class="nav-stats" id="dataStats">Loading...</span>
                <span class="nav-filename" id="csvFilename" style="display:none;">
                    <i class="fas fa-file-csv"></i>
                    <span id="currentFilename">No file loaded</span>
                </span>
                <div class="user-info" id="userInfo">
                    <span id="userDisplay">Loading...</span>
                </div>
                <button class="btn theme-toggle" onclick="toggleTheme()">
                    <i class="fas fa-moon" id="themeIcon"></i>
                    <span id="themeText">Dark</span>
                </button>
                <a href="https://github.com/jminck/oo-analytics/issues" target="_blank" class="btn btn-outline-secondary" title="Report a bug or issue">
                    <i class="fab fa-github"></i>
                    <span>Bug/Suggestion?</span>
                </a>
                <div class="dropdown">
                    <button class="btn btn-outline-primary dropdown-toggle" type="button" id="authDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="fas fa-user"></i>
                        <span id="authButtonText">Account</span>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="authDropdown" id="authDropdownMenu">
                        <!-- Auth menu items will be populated by JavaScript -->
                    </ul>
                </div>
            </div>
        </div>
    </nav>

    <!-- Login Loading Overlay -->
    <div id="loginLoadingOverlay" class="login-loading" style="display: none;">
        <div class="login-loading-content">
            <div class="login-loading-spinner"></div>
            <div class="login-loading-text">Signing you in...</div>
            <div class="login-loading-subtext">Please wait while we authenticate your account</div>
        </div>
    </div>

    <div class="container mt-4">
        <!-- Alerts -->
        <div id="alertContainer"></div>

        <!-- File Upload Section -->
        <div class="row mb-4">
            <div class="col-12">
                <h2 class="section-title">
                    <i class="fas fa-database"></i>
                    Data Management
                </h2>
            </div>
            <div class="col-md-6 mb-3">
                <h5>Upload New File</h5>
                           <div class="d-flex align-items-start gap-3 mb-2">
               <div style="flex: 1; min-width: 0;">
                   <label for="friendlyNameInput" class="form-label">Friendly Name (optional):</label>
                   <input type="text" class="form-control form-control-sm" id="friendlyNameInput" placeholder="e.g., Q4 2024 Trades">
                   <small class="text-muted">Leave empty to use original filename</small>
               </div>
               <div class="upload-area" id="uploadArea" onclick="if (!window.selectedFile) document.getElementById('fileInput').click()" style="height: 80px; flex: 1; min-width: 0;">
                        <div class="upload-content" id="uploadContent">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <h6 id="uploadPrompt" style="font-size: 0.8rem; margin: 0;">Drop CSV here</h6>
                            <small class="text-muted" id="uploadHint" style="font-size: 0.7rem;">or click to browse</small>
                        </div>
                        <div id="selectedFileInfo" style="display:none;">
                            <span id="selectedFileName" class="fw-bold" style="font-size: 0.8rem;"></span>
                            <button type="button" class="btn btn-link btn-sm text-danger ms-2" id="clearFileBtn" style="font-size: 0.7rem;">Remove</button>
                            <div class="text-muted" style="font-size: 0.7rem;">Click Upload</div>
                        </div>
                        <input type="file" id="fileInput" accept=".csv" style="display: none;">
                    </div>
                </div>
                <!-- Add an explicit Upload button below the initial capital input -->
                <div class="mb-2" id="initialCapitalGroup" style="display:none;">
                    <label for="initialCapitalInput" class="form-label">Initial Capital (real trade logs only):</label>
                    <input type="number" class="form-control form-control-sm" id="initialCapitalInput" name="initial_capital" min="1" step="1" value="100000">
                    <small class="text-muted">Used to calculate portfolio values for real trade logs. Default: 100,000</small>
                </div>
                <button class="btn btn-primary mt-2" id="uploadFileBtn" style="display:none;">Upload</button>
                
                <!-- Load Sample Data Button -->
                <div class="mt-3">
                    <button class="btn btn-outline-info" id="loadSampleDataBtn" onclick="loadSamplePortfolioData()">
                        <i class="fas fa-download"></i> Load Sample Portfolio Data
                    </button>
                    <small class="text-muted d-block mt-1">Load Example-Portfolio.csv for testing and demonstration</small>
                </div>
            </div>
            <div class="col-md-6 mb-3">
                <h5>Load Previous File</h5>
                <div class="saved-files-section">
                    <label for="savedFilesSelect" class="form-label">Select a previously uploaded file:</label>
                    <select class="form-select" id="savedFilesSelect">
                        <option value="">Loading saved files...</option>
                    </select>
                    <div class="d-flex gap-2 mt-2">
                        <button class="btn btn-primary btn-sm" id="loadFileBtn" disabled>Load Selected File</button>
                        <button class="btn btn-outline-info btn-sm" id="editNameBtn" disabled title="Edit friendly name">✏️ Rename</button>
                        <button class="btn btn-outline-danger btn-sm" id="deleteFileBtn" disabled title="Delete selected file">🗑️ Delete</button>
                        <button class="btn btn-outline-secondary btn-sm" id="cleanupFilesBtn" title="Remove duplicate files, keeping only the most recent version">🧹 Cleanup Duplicates</button>
                    </div>
                    <div id="savedFileStatus" class="mt-2"></div>
                </div>
            </div>
        </div>


        <!-- Portfolio Overview Metrics -->
        <div class="mb-4">
                <h2 class="section-title">
                    <i class="fas fa-chart-area"></i>
                    Portfolio Overview
                </h2>
            <div class="portfolio-overview-container">
                <div class="metric-card-wrapper">
                <div class="card metric-card">
                    <div class="card-body text-center">
                        <div class="metric-title">Starting Capital</div>
                        <div class="metric-value" id="startingCapital">$0</div>
                        <div class="metric-subtitle" id="startDate" style="font-size: 0.8em; color: #666; margin-top: 4px;"></div>
                    </div>
                </div>
            </div>
                <div class="metric-card-wrapper">
                <div class="card metric-card">
                    <div class="card-body text-center">
                        <div class="metric-title">Ending Capital</div>
                        <div class="metric-value" id="endingCapital">$0</div>
                        <div class="metric-subtitle" id="endDate" style="font-size: 0.8em; color: #666; margin-top: 4px;"></div>
                    </div>
                </div>
            </div>
                <div class="metric-card-wrapper">
                <div class="card metric-card">
                    <div class="card-body text-center">
                        <div class="metric-title">Total P&L</div>
                        <div class="metric-value" id="totalPnL">$0</div>
                    </div>
                </div>
            </div>
                <div class="metric-card-wrapper">
                <div class="card metric-card">
                    <div class="card-body text-center">
                            <div class="metric-title">Max Drawdown</div>
                            <div class="metric-value" id="maxDrawdown">$0</div>
                    </div>
                </div>
            </div>
                <div class="metric-card-wrapper">
                <div class="card metric-card">
                    <div class="card-body text-center">
                            <div class="metric-title">Max Drawdown %</div>
                            <div class="metric-value" id="maxDrawdownPct">0%</div>
                    </div>
                </div>
            </div>
                <div class="metric-card-wrapper">
                <div class="card metric-card">
                    <div class="card-body text-center">
                            <div class="metric-title">CAGR</div>
                            <div class="metric-value" id="cagr">0%</div>
                    </div>
                </div>
            </div>
                <div class="metric-card-wrapper">
                <div class="card metric-card">
                    <div class="card-body text-center">
                            <div class="metric-title">MAR</div>
                            <div class="metric-value" id="mar">0</div>
                    </div>
                </div>
            </div>
                <div class="metric-card-wrapper">
                <div class="card metric-card">
                    <div class="card-body text-center">
                            <div class="metric-title">Total Trades</div>
                            <div class="metric-value" id="totalTrades">0</div>
                    </div>
                </div>
            </div>
                <div class="metric-card-wrapper">
                <div class="card metric-card">
                    <div class="card-body text-center">
                            <div class="metric-title">Strategies</div>
                            <div class="metric-value" id="strategyCount">0</div>
                    </div>
                </div>
            </div>
                <div class="metric-card-wrapper">
                <div class="card metric-card">
                    <div class="card-body text-center">
                        <div class="metric-title">Avg Days to New High</div>
                        <div class="metric-value" id="avgDaysToNewHigh">N/A</div>
                    </div>
                </div>
            </div>
                <div class="metric-card-wrapper">
                <div class="card metric-card">
                    <div class="card-body text-center">
                        <div class="metric-title">Longest Days to New High</div>
                        <div class="metric-value" id="longestDaysSinceToNewHigh">N/A</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabbed Analytics Interface -->
        <div class="row mb-4">
            <div class="col-12">
                <h2 class="section-title">
                    <i class="fas fa-chart-pie"></i>
                    Analytics Dashboard
                </h2>
            </div>
        </div>
        
        <!-- Chart Selector and Container Layout -->
        <div class="d-flex gap-3 mb-4" style="overflow-x: hidden; min-width: 0;">
            <!-- Left Sidebar - Chart Selector (Auto-sized) -->
            <div class="flex-shrink-0">
                <div class="card sidebar-chart-selector">
                    <div class="card-header py-2">
                        <h6 class="mb-0">
                            <i class="fas fa-chart-bar"></i>
                            Charts
                        </h6>
                    </div>
                    <div class="card-body p-1">
                        <div id="chartButtons" class="d-grid gap-1">
                        <!-- Chart buttons will be populated by JavaScript -->
                    </div>
                    </div>
                    </div>
                </div>
            
            <!-- Right Side - Chart Container (Flexible) -->
            <div class="flex-grow-1" style="min-width: 0; overflow-x: hidden;">
                
                <!-- Overview Content (hidden by default, shown when "Overview" chart type is selected) -->
                <div id="overviewContent" style="display: none;">
                    <!-- Strategy Performance -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h3 class="section-title">
                                <i class="fas fa-table"></i>
                                Strategy Performance
                            </h3>
                            <div class="card strategy-table">
                                <div class="card-body">
                                    <div class="table-responsive" style="max-height: 600px; overflow-x: auto; overflow-y: auto;">
                                        <table class="table table-hover" id="strategyTable">
                                            <thead class="table-dark">
                                                <tr>
                                                    <th style="min-width: 200px; cursor:pointer;" data-key="strategy" onclick="sortStrategyTable('strategy')" class="custom-tooltip" data-tooltip="Name of the trading strategy">Strategy <span id="sort-indicator-strategy"></span></th>
                                                    <th style="cursor:pointer;" data-key="total_pnl" onclick="sortStrategyTable('total_pnl')" class="custom-tooltip" data-tooltip="Total profit/loss for all trades in this strategy">Total P&L <span id="sort-indicator-total_pnl"></span></th>
                                                    <th style="cursor:pointer;" data-key="trades" onclick="sortStrategyTable('trades')" class="custom-tooltip" data-tooltip="Total number of completed trades">Trades <span id="sort-indicator-trades"></span></th>
                                                    <th style="cursor:pointer;" data-key="wins" onclick="sortStrategyTable('wins')" class="custom-tooltip" data-tooltip="Number of profitable trades">Wins <span id="sort-indicator-wins"></span></th>
                                                    <th style="cursor:pointer;" data-key="losses" onclick="sortStrategyTable('losses')" class="custom-tooltip" data-tooltip="Number of losing trades">Losses <span id="sort-indicator-losses"></span></th>
                                                    <th style="cursor:pointer;" data-key="commissions" onclick="sortStrategyTable('commissions')" class="custom-tooltip" data-tooltip="Total commission costs for all trades">Commissions <span id="sort-indicator-commissions"></span></th>
                                                    <th style="cursor:pointer;" data-key="win_rate" onclick="sortStrategyTable('win_rate')" class="custom-tooltip" data-tooltip="Percentage of trades that were profitable">Win Rate <span id="sort-indicator-win_rate"></span></th>
                                                    <th style="cursor:pointer;" data-key="max_loss_streak" onclick="sortStrategyTable('max_loss_streak')" class="custom-tooltip" data-tooltip="Maximum consecutive losing trades">Max Loss Streak <span id="sort-indicator-max_loss_streak"></span></th>
                                                    <th style="cursor:pointer;" data-key="avg_win" onclick="sortStrategyTable('avg_win')" class="custom-tooltip" data-tooltip="Average profit amount for winning trades">Avg Winner <span id="sort-indicator-avg_win"></span></th>
                                                    <th style="cursor:pointer;" data-key="avg_loss" onclick="sortStrategyTable('avg_loss')" class="custom-tooltip" data-tooltip="Average loss amount for losing trades">Avg Loser <span id="sort-indicator-avg_loss"></span></th>
                                                    <th style="cursor:pointer;" data-key="max_win" onclick="sortStrategyTable('max_win')" class="custom-tooltip" data-tooltip="Largest profit from a single winning trade">Max Winner <span id="sort-indicator-max_win"></span></th>
                                                    <th style="cursor:pointer;" data-key="max_loss" onclick="sortStrategyTable('max_loss')" class="custom-tooltip" data-tooltip="Largest loss from a single losing trade">Max Loser <span id="sort-indicator-max_loss"></span></th>
                                                    <th style="cursor:pointer;" data-key="avg_win_per_lot" onclick="sortStrategyTable('avg_win_per_lot')" class="custom-tooltip" data-tooltip="Average profit per contract for winning trades">Avg Win/Lot <span id="sort-indicator-avg_win_per_lot"></span></th>
                                                    <th style="cursor:pointer;" data-key="avg_loss_per_lot" onclick="sortStrategyTable('avg_loss_per_lot')" class="custom-tooltip" data-tooltip="Average loss per contract for losing trades">Avg Loss/Lot <span id="sort-indicator-avg_loss_per_lot"></span></th>
                                                    <th style="cursor:pointer;" data-key="max_win_per_lot" onclick="sortStrategyTable('max_win_per_lot')" class="custom-tooltip" data-tooltip="Largest profit per contract from a single trade">Max Win/Lot <span id="sort-indicator-max_win_per_lot"></span></th>
                                                    <th style="cursor:pointer;" data-key="max_loss_per_lot" onclick="sortStrategyTable('max_loss_per_lot')" class="custom-tooltip" data-tooltip="Largest loss per contract from a single trade">Max Loss/Lot <span id="sort-indicator-max_loss_per_lot"></span></th>
                                                    <th style="cursor:pointer;" data-key="comm_per_lot" onclick="sortStrategyTable('comm_per_lot')" class="custom-tooltip" data-tooltip="Average commission cost per contract">Comm/Lot <span id="sort-indicator-comm_per_lot"></span></th>
                                                    <th style="cursor:pointer;" data-key="expectancy_per_lot" onclick="sortStrategyTable('expectancy_per_lot')" class="custom-tooltip" data-tooltip="Expected profit/loss per contract: (win_rate × avg_win) - (loss_rate × avg_loss)">Expectancy/Lot <span id="sort-indicator-expectancy_per_lot"></span></th>
                                                    <th style="cursor:pointer;" data-key="profit_factor" onclick="sortStrategyTable('profit_factor')" class="custom-tooltip" data-tooltip="Ratio of total profits to total losses (higher is better)">Profit Factor <span id="sort-indicator-profit_factor"></span></th>
                                                    <th style="cursor:pointer;" data-key="margin_percentage" onclick="sortStrategyTable('margin_percentage')" class="custom-tooltip" data-tooltip="Trade size percentage: Margin Req. / (Funds at Close - P/L) from first trade">Margin % <span id="sort-indicator-margin_percentage"></span></th>
                                                    <th style="cursor:pointer;" data-key="efficiency" onclick="sortStrategyTable('efficiency')" class="custom-tooltip" data-tooltip="Risk-adjusted performance: (Expectancy ÷ Margin) × Win Rate">Efficiency <span id="sort-indicator-efficiency"></span></th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr>
                                                    <td colspan="21" class="text-center text-muted">No strategy data available</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>


                    <!-- Portfolio Balance Analysis -->
                    <div class="row mb-4">
                        <div class="col-md-12">
                            <h3 class="section-title">
                                <i class="fas fa-balance-scale"></i>
                                Portfolio Balance Analysis
                                <i class="fas fa-info-circle ms-2" 
                                   data-bs-toggle="tooltip" 
                                   data-bs-placement="top" 
                                   data-bs-html="true"
                                   data-bs-custom-class="wide-tooltip"
                                   title="<div style='text-align: left; max-width: 500px;'><strong>Strategy Classification Logic:</strong><br><br>
                                   <strong>BULLISH Strategies:</strong><br>
                                   • Market goes UP (+0.5%+) AND strategy is PROFITABLE<br>
                                   • Market goes DOWN (-0.5%+) AND strategy LOSES money<br><br>
                                   <strong>BEARISH Strategies:</strong><br>
                                   • Market goes DOWN (-0.5%+) AND strategy is PROFITABLE<br>
                                   • Market goes UP (+0.5%+) AND strategy LOSES money<br><br>
                                   <strong>NEUTRAL Strategies:</strong><br>
                                   • Small market movements (-0.5% to +0.5%)<br>
                                   • Mixed signals or no clear market correlation<br><br>
                                   <em>Classification based on opening/closing prices and P&L for each trade.</em></div>"></i>
                            </h3>
                            <div class="card">
                                <div class="card-body">
                                    <div id="balanceAnalysis">
                                        <p class="text-muted">Upload data to see portfolio balance across bullish/bearish/neutral strategies</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-body">
                        <div id="chartContainer" class="chart-container">
                            <div class="text-center text-muted">
                                <i class="fas fa-chart-bar" style="font-size: 3rem; color: var(--primary-color); margin-bottom: 1rem;"></i>
                                <h4>Upload data to see interactive charts</h4>
                                <p>Charts will show strategy comparisons, correlations, and performance analysis</p>
                            </div>
                        </div>
                        <div id="dailyMarginTableContainer" class="table-container" style="display: none;">
                            <!-- Paginated daily margin table will be rendered here -->
                        </div>
                        <div id="chartLoading" class="loading">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p>Generating chart...</p>
                        </div>
                    </div>
                </div>
                
                <!-- MEIC Analysis Content (hidden by default, shown when "MEIC Analysis" chart type is selected) -->
                <div id="meicAnalysisContent" style="display: none;">
                    <!-- MEIC Requirements Explanation -->
                    <div class="row mb-3">
                        <div class="col-12">
                            <div class="alert alert-info py-2">
                                <h6 class="alert-heading mb-2">
                                    <i class="fas fa-info-circle"></i>
                                    MEIC (Multiple Entry Iron Condor) Analysis Requirements
                                </h6>
                                <div class="row">
                                    <div class="col-md-6">
                                        <strong>Naming:</strong> "meic" must be in filename or strategy name<br>
                                        <strong>Structure:</strong> 2 leg groups (put spread + call spread)<br>
                                        <strong>Timing:</strong> Same entry date and time for both trades
                                    </div>
                                    <div class="col-md-6">
                                        <strong>Example:</strong> Entry 15:14:00 on 2025-09-05<br>
                                        • Put: "4 Sep 5 6470 P STO 1.95 | 4 Sep 5 6395 P BTO 0.05"<br>
                                        • Call: "4 Sep 5 6485 C STO 2.20 | 4 Sep 5 6540 C BTO 0.05"
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- MEIC No Trades Message (hidden by default) -->
                    <div id="meicNoTradesMessage" style="display: none;">
                        <div class="row mb-4">
                            <div class="col-12">
                                <div class="alert alert-info">
                                    <h4 class="alert-heading">
                                        <i class="fas fa-info-circle"></i>
                                        No MEIC Trades Detected
                                    </h4>
                                    <p>No Multiple Entry Iron Condor (MEIC) trades were found in your data. To analyze MEIC trades, please ensure:</p>
                                    <hr>
                                    <h6><strong>Naming Requirements:</strong></h6>
                                    <ul>
                                        <li>The word "meic" (case-insensitive) must appear in either:</li>
                                        <ul>
                                            <li>The <strong>filename</strong> of your uploaded CSV file, OR</li>
                                            <li>The <strong>strategy name</strong> in your trade data</li>
                                        </ul>
                                    </ul>
                                    <h6><strong>Leg Group Requirements:</strong></h6>
                                    <ul>
                                        <li>MEIC trades must be organized in "leg groups"</li>
                                        <li>Each leg group consists of <strong>2 trades</strong> placed at the same entry time:</li>
                                        <ul>
                                            <li>One trade for the <strong>put spread</strong> (P strikes only)</li>
                                            <li>One trade for the <strong>call spread</strong> (C strikes only)</li>
                                        </ul>
                                        <li>Both trades must have the same <strong>entry date and time</strong></li>
                                    </ul>
                                    <h6><strong>Example:</strong></h6>
                                    <p>For a MEIC trade group entered at 15:14:00 on 2025-09-05:</p>
                                    <ul>
                                        <li><strong>Put Spread:</strong> "4 Sep 5 6470 P STO 1.95 | 4 Sep 5 6395 P BTO 0.05"</li>
                                        <li><strong>Call Spread:</strong> "4 Sep 5 6485 C STO 2.20 | 4 Sep 5 6540 C BTO 0.05"</li>
                                    </ul>
                                    <hr>
                                    <div class="mt-3">
                                        <button class="btn btn-success" onclick="loadSampleMEICData()">
                                            <i class="fas fa-download"></i> Load Sample MEIC Data
                                        </button>
                                        <small class="text-muted d-block mt-1">Load Example-Portfolio-MEIC.csv for testing and demonstration</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- MEIC Overview -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h3 class="section-title">
                                <i class="fas fa-chart-pie"></i>
                                MEIC Overview
                            </h3>
                            <div class="card">
                                <div class="card-body">
                                    <div id="meicOverviewStats">
                                        <p class="text-muted">Loading MEIC overview statistics...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- MEIC Time Heatmap -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h3 class="section-title">
                                <i class="fas fa-chart-bar"></i>
                                MEIC Performance Heatmap
                            </h3>
                            <div class="card">
                                <div class="card-body">
                                    <!-- Date Range Controls -->
                                    <div class="row mb-2">
                                        <div class="col-12">
                                            <div class="card border-light">
                                                <div class="card-body py-2">
                                                    <div class="row align-items-center">
                                                        <div class="col-md-8">
                                                            <h6 class="card-title mb-2">
                                                                <i class="fas fa-sliders-h"></i> Date Range Filter
                                                            </h6>
                                                            <p class="text-muted small mb-3">
                                                                <i class="fas fa-info-circle"></i> 
                                                                Filter the date range to analyze how different time periods impact the MEIC heatmap performance and patterns.
                                                            </p>
                                                            
                                                            <!-- Date Range Display -->
                                                            <div class="row mb-2">
                                                                <div class="col-6">
                                                                    <small class="text-muted">Start:</small> <span id="meicStartDateDisplay" class="fw-bold">All Dates</span>
                                                                </div>
                                                                <div class="col-6">
                                                                    <small class="text-muted">End:</small> <span id="meicEndDateDisplay" class="fw-bold">All Dates</span>
                                                                </div>
                                                            </div>
                                                            
                                                            <!-- Sliders -->
                                                            <div class="mb-2">
                                                                <label for="meicStartDateSlider" class="form-label small mb-1">Start Date</label>
                                                                <input type="range" class="form-range" id="meicStartDateSlider" 
                                                                       min="0" max="100" value="0" step="1" oninput="updateMEICDateLabels()">
                                                                <div class="d-flex justify-content-between">
                                                                    <small class="text-muted" id="meicStartDateMin">Loading...</small>
                                                                    <small class="text-muted" id="meicStartDateMax">Loading...</small>
                                                                </div>
                                                            </div>
                                                            
                                                            <div class="mb-2">
                                                                <label for="meicEndDateSlider" class="form-label small mb-1">End Date</label>
                                                                <input type="range" class="form-range" id="meicEndDateSlider" 
                                                                       min="0" max="100" value="100" step="1" oninput="updateMEICDateLabels()">
                                                                <div class="d-flex justify-content-between">
                                                                    <small class="text-muted" id="meicEndDateMin">Loading...</small>
                                                                    <small class="text-muted" id="meicEndDateMax">Loading...</small>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        
                                                        <div class="col-md-4">
                                                            <!-- Trade Count & Actions -->
                                                            <div class="alert alert-info py-1 mb-2" id="meicTradeCountAlert">
                                                                <small><i class="fas fa-chart-bar"></i> <strong>Trades:</strong> <span id="meicTradeCount">Loading...</span></small>
                                                            </div>
                                                            
                                                            <!-- Recalculation Notice -->
                                                            <div id="meicRecalculationNotice" style="display: none;">
                                                                <div class="alert alert-warning py-1 mb-2">
                                                                    <small><i class="fas fa-exclamation-triangle"></i> <strong>Recalculation needed!</strong></small>
                                                                </div>
                                                            </div>
                                                            
                                                            <!-- Action Buttons -->
                                                            <div class="d-grid gap-1">
                                                                <button type="button" class="btn btn-primary btn-sm" onclick="recalculateMEICHeatmap()" id="meicRecalculateBtn">
                                                                    <i class="fas fa-calculator"></i> Recalculate
                                                                </button>
                                                                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="resetMEICDateRange()">
                                                                    <i class="fas fa-undo"></i> Reset
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div id="meicHeatmapChart" class="chart-container">
                                        <div class="text-center text-muted">
                                            <i class="fas fa-chart-bar" style="font-size: 3rem; color: var(--primary-color); margin-bottom: 1rem;"></i>
                                            <h4>MEIC Performance Heatmap</h4>
                                            <p>Heatmap will show P&L by day of week and entry time</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>




        <!-- Simulation Trades Modal -->
        <div class="modal fade" id="simulationTradesModal" tabindex="-1" aria-labelledby="simulationTradesModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="simulationTradesModalLabel">Simulated Trades - Simulation #<span id="modalSimulationId"></span></h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div id="simulationSummary" class="alert alert-info mb-3">
                            <!-- Simulation summary will be populated here -->
                        </div>
                        <div class="table-responsive" style="max-height: 500px;">
                            <table class="table table-sm table-striped" id="simulatedTradesTable">
                                <thead class="table-dark sticky-top">
                                    <tr>
                                        <th>Trade #</th>
                                        <th>P&L</th>
                                        <th>Result</th>
                                        <th>Cumulative P&L</th>
                                        <th>Account Balance</th>
                                    </tr>
                                </thead>
                                <tbody id="simulatedTradesTableBody">
                                    <!-- Trades will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <div class="text-muted small me-auto" id="modalTradeComparison">
                            <!-- Historical comparison info -->
                        </div>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>





        <!-- Footer -->
        <footer class="text-center text-muted py-4">
            <p>Simple Portfolio Analytics - Strategy-focused trading analysis made easy</p>
        </footer>
    </div>

    <script>
        // Cache busting version - v20241213_1
        console.log('🔧 JavaScript loaded - v20241213_3_no_severity');
        
        // Global state
        let currentChart = null;
        let availableCharts = {};
        let chartsLoadedSuccessfully = false;

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            console.log('=== PAGE INITIALIZATION START ===');
            console.log('DOM loaded, initializing...');
            
            console.log('1. Loading user info...');
            loadUserInfo();
            
            console.log('2. Setting up file upload...');
            setupFileUpload();
            
            console.log('3. Setting up saved files...');
            setupSavedFiles();
            
            console.log('4. Loading data stats...');
            loadDataStats();
            
            console.log('5. Loading files overview...');
            loadFilesOverview();
            
            console.log('6. Loading available charts...');
            loadAvailableCharts();
            
            console.log('7. Loading portfolio data...');
            loadPortfolioData();
            
            console.log('8. Loading current filename...');
            loadCurrentFilename();
            
            console.log('=== PAGE INITIALIZATION COMPLETED ===');
            
            
            // Ensure chart buttons are loaded
            setTimeout(() => {
                console.log('🔧 TIMEOUT CHECK v2 - availableCharts:', availableCharts ? Object.keys(availableCharts).length : 'null/undefined');
                console.log('🔧 TIMEOUT CHECK v2 - chartsLoadedSuccessfully:', chartsLoadedSuccessfully);
                if ((!availableCharts || Object.keys(availableCharts).length === 0) && !chartsLoadedSuccessfully) {
                    console.log('No charts available, using fallback...');
                    forceRenderChartButtons();
                } else {
                    console.log('✅ Charts already loaded, skipping fallback');
                }
                // Load overview by default
                loadChart('overview');
            }, 1000);
            
        });

        // File upload functionality
        function setupFileUpload() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');
            const initialCapitalGroup = document.getElementById('initialCapitalGroup');
            const initialCapitalInput = document.getElementById('initialCapitalInput');
            const uploadFileBtn = document.getElementById('uploadFileBtn');
            const uploadContent = document.getElementById('uploadContent');
            const uploadPrompt = document.getElementById('uploadPrompt');
            const uploadHint = document.getElementById('uploadHint');
            const selectedFileInfo = document.getElementById('selectedFileInfo');
            const selectedFileName = document.getElementById('selectedFileName');
            const clearFileBtn = document.getElementById('clearFileBtn');
            
            window.selectedFile = null;

            // Drag and drop handlers
            uploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });
            uploadArea.addEventListener('dragleave', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
            });
            uploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    previewFile(files[0]);
                }
            });
            fileInput.addEventListener('change', function(e) {
                if (e.target.files.length > 0) {
                    previewFile(e.target.files[0]);
                }
            });
            // Prefill initial capital from backend if available
            if (window.lastInitialCapital) {
                initialCapitalInput.value = window.lastInitialCapital;
            }
            // Upload button handler
            uploadFileBtn.addEventListener('click', function() {
                if (window.selectedFile) {
                    handleFileUpload(window.selectedFile);
                }
            });
            // Clear file handler
            clearFileBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                window.selectedFile = null;
                fileInput.value = '';
                selectedFileInfo.style.display = 'none';
                uploadContent.style.display = '';
                uploadFileBtn.style.display = 'none';
                initialCapitalGroup.style.display = 'none';
            });
            // Preview file header to detect real trade log and count lines
            function previewFile(file) {
                window.selectedFile = file;
                selectedFileName.textContent = file.name;
                selectedFileInfo.style.display = '';
                uploadContent.style.display = 'none';
                uploadFileBtn.style.display = 'none'; // Hide upload button until modal is shown
                
                // Show loading state for file analysis
                const originalFileName = selectedFileName.textContent;
                selectedFileName.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Analyzing file...';
                
                const reader = new FileReader();
                reader.onload = function(evt) {
                    const content = evt.target.result;
                    const lines = content.split('\n');
                    const lineCount = lines.length;
                    
                    // Estimate trade count (subtract 1 for header, filter out empty lines)
                    const nonEmptyLines = lines.filter(line => line.trim() !== '').length;
                    const estimatedTradeCount = Math.max(0, nonEmptyLines - 1); // Subtract header
                    
                    // Get configuration from backend for trade limit
                    fetch('/api/config')
                        .then(response => response.json())
                        .then(configData => {
                            if (configData.success) {
                                const config = configData.data;
                                const maxTrades = config.max_trades_limit;
                                const limitDisabled = config.disable_trade_limit;
                                
                                // Prepare analysis data for modal
                                const analysisData = {
                                    lineCount: lineCount,
                                    estimatedTradeCount: estimatedTradeCount,
                                    maxTrades: maxTrades,
                                    warning: null
                                };
                                
                                // Check for trade limit warning
                                if (!limitDisabled && estimatedTradeCount > maxTrades) {
                                    analysisData.warning = `This file contains approximately ${estimatedTradeCount.toLocaleString()} trades. The recommended limit is ${maxTrades.toLocaleString()} trades. Large files may cause performance issues.`;
                                }
                                
                                // Show the modal with analysis results
                                showFileAnalysisModal(file, analysisData);
                                
                            } else {
                                // Fallback if config fetch fails
                                const analysisData = {
                                    lineCount: lineCount,
                                    estimatedTradeCount: estimatedTradeCount,
                                    maxTrades: 3000, // Default fallback
                                    warning: null
                                };
                                showFileAnalysisModal(file, analysisData);
                            }
                        })
                        .catch(error => {
                            console.error('Error fetching config:', error);
                            // Fallback if config fetch fails
                            const analysisData = {
                                lineCount: lineCount,
                                estimatedTradeCount: estimatedTradeCount,
                                maxTrades: 3000, // Default fallback
                                warning: null
                            };
                            showFileAnalysisModal(file, analysisData);
                        });
                    
                    // Check if it's a real trade log for initial capital
                    const firstLine = lines[0];
                    if (firstLine && firstLine.includes('Initial Premium')) {
                        initialCapitalGroup.style.display = '';
                        if (window.lastInitialCapital) {
                            initialCapitalInput.value = window.lastInitialCapital;
                        } else {
                            initialCapitalInput.value = 100000;
                        }
                    } else {
                        initialCapitalGroup.style.display = 'none';
                    }
                };
                reader.readAsText(file);
            }
        }

        function handleFileUpload(file) {
            // Track file upload attempt
            if (window.appInsights) {
                window.appInsights.trackEvent('frontend_file_upload_attempted', {
                    fileName: file.name,
                    fileSize: file.size,
                    fileType: file.type
                });
            }
            
            if (!file.name.toLowerCase().endsWith('.csv')) {
                // Track invalid file type
                if (window.appInsights) {
                    window.appInsights.trackEvent('frontend_file_upload_failed', {
                        fileName: file.name,
                        error: 'invalid_file_type'
                    });
                }
                showAlert('Please select a CSV file', 'warning');
                return;
            }
            const formData = new FormData();
            formData.append('file', file);
            // Add friendly name if provided
            const friendlyName = document.getElementById('friendlyNameInput').value.trim();
            if (friendlyName) {
                formData.append('friendly_name', friendlyName);
            }
            // Add initial capital if visible
            const initialCapitalGroup = document.getElementById('initialCapitalGroup');
            if (initialCapitalGroup && initialCapitalGroup.style.display !== 'none') {
                const initialCapital = document.getElementById('initialCapitalInput').value;
                if (initialCapital) {
                    formData.append('initial_capital', initialCapital);
                }
            }
            // Show loading state
            const uploadBtn = document.getElementById('uploadFileBtn');
            const originalBtnText = uploadBtn.innerHTML;
            uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading...';
            uploadBtn.disabled = true;
            
            showAlert('Uploading and processing file...', 'info');
            fetch('/api/upload', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Track successful upload
                    if (window.appInsights) {
                        window.appInsights.trackEvent('frontend_file_upload_success', {
                            fileName: file.name,
                            tradesCount: data.data.trades_count,
                            strategiesCount: data.data.strategies_count,
                            friendlyName: data.data.friendly_name
                        }, {
                            tradesCount: data.data.trades_count,
                            strategiesCount: data.data.strategies_count
                        });
                    }
                    
                    const displayName = data.data.friendly_name || file.name;
                    showAlert(`Success! Uploaded ${data.data.trades_count} trades from ${data.data.strategies_count} strategies as "${displayName}"`, 'success');
                    
                    // Show warning if file exceeds recommended trade limit
                    if (data.warning) {
                        console.log('DEBUG: Showing warning alert:', data.warning);
                        showAlert(data.warning, 'warning');
                    } else {
                        console.log('DEBUG: No warning in response data');
                    }
                    
                    // Update filename display
                    updateFilenameDisplay(data.data.filename || file.name);
                    
                    document.getElementById('friendlyNameInput').value = '';
                    if (data.data.initial_capital) {
                        window.lastInitialCapital = data.data.initial_capital;
                        document.getElementById('initialCapitalInput').value = data.data.initial_capital;
                    }
                    // Reset upload area
                    window.selectedFile = null;
                    document.getElementById('fileInput').value = '';
                    document.getElementById('selectedFileInfo').style.display = 'none';
                    document.getElementById('uploadContent').style.display = '';
                    document.getElementById('uploadFileBtn').style.display = 'none';
                    document.getElementById('initialCapitalGroup').style.display = 'none';
                    // Clear all application state before loading new data
                    clearAllAppState();
                    
                    loadPortfolioData();
                    loadDataStats();
                    loadSavedFilesList();
                    loadFilesOverview();
                } else {
                    // Track upload failure
                    if (window.appInsights) {
                        window.appInsights.trackEvent('frontend_file_upload_failed', {
                            fileName: file.name,
                            error: data.error
                        });
                    }
                    showAlert(`Upload failed: ${data.error}`, 'danger');
                }
                
                // Restore button state
                uploadBtn.innerHTML = originalBtnText;
                uploadBtn.disabled = false;
            })
            .catch(error => {
                // Track upload error
                if (window.appInsights) {
                    window.appInsights.trackEvent('frontend_file_upload_error', {
                        fileName: file.name,
                        error: error.message
                    });
                }
                showAlert(`Upload error: ${error.message}`, 'danger');
                
                // Restore button state
                uploadBtn.innerHTML = originalBtnText;
                uploadBtn.disabled = false;
            });
        }

        function loadSamplePortfolioData() {
            // Track sample data load attempt
            if (window.appInsights) {
                window.appInsights.trackEvent('frontend_sample_data_load_attempted');
            }
            
            showAlert('Loading sample portfolio data...', 'info');
            
            fetch('/api/load-sample-data', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Track successful sample data load
                    if (window.appInsights) {
                        window.appInsights.trackEvent('frontend_sample_data_load_success', {
                            tradesCount: data.data.trades_count,
                            strategiesCount: data.data.strategies_count
                        });
                    }
                    
                    const displayName = data.data.friendly_name || 'Example Portfolio';
                    showAlert(`Success! Loaded ${data.data.trades_count} trades from ${data.data.strategies_count} strategies as "${displayName}"`, 'success');
                    
                    // Update filename display
                    updateFilenameDisplay(data.data.filename || 'Example-Portfolio.csv');
                    
                    // Clear all application state before loading new data
                    clearAllAppState();
                    
                    // Reload portfolio data and charts
                    loadPortfolioData();
                    loadSavedFilesList();
                    loadFilesOverview();
                } else {
                    // Track sample data load failure
                    if (window.appInsights) {
                        window.appInsights.trackEvent('frontend_sample_data_load_failed', {
                            error: data.error
                        });
                    }
                    showAlert(`Failed to load sample data: ${data.error}`, 'danger');
                }
            })
            .catch(error => {
                // Track sample data load error
                if (window.appInsights) {
                    window.appInsights.trackEvent('frontend_sample_data_load_error', {
                        error: error.message
                    });
                }
                showAlert(`Error loading sample data: ${error.message}`, 'danger');
            });
        }
        
        function loadSampleMEICData() {
            // Track sample MEIC data load attempt
            if (window.appInsights) {
                window.appInsights.trackEvent('frontend_sample_meic_data_load_attempted');
            }
            
            showAlert('Loading sample MEIC data...', 'info');
            
            fetch('/api/load-sample-meic-data', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Track successful sample MEIC data load
                    if (window.appInsights) {
                        window.appInsights.trackEvent('frontend_sample_meic_data_load_success', {
                            tradesCount: data.data.trades_count,
                            strategiesCount: data.data.strategies_count
                        });
                    }
                    
                    const displayName = data.data.friendly_name || 'Example MEIC Portfolio';
                    showAlert(`Success! Loaded ${data.data.trades_count} trades from ${data.data.strategies_count} strategies as "${displayName}"`, 'success');
                    
                    // Update filename display
                    updateFilenameDisplay(data.data.filename || 'Example-Portfolio-MEIC.csv');
                    
                    // Clear all application state before loading new data
                    clearAllAppState();
                    
                    // Load the new data
                    loadPortfolioData();
                    
                    // Hide the "No MEIC Trades Detected" message
                    const meicNoTradesMessage = document.getElementById('meicNoTradesMessage');
                    if (meicNoTradesMessage) {
                        meicNoTradesMessage.style.display = 'none';
                    }
                    
                    // Initialize MEIC analysis after a short delay to ensure data is loaded
                    setTimeout(() => {
                        console.log('🔄 Initializing MEIC analysis after sample data load...');
                        checkMEICTrades();
                        loadMEICOverview();
                    }, 1000);
                } else {
                    // Track sample MEIC data load failure
                    if (window.appInsights) {
                        window.appInsights.trackEvent('frontend_sample_meic_data_load_failed', {
                            error: data.error
                        });
                    }
                    showAlert(`Failed to load sample MEIC data: ${data.error}`, 'danger');
                }
            })
            .catch(error => {
                // Track sample MEIC data load error
                if (window.appInsights) {
                    window.appInsights.trackEvent('frontend_sample_meic_data_load_error', {
                        error: error.message
                    });
                }
                showAlert(`Error loading sample MEIC data: ${error.message}`, 'danger');
            });
        }
        

        // Saved files functionality
        function setupSavedFiles() {
            console.log('setupSavedFiles() called');
            loadSavedFilesList();
            console.log('setupSavedFiles() completed');
            
            const savedFilesSelect = document.getElementById('savedFilesSelect');
            const loadFileBtn = document.getElementById('loadFileBtn');
            const editNameBtn = document.getElementById('editNameBtn');
            const deleteFileBtn = document.getElementById('deleteFileBtn');
            
            // Enable/disable buttons based on selection
            savedFilesSelect.addEventListener('change', function() {
                const hasSelection = !!this.value;
                loadFileBtn.disabled = !hasSelection;
                editNameBtn.disabled = !hasSelection;
                deleteFileBtn.disabled = !hasSelection;
            });
            
            // Handle load file button click
            loadFileBtn.addEventListener('click', function() {
                const selectedFile = savedFilesSelect.value;
                if (selectedFile) {
                    loadSavedFile(selectedFile);
                }
            });
            
            // Handle edit name button click
            editNameBtn.addEventListener('click', function() {
                const selectedFile = savedFilesSelect.value;
                const selectedOption = savedFilesSelect.options[savedFilesSelect.selectedIndex];
                
                if (selectedFile && selectedOption) {
                    // Get current friendly name from the displayed text
                    const currentText = selectedOption.textContent;
                    const currentName = currentText.split(' (')[0]; // Remove date part
                    
                    const newName = prompt('Enter new friendly name:', currentName);
                    if (newName && newName.trim() && newName.trim() !== currentName) {
                        updateFriendlyName(selectedFile, newName.trim());
                    }
                }
            });
            
            // Handle delete file button click
            deleteFileBtn.addEventListener('click', function() {
                const selectedFile = savedFilesSelect.value;
                const selectedOption = savedFilesSelect.options[savedFilesSelect.selectedIndex];
                
                if (selectedFile && selectedOption) {
                    const fileName = selectedOption.textContent.split(' (')[0]; // Remove date part
                    
                    if (confirm(`Are you sure you want to delete "${fileName}"?\n\nThis action cannot be undone.`)) {
                        deleteFile(selectedFile);
                    }
                }
            });
            
            // Handle cleanup files button click
            const cleanupFilesBtn = document.getElementById('cleanupFilesBtn');
            cleanupFilesBtn.addEventListener('click', function() {
                if (confirm('This will delete duplicate files, keeping only the most recent version of each dataset. Continue?')) {
                    cleanupDuplicateFiles();
                }
            });
        }
        
        function loadSavedFilesList() {
            console.log('loadSavedFilesList() called');
            console.log('Fetching /api/saved-files...');
            
            fetch('/api/saved-files')
            .then(response => {
                console.log('Response received:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('Data received:', data);
                const select = document.getElementById('savedFilesSelect');
                select.innerHTML = '<option value="">Select a file...</option>';
                
                if (data.success && data.data.length > 0) {
                    data.data.forEach(file => {
                        const option = document.createElement('option');
                        option.value = file.filename;
                        option.textContent = `${file.friendly_name} (${file.upload_date})`;
                        option.setAttribute('data-friendly-name', file.friendly_name);
                        select.appendChild(option);
                    });
                } else {
                    select.innerHTML = '<option value="">No saved files found</option>';
                }
                console.log('loadSavedFilesList() completed');
            })
            .catch(error => {
                console.error('Error loading saved files:', error);
                document.getElementById('savedFilesSelect').innerHTML = '<option value="">Error loading files</option>';
            });
        }
        
        function loadSavedFile(filename) {
            const statusDiv = document.getElementById('savedFileStatus');
            statusDiv.innerHTML = '<small class="text-info">Loading file...</small>';
            
            fetch(`/api/load-file/${encodeURIComponent(filename)}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    statusDiv.innerHTML = `<small class="text-success">✅ ${data.message}</small>`;
                    
                    // Show warning if file exceeds recommended trade limit
                    if (data.warning) {
                        console.log('DEBUG: Showing warning alert for saved file:', data.warning);
                        showAlert(data.warning, 'warning');
                    } else {
                        console.log('DEBUG: No warning in saved file response data');
                    }
                    
                    // Update filename display
                    updateFilenameDisplay(filename);
                    
                    // Clear chart first to prevent race conditions
                    document.getElementById('chartContainer').innerHTML = 
                        '<div class="text-center text-muted"><h4>📊 Data loaded! Select a chart to view analytics</h4></div>';
                    
                    // Set flag to prevent auto-loading cumulative P&L
                    window.skipAutoLoadCumulativePnl = true;
                    
                    // Clear all application state before loading new data
                    clearAllAppState();
                    
                    // Refresh all data displays
                    loadDataStats();
                    loadPortfolioData();
                    loadFilesOverview();
                    
                    // When loading a saved file, prefill initial capital if present
                    if (data.data.initial_capital) {
                        window.lastInitialCapital = data.data.initial_capital;
                        document.getElementById('initialCapitalInput').value = data.data.initial_capital;
                    }

                    // Reset the flag after a delay
                    setTimeout(() => {
                        window.skipAutoLoadCumulativePnl = false;
                        statusDiv.innerHTML = '';
                    }, 3000);
                } else {
                    statusDiv.innerHTML = `<small class="text-danger">❌ ${data.error}</small>`;
                }
            })
            .catch(error => {
                console.error('Error loading file:', error);
                statusDiv.innerHTML = '<small class="text-danger">❌ Error loading file</small>';
            });
        }
        
        function updateFriendlyName(filename, newFriendlyName) {
            const statusDiv = document.getElementById('savedFileStatus');
            statusDiv.innerHTML = '<small class="text-info">Updating name...</small>';
            
            fetch('/api/update-friendly-name', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    filename: filename,
                    friendly_name: newFriendlyName
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    statusDiv.innerHTML = `<small class="text-success">✅ ${data.message}</small>`;
                    loadSavedFilesList(); // Refresh the list to show new name
                    loadFilesOverview(); // Refresh the files overview table
                    
                    setTimeout(() => {
                        statusDiv.innerHTML = '';
                    }, 3000);
                } else {
                    statusDiv.innerHTML = `<small class="text-danger">❌ ${data.error}</small>`;
                }
            })
            .catch(error => {
                console.error('Error updating friendly name:', error);
                statusDiv.innerHTML = '<small class="text-danger">❌ Error updating name</small>';
            });
        }
        
        function deleteFile(filename) {
            const statusDiv = document.getElementById('savedFileStatus');
            statusDiv.innerHTML = '<small class="text-info">Deleting file...</small>';
            
            fetch('/api/delete-file', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    filename: filename
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    statusDiv.innerHTML = `<small class="text-success">✅ ${data.message}</small>`;
                    
                    // Refresh the saved files list
                    loadSavedFilesList();
                    loadFilesOverview(); // Refresh the files overview table
                    
                    // Clear the chart and stats if the deleted file was currently loaded
                    document.getElementById('chartContainer').innerHTML = 
                        '<div class="text-center text-muted"><h4>📊 Upload or select a file to view analytics</h4></div>';
                    
                    setTimeout(() => {
                        statusDiv.innerHTML = '';
                    }, 3000);
                } else {
                    statusDiv.innerHTML = `<small class="text-danger">❌ ${data.error}</small>`;
                }
            })
            .catch(error => {
                console.error('Error deleting file:', error);
                statusDiv.innerHTML = '<small class="text-danger">❌ Error deleting file</small>';
            });
        }
        
        function cleanupDuplicateFiles() {
            const statusDiv = document.getElementById('savedFileStatus');
            statusDiv.innerHTML = '<small class="text-info">🧹 Cleaning up duplicate files...</small>';
            
            fetch('/api/cleanup-files', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    if (data.deleted_count > 0) {
                        statusDiv.innerHTML = `<small class="text-success">✅ ${data.message}</small>`;
                        
                        // Show details of deleted files if any
                        if (data.deleted_files && data.deleted_files.length > 0) {
                            const fileList = data.deleted_files.join(', ');
                            statusDiv.innerHTML += `<br><small class="text-muted">Deleted: ${fileList}</small>`;
                        }
                        
                        // Refresh saved files list
                        loadSavedFilesList();
                    } else {
                        statusDiv.innerHTML = '<small class="text-info">ℹ️ No duplicate files found to clean up</small>';
                    }
                    
                    setTimeout(() => {
                        statusDiv.innerHTML = '';
                    }, 5000);
                } else {
                    statusDiv.innerHTML = `<small class="text-danger">❌ ${data.error}</small>`;
                }
            })
            .catch(error => {
                console.error('Error during cleanup:', error);
                statusDiv.innerHTML = '<small class="text-danger">❌ Error during cleanup</small>';
            });
        }

        function loadDataStats() {
            fetch('/api/data/stats')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const stats = data.data;
                    document.getElementById('dataStats').textContent = 
                        `${stats.trade_count} trades | ${stats.strategy_count} strategies`;
                }
            });
        }

        // Files overview sorting variables
        let filesOverviewSortKey = 'upload_date';
        let filesOverviewSortAsc = false;
        let filesOverviewData = [];

        function loadFilesOverview() {
            const container = document.getElementById('chartContainer');
            container.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin"></i> Loading files overview...</div>';
            
            // Always fetch fresh data from API to ensure we have the latest calculations
            // Add cache-busting parameter to force fresh data
            fetch('/api/files/overview?' + new Date().getTime(), {
                method: 'GET',
                cache: 'no-cache',
                headers: {
                    'Cache-Control': 'no-cache',
                    'Pragma': 'no-cache'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    filesOverviewData = data.data;
                    renderFilesOverviewInContainer(filesOverviewData);
                } else {
                    console.error('Failed to load files overview:', data.error);
                    container.innerHTML = '<div class="text-center text-danger">Error loading files overview: ' + data.error + '</div>';
                }
            })
            .catch(error => {
                console.error('Error loading files overview:', error);
                container.innerHTML = '<div class="text-center text-danger">Error loading files overview</div>';
            });
        }

        function renderFilesOverviewInContainer(files) {
            const container = document.getElementById('chartContainer');
            
            if (!files || files.length === 0) {
                container.innerHTML = '<div class="text-center text-muted"><h4>📁 No uploaded files found</h4><p>Upload some CSV files to see them here.</p></div>';
                return;
            }

            // Sort files based on current sort settings
            const sortedFiles = [...files].sort((a, b) => {
                let aVal = a[filesOverviewSortKey];
                let bVal = b[filesOverviewSortKey];
                
                // Handle date sorting
                if (filesOverviewSortKey === 'start_date' || filesOverviewSortKey === 'upload_date') {
                    aVal = new Date(aVal);
                    bVal = new Date(bVal);
                }
                
                // Handle numeric sorting
                if (filesOverviewSortKey === 'total_pnl' || filesOverviewSortKey === 'total_trades' || 
                    filesOverviewSortKey === 'strategy_count' || filesOverviewSortKey === 'initial_capital' || 
                    filesOverviewSortKey === 'ending_capital' || filesOverviewSortKey === 'cagr' || 
                    filesOverviewSortKey === 'max_drawdown') {
                    // For max_drawdown, use the percentage value for sorting
                    if (filesOverviewSortKey === 'max_drawdown') {
                        aVal = parseFloat(a.max_drawdown_pct) || 0;
                        bVal = parseFloat(b.max_drawdown_pct) || 0;
                    } else {
                        aVal = parseFloat(aVal) || 0;
                        bVal = parseFloat(bVal) || 0;
                    }
                }
                
                if (aVal < bVal) return filesOverviewSortAsc ? -1 : 1;
                if (aVal > bVal) return filesOverviewSortAsc ? 1 : -1;
                return 0;
            });

            let tableHTML = `
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h4 class="mb-0">
                            <i class="fas fa-folder-open"></i>
                            Uploaded Files Overview
                        </h4>
                        <div class="d-flex gap-2 align-items-center">
                            <button class="btn btn-sm btn-outline-primary" onclick="selectAllFilesOverview()">
                                <i class="fas fa-check-square"></i> Select All
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="deselectAllFilesOverview()">
                                <i class="fas fa-square"></i> Deselect All
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteSelectedFiles()" id="bulkDeleteBtn" disabled>
                                <i class="fas fa-trash"></i> Move to Recycle (<span id="selectedCount">0</span>)
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th width="50">
                                            <input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll()">
                                        </th>
                                        <th style="cursor:pointer;" onclick="sortFilesOverview('friendly_name')">File Name <span id="sort-indicator-friendly_name"></span></th>
                                        <th style="cursor:pointer;" onclick="sortFilesOverview('data_type')">Data Type <span id="sort-indicator-data_type"></span></th>
                                        <th style="cursor:pointer;" onclick="sortFilesOverview('start_date')">Date Range <span id="sort-indicator-start_date"></span></th>
                                        <th style="cursor:pointer;" onclick="sortFilesOverview('total_pnl')">Total P&L <span id="sort-indicator-total_pnl"></span></th>
                                        <th style="cursor:pointer;" onclick="sortFilesOverview('total_trades')">Total Trades <span id="sort-indicator-total_trades"></span></th>
                                        <th style="cursor:pointer;" onclick="sortFilesOverview('strategy_count')">Strategies <span id="sort-indicator-strategy_count"></span></th>
                                        <th style="cursor:pointer;" onclick="sortFilesOverview('initial_capital')">Starting Capital <span id="sort-indicator-initial_capital"></span></th>
                                        <th style="cursor:pointer;" onclick="sortFilesOverview('ending_capital')">Ending Capital <span id="sort-indicator-ending_capital"></span></th>
                                        <th style="cursor:pointer;" onclick="sortFilesOverview('cagr')">CAGR <span id="sort-indicator-cagr"></span></th>
                                        <th style="cursor:pointer;" onclick="sortFilesOverview('max_drawdown')">Max Drawdown <span id="sort-indicator-max_drawdown"></span></th>
                                        <th style="cursor:pointer;" onclick="sortFilesOverview('upload_date')">Upload Date <span id="sort-indicator-upload_date"></span></th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
            `;

            sortedFiles.forEach(file => {
                const pnlClass = file.total_pnl >= 0 ? 'text-success' : 'text-danger';
                const cagrClass = file.cagr >= 0 ? 'text-success' : 'text-danger';
                const drawdownClass = file.max_drawdown <= 0 ? 'text-success' : 'text-danger';
                
                tableHTML += `
                    <tr>
                        <td>
                            <input type="checkbox" class="file-checkbox" value="${file.filename}" onchange="updateBulkDeleteButton()">
                        </td>
                        <td><strong>${file.friendly_name}</strong></td>
                        <td><span class="badge bg-info">${file.data_type}</span></td>
                        <td>${file.start_date} to ${file.end_date}</td>
                        <td class="${pnlClass}">$${file.total_pnl.toLocaleString()}</td>
                        <td>${file.total_trades.toLocaleString()}</td>
                        <td>${file.strategy_count}</td>
                        <td>$${file.initial_capital.toLocaleString()}</td>
                        <td>$${file.ending_capital.toLocaleString()}</td>
                        <td class="${cagrClass}">${file.cagr.toFixed(2)}%</td>
                        <td class="${drawdownClass}">${file.max_drawdown_pct.toFixed(2)}%</td>
                        <td>${new Date(file.upload_date).toLocaleDateString()}</td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="loadFileFromTable('${file.filename}')" title="Load this file">
                                <i class="fas fa-play"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteFileFromTable('${file.filename}', '${file.friendly_name}')" title="Move to recycle">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });

            tableHTML += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;

            container.innerHTML = tableHTML;
            updateFilesOverviewSortIndicators();
        }

        function renderFilesOverviewTable(files) {
            const tbody = document.getElementById('filesOverviewTableBody');
            
            if (!files || files.length === 0) {
                tbody.innerHTML = '<tr><td colspan="12" class="text-center text-muted">No files uploaded yet</td></tr>';
                return;
            }
            
            // Sort the data
            const sorted = [...files].sort((a, b) => {
                let valA, valB;
                
                if (filesOverviewSortKey === 'friendly_name' || filesOverviewSortKey === 'data_type') {
                    valA = (a[filesOverviewSortKey] || '').toLowerCase();
                    valB = (b[filesOverviewSortKey] || '').toLowerCase();
                } else if (filesOverviewSortKey === 'start_date') {
                    // Sort by start date (convert to Date objects for comparison)
                    valA = a.start_date !== 'N/A' ? new Date(a.start_date) : new Date(0);
                    valB = b.start_date !== 'N/A' ? new Date(b.start_date) : new Date(0);
                } else if (filesOverviewSortKey === 'upload_date') {
                    // Sort by upload date
                    valA = new Date(a.upload_date);
                    valB = new Date(b.upload_date);
                } else {
                    // Numeric fields
                    valA = Number(a[filesOverviewSortKey]) || 0;
                    valB = Number(b[filesOverviewSortKey]) || 0;
                }
                
                if (valA < valB) return filesOverviewSortAsc ? -1 : 1;
                if (valA > valB) return filesOverviewSortAsc ? 1 : -1;
                return 0;
            });
            
            tbody.innerHTML = sorted.map(file => `
                <tr class="file-row" data-filename="${file.filename}">
                    <td>
                        <strong>${file.friendly_name}</strong>
                        <br><small class="text-muted">${file.filename}</small>
                    </td>
                    <td>
                        <span class="badge ${file.data_type === 'Live Data' ? 'bg-success' : 'bg-info'}">
                            ${file.data_type}
                        </span>
                    </td>
                    <td style="min-width: 200px;">
                        ${file.start_date !== 'N/A' && file.end_date !== 'N/A' 
                            ? `<div class="text-nowrap">${new Date(file.start_date).toLocaleDateString('en-GB', {weekday: 'short', day: '2-digit', month: 'short', year: 'numeric'})}</div><div class="text-muted small">to</div><div class="text-nowrap">${new Date(file.end_date).toLocaleDateString('en-GB', {weekday: 'short', day: '2-digit', month: 'short', year: 'numeric'})}</div>`
                            : 'N/A'
                        }
                    </td>
                    <td class="${file.total_pnl >= 0 ? 'text-success' : 'text-danger'}">
                        $${file.total_pnl.toLocaleString()}
                    </td>
                    <td>${file.total_trades.toLocaleString()}</td>
                    <td>${file.strategy_count}</td>
                    <td>${file.initial_capital ? '$' + file.initial_capital.toLocaleString() : 'N/A'}</td>
                    <td class="${file.ending_capital >= 0 ? 'text-success' : 'text-danger'}">
                        $${file.ending_capital.toLocaleString()}
                    </td>
                    <td class="${file.cagr >= 0 ? 'text-success' : 'text-danger'}">
                        ${file.cagr}%
                    </td>
                    <td>
                        <div class="text-danger">$${file.max_drawdown.toLocaleString()}</div>
                        <small class="text-muted">${file.max_drawdown_pct}%</small>
                    </td>
                    <td>
                        <small class="text-muted">${new Date(file.upload_date).toLocaleDateString()}</small>
                    </td>
                    <td>
                        <div class="d-flex gap-1">
                            <button class="btn btn-primary btn-sm" onclick="loadFileFromTable('${file.filename}'); event.stopPropagation();" title="Load this file">
                                <i class="fas fa-play"></i> Load
                            </button>
                            <button class="btn btn-outline-danger btn-sm" onclick="deleteFileFromTable('${file.filename}', '${file.friendly_name}'); event.stopPropagation();" title="Delete this file">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
            
            // Update sort indicators
            updateFilesOverviewSortIndicators();
        }
        
        function sortFilesOverview(key) {
            if (filesOverviewSortKey === key) {
                filesOverviewSortAsc = !filesOverviewSortAsc;
            } else {
                filesOverviewSortKey = key;
                filesOverviewSortAsc = key === 'friendly_name' || key === 'data_type' || key === 'start_date' || key === 'upload_date'; // default asc for text/dates, desc for numbers
            }
            // Check if we're in the chart container or the main page
            if (document.getElementById('chartContainer').innerHTML.includes('Uploaded Files Overview')) {
                renderFilesOverviewInContainer(filesOverviewData);
            } else {
            renderFilesOverviewTable(filesOverviewData);
            }
        }
        
        function updateFilesOverviewSortIndicators() {
            const keys = ['friendly_name', 'data_type', 'start_date', 'total_pnl', 'total_trades', 'strategy_count', 'initial_capital', 'ending_capital', 'cagr', 'max_drawdown', 'upload_date'];
            for (const key of keys) {
                const indicator = document.getElementById('sort-indicator-' + key);
                if (indicator) {
                    if (key === filesOverviewSortKey) {
                        indicator.textContent = filesOverviewSortAsc ? '▲' : '▼';
                    } else {
                        indicator.textContent = '';
                    }
                }
            }
        }

        // Multi-select functionality for file deletion
        function selectAllFilesOverview() {
            const checkboxes = document.querySelectorAll('.file-checkbox');
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = true;
            });
            selectAllCheckbox.checked = true;
            updateBulkDeleteButton();
        }

        function deselectAllFilesOverview() {
            const checkboxes = document.querySelectorAll('.file-checkbox');
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
            });
            selectAllCheckbox.checked = false;
            updateBulkDeleteButton();
        }

        function toggleSelectAll() {
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            const checkboxes = document.querySelectorAll('.file-checkbox');
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAllCheckbox.checked;
            });
            updateBulkDeleteButton();
        }

        function updateBulkDeleteButton() {
            const checkboxes = document.querySelectorAll('.file-checkbox:checked');
            const bulkDeleteBtn = document.getElementById('bulkDeleteBtn');
            const selectedCount = document.getElementById('selectedCount');
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            
            const count = checkboxes.length;
            selectedCount.textContent = count;
            
            if (count > 0) {
                bulkDeleteBtn.disabled = false;
            } else {
                bulkDeleteBtn.disabled = true;
            }
            
            // Update select all checkbox state
            const allCheckboxes = document.querySelectorAll('.file-checkbox');
            if (allCheckboxes.length === 0) {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = false;
            } else if (count === allCheckboxes.length) {
                selectAllCheckbox.checked = true;
                selectAllCheckbox.indeterminate = false;
            } else if (count > 0) {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = true;
            } else {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = false;
            }
        }

        function deleteSelectedFiles() {
            const checkboxes = document.querySelectorAll('.file-checkbox:checked');
            const selectedFiles = Array.from(checkboxes).map(cb => {
                const row = cb.closest('tr');
                const filename = cb.value;
                const friendlyName = row.querySelector('td:nth-child(2)').textContent.trim();
                return { filename, friendlyName };
            });
            
            if (selectedFiles.length === 0) {
                alert('No files selected for deletion.');
                return;
            }
            
            const fileList = selectedFiles.map(f => `"${f.friendlyName}"`).join(', ');
            const confirmMessage = `Are you sure you want to move ${selectedFiles.length} file(s) to recycle?\n\nFiles to move:\n${fileList}\n\nFiles will be zipped and moved to the recycle folder.`;
            
            if (confirm(confirmMessage)) {
                const statusDiv = document.getElementById('savedFileStatus');
                statusDiv.innerHTML = '<small class="text-info">Deleting files...</small>';
                
                // Delete files one by one
                let completed = 0;
                let errors = [];
                
                selectedFiles.forEach((file, index) => {
                    fetch('/api/delete-file', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            filename: file.filename
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        completed++;
                        if (!data.success) {
                            errors.push(`${file.friendlyName}: ${data.error}`);
                        }
                        
                        if (completed === selectedFiles.length) {
                            if (errors.length === 0) {
                                statusDiv.innerHTML = `<small class="text-success">✅ Successfully moved ${selectedFiles.length} file(s) to recycle</small>`;
                                
                                // Refresh the files overview
                                loadFilesOverview();
                                
                                // Refresh other displays
                                loadSavedFilesList();
                                loadFilesOverview();
                            } else {
                                statusDiv.innerHTML = `<small class="text-warning">⚠️ Moved ${completed - errors.length} file(s) to recycle, ${errors.length} failed: ${errors.join(', ')}</small>`;
                            }
                            
                            setTimeout(() => {
                                statusDiv.innerHTML = '';
                            }, 5000);
                        }
                    })
                    .catch(error => {
                        completed++;
                        errors.push(`${file.friendlyName}: Network error`);
                        
                        if (completed === selectedFiles.length) {
                            statusDiv.innerHTML = `<small class="text-danger">❌ Error moving files to recycle: ${errors.join(', ')}</small>`;
                            setTimeout(() => {
                                statusDiv.innerHTML = '';
                            }, 5000);
                        }
                    });
                });
            }
        }

        function loadFileFromTable(filename) {
            const statusDiv = document.getElementById('savedFileStatus');
            statusDiv.innerHTML = '<small class="text-info">Loading file...</small>';
            
            // Clear all application state before loading new data
            clearAllAppState();
            
            fetch(`/api/load-file/${encodeURIComponent(filename)}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    statusDiv.innerHTML = `<small class="text-success">✅ ${data.message}</small>`;
                    
                    // Update filename display
                    updateFilenameDisplay(filename);
                    
                    // Refresh all data displays
                    loadDataStats();
                    loadPortfolioData();
                    
                    // Clear chart
                    document.getElementById('chartContainer').innerHTML = 
                        '<div class="text-center text-muted"><h4>📊 Data loaded! Select a chart to view analytics</h4></div>';
                    
                    // When loading a saved file, prefill initial capital if present
                    if (data.data.initial_capital) {
                        window.lastInitialCapital = data.data.initial_capital;
                        document.getElementById('initialCapitalInput').value = data.data.initial_capital;
                    }

                    setTimeout(() => {
                        statusDiv.innerHTML = '';
                    }, 3000);
                } else {
                    statusDiv.innerHTML = `<small class="text-danger">❌ ${data.error}</small>`;
                }
            })
            .catch(error => {
                console.error('Error loading file:', error);
                statusDiv.innerHTML = '<small class="text-danger">❌ Error loading file</small>';
            });
        }

        function deleteFileFromTable(filename, friendlyName) {
            if (confirm(`Are you sure you want to delete "${friendlyName}"?\n\nThis action cannot be undone.`)) {
                const statusDiv = document.getElementById('savedFileStatus');
                statusDiv.innerHTML = '<small class="text-info">Deleting file...</small>';
                
                fetch('/api/delete-file', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        filename: filename
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        statusDiv.innerHTML = `<small class="text-success">✅ ${data.message}</small>`;
                        
                        // Refresh the saved files list and overview table
                        loadSavedFilesList();
                        loadFilesOverview();
                        
                        // Clear the chart and stats if the deleted file was currently loaded
                        document.getElementById('chartContainer').innerHTML = 
                            '<div class="text-center text-muted"><h4>📊 Upload or select a file to view analytics</h4></div>';
                        
                        setTimeout(() => {
                            statusDiv.innerHTML = '';
                        }, 3000);
                    } else {
                        statusDiv.innerHTML = `<small class="text-danger">❌ ${data.error}</small>`;
                    }
                })
                .catch(error => {
                    console.error('Error deleting file:', error);
                    statusDiv.innerHTML = '<small class="text-danger">❌ Error deleting file</small>';
                });
            }
        }

        function updateFilenameDisplay(filename) {
            const filenameElement = document.getElementById('csvFilename');
            const currentFilenameElement = document.getElementById('currentFilename');
            
            if (filename && filename.trim()) {
                // Show the filename display
                filenameElement.style.display = 'flex';
                // Set the filename text (truncate if too long)
                const displayName = filename.length > 120 ? filename.substring(0, 117) + '...' : filename;
                currentFilenameElement.textContent = displayName;
                currentFilenameElement.title = filename; // Full filename on hover
            } else {
                // Hide the filename display
                filenameElement.style.display = 'none';
            }
        }

        function loadCurrentFilename() {
            fetch('/api/data/stats')
            .then(response => response.json())
            .then(data => {
                if (data.success && data.data.filename) {
                    updateFilenameDisplay(data.data.filename);
                }
            })
            .catch(error => {
                console.error('Error loading current filename:', error);
            });
        }

        function loadAvailableCharts() {
            console.log('🔄 Loading available charts from API...');
            fetch('/api/charts/available')
            .then(response => {
                console.log('📊 Charts API response status:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('📊 Charts API data received:', data);
                try {
                    if (data.success) {
                        availableCharts = data.data;
                        console.log('✅ Available charts loaded:', Object.keys(availableCharts));
                    
                    // Ensure pnl_by_month is included (fallback for server restart issues)
                    if (!availableCharts['pnl_by_month']) {
                        console.log('Adding missing pnl_by_month chart to available charts');
                        availableCharts['pnl_by_month'] = 'P&L by month table';
                    }
                    
                    if (!availableCharts['commission_analysis']) {
                        console.log('Adding missing commission_analysis chart to available charts');
                        availableCharts['commission_analysis'] = 'Commission analysis';
                    }
                    
                    // Ensure conflicting_legs is available 
                    if (!availableCharts.conflicting_legs) {
                        availableCharts['conflicting_legs'] = 'Conflicting leg analysis';
                    }
                    
                    // Ensure cross_file_correlation is available
                    if (!availableCharts.cross_file_correlation) {
                        availableCharts['cross_file_correlation'] = 'Analyze strategies across multiple uploaded files';
                    }
                    
                    // Ensure blackout_dates is available
                    if (!availableCharts.blackout_dates) {
                        availableCharts['blackout_dates'] = 'Blackout dates analysis';
                    }
                    
                    // Ensure price_movement is available
                    if (!availableCharts.price_movement) {
                        availableCharts['price_movement'] = 'Price movement analysis';
                    }
                    
                    // Add separator to availableCharts for rendering (but it won't be clickable)
                    availableCharts['separator'] = '--- Cross-File Analysis ---';
                    
                    // Ensure files_overview is available
                    if (!availableCharts.files_overview) {
                        availableCharts['files_overview'] = 'Uploaded files overview and management';
                    }
                    
                        console.log('🎯 Final available charts:', Object.keys(availableCharts));
                        renderChartButtons();
                        console.log('✅ Chart buttons rendered successfully v2');
                        chartsLoadedSuccessfully = true;
                        console.log('🔧 FLAG SET v2 - chartsLoadedSuccessfully now:', chartsLoadedSuccessfully);
                    } else {
                        console.error('Failed to load charts:', data.error);
                        const container = document.getElementById('chartButtons');
                        container.innerHTML = `<p class="text-danger">Error loading charts: ${data.error}</p>`;
                    }
                } catch (error) {
                    console.error('❌ Error in loadAvailableCharts data processing:', error);
                    console.error('Error stack:', error.stack);
                    throw error; // Re-throw to trigger .catch()
                }
            })
            .catch(error => {
                console.error('❌ Error loading charts:', error);
                if (!chartsLoadedSuccessfully) {
                    console.log('🔄 CATCH FALLBACK v2 - Falling back to forceRenderChartButtons');
                    forceRenderChartButtons();
                } else {
                    console.log('✅ CATCH FALLBACK v2 - Charts already loaded successfully, skipping fallback');
                }
            });
        }



        function forceRenderChartButtons() {
            console.log('Force rendering chart buttons...');
            availableCharts = {
                'overview': 'Strategy performance overview and portfolio analysis',
                'cumulative_pnl': 'Cumulative profit and loss over time',
                'daily_pnl': 'Daily profit and loss analysis',
                'monthly_pnl_stacked': 'Monthly P&L breakdown by strategy',
                'pnl_by_day_of_week': 'P&L by day of week table',
                'pnl_by_month': 'P&L by month table',
                'commission_analysis': 'Commission analysis',
                'conflicting_legs': 'Conflicting leg analysis',
                'drawdown': 'Portfolio drawdown analysis',
                'portfolio_balance': 'Portfolio allocation by strategy',
                'strategy_detail': 'Detailed trade analysis by strategy',
                'win_rates_table': 'Win rate statistics table',
                'risk_return': 'Risk vs return scatter plot',
                'strategy_correlation': 'Strategy correlation heatmap',
                'margin_analysis': 'Margin requirements analysis',
                'daily_margin_analysis': 'Daily margin usage analysis',
                'monte_carlo': 'Monte Carlo simulation analysis',
                'mfe_mae': 'MFE/MAE Analysis',
                'blackout_dates': 'Blackout dates analysis',
                'price_movement': 'Price movement analysis',
                'live_vs_bt': 'Live vs Backtest comparison',
                'cross_file_correlation': 'Analyze strategies across multiple uploaded files'
            };
            renderChartButtons();
        }

        function renderChartButtons() {
            console.log('🔧 renderChartButtons() starting...');
            try {
                const container = document.getElementById('chartButtons');
                if (!container) {
                    console.error('❌ chartButtons container not found!');
                    return;
                }
                container.innerHTML = '';

                if (!availableCharts || Object.keys(availableCharts).length === 0) {
                // Fallback chart list - using array to preserve order
                const fallbackChartsArray = [
                    ['overview', 'Strategy performance overview and portfolio analysis'],
                    ['cumulative_pnl', 'Cumulative profit and loss over time'],
                    ['daily_pnl', 'Daily profit and loss analysis'],
                    ['monthly_pnl_stacked', 'Monthly P&L breakdown by strategy'],
                    ['pnl_by_day_of_week', 'P&L by day of week table'],
                    ['pnl_by_month', 'P&L by month table'],
                    ['commission_analysis', 'Commission analysis'],
                    ['conflicting_legs', 'Conflicting leg analysis'],
                    ['drawdown', 'Portfolio drawdown analysis'],
                    ['portfolio_balance', 'Portfolio allocation by strategy'],
                    ['strategy_detail', 'Detailed trade analysis by strategy'],
                    ['win_rates_table', 'Win rate statistics table'],
                    ['risk_return', 'Risk vs return scatter plot'],
                    ['strategy_correlation', 'Strategy correlation heatmap'],
                    ['margin_analysis', 'Margin requirements analysis'],
                    ['daily_margin_analysis', 'Daily margin usage analysis'],
                    ['monte_carlo', 'Monte Carlo simulation analysis'],
                    ['mfe_mae', 'MFE/MAE Analysis'],
                    ['blackout_dates', 'Blackout dates analysis'],
                    ['price_movement', 'Price movement analysis'],
                    ['meic_analysis', 'MEIC (Multiple Entry Iron Condor) analysis'],
                    ['separator', '--- Cross-File Analysis ---'],
                    ['live_vs_bt', 'Live vs Backtest comparison'],
                    ['cross_file_correlation', 'Analyze strategies across multiple uploaded files'],
                    ['files_overview', 'Uploaded files overview and management']
                ];
                
                // Convert array to object for compatibility, but exclude separator
                availableCharts = Object.fromEntries(fallbackChartsArray.filter(([key, value]) => key !== 'separator'));
            }

            // Define the desired order for charts
            const chartOrder = [
                'overview',
                'cumulative_pnl',
                'daily_pnl',
                'monthly_pnl_stacked',
                'pnl_by_day_of_week',
                'pnl_by_month',
                'commission_analysis',
                'conflicting_legs',
                'drawdown',
                'portfolio_balance',
                'strategy_detail',
                'win_rates_table',
                'risk_return',
                'strategy_correlation',
                'margin_analysis',
                'daily_margin_analysis',
                'monte_carlo',
                'mfe_mae',
                'blackout_dates',
                'price_movement',
                'meic_analysis',
                'separator',
                'live_vs_bt',
                'cross_file_correlation',
                'files_overview'
            ];

                // Debug: Check if conflicting_legs is in chartOrder
                console.log('🔧 conflicting_legs in chartOrder:', chartOrder.includes('conflicting_legs'));
                console.log('🔧 conflicting_legs in availableCharts:', !!availableCharts['conflicting_legs']);
                console.log('🔧 formatChartName test for conflicting_legs:', formatChartName('conflicting_legs'));

                // Render buttons in the specified order
                for (const chartType of chartOrder) {
                    if (availableCharts[chartType]) {
                        if (chartType === 'separator') {
                            // Create a visual separator that breaks out of the grid
                            const separator = document.createElement('div');
                            separator.className = 'w-100';
                            separator.innerHTML = `
                                <div class="border-top pt-4 mt-4 mb-3">
                                    <div class="text-center">
                                        <span class="badge bg-secondary fs-6 px-3 py-2">Cross-File Analysis</span>
                                    </div>
                                </div>
                            `;
                            container.appendChild(separator);
                        } else {
                        const button = document.createElement('button');
                        button.className = 'btn btn-outline-primary btn-chart';
                        button.textContent = formatChartName(chartType);
                        button.title = availableCharts[chartType];
                            // Fix closure issue by capturing chartType in a local variable
                            const currentChartType = chartType;
                            button.onclick = () => {
                                console.log('Button clicked for chart type:', currentChartType);
                                loadChart(currentChartType);
                            };
                        container.appendChild(button);
                        }
                    }
                }
            
                // Debug: Log what buttons were actually created
                console.log(`✅ Rendered ${container.children.length} chart buttons:`, 
                    Array.from(container.children).map(btn => btn.textContent));
            } catch (error) {
                console.error('❌ Error in renderChartButtons():', error);
                console.error('Error stack:', error.stack);
            }
        }

        function formatChartName(chartType) {
            const chartNames = {
                'overview': '📊 Overview',
                'cumulative_pnl': '📈 Cumulative P&L',
                'monthly_pnl': '📅 Monthly P&L',
                'monthly_pnl_stacked': '📊 Monthly Stacked',
                'daily_pnl': '📆 Daily P&L',
                'strategy_performance': '📈 Strategy Performance',
                'strategy_correlation': '🔗 Strategy Correlation',
                'risk_return': '📊 Risk vs Return',
                'drawdown': '📉 Drawdown',
                'portfolio_balance': '🥧 Portfolio Balance',
                'win_rate': '🎯 Win Rate',
                'win_rates_table': '📊 Win Rates Table',
                'monte_carlo': '🎲 Monte Carlo',
                'mfe_mae': '📈 MFE/MAE',
                'strategy_detail': '📋 Strategy Detail',
                'margin_analysis': '💰 Margin Analysis',
                'daily_margin_analysis': '📊 Daily Margin Analysis',
                'pnl_by_day_of_week': '📅 P&L by Day of Week',
                'pnl_by_month': '📅 P&L by Month',
                'commission_analysis': '💳 Commission Analysis',
                'conflicting_legs': '⚠️ Conflicting Legs',
                'blackout_dates': '🚫 Blackout Dates',
                'price_movement': '📈 Price Movement',
                'meic_analysis': '🎯 MEIC Analysis',
                'separator': '--- Cross-File Analysis ---',
                'live_vs_bt': '⚖️ Live vs Backtest',
                'cross_file_correlation': '🔗 Cross-File Correlation',
                'files_overview': '📁 Uploaded Files Overview'
            };
            return chartNames[chartType] || chartType;
        }

               function loadChart(chartType) {
           // Track chart loading
           if (window.appInsights) {
               window.appInsights.trackEvent('chart_loaded', {
                   chartType: chartType
               });
           }
           
           console.log('=== LOADCHART FUNCTION START ===');
           console.log('loadChart called with chartType:', chartType);
           console.log('chartType type:', typeof chartType);
           console.log('chartType length:', chartType.length);
           console.log('chartType === "strategy_detail":', chartType === 'strategy_detail');
           console.log('chartType.trim() === "strategy_detail":', chartType.trim() === 'strategy_detail');
           console.log('🔧 DEBUG: chartType === "blackout_dates":', chartType === 'blackout_dates');
           const container = document.getElementById('chartContainer');
           const loading = document.getElementById('chartLoading');
           const overviewContent = document.getElementById('overviewContent');
           const chartSelector = document.querySelector('.chart-selector');
       
           // Handle overview chart type
           if (chartType === 'overview') {
               console.log('Handling overview chart type - showing overview content');
               // Hide the chart container and show overview content, but keep chart selector visible
               container.style.display = 'none';
               loading.style.display = 'none';
               overviewContent.style.display = 'block';
               return;
                       } else {
                // For all other chart types, hide overview content and show chart container
                overviewContent.style.display = 'none';
                container.style.display = 'block';
                document.getElementById('dailyMarginTableContainer').style.display = 'none';
            }
            
            // Hide MEIC content for all chart types except MEIC analysis
            const meicContent = document.getElementById('meicAnalysisContent');
            if (meicContent && chartType !== 'meic_analysis') {
                meicContent.style.display = 'none';
            }

            
            if (chartType === 'monte_carlo') {
                // Clear any existing Monte Carlo form first
                console.log('Creating Monte Carlo form...');
                
                // Show Monte Carlo simulation form
                container.innerHTML = `
                    <div class="alert alert-danger" role="alert">
                        <strong>⚠️ DEVELOPMENT NOTICE:</strong> This Monte Carlo simulation page is currently under development and should not be relied upon for trading decisions. The calculations and results may contain errors or inaccuracies.
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <h5>Simulation Parameters</h5>
                            <div class="mb-3">
                                <label for="simulationType" class="form-label">Simulation Type:</label>
                                <select class="form-select" id="simulationType" onchange="toggleStrategySelection()">
                                    <option value="portfolio">Portfolio (All Strategies Combined)</option>
                                    <option value="single_strategy">Single Strategy</option>
                                </select>
                            </div>
                            <div class="mb-3" id="strategySelectionDiv" style="display: none;">
                                <label for="selectedStrategy" class="form-label">Select Strategy:</label>
                                <select class="form-select" id="selectedStrategy">
                                    <!-- Options will be populated by JavaScript -->
                                </select>
                            </div>
                            <!-- Trade size input removed - using historical position sizing -->
                            <div class="mb-3">
                                <label for="numSimulations" class="form-label">Number of Simulations:</label>
                                <select class="form-select" id="numSimulations">
                                    <option value="100">100 (Fast)</option>
                                    <option value="500">500</option>
                                    <option value="1000" selected>1,000 (Recommended)</option>
                                    <option value="2500">2,500</option>
                                    <option value="5000">5,000 (Slow)</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="numTrades" class="form-label">Number of Trades per Simulation:</label>
                                <input type="number" class="form-control" id="numTrades" placeholder="Use historical count">
                                <small class="text-muted">Leave empty to use same count as historical data</small>
                            </div>
                            <div class="mb-3">
                                <label for="riskFreeRate" class="form-label">Risk-Free Rate (% Annual):</label>
                                <input type="number" class="form-control" id="riskFreeRate" 
                                       value="4.0" min="0" max="20" step="0.1" 
                                       title="Annual risk-free rate for Sharpe and Sortino ratio calculations">
                                <small class="text-muted">Used for risk-adjusted performance calculations (default: 4%)</small>
                            </div>
                            <div class="d-grid gap-2">
                                <button class="btn btn-primary" id="runMonteCarloBtn">Run Simulation</button>
                                <div id="monteCarloStatus"></div>
                            </div>
                        </div>
                        <div class="col-md-8">
                            <h5>Simulation Results</h5>
                            <div id="monteCarloResults" class="alert alert-info">
                                Run a simulation to see probability distributions and risk metrics
                            </div>
                            <!-- Monte Carlo Charts section moved to dynamic content in JavaScript -->
                            <div class="mt-3" id="simulationDetailsSection" style="display: none;">
                                <h6>View Simulated Trades:</h6>
                                <div class="d-flex gap-2 align-items-center">
                                    <label for="simulationSelect" class="form-label mb-0">Simulation:</label>
                                    <select class="form-select form-select-sm" id="simulationSelect" style="width: auto;">
                                        <!-- Options will be populated by JavaScript -->
                                    </select>
                                    <button class="btn btn-outline-secondary btn-sm" onclick="viewSimulationTrades()">View Trades</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Monte Carlo chart container moved to dynamic content in JavaScript -->
                `;
                
                // Set up Monte Carlo button event
                document.getElementById('runMonteCarloBtn').onclick = runMonteCarloSimulation;
                
                // Load strategy options
                loadStrategyOptions();
                
                // Initialize form state
                toggleStrategySelection();
                
                // Ensure form is fully loaded before any operations
                setTimeout(() => {
                    console.log('Monte Carlo form fully initialized');
                }, 100);
                return;
            }

            console.log('Checking chartType:', chartType, 'Type:', typeof chartType, 'Length:', chartType.length);
            if (chartType === 'strategy_detail') {
                console.log('Handling strategy_detail chart type - creating UI');
                // Show strategy detail table with filtering
                container.innerHTML = `
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <h5>Strategy Filter</h5>
                            <div class="mb-3">
                                <label for="strategyFilter" class="form-label">Filter by Strategy:</label>
                                <select class="form-select" id="strategyFilter" multiple size="5">
                                    <!-- Options will be populated by JavaScript -->
                                </select>
                                <small class="text-muted">Hold Ctrl/Cmd to select multiple strategies. Leave empty to show all.</small>
                                <div class="alert alert-info mt-2" style="font-size: 0.9em;">
                                    <strong>Performance Note:</strong> Margin calculations are disabled by default for faster loading. Check the box above to include margin data (may slow down loading with large datasets).
                                </div>
                            </div>
                            <button class="btn btn-primary" onclick="loadStrategyDetails()">Load Trades</button>
                            <button class="btn btn-outline-secondary" onclick="clearStrategyFilter()">Clear Filter</button>
                            <div class="form-check mt-2">
                                <input class="form-check-input" type="checkbox" id="includeMarginCheck" onchange="loadStrategyDetails()">
                                <label class="form-check-label" for="includeMarginCheck">
                                    Include Margin Calculations (slower)
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h5>Trade Summary</h5>
                            <div id="tradeSummary" class="alert alert-info">
                                Select strategies and click "Load Trades" to see summary
                            </div>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-12">
                            <h5>Strategy P&L Performance</h5>
                            <div id="strategyPnlChart" class="chart-container" style="height: 400px;">
                                <div class="text-center text-muted py-5">
                                    Select strategies and click "Load Trades" to see P&L performance
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-12">
                            <h5>Trade Details</h5>
                            <div class="table-responsive">
                                <table class="table table-striped table-hover" id="strategyDetailTable">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>Date Opened</th>
                                            <th>Date Closed</th>
                                            <th>Strategy</th>
                                            <th>P&L</th>
                                            <th>Funds at Close</th>
                                            <th>Contracts</th>
                                            <th>Margin/Contract</th>
                                            <th>Opening Commissions</th>
                                            <th>Closing Commissions</th>
                                            <th>Result</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td colspan="10" class="text-center text-muted">Select strategies and click "Load Trades" to view trade details</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div id="paginationControls" class="d-flex justify-content-between align-items-center mt-3" style="display: none !important;">
                                <div class="pagination-info">
                                    <small class="text-muted">Showing <span id="paginationInfo"></span></small>
                                </div>
                                <nav aria-label="Trade pagination">
                                    <ul class="pagination pagination-sm mb-0" id="paginationButtons">
                                        <!-- Pagination buttons will be populated by JavaScript -->
                                    </ul>
                                </nav>
                            </div>
                        </div>
                    </div>
                `;
                
                // Load available strategies for the filter after ensuring DOM is ready
                setTimeout(() => {
                    loadAvailableStrategies().then(() => {
                        loadStrategyDetails();
                    });
                }, 100);
                console.log('Strategy detail handled, returning early');
                return;
            }

            if (chartType === 'win_rates_table') {
                // Win rates table - handled specially with sorting and colors
                loadWinRatesTable();
                return;
            }

            if (chartType === 'pnl_by_day_of_week') {
                // P&L by day of week table - handled specially with colorization
                loadPnlByDayOfWeekTable();
                return;
            }

            if (chartType === 'pnl_by_month') {
                // P&L by month table - handled specially with colorization
                loadPnlByMonthTable();
                return;
            }
            
            if (chartType === 'commission_analysis') {
                // Commission analysis table
                loadCommissionAnalysis();
                return;
            }
            
            if (chartType === 'conflicting_legs') {
                loadConflictingLegsChart();
                return;
            }
            
            if (chartType === 'blackout_dates') {
                console.log('🔧 BLACKOUT DATES CONDITION REACHED');
                console.log('🔧 About to call loadBlackoutDatesChart()');
                console.log('🔧 Function exists?', typeof loadBlackoutDatesChart);
                try {
                    loadBlackoutDatesChart();
                    console.log('🔧 loadBlackoutDatesChart() completed successfully');
                } catch (error) {
                    console.error('🔧 Error calling loadBlackoutDatesChart():', error);
                }
                return;
            }
            
            if (chartType === 'mfe_mae') {
                console.log('🔧 MFE/MAE ANALYSIS CONDITION REACHED');
                loadMFEMAEAnalysis();
                return;
            }
            
            if (chartType === 'live_vs_bt') {
                console.log('🔧 LIVE VS BT ANALYSIS CONDITION REACHED');
                loadLiveVsBTAnalysis();
                return;
            }
            
            if (chartType === 'meic_analysis') {
                console.log('🔧 MEIC ANALYSIS CONDITION REACHED');
                loadMEICAnalysis();
                return;
            }
            
            if (chartType === 'price_movement') {
                loadPriceMovementChart();
                return;
            }
            
            if (chartType === 'cross_file_correlation') {
                loadCrossFileCorrelationChart();
                return;
            }
            
            if (chartType === 'files_overview') {
                loadFilesOverview();
                return;
            }
            
            if (chartType === 'separator') {
                // Separator should not be clickable - this shouldn't happen
                console.warn('Separator chart type was clicked - this should not be possible');
                return;
            }

            if (chartType === 'margin_analysis') {
                // Margin analysis table - handled specially with sorting and colors
                loadMarginAnalysisTable();
                return;
            }

            if (chartType === 'daily_margin_analysis') {
                // Daily margin analysis - handled specially with chart and table
                loadDailyMarginAnalysis();
                return;
            }

            console.log('Making API call for chartType:', chartType);
            loading.style.display = 'block';
            container.innerHTML = '';

            fetch(`/api/charts/${chartType}`)
            .then(response => response.json())
            .then(data => {
                loading.style.display = 'none';
                console.log('Chart API response:', data);
                
                if (data.error) {
                    container.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
                } else if (data.chart) {
                    console.log('Chart data to parse:', data.chart);
                    const chartData = JSON.parse(data.chart);
                    console.log('Parsed chart data:', chartData);
                    
                    // Check if this is a drawdown chart with strategy stats
                    if (data.type === 'drawdown' && data.strategy_stats) {
                        renderDrawdownChartWithStats(chartData, data.strategy_stats);
                    } else if (data.type === 'portfolio_balance') {
                        // Special rendering for portfolio balance with explanation pane
                        renderPortfolioBalanceChart(chartData);
                    } else {
                        // Regular chart rendering
                    Plotly.newPlot('chartContainer', chartData.data, chartData.layout, {
                        responsive: true,
                        displayModeBar: true,
                        displaylogo: false,
                        useResizeHandler: true
                    }).then(() => {
                        // Ensure chart is properly sized after rendering
                        const container = document.getElementById('chartContainer');
                        if (container) {
                            Plotly.relayout('chartContainer', {
                                width: container.clientWidth - 60,
                                height: container.clientHeight - 60
                            });
                        }
                    });
                    }
                } else {
                    console.error('Unexpected response format:', data);
                    container.innerHTML = '<div class="alert alert-danger">Unexpected response format from chart API</div>';
                }
            })
            .catch(error => {
                loading.style.display = 'none';
                console.error('Error loading chart:', error);
                container.innerHTML = '<div class="alert alert-danger">Error loading chart</div>';
            });
        }

        function renderDrawdownChartWithStats(chartData, strategyStats) {
            const container = document.getElementById('chartContainer');
            
            // Create HTML with chart and strategy breakdown
            let html = `
                <div class="row" style="height: calc(100% - 200px);">
                    <div class="col-md-12" style="height: 100%;">
                        <div id="drawdownChart" style="height: 100%; width: 100%;"></div>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-md-12">
                        <div class="alert alert-info">
                            <h6><i class="fas fa-info-circle"></i> How to Use This Chart:</h6>
                            <ul class="mb-0">
                                <li><strong>Portfolio Lines:</strong> Blue line shows total account value, red area shows portfolio drawdown %</li>
                                <li><strong>Strategy P&L Lines:</strong> Click legend to show individual strategy cumulative P&L (dotted lines)</li>
                                <li><strong>Strategy Drawdown:</strong> Each strategy has a drawdown % line (dashed lines) calculated against "Funds at Close"</li>
                                <li><strong>Daily Details:</strong> Hover over any line to see day-by-day P&L and drawdown details</li>
                                <li><strong>Peak Tracking:</strong> Tooltips show current P&L vs. peak P&L and days since peak</li>
                            </ul>
                        </div>
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
            
            // Render the chart
            setTimeout(() => {
                Plotly.newPlot('drawdownChart', chartData.data, chartData.layout, {
                    responsive: true,
                    displayModeBar: true,
                    displaylogo: false,
                    useResizeHandler: true
                });
            }, 100);
        }

        function renderPortfolioBalanceChart(chartData) {
            const container = document.getElementById('chartContainer');
            
            // Create HTML with explanation pane above the chart
            let html = `
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="fas fa-info-circle"></i> Individual Strategy Analysis</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6 class="text-primary">Strategy Classification Logic:</h6>
                                        <ul class="list-unstyled small">
                                            <li><span style='color:#2ca02c'>🟢 BULLISH</span>: Market ↑ (+0.5%+) AND P&L > 0, OR Market ↓ (-0.5%+) AND P&L < 0</li>
                                            <li><span style='color:#d62728'>🔴 BEARISH</span>: Market ↓ (-0.5%+) AND P&L > 0, OR Market ↑ (+0.5%+) AND P&L < 0</li>
                                            <li><span style='color:#ff7f0e'>🟠 NEUTRAL</span>: Market movement between -0.5% and +0.5%</li>
                                        </ul>
                                    </div>
                                    <div class="col-md-6">
                                        <h6 class="text-info">Pie Chart Details:</h6>
                                        <ul class="list-unstyled small">
                                            <li>• Each slice = Individual strategy sized by |P&L|</li>
                                            <li>• Color = Strategy type (Bullish/Bearish/Neutral)</li>
                                            <li>• Sorted by P&L magnitude (largest first)</li>
                                            <li>• Hover for full strategy name and details</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-12">
                        <div id="portfolioBalanceChart" style="height: 600px;"></div>
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
            
            // Render the chart
            setTimeout(() => {
                Plotly.newPlot('portfolioBalanceChart', chartData.data, chartData.layout, {
                    responsive: true,
                    displayModeBar: true,
                    displaylogo: false,
                    useResizeHandler: true
                });
            }, 100);
        }

        function loadPortfolioData() {
            console.log('loadPortfolioData() called');
            
            // Load overview metrics
            console.log('Fetching /api/portfolio/overview...');
            fetch(`/api/portfolio/overview?t=${Date.now()}`)
            .then(response => {
                console.log('Overview response received:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('Overview data received:', data);
                if (data.success) {
                    updateOverviewMetrics(data.data);
                }
            });

            // Load strategy summary
            console.log('Fetching /api/portfolio/strategies...');
            fetch(`/api/portfolio/strategies?t=${Date.now()}`)
            .then(response => {
                console.log('Strategies response received:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('Strategies data received:', data);
                if (data.success) {
                    updateStrategyTable(data.data);
                }
            });

            // Load balance analysis
            console.log('Fetching /api/portfolio/balance-analysis...');
            fetch(`/api/portfolio/balance-analysis?t=${Date.now()}`)
            .then(response => {
                console.log('Balance analysis response received:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('Balance analysis data received:', data);
                if (data.success) {
                    updateBalanceAnalysis(data.data);
                }
            });

            // Auto-load cumulative P&L chart only if no chart is currently loaded and not loading a saved file
            setTimeout(() => {
                // Skip auto-load if we're loading a saved file
                if (window.skipAutoLoadCumulativePnl) {
                    console.log('Skipping auto-load - loading saved file');
                    return;
                }
                
                const container = document.getElementById('chartContainer');
                // Only auto-load if the container is empty or showing the default message
                if (!container.innerHTML || 
                    container.innerHTML.includes('Select a chart to view analytics') ||
                    container.innerHTML.includes('Upload or select a file to view analytics')) {
                    console.log('Auto-loading cumulative P&L chart...');
                loadChart('cumulative_pnl');
                } else {
                    console.log('Skipping auto-load - chart already loaded');
                }
            }, 500); // Small delay to ensure other data is loaded first
            
            // Ensure chart buttons are loaded
            setTimeout(() => {
                if (!availableCharts || Object.keys(availableCharts).length === 0) {
                    console.log('Re-loading chart buttons...');
                    loadAvailableCharts();
                }
            }, 1000);
            
            console.log('loadPortfolioData() completed');
        }

        function updateOverviewMetrics(data) {
            document.getElementById('startingCapital').textContent =
                data.starting_capital !== undefined ? `$${Number(data.starting_capital).toLocaleString()}` : '$0';
            document.getElementById('endingCapital').textContent =
                data.ending_capital !== undefined ? `$${Number(data.ending_capital).toLocaleString()}` : '$0';
            
            // Update dates
            document.getElementById('startDate').textContent =
                data.start_date !== undefined ? data.start_date : '';
            document.getElementById('endDate').textContent =
                data.end_date !== undefined ? data.end_date : '';
            
            document.getElementById('totalPnL').textContent =
                data.total_pnl !== undefined ? `$${Number(data.total_pnl).toLocaleString()}` : '$0';
            document.getElementById('totalTrades').textContent =
                data.total_trades !== undefined ? data.total_trades : '0';
            document.getElementById('strategyCount').textContent =
                data.strategy_count !== undefined ? data.strategy_count : '0';
            document.getElementById('maxDrawdown').textContent =
                data.max_drawdown !== undefined ? `$${Number(data.max_drawdown).toLocaleString()}` : '$0';
            document.getElementById('cagr').textContent =
                data.cagr !== undefined ? `${data.cagr}%` : '0%';
            document.getElementById('maxDrawdownPct').textContent =
                data.max_drawdown_pct !== undefined ? `${data.max_drawdown_pct}%` : '0%';
            document.getElementById('mar').textContent =
                data.mar !== undefined ? data.mar : '0';
            document.getElementById('avgDaysToNewHigh').textContent =
                data.avg_days_to_new_high !== undefined && data.avg_days_to_new_high !== null ? data.avg_days_to_new_high : 'N/A';
            document.getElementById('longestDaysSinceToNewHigh').textContent =
                data.longest_days_since_to_new_high !== undefined && data.longest_days_since_to_new_high !== null ? data.longest_days_since_to_new_high : 'N/A';
        }

        // Add global sort state
        let strategySortKey = 'total_pnl';
        let strategySortAsc = false;
        let strategyTableData = [];

        function updateStrategyTable(data) {
            console.log('updateStrategyTable called with data:', data);
            console.log('Data type:', typeof data);
            console.log('Data length:', data ? data.length : 'undefined');
            if (data && data.length > 0) {
                console.log('First strategy:', data[0]);
                console.log('Available fields:', Object.keys(data[0]));
            }
            strategyTableData = data;
            renderStrategyTable();
        }

        function safeNumber(val, decimals=0) {
            if (val === undefined || val === null || val === '' || isNaN(Number(val))) return '0';
            return Number(val).toFixed(decimals);
        }
        function safeCurrency(val) {
            if (val === undefined || val === null || val === '' || isNaN(Number(val))) return '$0';
            return `$${Number(val).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        }
        function safeString(val) {
            return val === undefined || val === null ? '' : String(val);
        }

        function renderStrategyTable() {
            console.log('renderStrategyTable called');
            console.log('strategyTableData:', strategyTableData);
            const tbody = document.querySelector('#strategyTable tbody');
            console.log('Found tbody:', tbody);
            tbody.innerHTML = '';
            if (!strategyTableData || strategyTableData.length === 0) {
                console.log('No strategy data, showing empty message');
                tbody.innerHTML = '<tr><td colspan="21" class="text-center text-muted">No strategy data available</td></tr>';
                return;
            }
            console.log('Rendering', strategyTableData.length, 'strategies');
            // Sort data
            const sorted = [...strategyTableData].sort((a, b) => {
                let valA, valB;
                
                // Map frontend column names to backend field names
                const fieldMap = {
                    'strategy': 'name',
                    'trades': 'trade_count',
                    'wins': 'wins_count',
                    'losses': 'losses_count',
                    'commissions': 'total_commissions',
                    'comm_per_lot': 'avg_commissions_per_lot'
                };
                
                const fieldName = fieldMap[strategySortKey] || strategySortKey;
                
                if (strategySortKey === 'strategy') {
                    valA = (a.name || '').toLowerCase();
                    valB = (b.name || '').toLowerCase();
                    if (valA < valB) return strategySortAsc ? -1 : 1;
                    if (valA > valB) return strategySortAsc ? 1 : -1;
                    return 0;
                } else {
                    valA = Number(a[fieldName]);
                    valB = Number(b[fieldName]);
                }
                if (isNaN(valA)) valA = 0;
                if (isNaN(valB)) valB = 0;
                return strategySortAsc ? valA - valB : valB - valA;
            });
            for (const row of sorted) {
                // Helper for colorization
                function pnlClass(val) {
                    if (val === undefined || val === null || isNaN(Number(val))) return '';
                    if (Number(val) > 0) return 'text-success fw-bold';
                    if (Number(val) < 0) return 'text-danger fw-bold';
                    return '';
                }
                
                // Special function for loss columns - losses should always be red even if positive
                function lossClass(val) {
                    if (val === undefined || val === null || isNaN(Number(val))) return '';
                    if (Number(val) !== 0) return 'text-danger fw-bold';
                    return '';
                }
                tbody.innerHTML += `
                <tr>
                    <td>${safeString(row.name)}</td>
                    <td class="${pnlClass(row.total_pnl)}">${safeCurrency(row.total_pnl)}</td>
                    <td>${safeNumber(row.trade_count)}</td>
                    <td>${safeNumber(row.wins_count)}</td>
                    <td>${safeNumber(row.losses_count)}</td>
                    <td>${safeCurrency(row.total_commissions)}</td>
                    <td>${safeNumber(row.win_rate, 2)}%</td>
                    <td>${safeNumber(row.max_loss_streak)}</td>
                    <td class="${pnlClass(row.avg_win)}">${safeCurrency(row.avg_win)}</td>
                    <td class="${lossClass(row.avg_loss)}">${safeCurrency(row.avg_loss)}</td>
                    <td class="${pnlClass(row.max_win)}">${safeCurrency(row.max_win)}</td>
                    <td class="${lossClass(row.max_loss)}">${safeCurrency(row.max_loss)}</td>
                    <td class="${pnlClass(row.avg_win_per_lot)}">${safeCurrency(row.avg_win_per_lot)}</td>
                    <td class="${lossClass(row.avg_loss_per_lot)}">${safeCurrency(row.avg_loss_per_lot)}</td>
                    <td class="${pnlClass(row.max_win_per_lot)}">${safeCurrency(row.max_win_per_lot)}</td>
                    <td class="${lossClass(row.max_loss_per_lot)}">${safeCurrency(row.max_loss_per_lot)}</td>
                    <td>${safeCurrency(row.avg_commissions_per_lot)}</td>
                    <td class="${pnlClass(row.expectancy_per_lot)}">${safeCurrency(row.expectancy_per_lot)}</td>
                    <td>${safeNumber(row.profit_factor, 2)}</td>
                    <td>${safeNumber(row.margin_percentage, 1)}%</td>
                    <td class="${pnlClass(row.efficiency)}">${safeNumber(row.efficiency, 4)}</td>
                </tr>
                `;
            }
            // Update sort indicators
            const keys = ['strategy','total_pnl','trades','wins','losses','commissions','win_rate','max_loss_streak','avg_win','avg_loss','max_win','max_loss','avg_win_per_lot','avg_loss_per_lot','max_win_per_lot','max_loss_per_lot','comm_per_lot','expectancy_per_lot','profit_factor','margin_percentage','efficiency'];
            for (const key of keys) {
                const indicator = document.getElementById('sort-indicator-' + key);
                if (key === strategySortKey) {
                    indicator.textContent = strategySortAsc ? '▲' : '▼';
                } else {
                    indicator.textContent = '';
                }
            }
            
            // Initialize tooltips for overview table
            setTimeout(() => {
                initializeCustomTooltips();
            }, 100);
        }

        function sortStrategyTable(key) {
            if (strategySortKey === key) {
                strategySortAsc = !strategySortAsc;
            } else {
                strategySortKey = key;
                strategySortAsc = key === 'strategy'; // default asc for name, desc for numbers
            }
            renderStrategyTable();
        }

        function updateBalanceAnalysis(data) {
            const container = document.getElementById('balanceAnalysis');
            
            if (!data.balance) {
                container.innerHTML = '<p class="text-muted">No balance data available</p>';
                return;
            }

            const balance = data.balance;
            const diversification = data.diversification;

            // Calculate totals
            const totalStrategies = (balance.BULLISH?.strategy_count || 0) + (balance.BEARISH?.strategy_count || 0) + (balance.NEUTRAL?.strategy_count || 0);
            const totalTrades = (balance.BULLISH?.trade_count || 0) + (balance.BEARISH?.trade_count || 0) + (balance.NEUTRAL?.trade_count || 0);
            const totalPnl = (balance.BULLISH?.pnl || 0) + (balance.BEARISH?.pnl || 0) + (balance.NEUTRAL?.pnl || 0);

            container.innerHTML = `
                <div class="row mb-3">
                    <div class="col-12">
                        <div class="alert alert-info">
                            <h6 class="mb-2"><i class="fas fa-info-circle"></i> Portfolio Balance Summary</h6>
                            <div class="row text-center">
                                <div class="col-md-3">
                                    <strong>${totalStrategies}</strong><br>
                                    <small class="text-muted">Total Strategies</small>
                                </div>
                                <div class="col-md-3">
                                    <strong>${totalTrades}</strong><br>
                                    <small class="text-muted">Total Trades</small>
                                </div>
                                <div class="col-md-3">
                                    <strong class="${totalPnl >= 0 ? 'positive' : 'negative'}">${formatCurrency(totalPnl)}</strong><br>
                                    <small class="text-muted">Total P&L</small>
                                </div>
                                <div class="col-md-3">
                                    <strong>${diversification?.score || 0}%</strong><br>
                                    <small class="text-muted">Diversification Score</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-4">
                        <div class="card h-100">
                            <div class="card-body">
                                <h6 class="card-title text-success">🟢 Bullish Strategies</h6>
                                <div class="mb-2">
                                    <strong>${balance.BULLISH ? balance.BULLISH.strategy_count : 0}</strong> strategies
                                    <span class="badge bg-success ms-2">${balance.BULLISH ? ((balance.BULLISH.strategy_count / totalStrategies) * 100).toFixed(1) : 0}%</span>
                                </div>
                                <div class="mb-2">
                                    <strong>${balance.BULLISH?.trade_count || 0}</strong> trades
                                    <span class="badge bg-secondary ms-2">${balance.BULLISH ? ((balance.BULLISH.trade_count / totalTrades) * 100).toFixed(1) : 0}%</span>
                                </div>
                                <div class="mb-2">
                                    P&L: <span class="${(balance.BULLISH?.pnl || 0) >= 0 ? 'positive' : 'negative'}">${formatCurrency(balance.BULLISH?.pnl || 0)}</span>
                                    <span class="badge bg-info ms-2">${balance.BULLISH ? ((balance.BULLISH.pnl / totalPnl) * 100).toFixed(1) : 0}%</span>
                                </div>
                        ${balance.BULLISH?.strategies ? `
                            <details>
                                        <summary class="text-muted" style="cursor: pointer; font-size: 0.9em;">Show strategies (${balance.BULLISH.strategies.length})</summary>
                                        <ul style="font-size: 0.8em; margin-top: 5px; max-height: 150px; overflow-y: auto; word-wrap: break-word; white-space: normal;">
                                            ${balance.BULLISH.strategies.map(s => `
                                                <li title="${s.name} - P&L: ${formatCurrency(s.pnl)}, Trades: ${s.trade_count}">
                                                    ${s.name}
                                                    <span class="text-muted">(${formatCurrency(s.pnl)})</span>
                                                </li>
                                            `).join('')}
                                </ul>
                            </details>
                        ` : ''}
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card h-100">
                            <div class="card-body">
                                <h6 class="card-title text-danger">🔴 Bearish Strategies</h6>
                                <div class="mb-2">
                                    <strong>${balance.BEARISH ? balance.BEARISH.strategy_count : 0}</strong> strategies
                                    <span class="badge bg-danger ms-2">${balance.BEARISH ? ((balance.BEARISH.strategy_count / totalStrategies) * 100).toFixed(1) : 0}%</span>
                                </div>
                                <div class="mb-2">
                                    <strong>${balance.BEARISH?.trade_count || 0}</strong> trades
                                    <span class="badge bg-secondary ms-2">${balance.BEARISH ? ((balance.BEARISH.trade_count / totalTrades) * 100).toFixed(1) : 0}%</span>
                                </div>
                                <div class="mb-2">
                                    P&L: <span class="${(balance.BEARISH?.pnl || 0) >= 0 ? 'positive' : 'negative'}">${formatCurrency(balance.BEARISH?.pnl || 0)}</span>
                                    <span class="badge bg-info ms-2">${balance.BEARISH ? ((balance.BEARISH.pnl / totalPnl) * 100).toFixed(1) : 0}%</span>
                                </div>
                        ${balance.BEARISH?.strategies ? `
                            <details>
                                        <summary class="text-muted" style="cursor: pointer; font-size: 0.9em;">Show strategies (${balance.BEARISH.strategies.length})</summary>
                                        <ul style="font-size: 0.8em; margin-top: 5px; max-height: 150px; overflow-y: auto; word-wrap: break-word; white-space: normal;">
                                            ${balance.BEARISH.strategies.map(s => `
                                                <li title="${s.name} - P&L: ${formatCurrency(s.pnl)}, Trades: ${s.trade_count}">
                                                    ${s.name}
                                                    <span class="text-muted">(${formatCurrency(s.pnl)})</span>
                                                </li>
                                            `).join('')}
                                </ul>
                            </details>
                        ` : ''}
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card h-100">
                            <div class="card-body">
                                <h6 class="card-title text-warning">🟡 Neutral Strategies</h6>
                                <div class="mb-2">
                                    <strong>${balance.NEUTRAL ? balance.NEUTRAL.strategy_count : 0}</strong> strategies
                                    <span class="badge bg-warning ms-2">${balance.NEUTRAL ? ((balance.NEUTRAL.strategy_count / totalStrategies) * 100).toFixed(1) : 0}%</span>
                                </div>
                                <div class="mb-2">
                                    <strong>${balance.NEUTRAL?.trade_count || 0}</strong> trades
                                    <span class="badge bg-secondary ms-2">${balance.NEUTRAL ? ((balance.NEUTRAL.trade_count / totalTrades) * 100).toFixed(1) : 0}%</span>
                                </div>
                                <div class="mb-2">
                                    P&L: <span class="${(balance.NEUTRAL?.pnl || 0) >= 0 ? 'positive' : 'negative'}">${formatCurrency(balance.NEUTRAL?.pnl || 0)}</span>
                                    <span class="badge bg-info ms-2">${balance.NEUTRAL ? ((balance.NEUTRAL.pnl / totalPnl) * 100).toFixed(1) : 0}%</span>
                                </div>
                        ${balance.NEUTRAL?.strategies ? `
                            <details>
                                        <summary class="text-muted" style="cursor: pointer; font-size: 0.9em;">Show strategies (${balance.NEUTRAL.strategies.length})</summary>
                                        <ul style="font-size: 0.8em; margin-top: 5px; max-height: 150px; overflow-y: auto; word-wrap: break-word; white-space: normal;">
                                            ${balance.NEUTRAL.strategies.map(s => `
                                                <li title="${s.name} - P&L: ${formatCurrency(s.pnl)}, Trades: ${s.trade_count}">
                                                    ${s.name}
                                                    <span class="text-muted">(${formatCurrency(s.pnl)})</span>
                                                </li>
                                            `).join('')}
                                </ul>
                            </details>
                        ` : ''}
                            </div>
                        </div>
                    </div>
                </div>
                <hr>
                <div class="mt-3">
                    <h6>🎯 Diversification Score</h6>
                    <div class="progress mb-2">
                        <div class="progress-bar" style="width: ${diversification.score}%">${diversification.score}%</div>
                    </div>
                    <small class="text-muted">${diversification.status}</small>
                    
                    <!-- Diversification Score Explanation -->
                    <div class="mt-2">
                        <button class="btn btn-outline-info btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#diversificationExplanation" aria-expanded="false" aria-controls="diversificationExplanation">
                            <i class="fas fa-info-circle"></i> How is this calculated?
                        </button>
                        <div class="collapse mt-2" id="diversificationExplanation">
                            <div class="card card-body bg-light">
                                <h6><strong>Diversification Score Logic:</strong></h6>
                                <p class="mb-2"><strong>Formula:</strong> Score = 100 - (Average Correlation × 100)</p>
                                <ul class="mb-2">
                                    <li><strong>Higher Score = Better Diversification</strong></li>
                                    <li><strong>Perfect Diversification (0% correlation) = 100% score</strong></li>
                                    <li><strong>Perfect Correlation (100% correlation) = 0% score</strong></li>
                                </ul>
                                <p class="mb-2"><strong>Your Score: ${diversification.score}%</strong> means your strategies have an average correlation of <strong>${(100 - diversification.score).toFixed(1)}%</strong></p>
                                <h6><strong>Status Thresholds:</strong></h6>
                                <ul class="mb-0">
                                    <li><span class="text-success">≥70%:</span> Well Diversified 🟢</li>
                                    <li><span class="text-warning">50-69%:</span> Moderately Diversified 🟡</li>
                                    <li><span class="text-warning">30-49%:</span> Poorly Diversified 🟠</li>
                                    <li><span class="text-danger"><30%:</span> Highly Correlated 🔴</li>
                                </ul>
                                <p class="mt-2 mb-0"><small class="text-muted"><strong>Why this matters:</strong> Low correlation means strategies don't all lose money at the same time, providing more stable overall portfolio performance and risk reduction.</small></p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Load MFE/MAE Analysis
        function loadMFEMAEAnalysis() {
            console.log('Loading MFE/MAE analysis...');
            
            const container = document.getElementById('chartContainer');
            const loading = document.getElementById('chartLoading');
            
            // Hide other content and show loading
            container.style.display = 'none';
            loading.style.display = 'block';
            
            // Create the MFE/MAE page content
            container.innerHTML = `
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="fas fa-chart-line"></i> MFE/MAE Analysis</h5>
                                <small class="text-muted">Maximum Favorable Excursion & Maximum Adverse Excursion</small>
                            </div>
                            <div class="card-body">
                                <div id="mfeMaeContent">
                                    <div class="text-center">
                                        <div class="spinner-border text-primary" role="status"></div>
                                        <p class="mt-2">Loading MFE/MAE analysis...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Show the container and hide loading
            container.style.display = 'block';
            loading.style.display = 'none';
            
            // Load the data
            fetch('/api/portfolio/mfe-mae-analysis')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        displayMFEMAEAnalysis(data.data);
                    } else {
                        displayMFEMAEError(data.error || 'Failed to load MFE/MAE analysis');
                    }
                })
                .catch(error => {
                    console.error('Error loading MFE/MAE analysis:', error);
                    displayMFEMAEError('Error loading MFE/MAE analysis: ' + error.message);
                });
        }

        function displayMFEMAEAnalysis(mfeMaeData) {
            const container = document.getElementById('mfeMaeContent');
            
            if (!mfeMaeData.available) {
                container.innerHTML = `
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> ${mfeMaeData.message}
                    </div>
                `;
                return;
            }
            
            if (!mfeMaeData.strategies || mfeMaeData.strategies.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i> No MFE/MAE data available for analysis.
                    </div>
                `;
                return;
            }
            
            // Create summary
            const summary = mfeMaeData.summary || {};
            const summaryHtml = `
                <div class="row mb-3">
                    <div class="col-12">
                        <div class="alert alert-info">
                            <h6><i class="fas fa-chart-bar"></i> Analysis Summary</h6>
                            <div class="row text-center">
                                <div class="col-md-3">
                                    <strong>${summary.total_strategies || 0}</strong><br>
                                    <small class="text-muted">Strategies</small>
                                </div>
                                <div class="col-md-3">
                                    <strong>${summary.total_trades_analyzed || 0}</strong><br>
                                    <small class="text-muted">Total Trades</small>
                                </div>
                                <div class="col-md-3">
                                    <strong>${summary.losing_trades_with_mfe || 0}</strong><br>
                                    <small class="text-muted">Losing Trades with MFE</small>
                                </div>
                                <div class="col-md-3">
                                    <strong>${summary.winning_trades_combined || 0}</strong><br>
                                    <small class="text-muted">Winning Trades (MAE + MFE)</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Create strategy table
            const tableHtml = `
                <div class="table-responsive">
                    <table class="table table-striped table-hover" id="mfeMaeTable">
                        <thead class="table-dark">
                            <tr>
                                <th rowspan="2" class="align-middle">
                                    <i class="fas fa-sort" style="opacity: 0.3;"></i> Strategy
                                </th>
                                <th rowspan="2" class="align-middle text-center">
                                    <i class="fas fa-sort" style="opacity: 0.3;"></i> Total<br><small class="text-muted">Trades</small>
                                </th>
                                <th colspan="3" class="text-center bg-danger bg-opacity-25 border border-danger border-2">
                                    <i class="fas fa-arrow-down text-danger"></i> LOSING TRADES MFE ANALYSIS
                                </th>
                                <th colspan="5" class="text-center bg-success bg-opacity-25 border border-success border-2">
                                    <i class="fas fa-arrow-up text-success"></i> WINNING TRADES COMBINED ANALYSIS
                                </th>
                            </tr>
                            <tr>
                                <th class="text-center bg-danger bg-opacity-10 border border-danger">
                                    <i class="fas fa-sort" style="opacity: 0.3;"></i> Count<br>
                                    <small class="text-muted" data-bs-toggle="tooltip" title="Number of losing trades">Losing</small>
                                </th>
                                <th class="text-center bg-danger bg-opacity-10 border border-danger">
                                    <i class="fas fa-sort" style="opacity: 0.3;"></i> Avg MFE %<br>
                                    <small class="text-muted" data-bs-toggle="tooltip" title="Average Maximum Favorable Excursion - how much profit losing trades saw before becoming losers">Missed Profit</small>
                                </th>
                                <th class="text-center bg-danger bg-opacity-10 border border-danger">
                                    <i class="fas fa-sort" style="opacity: 0.3;"></i> Profit Kept %<br>
                                    <small class="text-muted" data-bs-toggle="tooltip" title="Percentage of maximum profit that was retained (always 0% for losing trades)">Retained</small>
                                </th>
                                <th class="text-center bg-success bg-opacity-10 border border-success">
                                    <i class="fas fa-sort" style="opacity: 0.3;"></i> Count<br>
                                    <small class="text-muted" data-bs-toggle="tooltip" title="Number of winning trades">Winning</small>
                                </th>
                                <th class="text-center bg-success bg-opacity-10 border border-success">
                                    <i class="fas fa-sort" style="opacity: 0.3;"></i> Avg MAE %<br>
                                    <small class="text-muted" data-bs-toggle="tooltip" title="Average Maximum Adverse Excursion - how much pain winning trades endured before becoming profitable">Pain Endured</small>
                                </th>
                                <th class="text-center bg-success bg-opacity-10 border border-success">
                                    <i class="fas fa-sort" style="opacity: 0.3;"></i> Pain/Profit<br>
                                    <small class="text-muted" data-bs-toggle="tooltip" title="Ratio of maximum adverse excursion to final profit (lower is better)">Efficiency</small>
                                </th>
                                <th class="text-center bg-success bg-opacity-10 border border-success">
                                    <i class="fas fa-sort" style="opacity: 0.3;"></i> Avg MFE %<br>
                                    <small class="text-muted" data-bs-toggle="tooltip" title="Average Maximum Favorable Excursion - how much profit winning trades saw while open">Profit Potential</small>
                                </th>
                                <th class="text-center bg-success bg-opacity-10 border border-success">
                                    <i class="fas fa-sort" style="opacity: 0.3;"></i> Profit Kept %<br>
                                    <small class="text-muted" data-bs-toggle="tooltip" title="Percentage of maximum profit that was actually captured (higher is better)">Profit Retention</small>
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            ${mfeMaeData.strategies.map(strategy => `
                                <tr>
                                    <td><strong>${strategy.strategy_name}</strong></td>
                                    <td class="text-center">${strategy.total_trades}</td>
                                    <td class="text-center border border-danger">${strategy.losing_mfe.count}</td>
                                    <td class="text-center border border-danger ${strategy.losing_mfe.avg_mfe_pct > 50 ? 'text-warning' : 'text-success'}">
                                        ${strategy.losing_mfe.avg_mfe_pct.toFixed(1)}%
                                    </td>
                                    <td class="text-center text-info border border-danger">
                                        ${strategy.losing_mfe.avg_profit_kept_pct.toFixed(1)}%
                                    </td>
                                    <td class="text-center border border-success">${strategy.winning_combined.count}</td>
                                    <td class="text-center border border-success ${strategy.winning_combined.avg_mae_pct > 50 ? 'text-warning' : 'text-success'}">
                                        ${strategy.winning_combined.avg_mae_pct.toFixed(1)}%
                                    </td>
                                    <td class="text-center border border-success ${strategy.winning_combined.avg_pain_to_profit_ratio > 2.0 ? 'text-warning' : 'text-success'}">
                                        ${strategy.winning_combined.avg_pain_to_profit_ratio.toFixed(2)}
                                    </td>
                                    <td class="text-center border border-success ${strategy.winning_combined.avg_mfe_pct > 50 ? 'text-warning' : 'text-success'}">
                                        ${strategy.winning_combined.avg_mfe_pct.toFixed(1)}%
                                    </td>
                                    <td class="text-center border border-success ${strategy.winning_combined.avg_profit_kept_pct > 50 ? 'text-success' : 'text-warning'}">
                                        ${strategy.winning_combined.avg_profit_kept_pct.toFixed(1)}%
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
                
                <div class="mt-3">
                    <div class="alert alert-info">
                        <h6><i class="fas fa-lightbulb"></i> Key Insights:</h6>
                        <ul class="mb-0">
                            <li><strong>MFE (Losing Trades):</strong> How much profit losing trades saw before becoming losers (shows missed opportunities)</li>
                            <li><strong>Profit Kept % (Losing):</strong> Always 0% since they ended up losing (shows they didn't capture the profit they saw)</li>
                            <li><strong>MAE (Winning Trades):</strong> How much pain winning trades endured before becoming profitable</li>
                            <li><strong>Pain/Profit Ratio:</strong> Ratio of maximum adverse excursion to final profit (lower is better - shows efficiency of profit capture)</li>
                            <li><strong>MFE (Winning Trades):</strong> How much profit winning trades saw while open (shows profit potential)</li>
                            <li><strong>Profit Kept % (Winning):</strong> What percentage of maximum profit was actually captured (higher is better - shows profit retention efficiency)</li>
                        </ul>
                    </div>
                </div>
                
                <div class="mt-3">
                </div>
                
                <!-- Debug Cards Section -->
                <div class="mt-4">
                    <h5><i class="fas fa-info-circle"></i> Sample Trade Details by Strategy</h5>
                    <p class="text-muted small">Detailed breakdown of one sample winner and one sample loser for each strategy</p>
                    
                    ${mfeMaeData.strategies.map(strategy => {
                        const loser = strategy.debug_loser || {};
                        const winner = strategy.debug_winner || {};
                        
                        if (!loser.trade_type && !winner.trade_type) {
                            return '';
                        }
                        
                        return `
                            <div class="card mb-2">
                                <div class="card-header py-2">
                                    <h6 class="mb-0">${strategy.strategy_name}</h6>
                                </div>
                                <div class="card-body py-2">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="card border-danger">
                                                <div class="card-header bg-danger text-white py-1">
                                                    <h6 class="mb-0 small"><i class="fas fa-arrow-down"></i> Sample Loser</h6>
                                                </div>
                                                <div class="card-body py-2">
                                                    <div class="row g-1">
                                                        <div class="col-6">
                                                            <small><strong>Type:</strong> <span class="badge ${loser.trade_type === 'CREDIT' ? 'bg-success' : 'bg-primary'}">${loser.trade_type || 'N/A'}</span></small>
                                                        </div>
                                                        <div class="col-6">
                                                            <small><strong>P&L:</strong> <span class="text-danger">$${loser.pnl ? loser.pnl.toLocaleString() : '0'}</span></small>
                                                        </div>
                                                    </div>
                                                    <div class="row g-1">
                                                        <div class="col-6">
                                                            <small><strong>Premium:</strong> $${loser.premium ? Math.abs(loser.premium).toLocaleString() : '0'}${loser.premium && loser.premium > 0 ? ' (credit)' : loser.premium && loser.premium < 0 ? ' (debit)' : ''}</small>
                                                        </div>
                                                        <div class="col-6">
                                                            <small><strong>Close:</strong> $${loser.avg_closing_cost ? Math.abs(loser.avg_closing_cost).toLocaleString() : '0'}${loser.avg_closing_cost && loser.avg_closing_cost > 0 ? ' (credit)' : loser.avg_closing_cost && loser.avg_closing_cost < 0 ? ' (debit)' : ''}</small>
                                                        </div>
                                                    </div>
                                                    <div class="row g-1">
                                                        <div class="col-6">
                                                            <small><strong>Contracts:</strong> ${loser.contracts || '0'}</small>
                                                        </div>
                                                        <div class="col-6">
                                                            <small><strong>Margin/Contract:</strong> $${loser.margin_per_contract ? loser.margin_per_contract.toLocaleString() : '0'}</small>
                                                        </div>
                                                    </div>
                                                    <div class="row g-1">
                                                        <div class="col-4">
                                                            <small><strong>Final P&L:</strong> <span class="text-danger">${loser.final_pnl_pct ? loser.final_pnl_pct.toFixed(1) : '0.0'}%</span></small>
                                                        </div>
                                                        <div class="col-4">
                                                            <small><strong>MFE:</strong> ${loser.mfe_pct ? loser.mfe_pct.toFixed(1) : '0.0'}%</small>
                                                        </div>
                                                        <div class="col-4">
                                                            <small><strong>MAE:</strong> ${loser.mae_pct ? loser.mae_pct.toFixed(1) : '0.0'}%</small>
                                                        </div>
                                                    </div>
                                                    ${loser.legs ? `
                                                    <div class="row g-1">
                                                        <div class="col-12">
                                                            <small><strong>Legs:</strong> <span class="text-muted">${loser.legs}</span></small>
                                                        </div>
                                                    </div>
                                                    ` : ''}
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="card border-success">
                                                <div class="card-header bg-success text-white py-1">
                                                    <h6 class="mb-0 small"><i class="fas fa-arrow-up"></i> Sample Winner</h6>
                                                </div>
                                                <div class="card-body py-2">
                                                    <div class="row g-1">
                                                        <div class="col-6">
                                                            <small><strong>Type:</strong> <span class="badge ${winner.trade_type === 'CREDIT' ? 'bg-success' : 'bg-primary'}">${winner.trade_type || 'N/A'}</span></small>
                                                        </div>
                                                        <div class="col-6">
                                                            <small><strong>P&L:</strong> <span class="text-success">$${winner.pnl ? winner.pnl.toLocaleString() : '0'}</span></small>
                                                        </div>
                                                    </div>
                                                    <div class="row g-1">
                                                        <div class="col-6">
                                                            <small><strong>Premium:</strong> $${winner.premium ? Math.abs(winner.premium).toLocaleString() : '0'}${winner.premium && winner.premium > 0 ? ' (credit)' : winner.premium && winner.premium < 0 ? ' (debit)' : ''}</small>
                                                        </div>
                                                        <div class="col-6">
                                                            <small><strong>Close:</strong> $${winner.avg_closing_cost ? Math.abs(winner.avg_closing_cost).toLocaleString() : '0'}${winner.avg_closing_cost && winner.avg_closing_cost > 0 ? ' (credit)' : winner.avg_closing_cost && winner.avg_closing_cost < 0 ? ' (debit)' : ''}</small>
                                                        </div>
                                                    </div>
                                                    <div class="row g-1">
                                                        <div class="col-6">
                                                            <small><strong>Contracts:</strong> ${winner.contracts || '0'}</small>
                                                        </div>
                                                        <div class="col-6">
                                                            <small><strong>Margin/Contract:</strong> $${winner.margin_per_contract ? winner.margin_per_contract.toLocaleString() : '0'}</small>
                                                        </div>
                                                    </div>
                                                    <div class="row g-1">
                                                        <div class="col-3">
                                                            <small><strong>Final P&L:</strong> <span class="text-success">${winner.final_pnl_pct ? winner.final_pnl_pct.toFixed(1) : '0.0'}%</span></small>
                                                        </div>
                                                        <div class="col-3">
                                                            <small><strong>MAE:</strong> ${winner.mae_pct ? winner.mae_pct.toFixed(1) : '0.0'}%</small>
                                                        </div>
                                                        <div class="col-3">
                                                            <small><strong>MFE:</strong> ${winner.mfe_pct ? winner.mfe_pct.toFixed(1) : '0.0'}%</small>
                                                        </div>
                                                        <div class="col-3">
                                                            <small><strong>Kept:</strong> ${winner.profit_kept_pct ? winner.profit_kept_pct.toFixed(1) : '0.0'}%</small>
                                                        </div>
                                                    </div>
                                                    ${winner.legs ? `
                                                    <div class="row g-1">
                                                        <div class="col-12">
                                                            <small><strong>Legs:</strong> <span class="text-muted">${winner.legs}</span></small>
                                                        </div>
                                                    </div>
                                                    ` : ''}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
            
            container.innerHTML = summaryHtml + tableHtml;
            
            // Initialize tooltips
            const tooltipTriggerList = [].slice.call(container.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
            
            // Initialize table sorting
            initializeMFEMAETableSorting();
        }

        function displayMFEMAEError(errorMessage) {
            const container = document.getElementById('mfeMaeContent');
            container.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle"></i> ${errorMessage}
                </div>
            `;
        }

        function initializeMFEMAETableSorting() {
            const table = document.getElementById('mfeMaeTable');
            if (!table) return;
            
            // Get only the second row of headers (the actual column headers)
            const headerRows = table.querySelectorAll('thead tr');
            const headers = headerRows[1].querySelectorAll('th'); // Second row has the actual column headers
            let sortDirection = {};
            
            console.log('MFE/MAE Table headers found:', headers.length);
            
            headers.forEach((header, index) => {
                const sortIcon = header.querySelector('.fa-sort');
                if (sortIcon) {
                    header.style.cursor = 'pointer';
                    header.addEventListener('click', () => {
                        console.log('Sorting column:', index, header.textContent.trim());
                        sortTable(table, index, sortDirection);
                    });
                }
            });
            
            function sortTable(table, columnIndex, sortDirection) {
                const tbody = table.querySelector('tbody');
                const rows = Array.from(tbody.querySelectorAll('tr'));
                
                // Determine sort direction
                const currentDirection = sortDirection[columnIndex] || 'asc';
                sortDirection[columnIndex] = currentDirection === 'asc' ? 'desc' : 'asc';
                
                console.log(`Sorting column ${columnIndex} in ${sortDirection[columnIndex]} direction`);
                
                // Debug: Check the first row to see what data we're working with
                if (rows.length > 0) {
                    const firstRow = rows[0];
                    console.log('First row cells:', Array.from(firstRow.cells).map((cell, idx) => `${idx}: "${cell.textContent.trim()}"`));
                }
                
                // Update sort icons
                headers.forEach((header, index) => {
                    const icon = header.querySelector('.fa-sort');
                    if (icon) {
                        if (index === columnIndex) {
                            icon.className = sortDirection[columnIndex] === 'asc' ? 'fas fa-sort-up' : 'fas fa-sort-down';
                            icon.style.opacity = '1';
                        } else {
                            icon.className = 'fas fa-sort';
                            icon.style.opacity = '0.3';
                        }
                    }
                });
                
                // Sort rows
                rows.sort((a, b) => {
                    const aCell = a.cells[columnIndex];
                    const bCell = b.cells[columnIndex];
                    
                    let aValue, bValue;
                    
                    // Handle different data types
                    if (columnIndex === 0) {
                        // Strategy name (text)
                        aValue = aCell.textContent.trim();
                        bValue = bCell.textContent.trim();
                    } else {
                        // Numeric values - extract just the number part
                        const aText = aCell.textContent.trim();
                        const bText = bCell.textContent.trim();
                        
                        // Remove % and other non-numeric characters, keep decimal point and minus sign
                        aValue = parseFloat(aText.replace(/[^\d.-]/g, '')) || 0;
                        bValue = parseFloat(bText.replace(/[^\d.-]/g, '')) || 0;
                        
                        console.log(`Column ${columnIndex}: "${aText}" -> ${aValue}, "${bText}" -> ${bValue}`);
                    }
                    
                    let result;
                    if (aValue < bValue) {
                        result = sortDirection[columnIndex] === 'asc' ? -1 : 1;
                    } else if (aValue > bValue) {
                        result = sortDirection[columnIndex] === 'asc' ? 1 : -1;
                    } else {
                        result = 0;
                    }
                    
                    console.log(`Sorting: ${aValue} vs ${bValue}, direction: ${sortDirection[columnIndex]}, result: ${result}`);
                    return result;
                });
                
                // Re-append sorted rows
                rows.forEach(row => tbody.appendChild(row));
            }
        }


        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount);
        }

        // Table sorting functionality
        function initializeTableSorting() {
            const table = document.getElementById('individualStrategyResultsTable');
            if (!table) return;
            
            const headers = table.querySelectorAll('th.sortable');
            headers.forEach(header => {
                header.style.cursor = 'pointer';
                header.addEventListener('click', () => {
                    const sortKey = header.getAttribute('data-sort');
                    const currentOrder = header.getAttribute('data-order') || 'asc';
                    const newOrder = currentOrder === 'asc' ? 'desc' : 'asc';
                    
                    // Reset all headers
                    headers.forEach(h => {
                        h.setAttribute('data-order', '');
                        const icon = h.querySelector('i');
                        if (icon) icon.className = 'fas fa-sort';
                    });
                    
                    // Set current header
                    header.setAttribute('data-order', newOrder);
                    const icon = header.querySelector('i');
                    if (icon) {
                        icon.className = newOrder === 'asc' ? 'fas fa-sort-up' : 'fas fa-sort-down';
                    }
                    
                    sortTable(table, sortKey, newOrder);
                });
            });
        }
        
        function sortTable(table, sortKey, order) {
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            
            rows.sort((a, b) => {
                let aVal, bVal;
                
                switch (sortKey) {
                    case 'strategy':
                        aVal = a.getAttribute('data-strategy').toLowerCase();
                        bVal = b.getAttribute('data-strategy').toLowerCase();
                        break;
                    case 'win_probability':
                        aVal = parseFloat(a.getAttribute('data-win-probability'));
                        bVal = parseFloat(b.getAttribute('data-win-probability'));
                        break;
                    case 'avg_pnl':
                        aVal = parseFloat(a.getAttribute('data-avg-pnl'));
                        bVal = parseFloat(b.getAttribute('data-avg-pnl'));
                        break;
                    case 'max_drawdown':
                        aVal = parseFloat(a.getAttribute('data-max-drawdown'));
                        bVal = parseFloat(b.getAttribute('data-max-drawdown'));
                        break;
                    case 'sharpe_ratio':
                        aVal = parseFloat(a.getAttribute('data-sharpe-ratio'));
                        bVal = parseFloat(b.getAttribute('data-sharpe-ratio'));
                        break;
                    case 'sortino_ratio':
                        aVal = parseFloat(a.getAttribute('data-sortino-ratio'));
                        bVal = parseFloat(b.getAttribute('data-sortino-ratio'));
                        break;
                    case 'volatility':
                        aVal = parseFloat(a.getAttribute('data-volatility'));
                        bVal = parseFloat(b.getAttribute('data-volatility'));
                        break;
                    default:
                        return 0;
                }
                
                if (order === 'asc') {
                    return aVal > bVal ? 1 : aVal < bVal ? -1 : 0;
                } else {
                    return aVal < bVal ? 1 : aVal > bVal ? -1 : 0;
                }
            });
            
            // Clear tbody and re-append sorted rows
            tbody.innerHTML = '';
            rows.forEach(row => tbody.appendChild(row));
        }

        // Monte Carlo Simulation functionality
        let currentSimulationData = null;

        function toggleStrategySelection() {
            const simulationType = document.getElementById('simulationType').value;
            const strategyDiv = document.getElementById('strategySelectionDiv');
            
            if (simulationType === 'single_strategy') {
                strategyDiv.style.display = 'block';
            } else {
                strategyDiv.style.display = 'none';
            }
        }

        function loadStrategyOptions() {
            fetch('/api/strategy-details')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.data && data.data.strategies) {
                        const strategySelect = document.getElementById('selectedStrategy');
                        if (!strategySelect) {
                            console.error('Strategy select element not found');
                            return;
                        }
                        
                        console.log('Loading strategies for Monte Carlo dropdown:', data.data.strategies);
                        strategySelect.innerHTML = '';
                        
                        data.data.strategies.forEach(strategyName => {
                            const option = document.createElement('option');
                            option.value = strategyName;
                            option.textContent = strategyName;
                            strategySelect.appendChild(option);
                        });
                        
                        console.log('Loaded', data.data.strategies.length, 'strategies for Monte Carlo dropdown');
                    } else {
                        console.error('Failed to load strategies:', data.error || 'No strategies found');
                    }
                })
                .catch(error => {
                    console.error('Error loading strategies:', error);
                });
        }

        function clearMonteCarloResults() {
            // Clear results div
            const resultsDiv = document.getElementById('monteCarloResults');
            if (resultsDiv) {
                resultsDiv.innerHTML = '';
                resultsDiv.className = '';
            }
            
            // Clear status div
            const statusDiv = document.getElementById('monteCarloStatus');
            if (statusDiv) {
                statusDiv.innerHTML = '';
            }
            
            // Charts section is now generated dynamically in the results
            
            // Clear any existing Monte Carlo charts (but not the form)
            const monteCarloChartContainer = document.getElementById('monteCarloChartContainer');
            if (monteCarloChartContainer) {
                monteCarloChartContainer.innerHTML = '';
            }
            
            // Clear simulation details section
            const detailsSection = document.getElementById('simulationDetailsSection');
            if (detailsSection) {
                detailsSection.style.display = 'none';
            }
            
            // Clear current simulation data
            currentSimulationData = null;
        }

        function runMonteCarloSimulation() {
            const simulationType = document.getElementById('simulationType').value;
            const numSimulations = parseInt(document.getElementById('numSimulations').value);
            const numTradesInput = document.getElementById('numTrades').value;
            const numTrades = numTradesInput ? parseInt(numTradesInput) : null;
            
            const statusDiv = document.getElementById('monteCarloStatus');
            const resultsDiv = document.getElementById('monteCarloResults');
            const runBtn = document.getElementById('runMonteCarloBtn');
            
            // Check if all required elements exist
            if (!statusDiv || !resultsDiv || !runBtn) {
                console.error('Monte Carlo form elements not found. Please ensure the Monte Carlo form is loaded.');
                showAlert('Monte Carlo form not properly loaded. Please try clicking the Monte Carlo button again.', 'error');
                return;
            }
            
            // Clear previous results and hide chart section
            clearMonteCarloResults();
            
            // Disable button and show status
            runBtn.disabled = true;
            statusDiv.innerHTML = '<small class="text-info">Running simulation...</small>';
            resultsDiv.className = 'alert alert-info';
            
            // Get trade size percentage (use default 10.0 for single strategy analysis)
            // Get risk-free rate
            const riskFreeRateInput = document.getElementById('riskFreeRate');
            const riskFreeRate = riskFreeRateInput ? parseFloat(riskFreeRateInput.value) : 4.0;
            
            // Prepare request body (trade size now uses historical position sizing automatically)
            const requestBody = {
                num_simulations: numSimulations,
                risk_free_rate: riskFreeRate
            };
            
            if (numTrades) {
                requestBody.num_trades = numTrades;
            }
            
            // Determine API endpoint based on simulation type
            let apiEndpoint = '/api/monte-carlo/portfolio';
            let simulationDescription = `Running ${numSimulations.toLocaleString()} simulations...`;
            
            if (simulationType === 'single_strategy') {
                const selectedStrategy = document.getElementById('selectedStrategy').value;
                if (!selectedStrategy) {
                    statusDiv.innerHTML = '<small class="text-danger">Please select a strategy</small>';
                    runBtn.disabled = false;
                    return;
                }
                apiEndpoint = `/api/monte-carlo/strategy/${encodeURIComponent(selectedStrategy)}`;
                simulationDescription = `Running ${numSimulations.toLocaleString()} simulations for strategy: ${selectedStrategy}`;
                console.log('Single strategy simulation - Strategy:', selectedStrategy, 'Endpoint:', apiEndpoint);
                console.log('URL encoded strategy:', encodeURIComponent(selectedStrategy));
            }
            
            resultsDiv.innerHTML = simulationDescription;
            
            fetch(apiEndpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestBody)
            })
            .then(response => {
                console.log('Response status:', response.status, 'URL:', apiEndpoint);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                runBtn.disabled = false;
                
                if (data.success) {
                    currentSimulationData = data.data;
                    
                    // Display results
                    displayMonteCarloResults(data.data);
                    
                    statusDiv.innerHTML = '<small class="text-success">✅ Simulation completed!</small>';
                    
                    // Charts section is now generated dynamically in the results
                    // Load the Monte Carlo chart buttons
                    loadMonteCarloChartButtons();
                    showSimulationDetailsSection();
                    
                    setTimeout(() => {
                        statusDiv.innerHTML = '';
                    }, 3000);
                } else {
                    statusDiv.innerHTML = `<small class="text-danger">❌ ${data.error}</small>`;
                    resultsDiv.className = 'alert alert-danger';
                    resultsDiv.innerHTML = `Simulation failed: ${data.error}`;
                }
            })
            .catch(error => {
                runBtn.disabled = false;
                console.error('Monte Carlo simulation error:', error);
                console.error('Error details:', {
                    message: error.message,
                    stack: error.stack,
                    endpoint: apiEndpoint
                });
                statusDiv.innerHTML = '<small class="text-danger">❌ Simulation failed</small>';
                resultsDiv.className = 'alert alert-danger';
                resultsDiv.innerHTML = `Error: ${error.message}`;
            });
        }

        function formatRiskRatios(riskRatios) {
            const ratioDescriptions = {
                'sharpe_ratio': 'Sharpe Ratio (risk-adjusted return)',
                'sortino_ratio': 'Sortino Ratio (downside risk-adjusted)',
                'mar_ratio': 'MAR (Maximum Adverse Return)',
                'information_ratio': 'Information Ratio (vs benchmark)',
                'return_to_risk': 'Return to Risk Ratio'
            };
            
            let html = '';
            Object.entries(riskRatios).forEach(([key, value]) => {
                if (value !== undefined && key in ratioDescriptions) {
                    let formattedValue;
                    let colorClass = 'text-muted';
                    
                    if (value === Infinity || value === -Infinity || value === null) {
                        formattedValue = '∞';
                        colorClass = 'text-success';
                    } else if (typeof value === 'number' && !isNaN(value)) {
                        formattedValue = value.toFixed(2);
                        
                        // Color coding based on ratio quality
                        if (key === 'sharpe_ratio') {
                            if (value > 2) colorClass = 'text-success';
                            else if (value > 1) colorClass = 'text-warning';
                            else if (value > 0) colorClass = 'text-info';
                        } else if (key === 'sortino_ratio') {
                            if (value > 3) colorClass = 'text-success';
                            else if (value > 2) colorClass = 'text-warning';
                            else if (value > 1) colorClass = 'text-info';
                        } else if (key === 'mar_ratio') {
                            if (value > 1) colorClass = 'text-success';
                            else if (value > 0.5) colorClass = 'text-warning';
                            else if (value > 0) colorClass = 'text-info';
                        } else if (key === 'information_ratio') {
                            if (value > 1) colorClass = 'text-success';
                            else if (value > 0.5) colorClass = 'text-warning';
                            else if (value > 0) colorClass = 'text-info';
                        } else if (key === 'return_to_risk') {
                            if (value > 2) colorClass = 'text-success';
                            else if (value > 1) colorClass = 'text-warning';
                            else if (value > 0) colorClass = 'text-info';
                        }
                    } else {
                        formattedValue = 'N/A';
                    }
                    
                    html += `• <span class="${colorClass}">${ratioDescriptions[key]}: ${formattedValue}</span><br>`;
                }
            });
            
            if (html === '') {
                html = '<span class="text-muted">Risk ratios not available</span>';
            }
            
            return html;
        }

        function formatTTestResults(tTestResults) {
            const testDescriptions = {
                'profitability': 'Profitability Test',
                'outperform_initial': 'Outperform Initial Balance Test',
                'positive_returns': 'Positive Returns Test',
                'vs_risk_free': 'Risk-Free Rate Comparison Test',
                'consistency': 'Consistency Test'
            };
            
            const testIcons = {
                'profitability': 'fas fa-chart-line',
                'outperform_initial': 'fas fa-trophy',
                'positive_returns': 'fas fa-arrow-up',
                'vs_risk_free': 'fas fa-percentage',
                'consistency': 'fas fa-balance-scale'
            };
            
            let html = '<div class="row">';
            Object.entries(tTestResults).forEach(([key, result]) => {
                if (result !== null && result !== undefined) {
                    const tStat = result.t_statistic;
                    const pVal = result.p_value;
                    const df = result.degrees_of_freedom;
                    const interpretation = result.interpretation;
                    
                    // Color coding based on significance
                    let badgeClass = 'bg-secondary';
                    if (pVal < 0.001) badgeClass = 'bg-success';
                    else if (pVal < 0.01) badgeClass = 'bg-success';
                    else if (pVal < 0.05) badgeClass = 'bg-warning';
                    else if (pVal < 0.1) badgeClass = 'bg-info';
                    
                    // Significance indicators
                    const significance = pVal < 0.001 ? '***' : pVal < 0.01 ? '**' : pVal < 0.05 ? '*' : '';
                    
                    html += `
                        <div class="col-md-6 mb-3">
                            <div class="card bg-dark border-secondary">
                                <div class="card-header bg-secondary">
                                    <h6 class="mb-0"><i class="${testIcons[key] || 'fas fa-chart-bar'}"></i> ${testDescriptions[key] || key}</h6>
                                </div>
                                <div class="card-body">
                                    <p class="card-text"><strong>Hypothesis:</strong> ${result.hypothesis}</p>
                                    <p class="card-text"><strong>Test Statistic:</strong> t(${df}) = ${tStat.toFixed(3)}</p>
                                    <p class="card-text"><strong>P-Value:</strong> <span class="badge ${badgeClass}">${pVal < 0.001 ? '< 0.001' : pVal.toFixed(3)}${significance}</span></p>
                                    <p class="card-text"><strong>Result:</strong> ${interpretation}</p>
                                </div>
                            </div>
                        </div>
                    `;
                }
            });
            html += '</div>';
            
            if (html === '<div class="row"></div>') {
                html = '<span class="text-muted">T-test results not available (insufficient data or scipy not available)</span>';
            }
            
            return html;
        }

        function formatPValues(pValues) {
            const pValueDescriptions = {
                'profitability': 'Strategy is profitable (mean P&L > 0)',
                'outperform_initial': 'Strategy outperforms initial balance',
                'sharpe_ratio': 'Sharpe ratio is significantly positive',
                'drawdown_risk': 'Strategy has significant drawdown risk',
                'consistency': 'Strategy has consistent returns (low variance)'
            };
            
            const pValueIcons = {
                'profitability': 'fas fa-chart-line',
                'outperform_initial': 'fas fa-trophy',
                'sharpe_ratio': 'fas fa-chart-area',
                'drawdown_risk': 'fas fa-arrow-down',
                'consistency': 'fas fa-balance-scale'
            };
            
            const pValueExplanations = {
                'profitability': {
                    title: 'Strategy is profitable (mean P&L > 0)',
                    what: 'Tests whether your average trade makes money',
                    how: 'Compares your mean P&L to zero using a t-test',
                    interpretation: 'Low p-value means your profits are statistically significant, not just luck',
                    confidence: 'Confirms your strategy has a genuine positive edge'
                },
                'outperform_initial': {
                    title: 'Strategy outperforms initial balance',
                    what: 'Tests whether your final balance is significantly higher than starting balance',
                    how: 'Compares your ending balance to initial balance using statistical analysis',
                    interpretation: 'Low p-value means your growth is statistically significant',
                    confidence: 'Confirms your strategy genuinely grows your account over time'
                },
                'sharpe_ratio': {
                    title: 'Sharpe ratio is significantly positive',
                    what: 'Tests whether your risk-adjusted returns beat the risk-free rate',
                    how: 'Compares your Sharpe ratio to zero using statistical significance testing',
                    interpretation: 'Low p-value means your risk-adjusted performance is statistically significant',
                    confidence: 'Confirms your strategy beats risk-free investments after adjusting for volatility'
                },
                'drawdown_risk': {
                    title: 'Strategy has significant drawdown risk',
                    what: 'Tests whether your maximum drawdowns are statistically significant',
                    how: 'Analyzes the variance and magnitude of your drawdown periods',
                    interpretation: 'Low p-value means your drawdowns are a real feature, not random',
                    confidence: 'Confirms drawdown risk is a genuine characteristic of your strategy'
                },
                'consistency': {
                    title: 'Strategy has consistent returns (low variance)',
                    what: 'Tests whether your returns have low variability (are consistent)',
                    how: 'Analyzes the variance of your returns compared to a benchmark',
                    interpretation: 'Low p-value means your consistency is statistically significant',
                    confidence: 'Confirms your strategy produces reliable, predictable returns'
                }
            };
            
            let html = '<div class="row">';
            Object.entries(pValues).forEach(([key, value]) => {
                if (value !== null && value !== undefined) {
                    const significance = value < 0.001 ? '***' : value < 0.01 ? '**' : value < 0.05 ? '*' : '';
                    const badgeClass = value < 0.05 ? 'bg-success' : value < 0.1 ? 'bg-warning' : 'bg-secondary';
                    const formattedValue = value < 0.001 ? '< 0.001' : value.toFixed(3);
                    const explanation = pValueExplanations[key] || {};
                    
                    html += `
                        <div class="col-md-6 mb-3">
                            <div class="card bg-dark border-secondary">
                                <div class="card-header bg-secondary">
                                    <h6 class="mb-0"><i class="${pValueIcons[key] || 'fas fa-chart-bar'}"></i> ${explanation.title || pValueDescriptions[key] || key}</h6>
                                </div>
                                <div class="card-body">
                                    <p class="card-text"><strong>P-Value:</strong> <span class="badge ${badgeClass}">${formattedValue}${significance}</span></p>
                                    <p class="card-text"><small class="text-muted">${value < 0.05 ? 'Statistically significant' : value < 0.1 ? 'Marginally significant' : 'Not statistically significant'}</small></p>
                                    
                                    <hr class="my-2">
                                    
                                    <div class="mt-2">
                                        <p class="card-text"><strong>What it tests:</strong> ${explanation.what || 'Statistical significance of this metric'}</p>
                                        <p class="card-text"><strong>How it works:</strong> ${explanation.how || 'Uses statistical analysis to determine significance'}</p>
                                        <p class="card-text"><strong>What this means:</strong> ${explanation.interpretation || 'Low p-value indicates statistical significance'}</p>
                                        <p class="card-text"><strong>Your confidence:</strong> <span class="text-success">${explanation.confidence || 'This result is statistically reliable'}</span></p>
                                    </div>
                                    
                                    <div class="mt-2">
                                        <small class="text-muted">
                                            <strong>P-Value Scale:</strong><br>
                                            <span class="text-success">• < 0.001 (***): 99.9% confident - Extremely significant</span><br>
                                            <span class="text-success">• < 0.01 (**): 99% confident - Very significant</span><br>
                                            <span class="text-warning">• < 0.05 (*): 95% confident - Significant</span><br>
                                            <span class="text-secondary">• > 0.05: Not significant - Could be random</span>
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }
            });
            html += '</div>';
            
            if (html === '<div class="row"></div>') {
                html = '<span class="text-muted">P-values not available (insufficient data or scipy not available)</span>';
            }
            
            return html;
        }

        function displayMonteCarloResults(simulationData) {
            const resultsDiv = document.getElementById('monteCarloResults');
            
            if (!resultsDiv) {
                console.error('Monte Carlo results div not found. Make sure the Monte Carlo form is loaded.');
                return;
            }
            
            const summary = simulationData.simulation_summary;
            const balanceStats = simulationData.final_balance_stats;
            const probabilities = simulationData.probabilities;
            const drawdownStats = simulationData.drawdown_stats;
            const riskRatios = simulationData.risk_ratios || {};
            const tTestResults = simulationData.t_test_results || {};
            const pValues = simulationData.p_values || {};
            
            // Get the trade size from the user's input (not from simulation results)
            // Trade size now uses historical position sizing automatically
            
            resultsDiv.className = 'alert alert-success';
            resultsDiv.innerHTML = `
                <h6><strong>Simulation Summary</strong></h6>
                <div class="row">
                    <div class="col-md-6">
                        <strong>Simulation Parameters:</strong><br>
                        • <span class="custom-tooltip" data-tooltip="Number of Monte Carlo simulation runs performed to generate statistical results">${summary.num_simulations.toLocaleString()} simulations</span><br>
                        • <span class="custom-tooltip" data-tooltip="Number of trades randomly sampled in each simulation run">${summary.num_trades_per_sim.toLocaleString()} trades per simulation</span><br>
                        • <span class="custom-tooltip" data-tooltip="Uses historical position sizing from the original data">Trade size: Historical position sizing</span><br>
                        • <span class="custom-tooltip" data-tooltip="Initial account balance used as starting point for all simulations">Starting balance: $${summary.initial_balance.toLocaleString()}</span><br>
                        • <span class="custom-tooltip" data-tooltip="Actual final balance achieved in your historical trading data">Historical final balance: $${(summary.historical_final_balance || summary.historical_pnl || 0).toLocaleString()}</span>
                    </div>
                    <div class="col-md-6">
                        <strong>Outcome Probabilities:</strong><br>
                        • <span class="custom-tooltip" data-tooltip="Percentage of simulations that ended with positive total P&L">Win probability: ${probabilities.win_probability.toFixed(1)}%</span><br>
                        • <span class="custom-tooltip" data-tooltip="Percentage of simulations that ended with negative total P&L">Loss probability: ${probabilities.loss_probability.toFixed(1)}%</span><br>
                        • <span class="custom-tooltip" data-tooltip="Percentage of simulations that ended with zero or near-zero total P&L">Break-even probability: ${probabilities.break_even_probability.toFixed(1)}%</span>
                    </div>
                </div>
                <hr>
                <div class="row">
                    <div class="col-md-6">
                        <strong>Final Balance Statistics:</strong><br>
                        • <span class="custom-tooltip" data-tooltip="Average final account balance across all simulation runs">Mean: $${(balanceStats.mean || 0).toLocaleString()}</span><br>
                        • <span class="custom-tooltip" data-tooltip="Middle value when all final balances are sorted (50% above, 50% below)">Median: $${(balanceStats.median || 0).toLocaleString()}</span><br>
                        • <span class="custom-tooltip" data-tooltip="95% of simulations achieved this balance or lower (optimistic scenario)">Best case (95th percentile): $${(balanceStats.percentiles?.p95 || 0).toLocaleString()}</span><br>
                        • <span class="custom-tooltip" data-tooltip="5% of simulations achieved this balance or lower (pessimistic scenario)">Worst case (5th percentile): $${(balanceStats.percentiles?.p5 || 0).toLocaleString()}</span>
                    </div>
                    <div class="col-md-6">
                        <strong>Risk Metrics:</strong><br>
                        • <span class="custom-tooltip" data-tooltip="Average maximum drawdown (peak-to-trough decline) across all simulations">Average max drawdown: $${Math.abs(drawdownStats.mean || 0).toLocaleString()}</span><br>
                        • <span class="custom-tooltip" data-tooltip="Worst maximum drawdown experienced in any single simulation">Worst case drawdown: $${Math.abs(drawdownStats.max || 0).toLocaleString()}</span><br>
                        • <span class="custom-tooltip" data-tooltip="Standard deviation of final balances - measures consistency of outcomes">Standard deviation: $${(balanceStats.std || 0).toLocaleString()}</span>
                    </div>
                </div>
                <hr>
                <div class="row">
                    <div class="col-12">
                        <h6><strong>📈 Monte Carlo Charts</strong></h6>
                        <div id="monteCarloChartButtons">
                            <!-- Monte Carlo chart buttons will be populated by JavaScript -->
                        </div>
                        <div class="card mt-3" id="monteCarloChartCard" style="display: none;">
                            <div class="card-body">
                                <div id="monteCarloChartContainer" class="chart-container">
                                    <!-- Monte Carlo charts will be displayed here -->
                                </div>
                                <div id="monteCarloChartLoading" class="loading">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading chart...</span>
                                    </div>
                                    <p class="mt-2">Loading chart...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <hr>
                <div class="row">
                    <div class="col-12">
                        <h6><strong>📊 Risk Ratio Explanations</strong></h6>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card bg-dark border-secondary mb-3">
                                    <div class="card-header bg-secondary">
                                        <h6 class="mb-0"><i class="fas fa-chart-line"></i> Sharpe Ratio: ${riskRatios.sharpe_ratio?.toFixed(2) || 'N/A'}</h6>
                                    </div>
                                    <div class="card-body">
                                        <p class="card-text"><strong>Formula:</strong> (Annual Return - Risk-Free Rate) ÷ Annual Volatility</p>
                                        <p class="card-text"><strong>Calculation:</strong> (${riskRatios.mean_return_pct?.toFixed(2) || 'N/A'}% - ${document.getElementById('riskFreeRate')?.value || '4.0'}%) ÷ ${riskRatios.std_return_pct?.toFixed(2) || 'N/A'}% = ${riskRatios.sharpe_ratio?.toFixed(2) || 'N/A'}</p>
                                        <p class="card-text"><strong>What it measures:</strong> Risk-adjusted return per unit of total risk (volatility)</p>
                                        <p class="card-text"><strong>Your Result:</strong> <span class="badge ${riskRatios.sharpe_ratio >= 2.0 ? 'bg-success' : riskRatios.sharpe_ratio >= 1.0 ? 'bg-info' : riskRatios.sharpe_ratio >= 0.5 ? 'bg-warning' : 'bg-danger'}">${riskRatios.sharpe_ratio?.toFixed(2) || 'N/A'}</span></p>
                                        <p class="card-text"><strong>Interpretation:</strong></p>
                                        <ul class="mb-0">
                                            <li><span class="text-success">> 2.0:</span> Excellent risk-adjusted performance</li>
                                            <li><span class="text-info">1.0 - 2.0:</span> Good risk-adjusted performance</li>
                                            <li><span class="text-warning">0.5 - 1.0:</span> Acceptable risk-adjusted performance</li>
                                            <li><span class="text-danger">< 0.5:</span> Poor risk-adjusted performance</li>
                                        </ul>
                                        <p class="card-text mt-2"><small class="text-muted">Higher is better. Compares your returns to a risk-free investment (like Treasury bills) and adjusts for volatility.</small></p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card bg-dark border-secondary mb-3">
                                    <div class="card-header bg-secondary">
                                        <h6 class="mb-0"><i class="fas fa-shield-alt"></i> Sortino Ratio: ${riskRatios.sortino_ratio?.toFixed(2) || 'N/A'}</h6>
                                    </div>
                                    <div class="card-body">
                                        <p class="card-text"><strong>Formula:</strong> (Annual Return - Risk-Free Rate) ÷ Downside Deviation</p>
                                        <p class="card-text"><strong>Calculation:</strong> (${riskRatios.mean_return_pct?.toFixed(2) || 'N/A'}% - ${document.getElementById('riskFreeRate')?.value || '4.0'}%) ÷ ${riskRatios.downside_deviation_pct?.toFixed(2) || 'N/A'}% = ${riskRatios.sortino_ratio?.toFixed(2) || 'N/A'}</p>
                                        <p class="card-text"><strong>What it measures:</strong> Risk-adjusted return per unit of downside risk (only negative volatility)</p>
                                        <p class="card-text"><strong>Your Result:</strong> <span class="badge ${riskRatios.sortino_ratio >= 2.0 ? 'bg-success' : riskRatios.sortino_ratio >= 1.0 ? 'bg-info' : riskRatios.sortino_ratio >= 0.5 ? 'bg-warning' : 'bg-danger'}">${riskRatios.sortino_ratio?.toFixed(2) || 'N/A'}</span></p>
                                        <p class="card-text"><strong>Interpretation:</strong></p>
                                        <ul class="mb-0">
                                            <li><span class="text-success">> 2.0:</span> Excellent downside protection</li>
                                            <li><span class="text-info">1.0 - 2.0:</span> Good downside protection</li>
                                            <li><span class="text-warning">0.5 - 1.0:</span> Acceptable downside protection</li>
                                            <li><span class="text-danger">< 0.5:</span> Poor downside protection</li>
                                        </ul>
                                        <p class="card-text mt-2"><small class="text-muted">Higher is better. Focuses only on negative returns (downside risk) rather than all volatility. More relevant for risk-averse investors.</small></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card bg-dark border-secondary mb-3">
                                    <div class="card-header bg-secondary">
                                        <h6 class="mb-0"><i class="fas fa-chart-area"></i> MAR: ${riskRatios.mar_ratio?.toFixed(2) || 'N/A'}</h6>
                                    </div>
                                    <div class="card-body">
                                        <p class="card-text"><strong>Formula:</strong> Annual Return ÷ Maximum Drawdown</p>
                                        <p class="card-text"><strong>Calculation:</strong> ${riskRatios.mean_return_pct?.toFixed(2) || 'N/A'}% ÷ ${riskRatios.mean_max_drawdown_pct?.toFixed(2) || 'N/A'}% = ${riskRatios.mar_ratio?.toFixed(2) || 'N/A'}</p>
                                        <p class="card-text"><strong>What it measures:</strong> Return per unit of maximum drawdown risk</p>
                                        <p class="card-text"><strong>Your Result:</strong> <span class="badge ${riskRatios.mar_ratio >= 1.0 ? 'bg-success' : riskRatios.mar_ratio >= 0.5 ? 'bg-info' : riskRatios.mar_ratio >= 0.25 ? 'bg-warning' : 'bg-danger'}">${riskRatios.mar_ratio?.toFixed(2) || 'N/A'}</span></p>
                                        <p class="card-text"><strong>Interpretation:</strong></p>
                                        <ul class="mb-0">
                                            <li><span class="text-success">> 1.0:</span> Excellent drawdown-adjusted performance</li>
                                            <li><span class="text-info">0.5 - 1.0:</span> Good drawdown-adjusted performance</li>
                                            <li><span class="text-warning">0.25 - 0.5:</span> Acceptable drawdown-adjusted performance</li>
                                            <li><span class="text-danger">< 0.25:</span> Poor drawdown-adjusted performance</li>
                                        </ul>
                                        <p class="card-text mt-2"><small class="text-muted">Higher is better. Shows how much return you get for each unit of maximum drawdown risk.</small></p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card bg-dark border-secondary mb-3">
                                    <div class="card-header bg-secondary">
                                        <h6 class="mb-0"><i class="fas fa-info-circle"></i> Information Ratio: ${riskRatios.information_ratio?.toFixed(2) || 'N/A'}</h6>
                                    </div>
                                    <div class="card-body">
                                        <p class="card-text"><strong>Formula:</strong> (Strategy Return - Benchmark Return) ÷ Tracking Error</p>
                                        <p class="card-text"><strong>Calculation:</strong> (${riskRatios.mean_return_pct?.toFixed(2) || 'N/A'}% - ${document.getElementById('riskFreeRate')?.value || '4.0'}%) ÷ ${riskRatios.std_return_pct?.toFixed(2) || 'N/A'}% = ${riskRatios.information_ratio?.toFixed(2) || 'N/A'}</p>
                                        <p class="card-text"><strong>What it measures:</strong> Consistency of outperformance vs benchmark</p>
                                        <p class="card-text"><strong>Your Result:</strong> <span class="badge ${riskRatios.information_ratio >= 0.5 ? 'bg-success' : riskRatios.information_ratio >= 0.25 ? 'bg-info' : riskRatios.information_ratio >= 0.1 ? 'bg-warning' : 'bg-danger'}">${riskRatios.information_ratio?.toFixed(2) || 'N/A'}</span></p>
                                        <p class="card-text"><strong>Interpretation:</strong></p>
                                        <ul class="mb-0">
                                            <li><span class="text-success">> 0.5:</span> Excellent consistency</li>
                                            <li><span class="text-info">0.25 - 0.5:</span> Good consistency</li>
                                            <li><span class="text-warning">0.1 - 0.25:</span> Acceptable consistency</li>
                                            <li><span class="text-danger">< 0.1:</span> Poor consistency</li>
                                        </ul>
                                        <p class="card-text mt-2"><small class="text-muted">Higher is better. Measures how consistently the strategy outperforms its benchmark.</small></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="alert alert-info">
                            <h6><i class="fas fa-lightbulb"></i> Key Differences:</h6>
                            <ul class="mb-0">
                                <li><strong>Sharpe Ratio:</strong> Uses total volatility (both positive and negative price movements)</li>
                                <li><strong>Sortino Ratio:</strong> Uses only downside deviation (negative price movements)</li>
                                <li><strong>MAR (Maximum Adverse Return):</strong> Focuses on maximum drawdown as the risk measure</li>
                                <li><strong>Information Ratio:</strong> Measures consistency vs a benchmark (typically risk-free rate)</li>
                                <li><strong>When to use:</strong> Sortino is better for strategies with asymmetric returns (more upside than downside volatility)</li>
                                <li><strong>Risk-free rate:</strong> All ratios subtract the risk-free rate (2% annual) to show excess returns above a safe investment</li>
                            </ul>
                        </div>
                    </div>
                </div>
                <hr>
                <div class="row">
                    <div class="col-12">
                        <strong><span class="custom-tooltip" data-tooltip="Risk-adjusted performance metrics that compare returns to the risk taken to achieve them">Risk-Adjusted Performance Ratios:</span></strong><br>
                        <small class="text-muted">Higher ratios indicate better risk-adjusted returns.</small><br>
                        ${formatRiskRatios(riskRatios)}
                    </div>
                </div>
                <hr>
                <div class="row">
                    <div class="col-12">
                        <strong><span class="custom-tooltip" data-tooltip="Statistical tests that determine if the observed performance is significantly different from zero or random chance">T-Test Statistical Analysis:</span></strong><br>
                        <small class="text-muted">T-tests validate statistical significance of performance metrics.</small><br>
                        ${formatTTestResults(tTestResults)}
                    </div>
                </div>
                <hr>
                <div class="row">
                    <div class="col-12">
                        <strong><span class="custom-tooltip" data-tooltip="Probability that the observed results occurred by random chance - lower values indicate stronger statistical evidence">Statistical Significance (P-Values):</span></strong><br>
                        <small class="text-muted">Lower p-values indicate stronger statistical evidence. Values &lt; 0.05 are typically considered significant.</small><br>
                        ${formatPValues(pValues)}
                    </div>
                </div>
            `;
            
            // Initialize tooltips and sorting after content is rendered
            setTimeout(() => {
                initializeCustomTooltips();
                initializeTableSorting();
            }, 100);
        }

        function displayAllStrategiesResults(data) {
            const resultsDiv = document.getElementById('monteCarloResults');
            
            if (!resultsDiv) {
                console.error('Monte Carlo results div not found. Make sure the Monte Carlo form is loaded.');
                return;
            }
            
            resultsDiv.className = 'alert alert-success';
            
            const fragilityAnalysis = data.fragility_analysis || {};
            const strategyResults = data.strategy_results || {};
            const summary = data.summary || {};
            
            // Get the trade size from the simulation results (this will be the actual value used)
            // Trade size now uses historical position sizing automatically
            
            let html = `
                <div class="row">
                    <div class="col-12">
                        <h6><i class="fas fa-chart-line"></i> Strategy Fragility Analysis</h6>
                        <p class="text-muted"><strong>Trade Size:</strong> Historical position sizing</p>
                        <p class="text-muted">Analysis of ${summary.total_strategies || 0} strategies with ${summary.num_simulations_per_strategy || 0} simulations each</p>
                    </div>
                </div>
                <hr>
            `;
            
            // Sharpe Ratio Ranking
            if (fragilityAnalysis.sharpe_ranking && fragilityAnalysis.sharpe_ranking.length > 0) {
                html += `
                    <div class="row">
                        <div class="col-md-6">
                            <h6><i class="fas fa-chart-line"></i> Sharpe Ratio Ranking</h6>
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Rank</th>
                                            <th>Strategy</th>
                                            <th>Sharpe Ratio</th>
                                            <th>Quality</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                `;
                
                fragilityAnalysis.sharpe_ranking.forEach(([strategyName, sharpe], index) => {
                    const quality = sharpe > 2 ? 'Excellent' : sharpe > 1 ? 'Good' : sharpe > 0 ? 'Fair' : 'Poor';
                    const qualityClass = sharpe > 2 ? 'success' : sharpe > 1 ? 'primary' : sharpe > 0 ? 'warning' : 'danger';
                    
                    html += `
                        <tr>
                            <td>${index + 1}</td>
                            <td><strong>${strategyName}</strong></td>
                            <td>${sharpe.toFixed(2)}</td>
                            <td><span class="badge bg-${qualityClass}">${quality}</span></td>
                        </tr>
                    `;
                });
                
                html += `
                                    </tbody>
                                </table>
                            </div>
                        </div>
                `;
            }
            
            // Sortino Ratio Ranking
            if (fragilityAnalysis.sortino_ranking && fragilityAnalysis.sortino_ranking.length > 0) {
                html += `
                        <div class="col-md-6">
                            <h6><i class="fas fa-shield-alt"></i> Sortino Ratio Ranking</h6>
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Rank</th>
                                            <th>Strategy</th>
                                            <th>Sortino Ratio</th>
                                            <th>Quality</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                `;
                
                fragilityAnalysis.sortino_ranking.forEach(([strategyName, sortino], index) => {
                    // Handle null values (representing infinity) as perfect
                    const quality = sortino === null ? 'Perfect' : sortino > 2 ? 'Excellent' : sortino > 1 ? 'Good' : sortino > 0 ? 'Fair' : 'Poor';
                    const qualityClass = sortino === null ? 'success' : sortino > 2 ? 'success' : sortino > 1 ? 'primary' : sortino > 0 ? 'warning' : 'danger';
                    
                    html += `
                        <tr>
                            <td>${index + 1}</td>
                            <td><strong>${strategyName}</strong></td>
                            <td>${sortino !== null ? sortino.toFixed(2) : '∞'}</td>
                            <td><span class="badge bg-${qualityClass}">${quality}</span></td>
                        </tr>
                    `;
                });
                
                html += `
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <hr>
                `;
            }
            
            // Individual Strategy Results Summary
            html += `
                <div class="row">
                    <div class="col-12">
                        <h6><i class="fas fa-list"></i> Individual Strategy Results</h6>
                        <div class="table-responsive">
                            <table class="table table-sm" id="individualStrategyResultsTable">
                                <thead>
                                    <tr>
                                        <th class="custom-tooltip sortable" data-tooltip="Trading strategy name" data-sort="strategy">Strategy <i class="fas fa-sort"></i></th>
                                        <th class="custom-tooltip sortable" data-tooltip="Percentage of Monte Carlo simulations where the strategy ended up profitable overall after running the full number of trades" data-sort="win_probability">Win Probability <i class="fas fa-sort"></i></th>
                                        <th class="custom-tooltip sortable" data-tooltip="Average profit/loss per lot per trade from Monte Carlo simulation results" data-sort="avg_pnl">Avg P&L/Lot <i class="fas fa-sort"></i></th>
                                        <th class="custom-tooltip sortable" data-tooltip="Maximum drawdown per lot per trade from Monte Carlo simulation results" data-sort="max_drawdown">Max Drawdown/Lot <i class="fas fa-sort"></i></th>
                                        <th class="custom-tooltip sortable" data-tooltip="Risk-adjusted return ratio: (Mean Return - Risk-free Rate) / Standard Deviation of Returns" data-sort="sharpe_ratio">Sharpe Ratio <i class="fas fa-sort"></i></th>
                                        <th class="custom-tooltip sortable" data-tooltip="Downside risk-adjusted return ratio: (Mean Return - Risk-free Rate) / Downside Deviation (only considers negative returns)" data-sort="sortino_ratio">Sortino Ratio <i class="fas fa-sort"></i></th>
                                        <th class="custom-tooltip sortable" data-tooltip="Standard deviation of per-lot P&L per trade from Monte Carlo simulation results - measures consistency of trade outcomes" data-sort="volatility">Volatility/Lot <i class="fas fa-sort"></i></th>
                                    </tr>
                                </thead>
                                <tbody>
            `;
            
            Object.entries(strategyResults).forEach(([strategyName, results]) => {
                const winProb = results.probabilities?.win_probability || 0;
                const avgPnl = results.pnl_stats?.mean || 0;
                const maxDD = results.drawdown_stats?.max || 0;
                const sharpe = results.risk_ratios?.sharpe_ratio || 0;
                const sortino = results.risk_ratios?.sortino_ratio || 0;
                const volatility = results.pnl_stats?.std || 0;
                
                const winProbClass = winProb > 60 ? 'success' : winProb > 40 ? 'warning' : 'danger';
                const sharpeClass = sharpe > 1 ? 'success' : sharpe > 0 ? 'warning' : 'danger';
                const sortinoClass = sortino === null ? 'success' : sortino > 2 ? 'success' : sortino > 1 ? 'primary' : sortino > 0 ? 'warning' : 'danger';
                
                html += `
                    <tr data-strategy="${strategyName}" data-win-probability="${winProb}" data-avg-pnl="${avgPnl}" data-max-drawdown="${maxDD}" data-sharpe-ratio="${sharpe || 0}" data-sortino-ratio="${sortino || 0}" data-volatility="${volatility}">
                        <td><strong>${strategyName}</strong></td>
                        <td><span class="badge bg-${winProbClass}">${winProb.toFixed(1)}%</span></td>
                        <td>${formatCurrency(avgPnl)}</td>
                        <td>${formatCurrency(maxDD)}</td>
                        <td><span class="badge bg-${sharpeClass}">${sharpe !== null ? sharpe.toFixed(2) : 'N/A'}</span></td>
                        <td><span class="badge bg-${sortinoClass}">${sortino === null ? '∞' : sortino !== null ? sortino.toFixed(2) : 'N/A'}</span></td>
                        <td>${formatCurrency(volatility)}</td>
                    </tr>
                `;
            });
            
            html += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <hr>
            `;
            
            // Fragility Metrics
            if (fragilityAnalysis.win_probability_range) {
                const wpRange = fragilityAnalysis.win_probability_range;
                html += `
                    <div class="row">
                        <div class="col-md-6">
                            <h6><i class="fas fa-percentage"></i> Win Probability Range</h6>
                            <p><strong>Min:</strong> ${wpRange.min.toFixed(1)}% | <strong>Max:</strong> ${wpRange.max.toFixed(1)}%</p>
                            <p><strong>Variation:</strong> ${wpRange.coefficient_of_variation.toFixed(2)}</p>
                        </div>
                `;
            }
            
            if (fragilityAnalysis.drawdown_range) {
                const ddRange = fragilityAnalysis.drawdown_range;
                html += `
                        <div class="col-md-6">
                            <h6><i class="fas fa-arrow-down"></i> Drawdown Range</h6>
                            <p><strong>Min:</strong> ${formatCurrency(ddRange.min)} | <strong>Max:</strong> ${formatCurrency(ddRange.max)}</p>
                            <p><strong>Variation:</strong> ${ddRange.coefficient_of_variation.toFixed(2)}</p>
                        </div>
                `;
            }
            
            html += `
                    </div>
                    <div class="row mt-3">
                        <div class="col-12">
                            <div class="alert alert-info">
                                <h6><i class="fas fa-lightbulb"></i> Interpretation Guide</h6>
                                <ul class="mb-0">
                                    <li><strong>Sharpe Ratio:</strong> Risk-adjusted return (return per unit of total risk). Higher is better. >2 = Excellent, >1 = Good, >0 = Fair</li>
                                    <li><strong>Sortino Ratio:</strong> Risk-adjusted return focusing only on downside risk. Higher is better. >2 = Excellent, >1 = Good, >0 = Fair</li>
                                    <li><strong>High Win Probability:</strong> Strategy wins most of the time, but check drawdowns for tail risk</li>
                                    <li><strong>High Volatility:</strong> Strategy has large swings in performance</li>
                                    <li><strong>High Drawdown:</strong> Strategy can experience significant losses when wrong</li>
                                    <li><strong>High Variation:</strong> Strategies perform very differently from each other</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
                <hr>
                <div class="row">
                    <div class="col-12">
                        <h6><strong>📊 Risk Ratio Explanations</strong></h6>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card bg-dark border-secondary mb-3">
                                    <div class="card-header bg-secondary">
                                        <h6 class="mb-0"><i class="fas fa-chart-line"></i> Sharpe Ratio: ${riskRatios.sharpe_ratio?.toFixed(2) || 'N/A'}</h6>
                                    </div>
                                    <div class="card-body">
                                        <p class="card-text"><strong>Formula:</strong> (Annual Return - Risk-Free Rate) ÷ Annual Volatility</p>
                                        <p class="card-text"><strong>Calculation:</strong> (${riskRatios.mean_return_pct?.toFixed(2) || 'N/A'}% - ${document.getElementById('riskFreeRate')?.value || '4.0'}%) ÷ ${riskRatios.std_return_pct?.toFixed(2) || 'N/A'}% = ${riskRatios.sharpe_ratio?.toFixed(2) || 'N/A'}</p>
                                        <p class="card-text"><strong>What it measures:</strong> Risk-adjusted return per unit of total risk (volatility)</p>
                                        <p class="card-text"><strong>Your Result:</strong> <span class="badge ${riskRatios.sharpe_ratio >= 2.0 ? 'bg-success' : riskRatios.sharpe_ratio >= 1.0 ? 'bg-info' : riskRatios.sharpe_ratio >= 0.5 ? 'bg-warning' : 'bg-danger'}">${riskRatios.sharpe_ratio?.toFixed(2) || 'N/A'}</span></p>
                                        <p class="card-text"><strong>Interpretation:</strong></p>
                                        <ul class="mb-0">
                                            <li><span class="text-success">> 2.0:</span> Excellent risk-adjusted performance</li>
                                            <li><span class="text-info">1.0 - 2.0:</span> Good risk-adjusted performance</li>
                                            <li><span class="text-warning">0.5 - 1.0:</span> Acceptable risk-adjusted performance</li>
                                            <li><span class="text-danger">< 0.5:</span> Poor risk-adjusted performance</li>
                                        </ul>
                                        <p class="card-text mt-2"><small class="text-muted">Higher is better. Compares your returns to a risk-free investment (like Treasury bills) and adjusts for volatility.</small></p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card bg-dark border-secondary mb-3">
                                    <div class="card-header bg-secondary">
                                        <h6 class="mb-0"><i class="fas fa-shield-alt"></i> Sortino Ratio: ${riskRatios.sortino_ratio?.toFixed(2) || 'N/A'}</h6>
                                    </div>
                                    <div class="card-body">
                                        <p class="card-text"><strong>Formula:</strong> (Annual Return - Risk-Free Rate) ÷ Downside Deviation</p>
                                        <p class="card-text"><strong>Calculation:</strong> (${riskRatios.mean_return_pct?.toFixed(2) || 'N/A'}% - ${document.getElementById('riskFreeRate')?.value || '4.0'}%) ÷ ${riskRatios.downside_deviation_pct?.toFixed(2) || 'N/A'}% = ${riskRatios.sortino_ratio?.toFixed(2) || 'N/A'}</p>
                                        <p class="card-text"><strong>What it measures:</strong> Risk-adjusted return per unit of downside risk (only negative volatility)</p>
                                        <p class="card-text"><strong>Your Result:</strong> <span class="badge ${riskRatios.sortino_ratio >= 2.0 ? 'bg-success' : riskRatios.sortino_ratio >= 1.0 ? 'bg-info' : riskRatios.sortino_ratio >= 0.5 ? 'bg-warning' : 'bg-danger'}">${riskRatios.sortino_ratio?.toFixed(2) || 'N/A'}</span></p>
                                        <p class="card-text"><strong>Interpretation:</strong></p>
                                        <ul class="mb-0">
                                            <li><span class="text-success">> 2.0:</span> Excellent downside protection</li>
                                            <li><span class="text-info">1.0 - 2.0:</span> Good downside protection</li>
                                            <li><span class="text-warning">0.5 - 1.0:</span> Acceptable downside protection</li>
                                            <li><span class="text-danger">< 0.5:</span> Poor downside protection</li>
                                        </ul>
                                        <p class="card-text mt-2"><small class="text-muted">Higher is better. Focuses only on negative returns (downside risk) rather than all volatility. More relevant for risk-averse investors.</small></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card bg-dark border-secondary mb-3">
                                    <div class="card-header bg-secondary">
                                        <h6 class="mb-0"><i class="fas fa-chart-area"></i> MAR: ${riskRatios.mar_ratio?.toFixed(2) || 'N/A'}</h6>
                                    </div>
                                    <div class="card-body">
                                        <p class="card-text"><strong>Formula:</strong> Annual Return ÷ Maximum Drawdown</p>
                                        <p class="card-text"><strong>Calculation:</strong> ${riskRatios.mean_return_pct?.toFixed(2) || 'N/A'}% ÷ ${riskRatios.mean_max_drawdown_pct?.toFixed(2) || 'N/A'}% = ${riskRatios.mar_ratio?.toFixed(2) || 'N/A'}</p>
                                        <p class="card-text"><strong>What it measures:</strong> Return per unit of maximum drawdown risk</p>
                                        <p class="card-text"><strong>Your Result:</strong> <span class="badge ${riskRatios.mar_ratio >= 1.0 ? 'bg-success' : riskRatios.mar_ratio >= 0.5 ? 'bg-info' : riskRatios.mar_ratio >= 0.25 ? 'bg-warning' : 'bg-danger'}">${riskRatios.mar_ratio?.toFixed(2) || 'N/A'}</span></p>
                                        <p class="card-text"><strong>Interpretation:</strong></p>
                                        <ul class="mb-0">
                                            <li><span class="text-success">> 1.0:</span> Excellent drawdown-adjusted performance</li>
                                            <li><span class="text-info">0.5 - 1.0:</span> Good drawdown-adjusted performance</li>
                                            <li><span class="text-warning">0.25 - 0.5:</span> Acceptable drawdown-adjusted performance</li>
                                            <li><span class="text-danger">< 0.25:</span> Poor drawdown-adjusted performance</li>
                                        </ul>
                                        <p class="card-text mt-2"><small class="text-muted">Higher is better. Shows how much return you get for each unit of maximum drawdown risk.</small></p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card bg-dark border-secondary mb-3">
                                    <div class="card-header bg-secondary">
                                        <h6 class="mb-0"><i class="fas fa-info-circle"></i> Information Ratio: ${riskRatios.information_ratio?.toFixed(2) || 'N/A'}</h6>
                                    </div>
                                    <div class="card-body">
                                        <p class="card-text"><strong>Formula:</strong> (Strategy Return - Benchmark Return) ÷ Tracking Error</p>
                                        <p class="card-text"><strong>Calculation:</strong> (${riskRatios.mean_return_pct?.toFixed(2) || 'N/A'}% - ${document.getElementById('riskFreeRate')?.value || '4.0'}%) ÷ ${riskRatios.std_return_pct?.toFixed(2) || 'N/A'}% = ${riskRatios.information_ratio?.toFixed(2) || 'N/A'}</p>
                                        <p class="card-text"><strong>What it measures:</strong> Consistency of outperformance vs benchmark</p>
                                        <p class="card-text"><strong>Your Result:</strong> <span class="badge ${riskRatios.information_ratio >= 0.5 ? 'bg-success' : riskRatios.information_ratio >= 0.25 ? 'bg-info' : riskRatios.information_ratio >= 0.1 ? 'bg-warning' : 'bg-danger'}">${riskRatios.information_ratio?.toFixed(2) || 'N/A'}</span></p>
                                        <p class="card-text"><strong>Interpretation:</strong></p>
                                        <ul class="mb-0">
                                            <li><span class="text-success">> 0.5:</span> Excellent consistency</li>
                                            <li><span class="text-info">0.25 - 0.5:</span> Good consistency</li>
                                            <li><span class="text-warning">0.1 - 0.25:</span> Acceptable consistency</li>
                                            <li><span class="text-danger">< 0.1:</span> Poor consistency</li>
                                        </ul>
                                        <p class="card-text mt-2"><small class="text-muted">Higher is better. Measures how consistently the strategy outperforms its benchmark.</small></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="alert alert-info">
                            <h6><i class="fas fa-lightbulb"></i> Key Differences:</h6>
                            <ul class="mb-0">
                                <li><strong>Sharpe Ratio:</strong> Uses total volatility (both positive and negative price movements)</li>
                                <li><strong>Sortino Ratio:</strong> Uses only downside deviation (negative price movements)</li>
                                <li><strong>MAR (Maximum Adverse Return):</strong> Focuses on maximum drawdown as the risk measure</li>
                                <li><strong>Information Ratio:</strong> Measures consistency vs a benchmark (typically risk-free rate)</li>
                                <li><strong>When to use:</strong> Sortino is better for strategies with asymmetric returns (more upside than downside volatility)</li>
                                <li><strong>Risk-free rate:</strong> All ratios subtract the risk-free rate (2% annual) to show excess returns above a safe investment</li>
                            </ul>
                        </div>
                    </div>
                </div>
            `;
            
            resultsDiv.innerHTML = html;
            
            // Initialize tooltips for Individual Strategy Results table
            setTimeout(() => {
                initializeCustomTooltips();
            }, 100);
        }

        function loadMonteCarloChartButtons() {
            fetch('/api/charts/monte-carlo/available')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const buttonContainer = document.getElementById('monteCarloChartButtons');
                    if (!buttonContainer) {
                        console.error('Monte Carlo chart buttons container not found. Make sure the Monte Carlo form is loaded.');
                        return;
                    }
                    
                    buttonContainer.innerHTML = '';
                    
                    Object.entries(data.data).forEach(([chartType, description]) => {
                        const button = document.createElement('button');
                        button.className = 'btn btn-outline-primary btn-sm me-2 mb-2';
                        button.textContent = description;
                        button.onclick = () => loadMonteCarloChart(chartType);
                        buttonContainer.appendChild(button);
                    });
                }
            })
            .catch(error => {
                console.error('Error loading Monte Carlo chart buttons:', error);
            });
        }

        function loadMonteCarloChart(chartType) {
            if (!currentSimulationData) {
                showAlert('Please run a simulation first', 'warning');
                return;
            }
            
            const container = document.getElementById('monteCarloChartContainer');
            const loading = document.getElementById('monteCarloChartLoading');
            const chartCard = document.getElementById('monteCarloChartCard');
            
            // Show loading
            container.style.display = 'none';
            loading.style.display = 'block';
            chartCard.style.display = 'block';
            
            fetch(`/api/charts/monte-carlo/${chartType}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    simulation_data: currentSimulationData
                })
            })
            .then(response => response.json())
            .then(data => {
                loading.style.display = 'none';
                container.style.display = 'block';
                
                if (data.success) {
                    const chartSpec = JSON.parse(data.data.chart);
                    Plotly.newPlot(container, chartSpec.data, chartSpec.layout);
                } else {
                    container.innerHTML = `<div class="alert alert-danger">Error loading chart: ${data.error}</div>`;
                }
            })
            .catch(error => {
                loading.style.display = 'none';
                container.style.display = 'block';
                container.innerHTML = `<div class="alert alert-danger">Error loading chart: ${error.message}</div>`;
                console.error('Error loading Monte Carlo chart:', error);
            });
        }

        function showSimulationDetailsSection() {
            const section = document.getElementById('simulationDetailsSection');
            const select = document.getElementById('simulationSelect');
            
            if (!section || !select) {
                console.error('Simulation details section elements not found. Make sure the Monte Carlo form is loaded.');
                return;
            }
            
            // Populate simulation select options
            select.innerHTML = '<option value="">Select simulation...</option>';
            
            if (currentSimulationData && currentSimulationData.simulation_results) {
                currentSimulationData.simulation_results.forEach(sim => {
                    const option = document.createElement('option');
                    option.value = sim.simulation_id;
                    option.textContent = `Simulation #${sim.simulation_id} (Final: $${(sim.final_balance || sim.final_pnl || 0).toLocaleString()}, P&L: $${(sim.total_pnl || sim.final_pnl || 0).toLocaleString()})`;
                    select.appendChild(option);
                });
            }
            
            section.style.display = 'block';
        }

        function viewSimulationTrades() {
            const simulationId = document.getElementById('simulationSelect').value;
            
            if (!simulationId) {
                showAlert('Please select a simulation to view', 'warning');
                return;
            }
            
            if (!currentSimulationData) {
                showAlert('No simulation data available', 'error');
                return;
            }
            
            // Show loading in modal
            document.getElementById('modalSimulationId').textContent = simulationId;
            document.getElementById('simulationSummary').innerHTML = '<div class="spinner-border spinner-border-sm me-2"></div>Loading simulation details...';
            document.getElementById('simulatedTradesTableBody').innerHTML = '';
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('simulationTradesModal'));
            modal.show();
            
            // Fetch simulation details
            fetch(`/api/monte-carlo/simulation-details/${simulationId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    simulation_data: currentSimulationData
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displaySimulationTrades(data.data);
                } else {
                    document.getElementById('simulationSummary').innerHTML = `<div class="alert alert-danger">Error: ${data.error}</div>`;
                }
            })
            .catch(error => {
                console.error('Error fetching simulation details:', error);
                document.getElementById('simulationSummary').innerHTML = `<div class="alert alert-danger">Error loading simulation details: ${error.message}</div>`;
            });
        }

        function displaySimulationTrades(simulationDetails) {
            const summary = simulationDetails.summary;
            const trades = simulationDetails.trades;
            const comparison = simulationDetails.historical_comparison;
            
            // Update summary
            document.getElementById('simulationSummary').innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <strong>Simulation Summary:</strong><br>
                        • Total Trades: ${summary.total_trades}<br>
                        • Winning Trades: ${summary.winning_trades} (${summary.win_rate.toFixed(1)}%)<br>
                        • Losing Trades: ${summary.losing_trades}<br>
                        • Final P&L: $${(summary.total_pnl || 0).toLocaleString()}<br>
                        • Final Balance: $${(summary.final_balance || 0).toLocaleString()}<br>
                        • Max Drawdown: $${Math.abs(summary.max_drawdown || 0).toLocaleString()}
                    </div>
                    <div class="col-md-6">
                        <strong>How This Simulation Was Created:</strong><br>
                        • Randomly selected ${summary.total_trades} trades from your ${comparison.historical_trade_count} historical trades<br>
                        • Historical P&L range: $${(comparison.historical_pnl_range?.min || 0).toLocaleString()} to $${(comparison.historical_pnl_range?.max || 0).toLocaleString()}<br>
                        • This simulation P&L range: $${(comparison.simulated_pnl_range?.min || 0).toLocaleString()} to $${(comparison.simulated_pnl_range?.max || 0).toLocaleString()}<br>
                        <small class="text-muted">Each trade below was randomly picked from your actual trading history</small>
                    </div>
                </div>
            `;
            
            // Update comparison info
            document.getElementById('modalTradeComparison').innerHTML = 
                `Showing ${trades.length} randomly sampled trades from ${comparison.historical_trade_count} historical trades`;
            
            // Populate trades table
            const tableBody = document.getElementById('simulatedTradesTableBody');
            tableBody.innerHTML = '';
            
            trades.forEach(trade => {
                const row = document.createElement('tr');
                const resultClass = trade.is_winner ? 'text-success' : 'text-danger';
                const resultText = trade.is_winner ? 'WIN' : 'LOSS';
                const balanceClass = trade.account_balance > currentSimulationData.simulation_summary.initial_balance ? 'text-success' : 'text-danger';
                
                row.innerHTML = `
                    <td>${trade.trade_number}</td>
                    <td class="${resultClass}">$${trade.pnl.toLocaleString()}</td>
                    <td><span class="badge bg-${trade.is_winner ? 'success' : 'danger'}">${resultText}</span></td>
                    <td class="${trade.cumulative_pnl >= 0 ? 'text-success' : 'text-danger'}">$${trade.cumulative_pnl.toLocaleString()}</td>
                    <td class="${balanceClass}">$${trade.account_balance.toLocaleString()}</td>
                `;
                
                tableBody.appendChild(row);
            });
        }

        function showAlert(message, type = 'info') {
            const container = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type} alert-dismissible fade show alert-custom`;
            alert.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            container.appendChild(alert);

            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (alert.parentNode) {
                    alert.remove();
                }
            }, 5000);
        }

        // Strategy Detail Functions
        let strategyCurrentPage = 1;
        let currentPaginationData = null;
        
        function loadAvailableStrategies() {
            console.log('Loading available strategies...');
            return fetch('/api/strategy-details')
            .then(response => {
                console.log('Strategy details response status:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('Strategy details data:', data);
                if (data.success) {
                    const select = document.getElementById('strategyFilter');
                    select.innerHTML = '';
                    
                    console.log('Available strategies:', data.data.strategies);
                    data.data.strategies.forEach(strategy => {
                        const option = document.createElement('option');
                        option.value = strategy;
                        option.textContent = strategy;
                        select.appendChild(option);
                    });
                    console.log('Strategy filter populated with', data.data.strategies.length, 'strategies');
                } else {
                    console.error('Failed to load strategies:', data.error);
                }
                return data;
            })
            .catch(error => {
                console.error('Error loading strategies:', error);
                throw error;
            });
        }

        function loadStrategyDetails(page = 1) {
            console.log('Loading strategy details, page:', page);
            const selectedStrategies = Array.from(document.getElementById('strategyFilter').selectedOptions).map(option => option.value);
            console.log('Selected strategies:', selectedStrategies);
            
            const summaryDiv = document.getElementById('tradeSummary');
            const tableBody = document.querySelector('#strategyDetailTable tbody');
            
            // Update current page
            strategyCurrentPage = page;
            
            // Show loading
            summaryDiv.innerHTML = '<div class="spinner-border spinner-border-sm me-2"></div>Loading trades...';
            tableBody.innerHTML = '<tr><td colspan="10" class="text-center"><div class="spinner-border spinner-border-sm"></div> Loading...</td></tr>';
            
            // Check if margin calculations are requested
            const includeMargin = document.getElementById('includeMarginCheck').checked;
            
            // Build query string for selected strategies and pagination
            const queryParams = [
                ...selectedStrategies.map(strategy => `strategies[]=${encodeURIComponent(strategy)}`),
                `page=${page}`,
                `include_margin=${includeMargin}`  // Use checkbox value
            ].join('&');
            const url = `/api/strategy-details${queryParams ? '?' + queryParams : ''}`;
            console.log('Fetching URL:', url);
            
            fetch(url)
                .then(response => {
                    console.log('Strategy details response status:', response.status);
                    return response.json();
                })
                .then(data => {
                    console.log('Strategy details response data:', data);
                    if (data.success) {
                        displayStrategyDetails(data.data);
                        // Also load P&L chart
                        loadStrategyPnlChart(selectedStrategies);
                    } else {
                        console.error('Strategy details error:', data.error);
                        summaryDiv.innerHTML = `<div class="alert alert-danger">Error: ${data.error}</div>`;
                        tableBody.innerHTML = '<tr><td colspan="9" class="text-center text-danger">Error loading trades</td></tr>';
                    }
                })
                .catch(error => {
                    console.error('Error loading strategy details:', error);
                    summaryDiv.innerHTML = `<div class="alert alert-danger">Error loading trades: ${error.message}</div>`;
                    tableBody.innerHTML = '<tr><td colspan="9" class="text-center text-danger">Error loading trades</td></tr>';
                });
        }

        function loadStrategyPnlChart(selectedStrategies) {
            const chartContainer = document.getElementById('strategyPnlChart');
            
            if (selectedStrategies.length === 0) {
                chartContainer.innerHTML = '<div class="text-center text-muted py-5">Select strategies to see P&L performance</div>';
                return;
            }
            
            // Show loading
            chartContainer.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-primary" role="status"></div><p>Loading P&L chart...</p></div>';
            
            fetch('/api/strategy-pnl', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    strategies: selectedStrategies
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Clear loading state completely before creating chart
                    chartContainer.innerHTML = '';
                    createStrategyPnlChart(data.data);
                } else {
                    chartContainer.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
                }
            })
            .catch(error => {
                console.error('Error loading P&L chart:', error);
                chartContainer.innerHTML = '<div class="alert alert-danger">Error loading P&L chart</div>';
            });
        }

        function createStrategyPnlChart(strategyData) {
            const chartContainer = document.getElementById('strategyPnlChart');
            
            // Clear any existing content completely
            chartContainer.innerHTML = '';
            
            // Create traces for each strategy
            const traces = [];
            const colors = ['#1f77b4', '#ff7f0e', '#2ca02c', '#d62728', '#9467bd', '#8c564b', '#e377c2', '#7f7f7f', '#bcbd22', '#17becf'];
            
            console.log('=== STARTING CHART CREATION ===');
            console.log('Raw strategy data:', JSON.stringify(strategyData, null, 2));
            
            // Get current date for validation
            const currentDate = new Date();
            const maxAllowedDate = new Date(currentDate.getFullYear() + 1, currentDate.getMonth(), currentDate.getDate());
            console.log('Current date:', currentDate.toISOString());
            console.log('Max allowed date:', maxAllowedDate.toISOString());
            
            Object.keys(strategyData).forEach((strategyName, index) => {
                const data = strategyData[strategyName];
                const color = colors[index % colors.length];
                
                console.log(`\n=== PROCESSING STRATEGY: ${strategyName} ===`);
                console.log('Strategy data:', data);
                console.log('Dates array length:', data.dates ? data.dates.length : 'undefined');
                console.log('P&L array length:', data.cumulative_pnl ? data.cumulative_pnl.length : 'undefined');
                
                // Ensure we have valid data
                if (data.dates && data.cumulative_pnl && data.dates.length > 0) {
                    // Verify data integrity
                    if (data.dates.length === data.cumulative_pnl.length) {
                        console.log('Data arrays match in length ✓');
                        
                        // Log first and last few data points
                        console.log('First 3 data points:');
                        for (let i = 0; i < Math.min(3, data.dates.length); i++) {
                            console.log(`  ${i+1}. Date: ${data.dates[i]}, P&L: $${data.cumulative_pnl[i].toLocaleString()}`);
                        }
                        
                        if (data.dates.length > 3) {
                            console.log('Last 3 data points:');
                            for (let i = Math.max(0, data.dates.length - 3); i < data.dates.length; i++) {
                                console.log(`  ${i+1}. Date: ${data.dates[i]}, P&L: $${data.cumulative_pnl[i].toLocaleString()}`);
                            }
                        }
                        
                        // Filter out invalid future dates
                        const validDates = [];
                        const validPnl = [];
                        
                        console.log('\nFiltering dates...');
                        for (let i = 0; i < data.dates.length; i++) {
                            const dateStr = data.dates[i];
                            const pnl = data.cumulative_pnl[i];
                            
                            try {
                                // Handle both ISO format and legacy string format
                                let tradeDate;
                                if (dateStr.includes('T') || dateStr.includes('Z')) {
                                    // ISO format
                                    tradeDate = new Date(dateStr);
                                } else {
                                    // Legacy format - parse as GMT string
                                    tradeDate = new Date(dateStr);
                                }
                                
                                if (tradeDate <= maxAllowedDate && !isNaN(tradeDate.getTime())) {
                                    validDates.push(dateStr);
                                    validPnl.push(pnl);
                                } else {
                                    console.warn(`❌ Skipping invalid date: ${dateStr} (parsed as ${tradeDate.toISOString()}) for strategy ${strategyName}`);
                                }
                            } catch (e) {
                                console.warn(`❌ Skipping invalid date: ${dateStr} for strategy ${strategyName}: ${e}`);
                            }
                        }
                        
                        console.log(`Filtered ${validDates.length} valid dates from ${data.dates.length} total`);
                        
                        if (validDates.length > 0) {
                            // Verify chronological order on frontend
                            console.log(`\nVerifying chronological order for ${strategyName}...`);
                            let isChronological = true;
                            for (let i = 1; i < validDates.length; i++) {
                                const prevDateStr = validDates[i-1];
                                const currDateStr = validDates[i];
                                
                                // Parse dates consistently
                                let prevDate, currDate;
                                if (prevDateStr.includes('T') || prevDateStr.includes('Z')) {
                                    prevDate = new Date(prevDateStr);
                                } else {
                                    prevDate = new Date(prevDateStr);
                                }
                                
                                if (currDateStr.includes('T') || currDateStr.includes('Z')) {
                                    currDate = new Date(currDateStr);
                                } else {
                                    currDate = new Date(currDateStr);
                                }
                                
                                if (currDate < prevDate) {
                                    console.error(`❌ Date order issue at position ${i}: ${prevDateStr} -> ${currDateStr}`);
                                    isChronological = false;
                                }
                            }
                            
                            if (isChronological) {
                                console.log(`  ✓ Dates are in chronological order`);
                            } else {
                                console.error(`  ❌ Dates are NOT in chronological order - this will cause zigzag lines!`);
                                console.log(`  First 10 dates:`, validDates.slice(0, 10));
                                console.log(`  Last 10 dates:`, validDates.slice(-10));
                            }
                            
                            // Create the trace
                            const trace = {
                                x: validDates,
                                y: validPnl,
                                mode: 'lines+markers',
                                name: strategyName,
                                line: {
                                    color: color,
                                    width: 2
                                },
                                marker: {
                                    size: 4,
                                    color: color
                                },
                                hovertemplate: `<b>${strategyName}</b><br>Date: %{x}<br>Cumulative P&L: $%{y:,.2f}<extra></extra>`
                            };
                            
                            traces.push(trace);
                            
                            console.log(`✅ Added trace for ${strategyName}:`);
                            console.log(`  - Color: ${color}`);
                            console.log(`  - Data points: ${validDates.length}`);
                            console.log(`  - Date range: ${validDates[0]} to ${validDates[validDates.length-1]}`);
                            console.log(`  - P&L range: $${Math.min(...validPnl).toLocaleString()} to $${Math.max(...validPnl).toLocaleString()}`);
                            console.log(`  - Chronological: ${isChronological ? 'Yes' : 'No'}`);
                        } else {
                            console.error(`❌ No valid dates found for strategy: ${strategyName}`);
                        }
                    } else {
                        console.error(`❌ Data mismatch for ${strategyName}: ${data.dates.length} dates vs ${data.cumulative_pnl.length} P&L values`);
                    }
                } else {
                    console.warn(`❌ Invalid data for strategy: ${strategyName}`, data);
                }
            });
            
            console.log(`\n=== FINAL TRACES SUMMARY ===`);
            console.log(`Total traces created: ${traces.length}`);
            traces.forEach((trace, index) => {
                console.log(`Trace ${index + 1}: ${trace.name}`);
                console.log(`  - X values: ${trace.x.length} points`);
                console.log(`  - Y values: ${trace.y.length} points`);
                console.log(`  - X range: ${trace.x[0]} to ${trace.x[trace.x.length-1]}`);
                console.log(`  - Y range: ${Math.min(...trace.y)} to ${Math.max(...trace.y)}`);
            });
            
            if (traces.length === 0) {
                console.error('❌ No traces created - showing error message');
                chartContainer.innerHTML = '<div class="alert alert-warning">No valid P&L data found for selected strategies</div>';
                return;
            }
            
            const layout = {
                title: 'Strategy P&L Performance',
                xaxis: {
                    title: 'Date',
                    tickangle: 45,
                    range: undefined
                },
                yaxis: {
                    title: 'Cumulative P&L ($)',
                    tickformat: ',.0f'
                },
                template: 'plotly_white',
                height: 400,
                legend: {
                    x: 0.02,
                    y: 0.98
                },
                hovermode: 'closest'
            };
            
            console.log('\n=== CREATING PLOTLY CHART ===');
            console.log('Layout:', layout);
            console.log('Traces to be plotted:', traces);
            
            Plotly.newPlot(chartContainer, traces, layout, {
                responsive: true,
                displayModeBar: true,
                displaylogo: false
            }).then(() => {
                console.log('✅ Plotly chart created successfully');
                console.log('Final chart container:', chartContainer);
            }).catch((error) => {
                console.error('❌ Error creating Plotly chart:', error);
            });
        }

        function displayStrategyDetails(data) {
            const trades = data.trades;
            const pagination = data.pagination;
            const overallStats = data.overall_stats;
            const summaryDiv = document.getElementById('tradeSummary');
            const tableBody = document.querySelector('#strategyDetailTable tbody');
            const paginationControls = document.getElementById('paginationControls');
            
            // Store pagination data for navigation
            currentPaginationData = pagination;
            
            // Update summary using overall statistics across all trades
            summaryDiv.innerHTML = `
                <div class="row">
                    <div class="col-md-12">
                        <strong>Trade Summary (Page ${pagination.current_page} of ${pagination.total_pages}):</strong><br>
                        • Total Trades: ${pagination.total_trades}<br>
                        • Trades on this page: ${trades.length}<br>
                        • Winning Trades: ${overallStats.total_winning_trades} (${overallStats.total_win_rate.toFixed(1)}%)<br>
                        • Losing Trades: ${overallStats.total_losing_trades}<br>
                        • Total P&L: $${overallStats.total_pnl.toLocaleString()}<br>
                        • Total Commissions: $${overallStats.total_commissions.toLocaleString()}<br>
                        • Net P&L: $${overallStats.total_net_pnl.toLocaleString()}
                    </div>
                </div>
            `;
            
            // Update table
            tableBody.innerHTML = '';
            
            if (trades.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="10" class="text-center text-muted">No trades found for selected strategies</td></tr>';
                paginationControls.style.display = 'none';
                return;
            }
            
            trades.forEach(trade => {
                const row = document.createElement('tr');
                const pnlClass = trade.pnl >= 0 ? 'text-success' : 'text-danger';
                const resultClass = trade.is_winner ? 'text-success' : 'text-danger';
                const resultText = trade.is_winner ? 'WIN' : 'LOSS';
                
                row.innerHTML = `
                    <td>${trade.date_opened || 'N/A'}</td>
                    <td>${trade.date_closed || 'N/A'}</td>
                    <td>${trade.strategy}</td>
                    <td class="${pnlClass}">$${trade.pnl.toLocaleString()}</td>
                    <td>$${trade.funds_at_close ? trade.funds_at_close.toLocaleString() : 'N/A'}</td>
                    <td>${trade.contracts}</td>
                                            <td>${trade.margin_per_contract && trade.margin_per_contract > 0 ? '$' + trade.margin_per_contract.toLocaleString() : 'N/A'}</td>
                    <td>$${trade.opening_commissions.toLocaleString()}</td>
                    <td>$${trade.closing_commissions.toLocaleString()}</td>
                    <td><span class="badge bg-${trade.is_winner ? 'success' : 'danger'}">${resultText}</span></td>
                `;
                
                tableBody.appendChild(row);
            });
            
            // Update pagination controls
            updatePaginationControls(pagination);
        }

        function clearStrategyFilter() {
            const select = document.getElementById('strategyFilter');
            Array.from(select.options).forEach(option => option.selected = false);
            
            // Reset pagination
            strategyCurrentPage = 1;
            currentPaginationData = null;
            
            // Clear the display
            document.getElementById('tradeSummary').innerHTML = `
                <div class="alert alert-info">
                    Select strategies and click "Load Trades" to see summary
                </div>
            `;
            
            document.querySelector('#strategyDetailTable tbody').innerHTML = `
                <tr>
                    <td colspan="10" class="text-center text-muted">Select strategies and click "Load Trades" to view trade details</td>
                </tr>
            `;
            
            // Hide pagination controls
            document.getElementById('paginationControls').style.display = 'none';
        }

        function updatePaginationControls(pagination) {
            const paginationControls = document.getElementById('paginationControls');
            const paginationInfo = document.getElementById('paginationInfo');
            const paginationButtons = document.getElementById('paginationButtons');
            
            // Show pagination controls
            paginationControls.style.display = 'flex';
            
            // Update pagination info
            const startTrade = (pagination.current_page - 1) * pagination.trades_per_page + 1;
            const endTrade = Math.min(pagination.current_page * pagination.trades_per_page, pagination.total_trades);
            paginationInfo.textContent = `${startTrade}-${endTrade} of ${pagination.total_trades} trades`;
            
            // Build pagination buttons
            paginationButtons.innerHTML = '';
            
            // Previous button
            const prevLi = document.createElement('li');
            prevLi.className = `page-item ${pagination.current_page === 1 ? 'disabled' : ''}`;
            const prevButton = document.createElement('button');
            prevButton.className = 'page-link';
            prevButton.textContent = 'Previous';
            prevButton.onclick = () => {
                if (pagination.current_page > 1) {
                    loadStrategyDetails(pagination.current_page - 1);
                }
            };
            prevLi.appendChild(prevButton);
            paginationButtons.appendChild(prevLi);
            
            // Page number buttons
            const maxVisiblePages = 5;
            let startPage = Math.max(1, pagination.current_page - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(pagination.total_pages, startPage + maxVisiblePages - 1);
            
            // Adjust start page if we're near the end
            if (endPage - startPage < maxVisiblePages - 1) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }
            
            // First page button (if not visible)
            if (startPage > 1) {
                const firstLi = document.createElement('li');
                firstLi.className = 'page-item';
                const firstButton = document.createElement('button');
                firstButton.className = 'page-link';
                firstButton.textContent = '1';
                firstButton.onclick = () => loadStrategyDetails(1);
                firstLi.appendChild(firstButton);
                paginationButtons.appendChild(firstLi);
                
                if (startPage > 2) {
                    const ellipsisLi = document.createElement('li');
                    ellipsisLi.className = 'page-item disabled';
                    const ellipsisSpan = document.createElement('span');
                    ellipsisSpan.className = 'page-link';
                    ellipsisSpan.textContent = '...';
                    ellipsisLi.appendChild(ellipsisSpan);
                    paginationButtons.appendChild(ellipsisLi);
                }
            }
            
            // Page number buttons
            for (let i = startPage; i <= endPage; i++) {
                const pageLi = document.createElement('li');
                pageLi.className = `page-item ${i === pagination.current_page ? 'active' : ''}`;
                const pageButton = document.createElement('button');
                pageButton.className = 'page-link';
                pageButton.textContent = i;
                pageButton.onclick = () => loadStrategyDetails(i);
                pageLi.appendChild(pageButton);
                paginationButtons.appendChild(pageLi);
            }
            
            // Last page button (if not visible)
            if (endPage < pagination.total_pages) {
                if (endPage < pagination.total_pages - 1) {
                    const ellipsisLi = document.createElement('li');
                    ellipsisLi.className = 'page-item disabled';
                    const ellipsisSpan = document.createElement('span');
                    ellipsisSpan.className = 'page-link';
                    ellipsisSpan.textContent = '...';
                    ellipsisLi.appendChild(ellipsisSpan);
                    paginationButtons.appendChild(ellipsisLi);
                }
                
                const lastLi = document.createElement('li');
                lastLi.className = 'page-item';
                const lastButton = document.createElement('button');
                lastButton.className = 'page-link';
                lastButton.textContent = pagination.total_pages;
                lastButton.onclick = () => loadStrategyDetails(pagination.total_pages);
                lastLi.appendChild(lastButton);
                paginationButtons.appendChild(lastLi);
            }
            
            // Next button
            const nextLi = document.createElement('li');
            nextLi.className = `page-item ${pagination.current_page === pagination.total_pages ? 'disabled' : ''}`;
            const nextButton = document.createElement('button');
            nextButton.className = 'page-link';
            nextButton.textContent = 'Next';
            nextButton.onclick = () => {
                if (pagination.current_page < pagination.total_pages) {
                    loadStrategyDetails(pagination.current_page + 1);
                }
            };
            nextLi.appendChild(nextButton);
            paginationButtons.appendChild(nextLi);
        }

        function loadWinRatesTable() {
            console.log('Loading win rates table...');
            const loading = document.getElementById('chartLoading');
            const container = document.getElementById('chartContainer');
            
            if (loading) {
                loading.style.display = 'block';
            }
            
            fetch('/api/charts/win_rates_table')
                .then(response => {
                    console.log('Response status:', response.status);
                    return response.json();
                })
                .then(data => {
                    console.log('Win rates data:', data);
                    if (loading) {
                        loading.style.display = 'none';
                    }
                    if (data.error) {
                        container.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
                    } else {
                        // Parse the chart data
                        const chartData = JSON.parse(data.chart);
                        console.log('Parsed chart data:', chartData);
                        
                        // Create the table with sorting and colors
                        createSortableWinRatesTable(chartData);
                    }
                })
                .catch(error => {
                    console.error('Error loading win rates table:', error);
                    if (loading) {
                        loading.style.display = 'none';
                    }
                    container.innerHTML = '<div class="alert alert-danger">Error loading win rates table</div>';
                });
        }

        function createSortableWinRatesTable(chartData) {
            const container = document.getElementById('chartContainer');
            
            // Extract data from the Plotly table
            const table = chartData.data[0];
            const headers = table.header.values;
            const cells = table.cells.values;
            
            // Create HTML table
            let html = `
                <div class="table-responsive">
                    <table class="table table-striped table-hover" id="winRatesTable">
                        <thead class="table-dark">
                            <tr>
            `;
            
            // Define tooltip descriptions for Win Rates Table columns
            const winRatesDescriptions = [
                "Trading strategy name",
                "Total profit/loss for all trades in this strategy",
                "Total number of completed trades",
                "Number of profitable trades",
                "Number of losing trades",
                "Maximum consecutive winning trades",
                "Maximum consecutive losing trades",
                "Percentage of trades that were profitable",
                "Average profit amount for winning trades",
                "Average loss amount for losing trades",
                "Largest profit from a single winning trade",
                "Largest loss from a single losing trade",
                "Expected profit/loss per contract per trade"
            ];

            // Add headers with sort functionality and tooltips
            headers.forEach((header, index) => {
                const tooltipText = winRatesDescriptions[index] || "Performance metric";
                html += `<th onclick="sortWinRatesTable(${index})" style="cursor: pointer;" 
                    class="custom-tooltip" data-tooltip="${tooltipText}">
                    ${header} <span id="sort-${index}" class="sort-indicator">↕</span>
                </th>`;
            });
            
            html += `
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            // Add data rows
            for (let i = 0; i < cells[0].length; i++) {
                html += '<tr>';
                for (let j = 0; j < headers.length; j++) {
                    const value = cells[j][i];
                    
                    // Extract sortable value from displayed text
                    let sortValue = value;
                    if (j === 1) { // Total P&L column
                        sortValue = parseFloat(value.replace(/[$,]/g, ''));
                    } else if (j === 5 || j === 6) { // Max Win Streak, Max Lose Streak columns
                        sortValue = parseInt(value) || 0;
                    } else if (j === 7) { // Win Rate column
                        sortValue = parseFloat(value.replace('%', ''));
                    } else if (j >= 8 && j <= 11) { // Money columns (Avg Winner, Avg Loser, Max Winner, Max Loser)
                        sortValue = parseFloat(value.replace(/[$,]/g, ''));
                    } else if (j === 12) { // Expectancy column
                        // Parse the expectancy value to determine if positive or negative
                        const expectancyValue = parseFloat(value.replace(/[$,]/g, ''));
                        if (!isNaN(expectancyValue)) {
                            sortValue = expectancyValue;
                        }
                    }
                    
                    // Apply color formatting for winner/loser columns
                    let cellClass = '';
                    if (j === 1) { // Total P&L column
                        const pnlValue = parseFloat(value.replace(/[$,]/g, ''));
                        if (!isNaN(pnlValue)) {
                            cellClass = pnlValue >= 0 ? 'text-success fw-bold' : 'text-danger fw-bold';
                        }
                    } else if (j === 5) { // Max Win Streak column
                        cellClass = 'text-success fw-bold';
                    } else if (j === 6) { // Max Lose Streak column
                        cellClass = 'text-danger fw-bold';
                    } else if (j === 8 || j === 10) { // Avg Winner, Max Winner
                        cellClass = 'text-success fw-bold';
                    } else if (j === 9 || j === 11) { // Avg Loser, Max Loser
                        cellClass = 'text-danger fw-bold';
                    } else if (j === 12) { // Expectancy column
                        // Parse the expectancy value to determine if positive or negative
                        const expectancyValue = parseFloat(value.replace(/[$,]/g, ''));
                        if (!isNaN(expectancyValue)) {
                            cellClass = expectancyValue >= 0 ? 'text-success fw-bold' : 'text-danger fw-bold';
                        }
                    }
                    
                    html += `<td class="${cellClass}" data-sort-value="${sortValue}">${value}</td>`;
                }
                html += '</tr>';
            }
            
            html += `
                        </tbody>
                    </table>
                </div>
            `;
            
            container.innerHTML = html;
            
            // Initialize tooltips for win rates table
            setTimeout(() => {
                initializeCustomTooltips();
            }, 100);
        }

        function loadMarginAnalysisTable() {
            console.log('Loading margin analysis table...');
            const loading = document.getElementById('chartLoading');
            const container = document.getElementById('chartContainer');
            
            if (loading) {
                loading.style.display = 'block';
            }
            
            fetch('/api/charts/margin_analysis')
                .then(response => {
                    console.log('Response status:', response.status);
                    return response.json();
                })
                .then(data => {
                    console.log('Margin analysis data:', data);
                    if (loading) {
                        loading.style.display = 'none';
                    }
                    if (data.error) {
                        container.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
                    } else {
                        // Parse the chart data
                        const chartData = JSON.parse(data.chart);
                        console.log('Parsed chart data:', chartData);
                        
                        // Create the table with sorting and colors
                        createSortableMarginAnalysisTable(chartData);
                    }
                })
                .catch(error => {
                    console.error('Error loading margin analysis table:', error);
                    if (loading) {
                        loading.style.display = 'none';
                    }
                    container.innerHTML = '<div class="alert alert-danger">Error loading margin analysis table</div>';
                });
        }

        function createSortableMarginAnalysisTable(chartData) {
            const container = document.getElementById('chartContainer');
            
            // Extract data from the Plotly table
            const table = chartData.data[0];
            const headers = table.header.values;
            const cells = table.cells.values;
            
            // Create HTML table
            let html = `
                <div class="table-responsive">
                    <table class="table table-striped table-hover" id="marginAnalysisTable">
                        <thead class="table-dark">
                            <tr>
            `;
            
            // Define tooltip descriptions for each column
            const tooltipDescriptions = [
                "Trading strategy name",
                "Total completed trades",
                "Average margin per contract",
                "Average margin per contract (last 90 days)",
                "Lowest margin per contract and date",
                "Highest margin per contract and date", 
                "Percentage of profitable trades",
                "Average profit per winning contract",
                "Average loss per losing contract",
                "Largest profit per contract",
                "Largest loss per contract",
                "Expected profit/loss per contract",
                "Risk-adjusted performance: (Expectancy ÷ Margin) × Win Rate"
            ];

            // Add headers with sort functionality and custom tooltips
            headers.forEach((header, index) => {
                // Extract plain text from HTML header
                const headerText = header.replace(/<[^>]*>/g, '');
                html += `<th onclick="sortMarginAnalysisTable(${index})" style="cursor: pointer;" 
                    class="custom-tooltip" data-tooltip="${tooltipDescriptions[index]}">
                    ${headerText} <span id="sort-margin-${index}" class="sort-indicator">↕</span>
                </th>`;
            });
            
            html += `
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            // Add data rows
            for (let i = 0; i < cells[0].length; i++) {
                html += '<tr>';
                for (let j = 0; j < headers.length; j++) {
                    const value = cells[j][i];
                    
                    // Extract sortable value from displayed text
                    let sortValue = value;
                    if (j === 1) { // Trades column
                        sortValue = parseInt(value) || 0;
                    } else if (j === 2 || j === 3) { // Avg Margin/Contract columns
                        sortValue = parseFloat(value.replace(/[$,]/g, '')) || 0;
                    } else if (j === 4 || j === 5) { // Min/Max Margin/Contract columns
                        // Extract the dollar amount from the formatted string (e.g., "$1,234.56 (2025-01-01)")
                        const match = value.match(/\$([0-9,]+\.?[0-9]*)/);
                        sortValue = match ? parseFloat(match[1].replace(/,/g, '')) : 0;
                    } else if (j === 6) { // Win Rate column
                        sortValue = parseFloat(value.replace('%', '')) || 0;
                    } else if (j >= 7 && j <= 10) { // Money columns (Avg Winner, Avg Loser, Max Winner, Max Loser)
                        sortValue = parseFloat(value.replace(/[$,]/g, '')) || 0;
                    } else if (j === 11) { // Expectancy column
                        sortValue = parseFloat(value.replace(/[$,]/g, '')) || 0;
                    } else if (j === 12) { // Efficiency column
                        sortValue = parseFloat(value) || 0;
                    }
                    
                    // Apply color formatting for winner/loser columns
                    let cellClass = '';
                    if (j === 6) { // Win Rate column
                        const winRateValue = parseFloat(value.replace('%', ''));
                        if (!isNaN(winRateValue)) {
                            cellClass = winRateValue >= 50 ? 'text-success fw-bold' : 'text-danger fw-bold';
                        }
                    } else if (j === 7 || j === 9) { // Avg Winner, Max Winner
                        cellClass = 'text-success fw-bold';
                    } else if (j === 8 || j === 10) { // Avg Loser, Max Loser
                        cellClass = 'text-danger fw-bold';
                    } else if (j === 11) { // Expectancy column
                        const expectancyValue = parseFloat(value.replace(/[$,]/g, ''));
                        if (!isNaN(expectancyValue)) {
                            cellClass = expectancyValue >= 0 ? 'text-success fw-bold' : 'text-danger fw-bold';
                        }
                    } else if (j === 12) { // Efficiency column
                        const efficiencyValue = parseFloat(value);
                        if (!isNaN(efficiencyValue)) {
                            cellClass = efficiencyValue >= 0 ? 'text-success fw-bold' : 'text-danger fw-bold';
                        }
                    }
                    
                    html += `<td class="${cellClass}" data-sort-value="${sortValue}">${value}</td>`;
                }
                html += '</tr>';
            }
            
            html += `
                        </tbody>
                    </table>
                </div>
            `;
            
            container.innerHTML = html;
            
            // Add event listeners for custom tooltips
            setTimeout(() => {
                // Remove any existing tooltips first
                document.querySelectorAll('.js-tooltip').forEach(tip => tip.remove());
                
                // Remove all title attributes to prevent browser tooltips
                document.querySelectorAll('[title]').forEach(el => {
                    el.removeAttribute('title');
                });
                
                const tooltipElements = document.querySelectorAll('.custom-tooltip');
                tooltipElements.forEach(element => {
                    // Remove existing event listeners by cloning the element
                    const newElement = element.cloneNode(true);
                    element.parentNode.replaceChild(newElement, element);
                    
                    let tooltip = null;
                    
                    newElement.addEventListener('mouseenter', (e) => {
                        // Remove any existing tooltips first
                        document.querySelectorAll('.js-tooltip').forEach(tip => tip.remove());
                        
                        const tooltipText = newElement.getAttribute('data-tooltip');
                        if (tooltipText && !tooltip) {
                            tooltip = document.createElement('div');
                            tooltip.className = 'js-tooltip';
                        // Handle multi-line text by converting line breaks to <br> tags
                        const formattedText = tooltipText.replace(/\n/g, '<br>');
                        tooltip.innerHTML = formattedText;
                        tooltip.style.cssText = `
                            position: fixed;
                            background: #000;
                            color: #fff;
                            padding: 12px 16px;
                            border-radius: 8px;
                            font-size: 14px;
                            font-weight: normal;
                            z-index: 99999;
                            max-width: 400px;
                            text-align: left;
                            box-shadow: 0 4px 12px rgba(0,0,0,0.8);
                            border: 2px solid #fff;
                            pointer-events: none;
                            line-height: 1.4;
                        `;
                            
                            document.body.appendChild(tooltip);
                            
                            const rect = newElement.getBoundingClientRect();
                            tooltip.style.left = (rect.left + rect.width/2 - tooltip.offsetWidth/2) + 'px';
                            tooltip.style.top = (rect.top - tooltip.offsetHeight - 10) + 'px';
                        }
                    });
                    
                    newElement.addEventListener('mouseleave', () => {
                        if (tooltip) {
                            tooltip.remove();
                            tooltip = null;
                        }
                    });
                });
            }, 100);
        }

        // Shared function to initialize custom tooltips for all tables
        function initializeCustomTooltips() {
            console.log('🔧 initializeCustomTooltips() called');
            // Remove any existing tooltips first
            document.querySelectorAll('.js-tooltip').forEach(tip => tip.remove());
            
            const tooltipElements = document.querySelectorAll('.custom-tooltip');
            console.log('🔧 Found', tooltipElements.length, 'custom tooltip elements');
            tooltipElements.forEach((element, index) => {
                console.log('🔧 Processing tooltip element', index, ':', element);
                // Remove existing event listeners by cloning the element
                const newElement = element.cloneNode(true);
                element.parentNode.replaceChild(newElement, element);
                
                let tooltip = null;
                
                newElement.addEventListener('mouseenter', (e) => {
                    // Remove any existing tooltips first
                    document.querySelectorAll('.js-tooltip').forEach(tip => tip.remove());
                    
                    const tooltipText = newElement.getAttribute('data-tooltip');
                    if (tooltipText && !tooltip) {
                        console.log('Tooltip text:', tooltipText);
                        tooltip = document.createElement('div');
                        tooltip.className = 'js-tooltip';
                        // Handle multi-line text by converting line breaks to <br> tags
                        const formattedText = tooltipText.replace(/\n/g, '<br>');
                        console.log('Formatted text:', formattedText);
                        tooltip.innerHTML = formattedText;
                        tooltip.style.cssText = `
                            position: fixed;
                            background: #000;
                            color: #fff;
                            padding: 12px 16px;
                            border-radius: 8px;
                            font-size: 14px;
                            font-weight: normal;
                            z-index: 99999;
                            max-width: 400px;
                            text-align: left;
                            box-shadow: 0 4px 12px rgba(0,0,0,0.8);
                            border: 2px solid #fff;
                            pointer-events: none;
                            line-height: 1.4;
                        `;
                        
                        document.body.appendChild(tooltip);
                        
                        const rect = newElement.getBoundingClientRect();
                        tooltip.style.left = (rect.left + rect.width/2 - tooltip.offsetWidth/2) + 'px';
                        tooltip.style.top = (rect.top - tooltip.offsetHeight - 10) + 'px';
                    }
                });
                
                newElement.addEventListener('mouseleave', () => {
                    if (tooltip) {
                        tooltip.remove();
                        tooltip = null;
                    }
                });
            });
        }

        function sortMarginAnalysisTable(columnIndex) {
            const table = document.getElementById('marginAnalysisTable');
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            
            // Get current sort direction
            const sortIndicator = document.getElementById(`sort-margin-${columnIndex}`);
            const currentDirection = sortIndicator.textContent;
            
            // Reset all sort indicators
            document.querySelectorAll('.sort-indicator').forEach(indicator => {
                indicator.textContent = '↕';
            });
            
            // Set new sort direction
            const newDirection = currentDirection === '↑' ? '↓' : '↑';
            sortIndicator.textContent = newDirection;
            
            // Sort rows
            rows.sort((a, b) => {
                const aValue = a.cells[columnIndex].getAttribute('data-sort-value');
                const bValue = b.cells[columnIndex].getAttribute('data-sort-value');
                
                let aNum = parseFloat(aValue);
                let bNum = parseFloat(bValue);
                
                // Handle non-numeric values (strategy names)
                if (isNaN(aNum) || isNaN(bNum)) {
                    aNum = aValue;
                    bNum = bValue;
                }
                
                if (newDirection === '↑') {
                    return aNum > bNum ? 1 : -1;
                } else {
                    return aNum < bNum ? 1 : -1;
                }
            });
            
            // Reorder rows
            rows.forEach(row => tbody.appendChild(row));
        }

        function loadDailyMarginAnalysis() {
            console.log('Loading daily margin analysis...');
            const loading = document.getElementById('chartLoading');
            const container = document.getElementById('chartContainer');
            
            if (loading) {
                loading.style.display = 'block';
            }
            
            fetch('/api/charts/daily_margin_analysis')
                .then(response => {
                    console.log('Daily margin analysis response status:', response.status);
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Daily margin analysis data received:', data);
                    if (loading) {
                        loading.style.display = 'none';
                    }
                    if (data.error) {
                        console.error('API returned error:', data.error);
                        container.innerHTML = `<div class="alert alert-danger">Error: ${data.error}</div>`;
                    } else if (data.success === false) {
                        console.error('API returned success=false:', data);
                        container.innerHTML = `<div class="alert alert-danger">Failed to load daily margin analysis</div>`;
                    } else {
                        console.log('Creating daily margin analysis view...');
                        // Create the combined view with chart and table
                        createDailyMarginAnalysisView(data);
                    }
                })
                .catch(error => {
                    console.error('Error loading daily margin analysis:', error);
                    if (loading) {
                        loading.style.display = 'none';
                    }
                    container.innerHTML = `<div class="alert alert-danger">Error loading daily margin analysis: ${error.message}</div>`;
                });
        }

        function createDailyMarginAnalysisView(data) {
            const container = document.getElementById('chartContainer');
            
            // Parse the chart and table data
            const chartData = JSON.parse(data.chart);
            const tableData = JSON.parse(data.table);
            const tableRawData = data.table_data;  // Raw data for custom sorting
            const summary = data.summary;
            
            // Create the combined view
            let html = `
                <div class="row">
                    <div class="col-12 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">📊 Daily Margin Usage Summary</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-3">
                                        <div class="text-center">
                                            <h6>Total Days</h6>
                                            <h4 class="text-primary">${summary.total_days}</h4>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="text-center">
                                            <h6>Avg Margin ($)</h6>
                                            <h4 class="text-info">$${summary.avg_margin_dollars.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</h4>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="text-center">
                                            <h6>Avg Margin (%)</h6>
                                            <h4 class="text-warning">${summary.avg_margin_percentage.toFixed(2)}%</h4>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="text-center">
                                            <h6>Max Margin (%)</h6>
                                            <h4 class="text-danger">${summary.max_margin_percentage.toFixed(2)}%</h4>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-12 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">📈 Daily Margin Usage Chart</h5>
                            </div>
                            <div class="card-body">
                                <div id="dailyMarginChart" style="height: 600px;"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">📋 Daily Margin Usage Table</h5>
                            </div>
                            <div class="card-body">
                                <div id="dailyMarginTable"></div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
            
            // Render the chart
            setTimeout(() => {
                Plotly.newPlot('dailyMarginChart', chartData.data, chartData.layout, {
                    responsive: true,
                    displayModeBar: true,
                    displaylogo: false,
                    useResizeHandler: true
                });
            }, 100);
            
            // Render the custom sortable table
            setTimeout(() => {
                createSortableMarginTable(tableRawData);
            }, 200);
        }

        function createSortableMarginTable(tableData) {
            const container = document.getElementById('dailyMarginTable');
            
            // Create table HTML with sortable headers
            let tableHTML = `
                <div class="table-responsive">
                    <table class="table table-striped table-hover" id="marginTable">
                        <thead class="table-dark">
                            <tr>
                                <th style="cursor: pointer;" onclick="sortMarginTable(0)">
                                    Date <span id="sort-0" class="sort-indicator">↕</span>
                                </th>
                                <th style="cursor: pointer;" onclick="sortMarginTable(1)">
                                    Margin ($) <span id="sort-1" class="sort-indicator">↕</span>
                                </th>
                                <th style="cursor: pointer;" onclick="sortMarginTable(2)">
                                    Margin (%) <span id="sort-2" class="sort-indicator">↕</span>
                                </th>
                                <th style="cursor: pointer;" onclick="sortMarginTable(3)">
                                    Account Balance ($) <span id="sort-3" class="sort-indicator">↕</span>
                                </th>
                                <th style="cursor: pointer;" onclick="sortMarginTable(4)">
                                    Trades <span id="sort-4" class="sort-indicator">↕</span>
                                </th>
                                <th style="cursor: pointer;" onclick="sortMarginTable(5)">
                                    Strategies <span id="sort-5" class="sort-indicator">↕</span>
                                </th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            // Add table rows
            for (let i = 0; i < tableData.dates.length; i++) {
                tableHTML += `
                    <tr>
                        <td data-sort-value="${tableData.dates[i]}">${tableData.dates[i]}</td>
                        <td data-sort-value="${tableData.margin_dollars[i]}">$${tableData.margin_dollars[i].toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                        <td data-sort-value="${tableData.margin_percentages[i]}">${tableData.margin_percentages[i].toFixed(2)}%</td>
                        <td data-sort-value="${tableData.account_balances[i]}">$${tableData.account_balances[i].toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                        <td data-sort-value="${tableData.trades_counts[i]}">${tableData.trades_counts[i]}</td>
                        <td data-sort-value="${tableData.strategies_counts[i]}">${tableData.strategies_counts[i]}</td>
                    </tr>
                `;
            }
            
            tableHTML += `
                        </tbody>
                    </table>
                </div>
            `;
            
            container.innerHTML = tableHTML;
        }

        function sortMarginTable(columnIndex) {
            const table = document.getElementById('marginTable');
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            
            // Get current sort direction
            const sortIndicator = document.getElementById(`sort-${columnIndex}`);
            const currentDirection = sortIndicator.textContent;
            
            // Reset all sort indicators
            document.querySelectorAll('.sort-indicator').forEach(indicator => {
                indicator.textContent = '↕';
            });
            
            // Set new sort direction
            const newDirection = currentDirection === '↑' ? '↓' : '↑';
            sortIndicator.textContent = newDirection;
            
            // Sort rows
            rows.sort((a, b) => {
                const aValue = a.cells[columnIndex].getAttribute('data-sort-value');
                const bValue = b.cells[columnIndex].getAttribute('data-sort-value');
                
                let aNum = parseFloat(aValue);
                let bNum = parseFloat(bValue);
                
                // Handle date sorting (column 0)
                if (columnIndex === 0) {
                    aNum = new Date(aValue);
                    bNum = new Date(bValue);
                }
                
                // Handle non-numeric values
                if (isNaN(aNum) || isNaN(bNum)) {
                    if (aValue < bValue) return newDirection === '↑' ? -1 : 1;
                    if (aValue > bValue) return newDirection === '↑' ? 1 : -1;
                    return 0;
                }
                
                // Handle numeric values
                if (aNum < bNum) return newDirection === '↑' ? -1 : 1;
                if (aNum > bNum) return newDirection === '↑' ? 1 : -1;
                return 0;
            });
            
            // Re-append sorted rows
            rows.forEach(row => tbody.appendChild(row));
        }

        function sortWinRatesTable(columnIndex) {
            const table = document.getElementById('winRatesTable');
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            
            // Get current sort direction
            const sortIndicator = document.getElementById(`sort-${columnIndex}`);
            const currentDirection = sortIndicator.textContent;
            
            // Reset all sort indicators
            document.querySelectorAll('.sort-indicator').forEach(indicator => {
                indicator.textContent = '↕';
            });
            
            // Set new sort direction
            const newDirection = currentDirection === '↑' ? '↓' : '↑';
            sortIndicator.textContent = newDirection;
            
            // Sort rows
            rows.sort((a, b) => {
                const aValue = a.cells[columnIndex].getAttribute('data-sort-value');
                const bValue = b.cells[columnIndex].getAttribute('data-sort-value');
                
                let aNum = parseFloat(aValue);
                let bNum = parseFloat(bValue);
                
                // Handle non-numeric values (strategy names)
                if (isNaN(aNum) || isNaN(bNum)) {
                    aNum = aValue;
                    bNum = bValue;
                }
                
                if (newDirection === '↑') {
                    return aNum > bNum ? 1 : -1;
                } else {
                    return aNum < bNum ? 1 : -1;
                }
            });
            
            // Reorder rows
            rows.forEach(row => tbody.appendChild(row));
        }

        function loadPnlByDayOfWeekTable() {
            console.log('Loading P&L by day of week table...');
            const loading = document.getElementById('chartLoading');
            const container = document.getElementById('chartContainer');
            
            if (loading) {
                loading.style.display = 'block';
            }
            
            fetch('/api/pnl-by-day-of-week')
                .then(response => {
                    console.log('Response status:', response.status);
                    return response.json();
                })
                .then(data => {
                    console.log('P&L by day of week data:', data);
                    if (loading) {
                        loading.style.display = 'none';
                    }
                    if (data.error) {
                        container.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
                    } else {
                        createPnlByDayOfWeekTable(data);
                    }
                })
                .catch(error => {
                    console.error('Error loading P&L by day of week table:', error);
                    if (loading) {
                        loading.style.display = 'none';
                    }
                    container.innerHTML = '<div class="alert alert-danger">Error loading P&L by day of week table</div>';
                });
        }

        function createPnlByDayOfWeekTable(data) {
            const container = document.getElementById('chartContainer');
            
            if (!data.data || data.data.length === 0) {
                container.innerHTML = '<div class="alert alert-info">No P&L data available</div>';
                return;
            }
            
            const daysOfWeek = data.days_of_week || ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
            
            // Create strategy options for dropdown
            let strategyOptions = '<option value="all">All Strategies</option>';
            data.data.forEach(row => {
                strategyOptions += `<option value="${row.strategy}">${row.strategy}</option>`;
            });
            
            // Create HTML with table and chart
            let html = `
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5><i class="fas fa-calendar-week"></i> P&L by Day of Week</h5>
                        <div class="d-flex align-items-center">
                            <label for="strategyFilter" class="form-label me-2 mb-0">Filter by Strategy:</label>
                            <select class="form-select form-select-sm" id="strategyFilter" style="width: 250px;" onchange="filterPnlByDayOfWeek()">
                                ${strategyOptions}
                            </select>
                        </div>
                    </div>
                </div>
                <div class="table-responsive mb-4" style="max-height: 400px; overflow-y: auto;">
                    <table class="table table-striped table-hover table-sm" id="pnlByDayTable">
                        <thead class="table-dark">
                            <tr>
                                <th>Strategy</th>
                                <th>Trades</th>
            `;
            
            // Add day of week headers
            daysOfWeek.forEach(day => {
                html += `<th>${day}</th>`;
            });
            
            html += `
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            // Add data rows
            data.data.forEach(row => {
                html += '<tr>';
                html += `<td><strong>${row.strategy}</strong></td>`;
                html += `<td>${row.trades}</td>`;
                
                // Calculate total P&L for this strategy
                let strategyTotal = 0;
                
                // Add P&L for each day with color formatting
                daysOfWeek.forEach(day => {
                    const pnlValue = row[day] || 0;
                    strategyTotal += pnlValue;
                    
                    let cellClass = '';
                    let displayValue = '';
                    
                    if (pnlValue > 0) {
                        cellClass = 'text-success fw-bold';
                        displayValue = `$${pnlValue.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                    } else if (pnlValue < 0) {
                        cellClass = 'text-danger fw-bold';
                        displayValue = `$${pnlValue.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                    } else {
                        displayValue = `$${pnlValue.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                    }
                    
                    html += `<td class="${cellClass}" data-sort-value="${pnlValue}">${displayValue}</td>`;
                });
                
                // Add total column
                let totalCellClass = '';
                let totalDisplayValue = '';
                
                if (strategyTotal > 0) {
                    totalCellClass = 'text-success fw-bold';
                    totalDisplayValue = `$${strategyTotal.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                } else if (strategyTotal < 0) {
                    totalCellClass = 'text-danger fw-bold';
                    totalDisplayValue = `$${strategyTotal.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                } else {
                    totalCellClass = 'text-muted fw-bold';
                    totalDisplayValue = `$${strategyTotal.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                }
                
                html += `<td class="${totalCellClass}" data-sort-value="${strategyTotal}">${totalDisplayValue}</td>`;
                html += '</tr>';
            });
            
            
            html += `
                        </tbody>
                    </table>
                </div>
                <div class="mt-4">
                    <h5><i class="fas fa-chart-line"></i> Cumulative P&L by Day of Week</h5>
                    <div id="cumulativePnlChart" style="height: 500px; min-height: 500px;"></div>
                </div>
            `;
            
            container.innerHTML = html;
            
            // Store original data for filtering
            window.pnlByDayOfWeekData = data;
            
            // Load and create the cumulative chart
            loadCumulativeChartData();
        }
        
        function filterPnlByDayOfWeek() {
            const selectedStrategy = document.getElementById('strategyFilter').value;
            const data = window.pnlByDayOfWeekData;
            
            if (!data) return;
            
            const daysOfWeek = data.days_of_week || ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
            
            // Filter data based on selection
            let filteredData = data.data;
            if (selectedStrategy !== 'all') {
                filteredData = data.data.filter(row => row.strategy === selectedStrategy);
            }
            
            // Update table body
            const tbody = document.querySelector('#pnlByDayTable tbody');
            if (!tbody) return;
            
            let tableHtml = '';
            
            // Add filtered data rows
            filteredData.forEach(row => {
                tableHtml += '<tr>';
                tableHtml += `<td><strong>${row.strategy}</strong></td>`;
                tableHtml += `<td>${row.trades}</td>`;
                
                // Calculate total P&L for this strategy
                let strategyTotal = 0;
                
                // Add P&L for each day with color formatting
                daysOfWeek.forEach(day => {
                    const pnlValue = row[day] || 0;
                    strategyTotal += pnlValue;
                    
                    let cellClass = '';
                    let displayValue = '';
                    
                    if (pnlValue > 0) {
                        cellClass = 'text-success fw-bold';
                        displayValue = `$${pnlValue.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                    } else if (pnlValue < 0) {
                        cellClass = 'text-danger fw-bold';
                        displayValue = `$${pnlValue.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                    } else {
                        displayValue = `$${pnlValue.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                    }
                    
                    tableHtml += `<td class="${cellClass}" data-sort-value="${pnlValue}">${displayValue}</td>`;
                });
                
                // Add total column
                let totalCellClass = '';
                let totalDisplayValue = '';
                
                if (strategyTotal > 0) {
                    totalCellClass = 'text-success fw-bold';
                    totalDisplayValue = `$${strategyTotal.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                } else if (strategyTotal < 0) {
                    totalCellClass = 'text-danger fw-bold';
                    totalDisplayValue = `$${strategyTotal.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                } else {
                    totalCellClass = 'text-muted fw-bold';
                    totalDisplayValue = `$${strategyTotal.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                }
                
                tableHtml += `<td class="${totalCellClass}" data-sort-value="${strategyTotal}">${totalDisplayValue}</td>`;
                tableHtml += '</tr>';
            });
            
            tbody.innerHTML = tableHtml;
            
            // Update chart if it exists
            if (window.pnlByDayOfWeekChartData) {
                updateCumulativeChartForStrategy(selectedStrategy);
            }
        }
        
        function updateCumulativeChartForStrategy(selectedStrategy) {
            const chartData = window.pnlByDayOfWeekChartData;
            if (!chartData || !chartData.data) return;
            
            const daysOfWeek = chartData.days_of_week || ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];
            
            // Filter chart data based on selected strategy
            let filteredChartData = chartData.data;
            if (selectedStrategy !== 'all') {
                // Filter data for the selected strategy only
                filteredChartData = chartData.data.filter(trade => trade.strategy === selectedStrategy);
            }
            
            // Group data by day of week and calculate cumulative P&L for each day separately
            const dayData = {};
            const dayCumulativeTotals = {};
            daysOfWeek.forEach(day => {
                dayData[day] = [];
                dayCumulativeTotals[day] = 0;
            });
            
            // Also track overall cumulative P&L
            const overallCumulative = [];
            let totalCumulative = 0;
            
            // Sort filtered data by date to ensure proper cumulative calculation
            const sortedFilteredData = filteredChartData.sort((a, b) => new Date(a.date) - new Date(b.date));
            
            // Process the data to create cumulative series for each day
            sortedFilteredData.forEach(trade => {
                if (dayData[trade.day_of_week]) {
                    // Add to the cumulative total for this specific day
                    dayCumulativeTotals[trade.day_of_week] += trade.pnl;
                    
                    // Store the cumulative P&L for this day at this point in time
                    dayData[trade.day_of_week].push({
                        x: trade.date,
                        y: dayCumulativeTotals[trade.day_of_week]
                    });
                }
                
                // Add to overall cumulative
                totalCumulative += trade.pnl;
                overallCumulative.push({
                    x: trade.date,
                    y: totalCumulative
                });
            });
            
            // Create traces for each day of week
            const traces = [];
            const colors = ['#6366f1', '#8b5cf6', '#10b981', '#f59e0b', '#ef4444'];
            
            // Add overall cumulative P&L line first (so it appears behind other lines)
            if (overallCumulative.length > 0) {
                // Sort by date
                overallCumulative.sort((a, b) => new Date(a.x) - new Date(b.x));
                
                traces.push({
                    x: overallCumulative.map(d => d.x),
                    y: overallCumulative.map(d => d.y),
                    type: 'scatter',
                    mode: 'lines',
                    name: 'Total Portfolio',
                    line: {
                        color: '#ffffff',
                        width: 4,
                        dash: 'dash'
                    },
                    hovertemplate: '<b>Total Portfolio</b><br>' +
                                 'Date: %{x}<br>' +
                                 'Cumulative P&L: $%{y:,.2f}<br>' +
                                 '<extra></extra>'
                });
            }
            
            daysOfWeek.forEach((day, index) => {
                if (dayData[day].length > 0) {
                    // Sort by date
                    dayData[day].sort((a, b) => new Date(a.x) - new Date(b.x));
                    
                    traces.push({
                        x: dayData[day].map(d => d.x),
                        y: dayData[day].map(d => d.y),
                        type: 'scatter',
                        mode: 'lines+markers',
                        name: day,
                        line: {
                            color: colors[index % colors.length],
                            width: 3
                        },
                        marker: {
                            size: 4,
                            color: colors[index % colors.length]
                        },
                        hovertemplate: `<b>${day}</b><br>` +
                                     'Date: %{x}<br>' +
                                     'Cumulative P&L: $%{y:,.2f}<br>' +
                                     '<extra></extra>'
                    });
                }
            });
            
            const layout = {
                title: {
                    text: selectedStrategy === 'all' ? 'Cumulative P&L by Day of Week' : `Cumulative P&L by Day of Week - ${selectedStrategy}`,
                    font: { size: 18, color: '#ffffff' }
                },
                xaxis: {
                    title: 'Date',
                    color: '#ffffff',
                    gridcolor: '#404040',
                    showgrid: true
                },
                yaxis: {
                    title: 'Cumulative P&L ($)',
                    color: '#ffffff',
                    gridcolor: '#404040',
                    showgrid: true,
                    tickformat: '$,.0f'
                },
                plot_bgcolor: 'rgba(0,0,0,0)',
                paper_bgcolor: 'rgba(0,0,0,0)',
                font: { color: '#ffffff' },
                legend: {
                    x: 0.02,
                    y: 0.98,
                    bgcolor: 'rgba(0,0,0,0.5)',
                    bordercolor: '#404040',
                    borderwidth: 1
                },
                margin: { l: 60, r: 30, t: 60, b: 60 },
                hovermode: 'x unified'
            };
            
            const config = {
                responsive: true,
                displayModeBar: true,
                modeBarButtonsToRemove: ['pan2d', 'lasso2d', 'select2d'],
                displaylogo: false
            };
            
            // Update the chart
            Plotly.newPlot('cumulativePnlChart', traces, layout, config);
        }
        
        function loadCumulativeChartData() {
            fetch('/api/pnl-by-day-of-week-cumulative')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error('Error loading cumulative data:', data.error);
                        return;
                    }
                    // Store chart data for filtering
                    window.pnlByDayOfWeekChartData = data;
                    createCumulativePnlByDayOfWeekChart(data);
                })
                .catch(error => {
                    console.error('Error loading cumulative P&L data:', error);
                });
        }

        function loadCumulativePnlByDayOfWeekChart() {
            console.log('Loading cumulative P&L by day of week chart...');
            const loading = document.getElementById('chartLoading');
            const container = document.getElementById('chartContainer');
            
            if (loading) {
                loading.style.display = 'block';
            }
            
            fetch('/api/pnl-by-day-of-week-cumulative')
                .then(response => {
                    console.log('Response status:', response.status);
                    return response.json();
                })
                .then(data => {
                    console.log('Cumulative P&L by day of week data:', data);
                    if (loading) {
                        loading.style.display = 'none';
                    }
                    if (data.error) {
                        container.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
                    } else {
                        createCumulativePnlByDayOfWeekChart(data);
                    }
                })
                .catch(error => {
                    console.error('Error loading cumulative P&L by day of week chart:', error);
                    if (loading) {
                        loading.style.display = 'none';
                    }
                    container.innerHTML = '<div class="alert alert-danger">Error loading cumulative P&L chart</div>';
                });
        }

        function createCumulativePnlByDayOfWeekChart(data) {
            const container = document.getElementById('chartContainer');
            
            if (!data.data || data.data.length === 0) {
                container.innerHTML = '<div class="alert alert-info">No cumulative P&L data available</div>';
                return;
            }
            
            const daysOfWeek = data.days_of_week || ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];
            
            // Group data by day of week
            const dayData = {};
            daysOfWeek.forEach(day => {
                dayData[day] = [];
            });
            
            // Also track overall cumulative P&L
            const overallCumulative = [];
            let totalCumulative = 0;
            
            // Process the data to create cumulative series for each day
            data.data.forEach(trade => {
                if (dayData[trade.day_of_week]) {
                    dayData[trade.day_of_week].push({
                        x: trade.date,
                        y: trade.cumulative_pnl
                    });
                }
                
                // Add to overall cumulative
                totalCumulative += trade.pnl;
                overallCumulative.push({
                    x: trade.date,
                    y: totalCumulative
                });
            });
            
            // Create traces for each day of week
            const traces = [];
            const colors = ['#6366f1', '#8b5cf6', '#10b981', '#f59e0b', '#ef4444'];
            
            // Add overall cumulative P&L line first (so it appears behind other lines)
            if (overallCumulative.length > 0) {
                // Sort by date
                overallCumulative.sort((a, b) => new Date(a.x) - new Date(b.x));
                
                traces.push({
                    x: overallCumulative.map(d => d.x),
                    y: overallCumulative.map(d => d.y),
                    type: 'scatter',
                    mode: 'lines',
                    name: 'Total Portfolio',
                    line: {
                        color: '#ffffff',
                        width: 4,
                        dash: 'dash'
                    },
                    hovertemplate: '<b>Total Portfolio</b><br>' +
                                 'Date: %{x}<br>' +
                                 'Cumulative P&L: $%{y:,.2f}<br>' +
                                 '<extra></extra>'
                });
            }
            
            daysOfWeek.forEach((day, index) => {
                if (dayData[day].length > 0) {
                    // Sort by date
                    dayData[day].sort((a, b) => new Date(a.x) - new Date(b.x));
                    
                    traces.push({
                        x: dayData[day].map(d => d.x),
                        y: dayData[day].map(d => d.y),
                        type: 'scatter',
                        mode: 'lines+markers',
                        name: day,
                        line: {
                            color: colors[index % colors.length],
                            width: 3
                        },
                        marker: {
                            size: 4,
                            color: colors[index % colors.length]
                        },
                        hovertemplate: `<b>${day}</b><br>` +
                                     'Date: %{x}<br>' +
                                     'Cumulative P&L: $%{y:,.2f}<br>' +
                                     '<extra></extra>'
                    });
                }
            });
            
            const layout = {
                title: {
                    text: 'Cumulative P&L by Day of Week',
                    font: { size: 18, color: '#ffffff' }
                },
                xaxis: {
                    title: 'Date',
                    color: '#ffffff',
                    gridcolor: '#404040',
                    showgrid: true
                },
                yaxis: {
                    title: 'Cumulative P&L ($)',
                    color: '#ffffff',
                    gridcolor: '#404040',
                    showgrid: true,
                    tickformat: '$,.0f'
                },
                plot_bgcolor: 'rgba(0,0,0,0)',
                paper_bgcolor: 'rgba(0,0,0,0)',
                font: { color: '#ffffff' },
                legend: {
                    x: 0.02,
                    y: 0.98,
                    bgcolor: 'rgba(0,0,0,0.5)',
                    bordercolor: '#404040',
                    borderwidth: 1
                },
                margin: { l: 60, r: 30, t: 60, b: 60 },
                hovermode: 'x unified'
            };
            
            const config = {
                responsive: true,
                displayModeBar: true,
                modeBarButtonsToRemove: ['pan2d', 'lasso2d', 'select2d'],
                displaylogo: false
            };
            
            // Create the chart directly in the existing container
            
            // Create the chart
            Plotly.newPlot('cumulativePnlChart', traces, layout, config);
        }

        function loadConflictingLegsChart() {
            console.log('Loading conflicting legs chart...');
            const loading = document.getElementById('chartLoading');
            const container = document.getElementById('chartContainer');
            
            loading.style.display = 'block';
            container.innerHTML = '';
            
            fetch('/api/conflicting-legs')
                .then(response => response.json())
                .then(data => {
                    console.log('🔧 Conflicting legs API response:', data);
                    if (data.success) {
                        console.log('🔧 Conflicts data:', data.data.conflicts.length, 'conflicts found');
                        renderConflictingLegsChart(data.data);
                    } else {
                        container.innerHTML = `
                            <div class="alert alert-danger">
                                <h4>Error Loading Conflicting Leg Analysis</h4>
                                <p>${data.error}</p>
                            </div>
                        `;
                    }
                    loading.style.display = 'none';
                })
                .catch(error => {
                    console.error('Error loading conflicting legs analysis:', error);
                    container.innerHTML = `
                        <div class="alert alert-danger">
                            <h4>Error Loading Conflicting Leg Analysis</h4>
                            <p>${error.message}</p>
                        </div>
                    `;
                    loading.style.display = 'none';
                });
        }

        function renderConflictingLegsChart(data) {
            console.log('🔧 renderConflictingLegsChart called with data:', data);
            const container = document.getElementById('chartContainer');
            const { conflicts, summary } = data;
            console.log('🔧 Conflicts array:', conflicts.length, conflicts);
            
            let html = '';
            
            // Explanation section
            html += `
                <div class="alert alert-info mb-4">
                    <h5><i class="fas fa-info-circle"></i> What are Conflicting Legs?</h5>
                    <p class="mb-2">Conflicting legs occur when you have <strong>opposing positions on the same contract</strong> during overlapping time periods. This analysis identifies trades that may be working against each other.</p>
                    <div class="row">
                        <div class="col-md-6">
                            <strong>Examples of Conflicts:</strong>
                            <ul class="mb-0">
                                <li>Long call + Short call (same strike/expiry)</li>
                                <li>Long put + Short put (same strike/expiry)</li>
                                <li>Long stock + Short stock</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <strong>Why This Matters:</strong>
                            <ul class="mb-0">
                                <li>Positions may cancel each other out</li>
                                <li>Increased margin requirements</li>
                                <li>Reduced capital efficiency</li>
                                <li>Potential for unexpected losses</li>
                            </ul>
                        </div>
                    </div>
                </div>
            `;
            
            // Summary section with centered text
            html += `
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="metric-card">
                            <div class="card-body text-center">
                            <h4 class="metric-value text-danger">${summary.total_conflicts}</h4>
                            <p class="metric-title">Total Conflicts</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="metric-card">
                            <div class="card-body text-center">
                            <h4 class="metric-value text-warning">${summary.affected_trades}</h4>
                            <p class="metric-title">Affected Trades</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="metric-card">
                            <div class="card-body text-center">
                            <h4 class="metric-value text-info">${summary.affected_strategies}</h4>
                            <p class="metric-title">Affected Strategies</p>
                        </div>
                        </div>
                    </div>
                </div>
            `;
            
            if (conflicts.length === 0) {
                html += `
                    <div class="alert alert-success">
                        <h4><i class="fas fa-check-circle"></i> No Conflicting Legs Detected</h4>
                        <p>Great! No trades were found with opposing positions on the same contract during overlapping time periods.</p>
                    </div>
                `;
            } else {
                // Histogram section
                html += `
                    <div class="card mb-4">
                        <div class="card-body">
                            <h5 class="card-title">Conflict Distribution</h5>
                            <div id="conflictsHistogram" style="height: 400px;"></div>
                        </div>
                    </div>
                `;
                
                // Strategy breakdown (moved above table) - show both strategies in each conflict
                if (conflicts.length > 0) {
                    // Count strategy pairs (both strategies involved in conflicts)
                    const strategyPairCounts = {};
                    const individualStrategyCounts = {};
                    
                    conflicts.forEach(conflict => {
                        const strategy1 = conflict.trade1.strategy;
                        const strategy2 = conflict.trade2.strategy;
                        
                        // Count individual strategies
                        individualStrategyCounts[strategy1] = (individualStrategyCounts[strategy1] || 0) + 1;
                        individualStrategyCounts[strategy2] = (individualStrategyCounts[strategy2] || 0) + 1;
                        
                        // Count strategy pairs (ordered alphabetically for consistency)
                        const pair = strategy1 < strategy2 ? `${strategy1} ⚡ ${strategy2}` : `${strategy2} ⚡ ${strategy1}`;
                        strategyPairCounts[pair] = (strategyPairCounts[pair] || 0) + 1;
                    });
                    
                    // Sort by frequency (descending)
                    const sortedPairs = Object.entries(strategyPairCounts).sort((a, b) => b[1] - a[1]);
                    const sortedIndividual = Object.entries(individualStrategyCounts).sort((a, b) => b[1] - a[1]);
                    
                    console.log('🔧 Strategy pairs:', sortedPairs);
                    console.log('🔧 Individual strategies:', sortedIndividual);
                    
                    html += `
                        <div class="card mb-4">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h5 class="card-title mb-0">Conflicts by Strategy</h5>
                                    <div class="d-flex align-items-center gap-2">
                                        <label for="conflictsStrategyFilter" class="form-label mb-0 small">Filter by Strategy:</label>
                                        <select class="form-select form-select-sm" id="conflictsStrategyFilter" onchange="filterConflictsByStrategy(this.value)" style="width: auto;">
                                            <option value="">All Strategies</option>
                                        </select>
                                        <button class="btn btn-outline-secondary btn-sm" onclick="clearConflictsFilter()" title="Clear filter">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                </div>
                                
                                <h6 class="mt-3 mb-2 text-primary">Strategy Pairs in Conflicts (ordered by frequency)</h6>
                                <div class="row">
                    `;
                    
                    sortedPairs.forEach(([pair, count]) => {
                        // Extract first strategy from pair (before the " ⚡ " separator)
                        const firstStrategy = pair.split(' ⚡ ')[0];
                        console.log('Strategy pair:', pair, 'First strategy:', firstStrategy);
                        html += `
                            <div class="col-md-6 mb-2">
                                <div class="d-flex justify-content-between align-items-center p-2 border rounded strategy-pair-card" 
                                     data-strategy="${firstStrategy}" 
                                     style="cursor: pointer; transition: background-color 0.2s;" 
                                     onmouseover="this.style.backgroundColor='var(--bg-elevated)'"
                                     onmouseout="if (!this.style.backgroundColor.includes('var(--primary-color)')) this.style.backgroundColor=''"
                                     onclick="console.log('Clicked strategy pair:', '${firstStrategy}'); filterConflictsByStrategy('${firstStrategy.replace(/'/g, "\\'")}')"
                                     title="Click to filter by: ${firstStrategy}">
                                    <span class="small">${pair}</span>
                                    <span class="badge badge-danger">${count}</span>
                                </div>
                            </div>
                        `;
                    });
                    
                    html += `
                                </div>
                                
                                <h6 class="mt-4 mb-2 text-info">Individual Strategy Involvement (ordered by frequency)</h6>
                                <div class="row">
                    `;
                    
                    sortedIndividual.forEach(([strategy, count]) => {
                        html += `
                            <div class="col-md-6 mb-2">
                                <div class="d-flex justify-content-between align-items-center p-2 border rounded strategy-clickable" 
                                     data-strategy="${strategy}" 
                                     style="cursor: pointer; transition: background-color 0.2s;"
                                     onmouseover="this.style.backgroundColor='var(--bg-elevated)'"
                                     onmouseout="this.style.backgroundColor=''"
                                     onclick="filterConflictsByStrategy('${strategy}')">
                                    <span class="small">${strategy}</span>
                                    <span class="badge badge-warning">${count}</span>
                                </div>
                            </div>
                        `;
                    });
                    
                    html += `
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                // Conflicts table (removed Severity and Impact columns)
                html += `
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title mb-3">Detailed Conflicts</h5>
                            <div class="table-responsive">
                                <table class="table table-hover" id="conflictsTable">
                                    <thead class="table-dark">
                                        <tr>
                                            <th style="cursor: pointer;" onclick="sortConflictsTable('conflict_id')">Conflict # <span id="sort-indicator-conflict_id"></span></th>
                                            <th style="cursor: pointer;" onclick="sortConflictsTable('date')">Date <span id="sort-indicator-date"></span></th>
                                            <th style="cursor: pointer;" onclick="sortConflictsTable('contract')">Contract <span id="sort-indicator-contract"></span></th>
                                            <th style="cursor: pointer;" onclick="sortConflictsTable('trade1_strategy')">Trade 1 <span id="sort-indicator-trade1_strategy"></span></th>
                                            <th style="cursor: pointer;" onclick="sortConflictsTable('trade2_strategy')">Trade 2 <span id="sort-indicator-trade2_strategy"></span></th>
                                            <th style="cursor: pointer;" onclick="sortConflictsTable('overlap_days')">Overlap Days <span id="sort-indicator-overlap_days"></span></th>
                                        </tr>
                                    </thead>
                                    <tbody id="conflictsTableBody">
                `;
                
                conflicts.forEach((conflict, index) => {
                    console.log(`🔧 Conflict ${index + 1} data:`, conflict);
                    const trade1Pnl = conflict.trade1.pnl >= 0 ? 'text-success' : 'text-danger';
                    const trade2Pnl = conflict.trade2.pnl >= 0 ? 'text-success' : 'text-danger';
                    
                    html += `
                        <tr class="conflict-row" 
                            data-conflict-id="${conflict.conflict_id}"
                            data-date="${conflict.trade1.date_opened}"
                            data-contract="${conflict.contract_details.description}"
                            data-trade1-strategy="${conflict.trade1.strategy}"
                            data-trade2-strategy="${conflict.trade2.strategy}"
                            data-overlap-days="${conflict.overlap_days}">
                            <td>${conflict.conflict_id}</td>
                            <td>
                                <strong>${conflict.trade1.date_opened}</strong>
                            </td>
                            <td>
                                <strong>${conflict.contract_details.description}</strong>
                            </td>
                            <td>
                                <div class="small">
                                    <strong>${conflict.trade1.strategy}</strong><br>
                                    ${conflict.trade1.date_opened} to ${conflict.trade1.date_closed}<br>
                                    ${conflict.trade1.leg.quantity} ${conflict.trade1.leg.action} @ ${conflict.trade1.leg.premium}<br>
                                    P&L: <span class="${trade1Pnl}">$${conflict.trade1.pnl.toFixed(2)}</span>
                                </div>
                            </td>
                            <td>
                                <div class="small">
                                    <strong>${conflict.trade2.strategy}</strong><br>
                                    ${conflict.trade2.date_opened} to ${conflict.trade2.date_closed}<br>
                                    ${conflict.trade2.leg.quantity} ${conflict.trade2.leg.action} @ ${conflict.trade2.leg.premium}<br>
                                    P&L: <span class="${trade2Pnl}">$${conflict.trade2.pnl.toFixed(2)}</span>
                                </div>
                            </td>
                            <td>${conflict.overlap_days} days</td>
                        </tr>
                    `;
                });
                
                html += `
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            container.innerHTML = html;
            
            // Store conflicts data globally for filtering and sorting
            window.conflictsData = conflicts;
            
            // Populate strategy filter dropdown
            if (conflicts.length > 0) {
                const strategyFilter = document.getElementById('conflictsStrategyFilter');
                const strategies = new Set();
                conflicts.forEach(conflict => {
                    strategies.add(conflict.trade1.strategy);
                    strategies.add(conflict.trade2.strategy);
                });
                
                console.log('Available strategies in conflicts data:', Array.from(strategies));
                
                Array.from(strategies).sort().forEach(strategy => {
                    const option = document.createElement('option');
                    option.value = strategy;
                    option.textContent = strategy;
                    strategyFilter.appendChild(option);
                });
            }
            
            // Create histogram if there are conflicts
            if (conflicts.length > 0) {
                const chartData = createConflictsHistogram(conflicts);
                const config = {
                    responsive: true,
                    displayModeBar: true,
                    modeBarButtonsToRemove: ['pan2d', 'lasso2d', 'select2d']
                };
                Plotly.newPlot('conflictsHistogram', chartData.traces, chartData.layout, config);
            }
        }
        
        // Global variables for conflicts table sorting
        let conflictsSortKey = '';
        let conflictsSortDirection = 'asc';
        
        function filterConflictsByStrategy(strategy) {
            console.log('filterConflictsByStrategy called with:', strategy);
            const rows = document.querySelectorAll('.conflict-row');
            const strategyFilter = document.getElementById('conflictsStrategyFilter');
            
            console.log('Strategy filter element:', strategyFilter);
            
            // Update filter dropdown
            if (strategyFilter) {
                strategyFilter.value = strategy;
                console.log('Set filter value to:', strategy);
            } else {
                console.error('Strategy filter element not found!');
            }
            
            // Update strategy clickable elements highlighting
            document.querySelectorAll('.strategy-clickable').forEach(el => {
                if (el.dataset.strategy === strategy) {
                    el.style.backgroundColor = 'var(--primary-color)';
                    el.style.color = 'white';
                } else {
                    el.style.backgroundColor = '';
                    el.style.color = '';
                }
            });
            
            // Update strategy pair cards highlighting
            document.querySelectorAll('.strategy-pair-card').forEach(card => {
                const pairText = card.textContent;
                const firstStrategy = pairText.split(' & ')[0].trim();
                if (strategy && firstStrategy === strategy) {
                    card.style.backgroundColor = 'var(--primary-color)';
                    card.style.color = 'white';
                } else {
                    card.style.backgroundColor = '';
                    card.style.color = '';
                }
            });
            
            // Filter table rows
            let visibleRows = 0;
            rows.forEach(row => {
                const trade1Strategy = row.dataset.trade1Strategy;
                const trade2Strategy = row.dataset.trade2Strategy;
                
                if (!strategy || trade1Strategy === strategy || trade2Strategy === strategy) {
                    row.style.display = '';
                    visibleRows++;
                } else {
                    row.style.display = 'none';
                }
            });
            
            console.log(`Filtered to ${visibleRows} visible rows for strategy: ${strategy}`);
            
            // Filter strategy pairs section
            const strategyPairCards = document.querySelectorAll('.strategy-pair-card');
            strategyPairCards.forEach(card => {
                const pairText = card.textContent;
                // Check if the pair involves the selected strategy
                if (!strategy || pairText.includes(strategy)) {
                    card.closest('.col-md-6').style.display = '';
                } else {
                    card.closest('.col-md-6').style.display = 'none';
                }
            });
            
            // Filter individual strategy involvement section
            document.querySelectorAll('.strategy-clickable').forEach(el => {
                const strategyName = el.dataset.strategy;
                if (!strategy || strategyName === strategy) {
                    el.closest('.col-md-6').style.display = '';
                } else {
                    el.closest('.col-md-6').style.display = 'none';
                }
            });
            
            // Update row count display
            const visibleRowsCount = document.querySelectorAll('.conflict-row:not([style*="display: none"])');
            const visiblePairs = document.querySelectorAll('.strategy-pair-card').length - 
                                document.querySelectorAll('.strategy-pair-card').length + 
                                document.querySelectorAll('.strategy-pair-card:not([style*="display: none"])').length;
            console.log(`🔧 Filtered to ${visibleRowsCount.length} conflicts and ${visiblePairs} strategy pairs for strategy: ${strategy || 'All'}`);
        }
        
        function clearConflictsFilter() {
            filterConflictsByStrategy('');
            
            // Clear strategy highlighting
            document.querySelectorAll('.strategy-clickable').forEach(el => {
                el.style.backgroundColor = '';
                el.style.color = '';
            });
            
            // Show all strategy pairs and clear highlighting
            document.querySelectorAll('.strategy-pair-card').forEach(card => {
                card.closest('.col-md-6').style.display = '';
                card.style.backgroundColor = '';
                card.style.color = '';
            });
            
            // Show all individual strategies
            document.querySelectorAll('.strategy-clickable').forEach(el => {
                el.closest('.col-md-6').style.display = '';
            });
        }
        
        function sortConflictsTable(key) {
            const tbody = document.getElementById('conflictsTableBody');
            const rows = Array.from(tbody.querySelectorAll('.conflict-row'));
            
            // Determine sort direction
            if (conflictsSortKey === key) {
                conflictsSortDirection = conflictsSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                conflictsSortDirection = 'asc';
                conflictsSortKey = key;
            }
            
            // Clear all sort indicators
            document.querySelectorAll('[id^="sort-indicator-"]').forEach(indicator => {
                indicator.innerHTML = '';
            });
            
            // Add sort indicator
            const indicator = document.getElementById(`sort-indicator-${key}`);
            if (indicator) {
                indicator.innerHTML = conflictsSortDirection === 'asc' ? ' ↑' : ' ↓';
            }
            
            // Sort rows
            rows.sort((a, b) => {
                let aValue, bValue;
                
                switch (key) {
                    case 'conflict_id':
                        aValue = parseInt(a.dataset.conflictId);
                        bValue = parseInt(b.dataset.conflictId);
                        break;
                    case 'date':
                        aValue = new Date(a.dataset.date);
                        bValue = new Date(b.dataset.date);
                        break;
                    case 'contract':
                        aValue = a.dataset.contract.toLowerCase();
                        bValue = b.dataset.contract.toLowerCase();
                        break;
                    case 'trade1_strategy':
                        aValue = a.dataset.trade1Strategy.toLowerCase();
                        bValue = b.dataset.trade1Strategy.toLowerCase();
                        break;
                    case 'trade2_strategy':
                        aValue = a.dataset.trade2Strategy.toLowerCase();
                        bValue = b.dataset.trade2Strategy.toLowerCase();
                        break;
                    case 'overlap_days':
                        aValue = parseInt(a.dataset.overlapDays);
                        bValue = parseInt(b.dataset.overlapDays);
                        break;
                    default:
                        return 0;
                }
                
                if (aValue < bValue) return conflictsSortDirection === 'asc' ? -1 : 1;
                if (aValue > bValue) return conflictsSortDirection === 'asc' ? 1 : -1;
                return 0;
            });
            
            // Re-append sorted rows
            rows.forEach(row => tbody.appendChild(row));
        }

        function createConflictsHistogram(conflicts) {
            console.log('🔧 createConflictsHistogram called - v20241213_3_no_severity', conflicts.length, 'conflicts');
            
            // Group conflicts by date (no severity grouping)
            const conflictsByDate = {};
            const allDates = new Set();
            
            conflicts.forEach(conflict => {
                const date = conflict.trade1.date_opened;
                allDates.add(date);
                if (!conflictsByDate[date]) {
                    conflictsByDate[date] = [];
                }
                conflictsByDate[date].push(conflict);
            });
            
            // Get all weekdays in the date range (to show days with 0 conflicts)
            const sortedDates = Array.from(allDates).sort();
            if (sortedDates.length > 0) {
                const startDate = new Date(sortedDates[0]);
                const endDate = new Date(sortedDates[sortedDates.length - 1]);
                
                // Generate all weekdays between start and end dates
                const allWeekdays = [];
                for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                    const dayOfWeek = d.getDay();
                    if (dayOfWeek >= 1 && dayOfWeek <= 5) { // Monday to Friday
                        const dateStr = d.toISOString().split('T')[0];
                        allWeekdays.push(dateStr);
                        if (!conflictsByDate[dateStr]) {
                            conflictsByDate[dateStr] = [];
                        }
                    }
                }
                
                // Use all weekdays instead of just conflict dates
                const dates = allWeekdays.sort();
                
                // Prepare simple bar data (total count per date)
                const conflictCounts = dates.map(date => conflictsByDate[date].length);
                
                // Prepare tooltip data
                const tooltipData = dates.map(date => {
                    const dateConflicts = conflictsByDate[date];
                    
                    if (dateConflicts.length === 0) {
                        return `<b>Date: ${date}</b><br><b>No conflicts</b>`;
                    }
                    
                    let tooltip = `<b>Date: ${date}</b><br>`;
                    tooltip += `<b>Total Conflicts: ${dateConflicts.length}</b><br><br>`;
                    
                    dateConflicts.forEach((conflict, index) => {
                        if (index < 10) { // Show max 10 conflicts per date in tooltip
                            tooltip += `<b>Conflict ${index + 1}:</b><br>`;
                            tooltip += `<b>Contract:</b> ${conflict.contract_details.description}<br>`;
                            tooltip += `<b>Trade 1:</b> ${conflict.trade1.strategy} (${conflict.trade1.leg.action} ${conflict.trade1.leg.quantity}, P&L: $${conflict.trade1.pnl.toFixed(2)})<br>`;
                            tooltip += `<b>Trade 2:</b> ${conflict.trade2.strategy} (${conflict.trade2.leg.action} ${conflict.trade2.leg.quantity}, P&L: $${conflict.trade2.pnl.toFixed(2)})<br>`;
                            tooltip += `<b>Overlap:</b> ${conflict.overlap_days} days<br><br>`;
                        }
                    });
                    
                    if (dateConflicts.length > 10) {
                        tooltip += `... and ${dateConflicts.length - 10} more conflicts`;
                    }
                    
                    return tooltip;
                });
                
                // Create single bar trace
                const traces = [
                    {
                        x: dates,
                        y: conflictCounts,
                        type: 'bar',
                        name: 'Conflicts',
                        marker: { color: 'rgba(54, 162, 235, 0.8)' }, // Blue
                        hovertemplate: '%{customdata}<extra></extra>',
                        customdata: tooltipData
                    }
                ];
                
                const layout = {
                    title: 'Conflicts by Date (All Weekdays)',
                    xaxis: {
                        title: 'Date',
                        type: 'category'
                    },
                    yaxis: {
                        title: 'Number of Conflicts'
                    },
                    showlegend: false,
                    height: 400,
                    margin: { t: 50, r: 50, b: 100, l: 80 }
                };
                
                return { traces, layout };
            } else {
                // No conflicts found
                const traces = [{
                    x: [],
                    y: [],
                    type: 'bar',
                    name: 'No Conflicts'
                }];
                
                const layout = {
                    title: 'Conflicts by Date (No Data)',
                    xaxis: { title: 'Date' },
                    yaxis: { title: 'Number of Conflicts' },
                    showlegend: false,
                    height: 400,
                    margin: { t: 50, r: 50, b: 100, l: 80 }
                };
                
                return { traces, layout };
            }
            
        }

        function loadCommissionAnalysis() {
            console.log('Loading commission analysis...');
            const loading = document.getElementById('chartLoading');
            const container = document.getElementById('chartContainer');
            
            loading.style.display = 'block';
            container.innerHTML = '';
            
            fetch('/api/commission-analysis')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    loading.style.display = 'none';
                    createCommissionAnalysisDisplay(data);
                })
                .catch(error => {
                    loading.style.display = 'none';
                    console.error('Error loading commission analysis:', error);
                    container.innerHTML = `
                        <div class="alert alert-danger">
                            <h4>Error Loading Commission Analysis</h4>
                            <p>${error.message}</p>
                        </div>
                    `;
                });
        }

        function createCommissionAnalysisDisplay(data) {
            const container = document.getElementById('chartContainer');
            
            // Commission configuration panel
            const configHtml = `
                <div class="mb-4">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">Commission Configuration</h5>
                            <button class="btn btn-primary btn-sm" onclick="showCommissionConfigModal()">
                                <i class="bi bi-gear"></i> Configure Rates
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-4">
                                    <h6>SPX</h6>
                                    <small class="text-muted">
                                        Open: $${data.commission_rates.spx.opening_cost} | 
                                        Close: $${data.commission_rates.spx.closing_cost} | 
                                        Exercise: $${data.commission_rates.spx.exercise_fee}
                                    </small>
                                </div>
                                <div class="col-md-4">
                                    <h6>QQQ</h6>
                                    <small class="text-muted">
                                        Open: $${data.commission_rates.qqq.opening_cost} | 
                                        Close: $${data.commission_rates.qqq.closing_cost} | 
                                        Exercise: $${data.commission_rates.qqq.exercise_fee}
                                    </small>
                                </div>
                                <div class="col-md-4">
                                    <h6>Default (Others)</h6>
                                    <small class="text-muted">
                                        Open: $${data.commission_rates.default.opening_cost} | 
                                        Close: $${data.commission_rates.default.closing_cost} | 
                                        Exercise: $${data.commission_rates.default.exercise_fee}
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Summary statistics
            const summaryHtml = `
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card border-primary">
                            <div class="card-body text-center">
                                <h5 class="card-title text-primary">${data.summary.total_trades}</h5>
                                <p class="card-text text-dark">Total Trades</p>
                                <small class="text-muted">
                                    Live: ${data.summary.live_trades} | 
                                    Backtest: ${data.summary.backtest_trades}
                                </small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card border-success">
                            <div class="card-body text-center">
                                <h5 class="card-title text-success">$${data.summary.total_actual_commissions.toLocaleString()}</h5>
                                <p class="card-text text-dark">Actual Commissions</p>
                                <small class="text-muted">From backtest data</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card border-warning">
                            <div class="card-body text-center">
                                <h5 class="card-title text-warning">$${data.summary.total_estimated_commissions.toLocaleString()}</h5>
                                <p class="card-text text-dark">Estimated Commissions</p>
                                <small class="text-muted">From live data</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card border-danger">
                            <div class="card-body text-center">
                                <h5 class="card-title text-danger">$${data.summary.total_exercise_costs.toLocaleString()}</h5>
                                <p class="card-text text-dark">Exercise Costs</p>
                                <small class="text-muted">ITM legs exercised</small>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Breakdown table
            const breakdownHtml = `
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Commission Breakdown</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Type</th>
                                        <th>Amount</th>
                                        <th>Contracts</th>
                                        <th>Description</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>Actual Opening</td>
                                        <td>$${data.breakdown.actual_opening.toLocaleString()}</td>
                                        <td>${data.breakdown.actual_contracts.toLocaleString()}</td>
                                        <td>Opening commissions from backtest data</td>
                                    </tr>
                                    <tr>
                                        <td>Actual Closing</td>
                                        <td>$${data.breakdown.actual_closing.toLocaleString()}</td>
                                        <td>${data.breakdown.actual_closing_contracts.toLocaleString()}</td>
                                        <td>Closing commissions from backtest data (excludes expired)</td>
                                    </tr>
                                    <tr>
                                        <td>Estimated Opening</td>
                                        <td>$${data.breakdown.estimated_opening.toLocaleString()}</td>
                                        <td>${data.breakdown.estimated_contracts.toLocaleString()}</td>
                                        <td>Estimated opening commissions for live data</td>
                                    </tr>
                                    <tr>
                                        <td>Estimated Closing</td>
                                        <td>$${data.breakdown.estimated_closing.toLocaleString()}</td>
                                        <td>${data.breakdown.estimated_closing_contracts.toLocaleString()}</td>
                                        <td>Estimated closing commissions for live data (excludes expired)</td>
                                    </tr>
                                    <tr>
                                        <td>Exercise Costs</td>
                                        <td>$${data.breakdown.exercise_costs.toLocaleString()}</td>
                                        <td>${data.breakdown.exercise_contracts.toLocaleString()}</td>
                                        <td>Costs for exercising ITM options</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Total All Costs</strong></td>
                                        <td><strong>$${data.summary.total_all_costs.toLocaleString()}</strong></td>
                                        <td><strong>${data.summary.total_contracts.toLocaleString()}</strong></td>
                                        <td><strong>Combined actual + estimated + exercise costs</strong></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
            
            // By strategy breakdown
            let strategyRows = '';
            let totalTrades = 0, totalContracts = 0, totalActual = 0, totalEstimated = 0, totalExercise = 0, totalExerciseContracts = 0;
            
            for (const [strategy, info] of Object.entries(data.by_strategy)) {
                const totalCommissions = info.actual_commissions + info.estimated_commissions + info.exercise_costs;
                const avgPerTrade = info.count > 0 ? (totalCommissions / info.count) : 0;
                
                // Add to totals
                totalTrades += info.count;
                totalContracts += info.contracts || 0;
                totalActual += info.actual_commissions;
                totalEstimated += info.estimated_commissions;
                totalExercise += info.exercise_costs;
                totalExerciseContracts += info.exercise_contracts || 0;
                
                strategyRows += `
                    <tr>
                        <td>${strategy}</td>
                        <td>${info.count}</td>
                        <td>${(info.contracts || 0).toLocaleString()}</td>
                        <td>${(info.exercise_contracts || 0).toLocaleString()}</td>
                        <td>$${info.actual_commissions.toLocaleString()}</td>
                        <td>$${info.estimated_commissions.toLocaleString()}</td>
                        <td>$${info.exercise_costs.toLocaleString()}</td>
                        <td>$${totalCommissions.toLocaleString()}</td>
                        <td>$${avgPerTrade.toFixed(2)}</td>
                    </tr>
                `;
            }
            
            // Add totals row
            const grandTotal = totalActual + totalEstimated + totalExercise;
            const avgCommissionsPerTrade = totalTrades > 0 ? (grandTotal / totalTrades) : 0;
            strategyRows += `
                <tr style="font-weight: bold; border-top: 2px solid #dee2e6;">
                    <td>TOTAL</td>
                    <td>${totalTrades.toLocaleString()}</td>
                    <td>${totalContracts.toLocaleString()}</td>
                    <td>${totalExerciseContracts.toLocaleString()}</td>
                    <td>$${totalActual.toLocaleString()}</td>
                    <td>$${totalEstimated.toLocaleString()}</td>
                    <td>$${totalExercise.toLocaleString()}</td>
                    <td>$${grandTotal.toLocaleString()}</td>
                    <td>$${avgCommissionsPerTrade.toFixed(2)}</td>
                </tr>
            `;
            
            const strategyHtml = `
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Commission Analysis by Strategy</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Strategy</th>
                                        <th>Trades</th>
                                        <th>Contracts</th>
                                        <th>Contracts Exercised</th>
                                        <th>Actual Commissions</th>
                                        <th>Estimated Commissions</th>
                                        <th>Exercise Costs</th>
                                        <th>Total Commissions (incl. Exercise)</th>
                                        <th>Avg Commissions per Trade</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${strategyRows}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
            
            container.innerHTML = configHtml + summaryHtml + breakdownHtml + strategyHtml;
        }

        function showCommissionConfigModal() {
            // Load current configuration and show modal
            fetch('/api/commission-config')
                .then(response => response.json())
                .then(config => {
                    const modalHtml = `
                        <div class="modal fade" id="commissionConfigModal" tabindex="-1">
                            <div class="modal-dialog modal-lg">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title">Commission Configuration</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                    </div>
                                    <div class="modal-body">
                                        <form id="commissionConfigForm">
                                            <div class="row">
                                                <div class="col-md-4">
                                                    <h6>SPX Rates</h6>
                                                    <div class="mb-3">
                                                        <label class="form-label">Opening Cost ($)</label>
                                                        <input type="number" step="0.01" class="form-control" 
                                                               id="spx_opening" value="${config.spx.opening_cost}">
                                                    </div>
                                                    <div class="mb-3">
                                                        <label class="form-label">Closing Cost ($)</label>
                                                        <input type="number" step="0.01" class="form-control" 
                                                               id="spx_closing" value="${config.spx.closing_cost}">
                                                    </div>
                                                    <div class="mb-3">
                                                        <label class="form-label">Exercise Fee ($)</label>
                                                        <input type="number" step="0.01" class="form-control" 
                                                               id="spx_exercise" value="${config.spx.exercise_fee}">
                                                    </div>
                                                </div>
                                                <div class="col-md-4">
                                                    <h6>QQQ Rates</h6>
                                                    <div class="mb-3">
                                                        <label class="form-label">Opening Cost ($)</label>
                                                        <input type="number" step="0.01" class="form-control" 
                                                               id="qqq_opening" value="${config.qqq.opening_cost}">
                                                    </div>
                                                    <div class="mb-3">
                                                        <label class="form-label">Closing Cost ($)</label>
                                                        <input type="number" step="0.01" class="form-control" 
                                                               id="qqq_closing" value="${config.qqq.closing_cost}">
                                                    </div>
                                                    <div class="mb-3">
                                                        <label class="form-label">Exercise Fee ($)</label>
                                                        <input type="number" step="0.01" class="form-control" 
                                                               id="qqq_exercise" value="${config.qqq.exercise_fee}">
                                                    </div>
                                                </div>
                                                <div class="col-md-4">
                                                    <h6>Default Rates</h6>
                                                    <div class="mb-3">
                                                        <label class="form-label">Opening Cost ($)</label>
                                                        <input type="number" step="0.01" class="form-control" 
                                                               id="default_opening" value="${config.default.opening_cost}">
                                                    </div>
                                                    <div class="mb-3">
                                                        <label class="form-label">Closing Cost ($)</label>
                                                        <input type="number" step="0.01" class="form-control" 
                                                               id="default_closing" value="${config.default.closing_cost}">
                                                    </div>
                                                    <div class="mb-3">
                                                        <label class="form-label">Exercise Fee ($)</label>
                                                        <input type="number" step="0.01" class="form-control" 
                                                               id="default_exercise" value="${config.default.exercise_fee}">
                                                    </div>
                                                </div>
                                            </div>
                                        </form>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                        <button type="button" class="btn btn-primary" onclick="saveCommissionConfig()">Save Changes</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    // Remove existing modal if present
                    const existingModal = document.getElementById('commissionConfigModal');
                    if (existingModal) {
                        existingModal.remove();
                    }
                    
                    // Add modal to page
                    document.body.insertAdjacentHTML('beforeend', modalHtml);
                    
                    // Show modal
                    const modal = new bootstrap.Modal(document.getElementById('commissionConfigModal'));
                    modal.show();
                })
                .catch(error => {
                    console.error('Error loading commission config:', error);
                    alert('Error loading commission configuration');
                });
        }

        function saveCommissionConfig() {
            const config = {
                spx: {
                    opening_cost: parseFloat(document.getElementById('spx_opening').value),
                    closing_cost: parseFloat(document.getElementById('spx_closing').value),
                    exercise_fee: parseFloat(document.getElementById('spx_exercise').value)
                },
                qqq: {
                    opening_cost: parseFloat(document.getElementById('qqq_opening').value),
                    closing_cost: parseFloat(document.getElementById('qqq_closing').value),
                    exercise_fee: parseFloat(document.getElementById('qqq_exercise').value)
                },
                default: {
                    opening_cost: parseFloat(document.getElementById('default_opening').value),
                    closing_cost: parseFloat(document.getElementById('default_closing').value),
                    exercise_fee: parseFloat(document.getElementById('default_exercise').value)
                }
            };
            
            fetch('/api/commission-config', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(config)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Close modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('commissionConfigModal'));
                    modal.hide();
                    
                    // Reload commission analysis to show updated calculations
                    loadCommissionAnalysis();
                } else {
                    showAlert('Error updating configuration: ' + data.error, 'danger');
                }
            })
            .catch(error => {
                console.error('Error saving commission config:', error);
                showAlert('Error saving commission configuration', 'danger');
            });
        }

        function showAlert(message, type) {
            const alertHtml = `
                <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            
            const container = document.getElementById('chartContainer');
            container.insertAdjacentHTML('afterbegin', alertHtml);
            
            // Auto-dismiss after 5 seconds
            setTimeout(() => {
                const alert = container.querySelector('.alert');
                if (alert) {
                    alert.remove();
                }
            }, 5000);
        }

        function loadPnlByMonthTable() {
            console.log('Loading P&L by month table...');
            const loading = document.getElementById('chartLoading');
            const container = document.getElementById('chartContainer');
            
            if (loading) {
                loading.style.display = 'block';
            }
            
            fetch('/api/pnl-by-month')
                .then(response => {
                    console.log('Response status:', response.status);
                    return response.json();
                })
                .then(data => {
                    console.log('P&L by month data:', data);
                    if (loading) {
                        loading.style.display = 'none';
                    }
                    if (data.error) {
                        container.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
                    } else {
                        createPnlByMonthTable(data);
                    }
                })
                .catch(error => {
                    console.error('Error loading P&L by month table:', error);
                    if (loading) {
                        loading.style.display = 'none';
                    }
                    container.innerHTML = '<div class="alert alert-danger">Error loading P&L by month table</div>';
                });
        }

        function createPnlByMonthTable(data) {
            const container = document.getElementById('chartContainer');
            
            if (!data.data || data.data.length === 0) {
                container.innerHTML = '<div class="alert alert-info">No monthly P&L data available</div>';
                return;
            }
            
            const months = data.months || [];
            const monthLabels = data.month_labels || [];
            const monthlyTotals = data.monthly_totals || {};
            
            // Store data globally for sorting
            window.monthlyPnlData = data;
            window.monthlyPnlSortKey = 'strategy';
            window.monthlyPnlSortAsc = true;
            
            // Create HTML table with sticky columns
            let html = `
                <style>
                    #pnlByMonthTable {
                        position: relative;
                    }
                    #pnlByMonthTable th:nth-child(1),
                    #pnlByMonthTable td:nth-child(1) {
                        position: sticky;
                        left: 0;
                        background: var(--bg-elevated);
                        z-index: 10;
                        border-right: 2px solid var(--border-subtle);
                        width: 420px;
                        min-width: 420px;
                        max-width: 420px;
                    }
                    #pnlByMonthTable thead th:nth-child(1) {
                        background: var(--bs-dark) !important;
                        z-index: 11;
                    }
                    /* Handle dark mode */
                    [data-theme="dark"] #pnlByMonthTable th:nth-child(1),
                    [data-theme="dark"] #pnlByMonthTable td:nth-child(1) {
                        background: var(--bg-elevated);
                    }
                    [data-theme="dark"] #pnlByMonthTable thead th:nth-child(1) {
                        background: var(--bs-dark) !important;
                    }
                    /* Handle striped rows for sticky column */
                    .table-striped > tbody > tr:nth-of-type(odd) > td:nth-child(1) {
                        background: rgba(255, 255, 255, 0.05);
                    }
                    .table-striped > tbody > tr:nth-of-type(even) > td:nth-child(1) {
                        background: var(--bg-elevated);
                    }
                    /* Sortable header styles */
                    #pnlByMonthTable th.sortable {
                        cursor: pointer;
                        user-select: none;
                        position: relative;
                    }
                    #pnlByMonthTable th.sortable:hover {
                        background-color: rgba(255, 255, 255, 0.1);
                    }
                    #pnlByMonthTable th.sortable::after {
                        content: '↕️';
                        position: absolute;
                        right: 8px;
                        top: 50%;
                        transform: translateY(-50%);
                        opacity: 0.5;
                        font-size: 12px;
                    }
                    #pnlByMonthTable th.sortable.sort-asc::after {
                        content: '↑';
                        opacity: 1;
                        color: #28a745;
                    }
                    #pnlByMonthTable th.sortable.sort-desc::after {
                        content: '↓';
                        opacity: 1;
                        color: #dc3545;
                    }
                </style>
                <div class="table-responsive">
                    <table class="table table-striped table-hover" id="pnlByMonthTable">
                        <thead class="table-dark">
                            <tr>
                                <th class="sortable sort-asc" onclick="sortMonthlyPnlTable('strategy')">Strategy</th>
                                <th class="sortable" onclick="sortMonthlyPnlTable('trades')">Trades</th>
                                <th class="sortable" onclick="sortMonthlyPnlTable('total_pnl')">Total P&L</th>
            `;
            
            // Add month headers
            months.forEach((month, index) => {
                html += `<th class="sortable" style="min-width: 100px;" onclick="sortMonthlyPnlTable('${month}')">${monthLabels[index]}</th>`;
            });
            
            html += `
                            </tr>
                        </thead>
                        <tbody id="monthlyPnlTableBody">
            `;
            
            // Render table body
            html += renderMonthlyPnlTableBody(data);
            
            html += `
                        </tbody>
                    </table>
                </div>
            `;
            
            container.innerHTML = html;
        }

        function renderMonthlyPnlTableBody(data) {
            const months = data.months || [];
            const monthlyTotals = data.monthly_totals || {};
            let html = '';
            
            // Add data rows
            data.data.forEach(row => {
                html += '<tr>';
                html += `<td><strong>${row.strategy}</strong></td>`;
                html += `<td>${row.trades}</td>`;
                
                // Add total P&L with color formatting
                const totalPnl = row.total_pnl || 0;
                let totalClass = '';
                if (totalPnl > 0) {
                    totalClass = 'text-success fw-bold';
                } else if (totalPnl < 0) {
                    totalClass = 'text-danger fw-bold';
                }
                html += `<td class="${totalClass}">$${totalPnl.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>`;
                
                // Add P&L for each month with color formatting
                months.forEach(month => {
                    const pnlValue = row[month] || 0;
                    let cellClass = '';
                    let displayValue = '';
                    
                    if (pnlValue > 0) {
                        cellClass = 'text-success fw-bold';
                        displayValue = `$${pnlValue.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                    } else if (pnlValue < 0) {
                        cellClass = 'text-danger fw-bold';
                        displayValue = `$${pnlValue.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                    } else {
                        displayValue = `$${pnlValue.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                    }
                    
                    html += `<td class="${cellClass}" data-sort-value="${pnlValue}">${displayValue}</td>`;
                });
                
                html += '</tr>';
            });
            
            // Add totals row
            html += '<tr class="table-info fw-bold">';
            html += '<td><strong>Monthly Totals</strong></td>';
            html += '<td>-</td>';
            
            // Calculate and display total across all strategies
            const grandTotal = data.data.reduce((sum, row) => sum + (row.total_pnl || 0), 0);
            let grandTotalClass = '';
            if (grandTotal > 0) {
                grandTotalClass = 'text-success fw-bold';
            } else if (grandTotal < 0) {
                grandTotalClass = 'text-danger fw-bold';
            }
            html += `<td class="${grandTotalClass}">$${grandTotal.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>`;
            
            // Add monthly totals
            months.forEach(month => {
                const monthTotal = monthlyTotals[month] || 0;
                let cellClass = '';
                if (monthTotal > 0) {
                    cellClass = 'text-success fw-bold';
                } else if (monthTotal < 0) {
                    cellClass = 'text-danger fw-bold';
                }
                html += `<td class="${cellClass}">$${monthTotal.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>`;
            });
            
            html += '</tr>';
            
            return html;
        }

        function sortMonthlyPnlTable(sortKey) {
            if (!window.monthlyPnlData) return;
            
            // Toggle sort direction if clicking the same column
            if (window.monthlyPnlSortKey === sortKey) {
                window.monthlyPnlSortAsc = !window.monthlyPnlSortAsc;
            } else {
                window.monthlyPnlSortKey = sortKey;
                window.monthlyPnlSortAsc = true;
            }
            
            // Sort the data
            const sortedData = [...window.monthlyPnlData.data].sort((a, b) => {
                let valA = a[sortKey];
                let valB = b[sortKey];
                
                // Handle different data types
                if (sortKey === 'strategy') {
                    // String comparison
                    valA = (valA || '').toString().toLowerCase();
                    valB = (valB || '').toString().toLowerCase();
                    return window.monthlyPnlSortAsc ? valA.localeCompare(valB) : valB.localeCompare(valA);
                } else {
                    // Numeric comparison
                    valA = parseFloat(valA) || 0;
                    valB = parseFloat(valB) || 0;
                    return window.monthlyPnlSortAsc ? valA - valB : valB - valA;
                }
            });
            
            // Update the data object
            window.monthlyPnlData.data = sortedData;
            
            // Re-render the table body
            const tbody = document.getElementById('monthlyPnlTableBody');
            if (tbody) {
                tbody.innerHTML = renderMonthlyPnlTableBody(window.monthlyPnlData);
            }
            
            // Update sort indicators
            updateMonthlyPnlSortIndicators();
        }

        function updateMonthlyPnlSortIndicators() {
            // Remove all sort classes
            document.querySelectorAll('#pnlByMonthTable th.sortable').forEach(th => {
                th.classList.remove('sort-asc', 'sort-desc');
            });
            
            // Add sort class to current sort column
            const columns = ['strategy', 'trades', 'total_pnl', ...window.monthlyPnlData.months];
            const sortIndex = columns.indexOf(window.monthlyPnlSortKey);
            if (sortIndex >= 0) {
                const sortHeader = document.querySelectorAll('#pnlByMonthTable th.sortable')[sortIndex];
                if (sortHeader) {
                    sortHeader.classList.add(window.monthlyPnlSortAsc ? 'sort-asc' : 'sort-desc');
                }
            }
        }

        
        // Theme toggle functionality
        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            
            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            
            updateThemeUI(newTheme);
            
            // Re-render charts with new theme if any charts are loaded
            if (window.Plotly && document.querySelector('#chartContainer .js-plotly-plot')) {
                setTimeout(() => {
                    const chartElement = document.querySelector('#chartContainer .js-plotly-plot');
                    if (chartElement) {
                        window.Plotly.Plots.resize(chartElement);
                    }
                }, 100);
            }
        }
        
        function updateThemeUI(theme) {
            const themeIcon = document.getElementById('themeIcon');
            const themeText = document.getElementById('themeText');
            
            if (theme === 'dark') {
                themeIcon.className = 'fas fa-moon';
                themeText.textContent = 'Dark';
            } else {
                themeIcon.className = 'fas fa-sun';
                themeText.textContent = 'Light';
            }
        }
        
        // Initialize theme from localStorage
        document.addEventListener('DOMContentLoaded', function() {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            document.documentElement.setAttribute('data-theme', savedTheme);
            updateThemeUI(savedTheme);
        });
        
        // Enhanced chart theme compatibility
        function getChartTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            if (currentTheme === 'light') {
                return {
                    paper_bgcolor: 'rgba(255,255,255,0.8)',
                    plot_bgcolor: 'rgba(255,255,255,0.6)',
                    font: { color: '#1e293b' },
                    gridcolor: '#e2e8f0'
                };
            } else {
                return {
                    paper_bgcolor: 'rgba(255,255,255,0.05)',
                    plot_bgcolor: 'rgba(255,255,255,0.02)',
                    font: { color: '#ffffff' },
                    gridcolor: '#404040'
                };
            }
        }

        // Authentication functions
        function loadUserInfo() {
            fetch('/auth/user')
            .then(response => response.json())
            .then(data => {
                updateUserDisplay(data);
                updateAuthDropdown(data);
            })
            .catch(error => {
                console.error('Error loading user info:', error);
                updateUserDisplay({ is_authenticated: false, is_guest: false, user: null });
                updateAuthDropdown({ is_authenticated: false, is_guest: false, user: null });
            });
        }

        function updateUserDisplay(data) {
            const userDisplay = document.getElementById('userDisplay');
            const authButtonText = document.getElementById('authButtonText');
            
            if (data.is_authenticated) {
                const user = data.user;
                let displayHtml = '';
                
                if (user.avatar_url) {
                    displayHtml += `<img src="${user.avatar_url}" alt="${user.name}" class="user-avatar">`;
                }
                displayHtml += `<span>Welcome, ${user.name}</span>`;
                
                userDisplay.innerHTML = displayHtml;
                authButtonText.textContent = user.name;
            } else if (data.is_guest) {
                userDisplay.innerHTML = '<span><i class="fas fa-user-ninja"></i> Guest Mode</span>';
                authButtonText.textContent = 'Guest';
            } else {
                userDisplay.innerHTML = '<span>Not logged in</span>';
                authButtonText.textContent = 'Login';
            }
        }

        function updateAuthDropdown(data) {
            const dropdownMenu = document.getElementById('authDropdownMenu');
            
            if (data.is_authenticated) {
                // Check if user is admin
                const isAdmin = data.user.is_admin || false;
                
                // Logged in user menu
                dropdownMenu.innerHTML = `
                    <li><h6 class="dropdown-header">Signed in as ${data.user.name}</h6></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item" href="#" onclick="showUserInfo()">
                        <i class="fas fa-user"></i> Profile
                    </a></li>
                    ${isAdmin ? `<li><a class="dropdown-item" href="/admin/" target="_blank">
                        <i class="fas fa-cogs"></i> Admin Panel
                    </a></li>` : ''}
                    <li><a class="dropdown-item" href="#" onclick="switchToGuest()">
                        <i class="fas fa-user-ninja"></i> Switch to Guest
                    </a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item" href="/auth/logout">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </a></li>
                `;
            } else if (data.is_guest) {
                // Guest mode menu
                dropdownMenu.innerHTML = `
                    <li><h6 class="dropdown-header">Guest Mode</h6></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><span class="dropdown-item-text">
                        <small class="text-muted">Sign in to save your data permanently</small>
                    </span></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><div class="oauth-buttons">
                        <a href="/auth/login/discord" class="btn-oauth btn-discord">
                            <i class="fab fa-discord"></i> Sign in with Discord
                        </a>
                        <a href="/auth/login/google" class="btn-oauth btn-google">
                            <i class="fab fa-google"></i> Sign in with Google
                        </a>
                    </div></li>
                `;
            } else {
                // Not logged in menu
                dropdownMenu.innerHTML = `
                    <li><h6 class="dropdown-header">Sign In</h6></li>
                    <li><div class="oauth-buttons">
                        <a href="/auth/login/discord" class="btn-oauth btn-discord">
                            <i class="fab fa-discord"></i> Sign in with Discord
                        </a>
                        <a href="/auth/login/google" class="btn-oauth btn-google">
                            <i class="fab fa-google"></i> Sign in with Google
                        </a>
                        <a href="/auth/login/guest" class="btn-oauth btn-guest">
                            <i class="fas fa-user-ninja"></i> Continue as Guest
                        </a>
                    </div></li>
                `;
            }
        }

        function showUserInfo() {
            fetch('/auth/user')
            .then(response => response.json())
            .then(data => {
                if (data.is_authenticated) {
                    const user = data.user;
                    showAlert(`
                        <strong>User Profile</strong><br>
                        Name: ${user.name}<br>
                        Email: ${user.email}<br>
                        Provider: ${user.provider}<br>
                        Data Folder: ${user.data_folder}
                    `, 'info');
                }
            });
        }

        function switchToGuest() {
            if (confirm('Switch to guest mode? Your current session will be logged out.')) {
                window.location.href = '/auth/logout?redirect=' + encodeURIComponent('/auth/login/guest');
            }
        }

        // Login loading functions
        function showLoginLoading() {
            const overlay = document.getElementById('loginLoadingOverlay');
            if (overlay) {
                overlay.style.display = 'flex';
            }
        }

        function hideLoginLoading() {
            const overlay = document.getElementById('loginLoadingOverlay');
            if (overlay) {
                overlay.style.display = 'none';
            }
        }

        // Check Discord authentication status
        function checkDiscordAuth() {
            return fetch('/auth/check-discord-auth')
                .then(response => response.json())
                .catch(error => {
                    console.error('Error checking Discord auth:', error);
                    return { authenticated: false };
                });
        }

        // Add click handlers to OAuth buttons
        document.addEventListener('DOMContentLoaded', function() {
            // Add click handlers for OAuth buttons
            document.addEventListener('click', function(e) {
                if (e.target.closest('.btn-oauth')) {
                    const link = e.target.closest('.btn-oauth');
                    const href = link.getAttribute('href');
                    
                    // For Discord login, check if already authenticated
                    if (href && href.includes('/auth/login/discord')) {
                        e.preventDefault();
                        showLoginLoading();
                        
                        checkDiscordAuth().then(data => {
                            if (data.authenticated) {
                                // Already authenticated, redirect to dashboard
                                hideLoginLoading();
                                window.location.href = '/dashboard';
                            } else {
                                // Not authenticated, proceed with OAuth flow
                                window.location.href = href;
                            }
                        });
                    } else if (href && !href.includes('/auth/login/guest')) {
                        // Show loading for other OAuth logins (not guest)
                        showLoginLoading();
                    }
                }
            });
        });

        // Hide loading if user navigates back or cancels
        window.addEventListener('beforeunload', function() {
            hideLoginLoading();
        });

        // Also hide loading if page is hidden (user switches tabs)
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                hideLoginLoading();
            }
        });

        // Handle window resize to ensure charts are properly sized
        let resizeTimeout;
        window.addEventListener('resize', function() {
            // Debounce resize events to avoid excessive redraws
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(() => {
            const chartContainers = document.querySelectorAll('.chart-container');
            chartContainers.forEach(container => {
                const plotDiv = container.querySelector('.js-plotly-plot');
                if (plotDiv && plotDiv.layout) {
                        // Only resize if the container size has actually changed
                        const newWidth = container.clientWidth - 60; // Account for padding
                        const newHeight = Math.max(400, container.clientHeight - 60); // Minimum height of 400px
                        
                        // Check if size actually changed to avoid unnecessary redraws
                        if (plotDiv.layout.width !== newWidth || plotDiv.layout.height !== newHeight) {
                    Plotly.relayout(plotDiv, {
                                width: newWidth,
                                height: newHeight
                    });
                        }
                }
            });
            }, 150); // 150ms debounce
        });

        // Initial chart resize after page load
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                window.dispatchEvent(new Event('resize'));
            }, 1000);
        });

        // Toggle Files Overview section
        function toggleFilesOverview() {
            const card = document.getElementById('filesOverviewCard');
            const icon = document.getElementById('filesOverviewIcon');
            
            if (card.style.display === 'none') {
                card.style.display = 'block';
                icon.className = 'fas fa-chevron-up';
            } else {
                card.style.display = 'none';
                icon.className = 'fas fa-chevron-down';
            }
        }

        // Paginated Table functionality
        let currentTableData = null;
        let currentPage = 1;
        let currentSortColumn = null;
        let currentSortDirection = 'desc';

        function createPaginatedTable(containerId, tableData) {
            currentTableData = tableData;
            currentPage = 1;
            currentSortColumn = 'date';
            currentSortDirection = 'desc';
            
            renderPaginatedTable(containerId);
        }

        function renderPaginatedTable(containerId) {
            if (!currentTableData || !currentTableData.data) return;
            
            const container = document.getElementById(containerId);
            const pageSize = currentTableData.page_size || 50;
            const totalRecords = currentTableData.total_records;
            const totalPages = Math.ceil(totalRecords / pageSize);
            
            // Sort data
            let sortedData = [...currentTableData.data];
            if (currentSortColumn) {
                sortedData.sort((a, b) => {
                    let aVal = a[currentSortColumn];
                    let bVal = b[currentSortColumn];
                    
                    // Handle different data types
                    if (currentSortColumn === 'date') {
                        aVal = new Date(aVal);
                        bVal = new Date(bVal);
                    } else if (typeof aVal === 'string') {
                        aVal = aVal.toLowerCase();
                        bVal = bVal.toLowerCase();
                    }
                    
                    if (aVal < bVal) return currentSortDirection === 'asc' ? -1 : 1;
                    if (aVal > bVal) return currentSortDirection === 'asc' ? 1 : -1;
                    return 0;
                });
            }
            
            // Get current page data
            const startIndex = (currentPage - 1) * pageSize;
            const endIndex = startIndex + pageSize;
            const pageData = sortedData.slice(startIndex, endIndex);
            
            // Create table HTML
            let tableHtml = `
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
            `;
            
            // Add headers
            currentTableData.columns.forEach(column => {
                const sortIcon = currentSortColumn === column.key 
                    ? (currentSortDirection === 'asc' ? ' ↑' : ' ↓') 
                    : '';
                const sortClass = column.sortable ? 'sortable-header' : '';
                tableHtml += `
                    <th class="${sortClass}" data-column="${column.key}" onclick="${column.sortable ? `sortTable('${column.key}')` : ''}">
                        ${column.label}${sortIcon}
                    </th>
                `;
            });
            
            tableHtml += `
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            // Add rows
            pageData.forEach(row => {
                tableHtml += '<tr>';
                currentTableData.columns.forEach(column => {
                    let value = row[column.key];
                    let displayValue = value;
                    
                    // Format based on column type
                    switch (column.type) {
                        case 'currency':
                            displayValue = `$${value.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
                            break;
                        case 'percentage':
                            displayValue = `${value.toFixed(2)}%`;
                            break;
                        case 'date':
                            displayValue = new Date(value).toLocaleDateString();
                            break;
                        case 'number':
                            displayValue = value.toLocaleString();
                            break;
                    }
                    
                    tableHtml += `<td>${displayValue}</td>`;
                });
                tableHtml += '</tr>';
            });
            
            tableHtml += `
                        </tbody>
                    </table>
                </div>
            `;
            
            // Add pagination controls
            tableHtml += `
                <div class="d-flex justify-content-between align-items-center mt-3">
                    <div>
                        Showing ${startIndex + 1} to ${Math.min(endIndex, totalRecords)} of ${totalRecords} records
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-outline-secondary btn-sm" onclick="changePage(1)" ${currentPage === 1 ? 'disabled' : ''}>
                            <i class="fas fa-angle-double-left"></i>
                        </button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="changePage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>
                            <i class="fas fa-angle-left"></i>
                        </button>
                        <span class="btn btn-outline-secondary btn-sm disabled">
                            Page ${currentPage} of ${totalPages}
                        </span>
                        <button class="btn btn-outline-secondary btn-sm" onclick="changePage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>
                            <i class="fas fa-angle-right"></i>
                        </button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="changePage(${totalPages})" ${currentPage === totalPages ? 'disabled' : ''}>
                            <i class="fas fa-angle-double-right"></i>
                        </button>
                    </div>
                </div>
            `;
            
            container.innerHTML = tableHtml;
        }

        function sortTable(columnKey) {
            if (currentSortColumn === columnKey) {
                currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                currentSortColumn = columnKey;
                currentSortDirection = 'asc';
            }
            currentPage = 1; // Reset to first page when sorting
            renderPaginatedTable('dailyMarginTableContainer');
        }

        function changePage(page) {
            if (page >= 1 && page <= Math.ceil(currentTableData.total_records / (currentTableData.page_size || 50))) {
                currentPage = page;
                renderPaginatedTable('dailyMarginTableContainer');
            }
        }




        function renderBlackoutCumulativeChart(chartData, dateListName) {
            console.log('Rendering blackout cumulative chart with data:', chartData);
            
            const container = document.getElementById('blackoutCumulativeChart');
            if (!container) {
                console.error('Chart container not found');
                return;
            }
            
            // Prepare data for Plotly
            const traces = [];
            
            // Create main cumulative line using only the latest trade of each day
            const lineData = chartData.filter(d => d.is_latest_of_day);
            const x = lineData.map(d => d.date);
            const y = lineData.map(d => d.cumulative_pnl);
            
            traces.push({
                x: x,
                y: y,
                type: 'scatter',
                mode: 'lines+markers',
                name: 'Cumulative P&L',
                line: {
                    color: '#007bff',
                    width: 3
                },
                marker: {
                    size: 6,
                    color: '#007bff'
                },
                hovertemplate: '<b>%{x}</b><br>Cumulative P&L: $%{y:,.2f}<extra></extra>'
            });
            
            // Add individual trade markers with strategy colors
            const strategyColors = {};
            let colorIndex = 0;
            const colors = ['#28a745', '#dc3545', '#ffc107', '#17a2b8', '#6f42c1', '#fd7e14', '#20c997', '#e83e8c'];
            
            chartData.forEach((point, index) => {
                if (!strategyColors[point.strategy]) {
                    strategyColors[point.strategy] = colors[colorIndex % colors.length];
                    colorIndex++;
                }
                
                traces.push({
                    x: [point.date],
                    y: [point.cumulative_pnl],
                    type: 'scatter',
                    mode: 'markers',
                    name: point.strategy,
                    marker: {
                        size: 8,
                        color: strategyColors[point.strategy],
                        symbol: 'circle'
                    },
                    hovertemplate: `<b>${point.strategy}</b><br>Date: %{x}<br>Cumulative P&L: $%{y:,.2f}<br>Trade P&L: $${point.trade_pnl.toFixed(2)}<extra></extra>`,
                    showlegend: false
                });
            });
            
            const layout = {
                title: {
                    text: `Cumulative P&L Over Time - ${dateListName}`,
                    font: { size: 14, color: '#ffffff' },
                    x: 0.5,
                    xanchor: 'center'
                },
                xaxis: {
                    title: {
                        text: 'Date',
                        font: { color: '#ffffff', size: 12 }
                    },
                    type: 'date',
                    showgrid: true,
                    gridcolor: 'rgba(255,255,255,0.2)',
                    tickfont: { color: '#ffffff', size: 10 },
                    titlefont: { color: '#ffffff', size: 12 }
                },
                yaxis: {
                    title: {
                        text: 'Cumulative P&L ($)',
                        font: { color: '#ffffff', size: 12 }
                    },
                    tickformat: '$,.0f',
                    showgrid: true,
                    gridcolor: 'rgba(255,255,255,0.2)',
                    tickfont: { color: '#ffffff', size: 10 },
                    titlefont: { color: '#ffffff', size: 12 }
                },
                hovermode: 'closest',
                showlegend: true,
                legend: {
                    orientation: 'h',
                    y: -0.25,
                    x: 0.5,
                    xanchor: 'center',
                    font: { color: '#ffffff', size: 11 }
                },
                margin: { t: 50, r: 20, b: 80, l: 70 },
                plot_bgcolor: 'rgba(0,0,0,0)',
                paper_bgcolor: 'rgba(0,0,0,0)',
                autosize: true,
                width: null,
                height: 380
            };
            
            const config = {
                responsive: true,
                displayModeBar: true,
                modeBarButtonsToRemove: ['pan2d', 'lasso2d', 'select2d'],
                displaylogo: false,
                toImageButtonOptions: {
                    format: 'png',
                    filename: 'blackout_cumulative_pnl',
                    height: 400,
                    width: 800,
                    scale: 1
                }
            };
            
            Plotly.newPlot(container, traces, layout, config);
        }

        function updateAnalyzeButton() {
            const whitelistMode = document.getElementById('whitelistMode');
            const analyzeButton = document.getElementById('analyzeButton');
            
            if (!whitelistMode || !analyzeButton) return;
            
            const isWhitelistMode = whitelistMode.checked;
            
            if (isWhitelistMode) {
                analyzeButton.innerHTML = '<i class="fas fa-chart-bar"></i> Analyze Whitelist Dates';
            } else {
                analyzeButton.innerHTML = '<i class="fas fa-chart-bar"></i> Analyze Blackout Dates';
            }
        }

        function updateDateListDisplay() {
            const select = document.getElementById('dateListSelect');
            const display = document.getElementById('dateListDisplay');
            const whitelistMode = document.getElementById('whitelistMode');
            
            if (!select || !display) {
                console.log('❌ Missing elements: select=', !!select, 'display=', !!display);
                return;
            }
            
            const selectedList = select.value;
            const isWhitelistMode = whitelistMode ? whitelistMode.checked : false;
            
            console.log('🔧 updateDateListDisplay called:', { selectedList, isWhitelistMode });
            
            // Get the dates for the selected list using the new endpoint
            fetch('/api/blackout-date-lists')
            .then(response => response.json())
            .then(data => {
                console.log('📊 API response:', data);
                if (data.success && data.date_lists && data.date_lists[selectedList]) {
                    let dates = data.date_lists[selectedList];
                    
                    // If whitelist mode, we need to create a whitelist by removing blackout dates from full date range
                    if (isWhitelistMode && dates.length > 0) {
                        // Find the date range from the blackout dates
                        const years = new Set();
                        dates.forEach(dateStr => {
                            const year = parseInt(dateStr.split('-')[0]);
                            if (!isNaN(year)) years.add(year);
                        });
                        
                        if (years.size > 0) {
                            const allDates = new Set();
                            const minYear = Math.min(...years);
                            const maxYear = Math.max(...years);
                            
                            // Generate all dates in the range
                            for (let year = minYear; year <= maxYear; year++) {
                                for (let month = 1; month <= 12; month++) {
                                    const daysInMonth = new Date(year, month, 0).getDate();
                                    for (let day = 1; day <= daysInMonth; day++) {
                                        const dateStr = `${year.toString().padStart(4, '0')}-${month.toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
                                        allDates.add(dateStr);
                                    }
                                }
                            }
                            
                            // Remove blackout dates to create whitelist
                            const blackoutSet = new Set(dates);
                            dates = Array.from(allDates).filter(date => !blackoutSet.has(date));
                        }
                    }
                    
                    // Show the complete list of dates, comma-separated
                    display.value = dates.join(', ');
                    console.log('✅ Updated display with', dates.length, 'dates');
                    
                    // Update labels based on mode
                    const label = document.getElementById('dateListDisplayLabel');
                    const help = document.getElementById('dateListDisplayHelp');
                    
                    if (isWhitelistMode) {
                        label.textContent = 'Whitelist Dates:';
                        help.textContent = 'This shows the dates NOT in the selected blackout list (whitelist mode).';
                    } else {
                        label.textContent = 'Selected Dates:';
                        help.textContent = 'This shows the dates included in the selected blackout list.';
                    }
                } else {
                    console.log('❌ API response error:', data);
                    display.value = 'Error loading date list';
                }
            })
            .catch(error => {
                console.log('❌ Fetch error:', error);
                display.value = 'Error loading date list: ' + error.message;
            });
        }

        function loadBlackoutDatesChart() {
            console.log('🔧 loadBlackoutDatesChart() called - FUNCTION START');
            console.log('🔧 loadBlackoutDatesChart() called');
            const container = document.getElementById('chartContainer');
            const loading = document.getElementById('chartLoading');
            
            // Show date list selection interface
            container.innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <h5>🚫 Blackout Dates Analysis</h5>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info mb-4">
                            <h6><i class="fas fa-info-circle"></i> What is Blackout Dates Analysis?</h6>
                            <p class="mb-2">This tool analyzes trading performance on specific dates (like FOMC announcements, end of month, or end of quarter) to see how your strategies perform during these high-impact events.</p>
                            <p class="mb-2"><strong>Available Date Lists:</strong></p>
                            <ul class="mb-2">
                                <li><strong>FOMC Announcements:</strong> Federal Reserve meeting dates (2021-2025)</li>
                                <li><strong>End of Month (EOM):</strong> Last trading day of each month (2021-present)</li>
                                <li><strong>End of Quarter (EOQ):</strong> Last trading day of each quarter (2021-present)</li>
                                <li><strong>Short Weeks:</strong> Stock market holidays (2020-present)</li>
                            </ul>
                            <p class="mb-2"><strong>Why is this useful?</strong></p>
                            <ul class="mb-2">
                                <li><strong>Event Impact:</strong> See how market events affect your strategies</li>
                                <li><strong>Risk Management:</strong> Identify which strategies are most vulnerable to market events</li>
                                <li><strong>Strategy Selection:</strong> Choose strategies that perform well during high-volatility periods</li>
                                <li><strong>Timing Optimization:</strong> Adjust entry/exit timing around known market events</li>
                            </ul>
                            <p class="mb-0"><strong>How it works:</strong> The analysis includes trades that were either initiated on blackout dates OR had any blackout date fall between the opening and closing dates (multi-day trades).</p>
                            <p class="mb-0 mt-2"><strong>Note:</strong> FOMC dates are static and cover 2021-2026. Update the list when new Fed schedules are published.</p>
                        </div>
                        
                        <div class="mb-3">
                            <label for="dateListSelect" class="form-label">Select Date List:</label>
                            <select class="form-select" id="dateListSelect" onchange="updateDateListDisplay()">
                                <option value="FOMC Announcements">FOMC Announcements (until 2026-12-16)</option>
                                <option value="End of Month (EOM)">End of Month (EOM)</option>
                                <option value="End of Quarter (EOQ)">End of Quarter (EOQ)</option>
                                <option value="Short Weeks">Short Weeks (Stock Market Holidays)</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="maxDaysInput" class="form-label">
                                Max Days Between Blackout Date and Close Date:
                                <i class="fas fa-info-circle ms-2" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-html="true" data-bs-custom-class="wide-tooltip" title="<div style='text-align: left; max-width: 500px;'><strong>Multi-Day Trade Analysis:</strong><br><br>This setting controls how multi-day trades are analyzed when a blackout date falls between the opening and closing dates.<br><br><strong>Example:</strong><br>• Trade opens: 2021-01-25<br>• Blackout date: 2021-01-27 (FOMC)<br>• Trade closes: 2021-01-29<br><br>If 'Max Days' is set to 5, this trade will be included because the blackout date (Jan 27) is within 5 days of the close date (Jan 29).<br><br><strong>Purpose:</strong> Captures trades that were influenced by blackout events even if they weren't initiated on the exact blackout date.</div>"></i>
                            </label>
                            <input type="number" class="form-control" id="maxDaysInput" value="5" min="1" max="30" style="width: 100px;">
                            <small class="form-text text-muted">For multi-day trades, maximum days between blackout date and trade close date (default: 5)</small>
                        </div>
                        
                        
                        <div class="mb-3">
                            <label for="dateListDisplay" class="form-label" id="dateListDisplayLabel">Selected Dates:</label>
                            <textarea class="form-control" id="dateListDisplay" rows="4" readonly style="font-family: monospace; font-size: 12px; background-color: #f8f9fa; color: #000000 !important; border: 1px solid #dee2e6;"></textarea>
                            <small class="form-text text-muted" id="dateListDisplayHelp">This shows the dates included in the selected blackout list.</small>
                        </div>
                        
                        <div class="mb-3">
                            <button class="btn btn-outline-primary me-2" onclick="showCustomListManager()">
                                <i class="fas fa-cog"></i> Manage Custom Lists
                            </button>
                            <button class="btn btn-primary me-2" id="analyzeButton" onclick="runBlackoutDatesAnalysis()">
                                <i class="fas fa-chart-bar"></i> Analyze Blackout Dates
                            </button>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="checkbox" id="whitelistMode" onchange="updateDateListDisplay(); updateAnalyzeButton()">
                                <label class="form-check-label" for="whitelistMode">
                                    <strong>Analyze Whitelist Dates</strong>
                                </label>
                            </div>
                        </div>
                        
                        <div id="blackoutResults" class="mt-4" style="display: none;"></div>
                    </div>
                </div>
            `;
            
            // Load custom lists into dropdown
            loadCustomListsIntoDropdown();
            
            // Initialize date list display and button text
            updateDateListDisplay();
            updateAnalyzeButton();
            
            console.log('🔧 About to set timeout for tooltip initialization');
            // Initialize custom tooltips for the dynamically added content
            setTimeout(() => {
                console.log('🔧 Initializing custom tooltips for blackout dates section...');
                
                // Check if tooltip element exists
                const tooltipElement = document.querySelector('.custom-tooltip');
                console.log('🔧 Found tooltip element:', tooltipElement);
                if (tooltipElement) {
                    console.log('🔧 Tooltip element data-tooltip:', tooltipElement.getAttribute('data-tooltip'));
                }
                
                console.log('🔧 About to call initializeCustomTooltips()');
                try {
                    initializeCustomTooltips();
                    console.log('🔧 initializeCustomTooltips() completed successfully');
                } catch (error) {
                    console.error('🔧 Error calling initializeCustomTooltips():', error);
                }
            }, 100);
        }

        function runBlackoutDatesAnalysis() {
            const dateList = document.getElementById('dateListSelect').value;
            const whitelistMode = document.getElementById('whitelistMode');
            const maxDaysInput = document.getElementById('maxDaysInput');
            const isWhitelistMode = whitelistMode ? whitelistMode.checked : false;
            const maxDays = maxDaysInput ? parseInt(maxDaysInput.value) || 5 : 5;
            const resultsDiv = document.getElementById('blackoutResults');
            const loading = document.getElementById('chartLoading');
            
            loading.style.display = 'block';
            resultsDiv.style.display = 'none';
            
            fetch('/api/blackout-dates', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    date_list: dateList,
                    whitelist_mode: isWhitelistMode,
                    max_days: maxDays
                })
            })
            .then(response => response.json())
            .then(data => {
                loading.style.display = 'none';
                
                if (!data.success) {
                    resultsDiv.innerHTML = `<div class="alert alert-warning"><h5>Blackout Dates Analysis Error</h5><p>${data.error}</p></div>`;
                    resultsDiv.style.display = 'block';
                    return;
                }
                
                const results = data.strategy_results;
                
                if (results.length === 0) {
                    resultsDiv.innerHTML = `
                        <div class="alert alert-info">
                            <h5>No Trades Found</h5>
                            <p>No trades were initiated on the selected blackout dates (${data.date_list_name}).</p>
                        </div>
                    `;
                    resultsDiv.style.display = 'block';
                    return;
                }
                
                // Calculate totals
                const totals = {
                    total_trades: results.reduce((sum, r) => sum + r.total_trades, 0),
                    profitable_trades: results.reduce((sum, r) => sum + r.profitable_trades, 0),
                    unprofitable_trades: results.reduce((sum, r) => sum + r.unprofitable_trades, 0),
                    total_pnl: results.reduce((sum, r) => sum + r.total_pnl, 0),
                    pnl_per_lot: 0
                };
                
                // Calculate weighted average P&L per lot
                const totalContracts = results.reduce((sum, r) => {
                    return sum + r.trades.reduce((tradeSum, trade) => tradeSum + (trade.contracts || 1), 0);
                }, 0);
                totals.pnl_per_lot = totalContracts > 0 ? totals.total_pnl / totalContracts : 0;
                
                // Create results table
                let tableHtml = `
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="fas fa-chart-bar"></i> Blackout Dates Analysis Results</h5>
                            <small class="text-muted">Date List: ${data.date_list_name}</small>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped table-hover" id="blackoutSummaryTable">
                                    <thead class="table-dark">
                                        <tr>
                                            <th style="cursor:pointer;" onclick="sortBlackoutTable('strategy')">Strategy <span id="sort-indicator-strategy"></span></th>
                                            <th style="cursor:pointer;" onclick="sortBlackoutTable('total_trades')">Total Trades <span id="sort-indicator-total_trades"></span></th>
                                            <th style="cursor:pointer;" onclick="sortBlackoutTable('profitable_trades')">Profitable Trades <span id="sort-indicator-profitable_trades"></span></th>
                                            <th style="cursor:pointer;" onclick="sortBlackoutTable('unprofitable_trades')">Unprofitable Trades <span id="sort-indicator-unprofitable_trades"></span></th>
                                            <th style="cursor:pointer;" onclick="sortBlackoutTable('win_rate')">Win Rate <span id="sort-indicator-win_rate"></span></th>
                                            <th style="cursor:pointer;" onclick="sortBlackoutTable('total_pnl')">Total P&L <span id="sort-indicator-total_pnl"></span></th>
                                            <th style="cursor:pointer;" onclick="sortBlackoutTable('pnl_per_lot')">P&L/Lot <span id="sort-indicator-pnl_per_lot"></span></th>
                                        </tr>
                                    </thead>
                                    <tbody id="blackoutTableBody">
                `;
                
                // Store results for sorting
                window.blackoutResults = results;
                
                results.forEach(result => {
                    const winRateClass = result.win_rate >= 50 ? 'text-success' : 'text-danger';
                    const pnlClass = result.total_pnl >= 0 ? 'text-success' : 'text-danger';
                    const pnlPerLotClass = result.pnl_per_lot >= 0 ? 'text-success' : 'text-danger';
                    
                    tableHtml += `
                        <tr>
                            <td><strong>${result.strategy}</strong></td>
                            <td>${result.total_trades}</td>
                            <td class="text-success">${result.profitable_trades}</td>
                            <td class="text-danger">${result.unprofitable_trades}</td>
                            <td class="${winRateClass}"><strong>${result.win_rate}%</strong></td>
                            <td class="${pnlClass}"><strong>$${result.total_pnl.toLocaleString()}</strong></td>
                            <td class="${pnlPerLotClass}"><strong>$${result.pnl_per_lot.toLocaleString()}</strong></td>
                        </tr>
                    `;
                });
                
                // Add totals row with better styling
                const totalWinRate = totals.total_trades > 0 ? ((totals.profitable_trades / totals.total_trades) * 100).toFixed(1) : 0;
                const totalWinRateClass = totalWinRate >= 50 ? 'text-success' : 'text-danger';
                const totalPnlClass = totals.total_pnl >= 0 ? 'text-success' : 'text-danger';
                const totalPnlPerLotClass = totals.pnl_per_lot >= 0 ? 'text-success' : 'text-danger';
                
                tableHtml += `
                        <tr class="table-dark fw-bold">
                            <td><strong>TOTAL</strong></td>
                            <td><strong>${totals.total_trades}</strong></td>
                            <td class="text-success"><strong>${totals.profitable_trades}</strong></td>
                            <td class="text-danger"><strong>${totals.unprofitable_trades}</strong></td>
                            <td class="${totalWinRateClass}"><strong>${totalWinRate}%</strong></td>
                            <td class="${totalPnlClass}"><strong>$${totals.total_pnl.toLocaleString()}</strong></td>
                            <td class="${totalPnlPerLotClass}"><strong>$${totals.pnl_per_lot.toFixed(2)}</strong></td>
                        </tr>
                `;
                
                tableHtml += `
                                    </tbody>
                                </table>
                            </div>
                            
                            <div class="alert alert-light mt-3">
                                <h6><i class="fas fa-info-circle"></i> Analysis Summary</h6>
                                <p><strong>Total Strategies with Blackout Trades:</strong> ${results.length}</p>
                                <p><strong>Date List:</strong> ${data.date_list_name}</p>
                                <p><strong>Analysis Period:</strong> Based on trades initiated on the selected blackout dates</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Cumulative P&L Chart -->
                    <div class="card mt-4">
                        <div class="card-header">
                            <h5><i class="fas fa-chart-line"></i> Cumulative P&L Over Time</h5>
                            <small class="text-muted">Cumulative P&L for trades on ${data.date_list_name}</small>
                        </div>
                        <div class="card-body">
                            <div id="blackoutCumulativeChart" style="height: 400px; width: 100%; overflow: hidden; position: relative;"></div>
                        </div>
                    </div>
                    
                    <!-- Detailed Trades Table -->
                    <div class="card mt-4">
                        <div class="card-header">
                            <h5><i class="fas fa-list"></i> Individual Trades on Blackout Dates</h5>
                            <small class="text-muted">All trades initiated on ${data.date_list_name}</small>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped table-hover table-sm" id="blackoutTradesTable">
                                    <thead class="table-dark">
                                        <tr>
                                            <th style="cursor:pointer;" onclick="sortBlackoutTradesTable('strategy')">Strategy <span id="sort-indicator-trades-strategy"></span></th>
                                            <th style="cursor:pointer;" onclick="sortBlackoutTradesTable('date_opened')">Entry Date <span id="sort-indicator-trades-date_opened"></span></th>
                                            <th style="cursor:pointer;" onclick="sortBlackoutTradesTable('pnl')">P&L <span id="sort-indicator-trades-pnl"></span></th>
                                        </tr>
                                    </thead>
                                    <tbody id="blackoutTradesTableBody">
                `;
                
                // Collect all individual trades for sorting
                const allTrades = [];
                results.forEach(result => {
                    if (result.trades && result.trades.length > 0) {
                        result.trades.forEach(trade => {
                            allTrades.push({
                                strategy: result.strategy,
                                date_opened: trade.date_opened || 'N/A',
                                pnl: trade.pnl
                            });
                        });
                    }
                });
                
                // Sort by entry date by default (newest first)
                allTrades.sort((a, b) => {
                    if (a.date_opened === 'N/A' && b.date_opened === 'N/A') return 0;
                    if (a.date_opened === 'N/A') return 1;
                    if (b.date_opened === 'N/A') return -1;
                    return b.date_opened.localeCompare(a.date_opened); // Newest first
                });
                
                // Store trades for sorting
                window.blackoutTrades = allTrades;
                
                // Add individual trades
                allTrades.forEach(trade => {
                    const pnlClass = trade.pnl >= 0 ? 'text-success' : 'text-danger';
                    
                    tableHtml += `
                        <tr>
                            <td><strong>${trade.strategy}</strong></td>
                            <td>${trade.date_opened}</td>
                            <td class="${pnlClass}"><strong>$${trade.pnl.toLocaleString()}</strong></td>
                        </tr>
                    `;
                });
                
                tableHtml += `
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `;
                
                resultsDiv.innerHTML = tableHtml;
                resultsDiv.style.display = 'block';
                
                // Render cumulative P&L chart if data is available
                if (data.chart_data && data.chart_data.length > 0) {
                    renderBlackoutCumulativeChart(data.chart_data, data.date_list_name);
                }
            })
            .catch(error => {
                loading.style.display = 'none';
                resultsDiv.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
                resultsDiv.style.display = 'block';
            });
        }

        // Blackout table sorting variables
        let blackoutSortKey = 'total_pnl';
        let blackoutSortAsc = false;

        function sortBlackoutTable(key) {
            if (!window.blackoutResults) return;
            
            // Toggle sort direction if same key
            if (blackoutSortKey === key) {
                blackoutSortAsc = !blackoutSortAsc;
            } else {
                blackoutSortKey = key;
                blackoutSortAsc = false; // Default to descending for most columns
            }
            
            // Sort the data
            const sorted = [...window.blackoutResults].sort((a, b) => {
                let aVal = a[key];
                let bVal = b[key];
                
                // Handle numeric columns
                if (['total_trades', 'profitable_trades', 'unprofitable_trades', 'total_pnl', 'pnl_per_lot', 'win_rate'].includes(key)) {
                    aVal = parseFloat(aVal) || 0;
                    bVal = parseFloat(bVal) || 0;
                }
                
                // Handle string columns
                if (key === 'strategy') {
                    aVal = aVal.toLowerCase();
                    bVal = bVal.toLowerCase();
                }
                
                if (aVal < bVal) return blackoutSortAsc ? -1 : 1;
                if (aVal > bVal) return blackoutSortAsc ? 1 : -1;
                return 0;
            });
            
            // Re-render the table body
            const tbody = document.getElementById('blackoutTableBody');
            if (!tbody) return;
            
            let html = '';
            sorted.forEach(result => {
                const winRateClass = result.win_rate >= 50 ? 'text-success' : 'text-danger';
                const pnlClass = result.total_pnl >= 0 ? 'text-success' : 'text-danger';
                const pnlPerLotClass = result.pnl_per_lot >= 0 ? 'text-success' : 'text-danger';
                
                html += `
                    <tr>
                        <td><strong>${result.strategy}</strong></td>
                        <td>${result.total_trades}</td>
                        <td class="text-success">${result.profitable_trades}</td>
                        <td class="text-danger">${result.unprofitable_trades}</td>
                        <td class="${winRateClass}"><strong>${result.win_rate}%</strong></td>
                        <td class="${pnlClass}"><strong>$${result.total_pnl.toLocaleString()}</strong></td>
                        <td class="${pnlPerLotClass}"><strong>$${result.pnl_per_lot.toLocaleString()}</strong></td>
                    </tr>
                `;
            });
            
            // Add totals row (always at bottom)
            const totals = {
                total_trades: sorted.reduce((sum, r) => sum + r.total_trades, 0),
                profitable_trades: sorted.reduce((sum, r) => sum + r.profitable_trades, 0),
                unprofitable_trades: sorted.reduce((sum, r) => sum + r.unprofitable_trades, 0),
                total_pnl: sorted.reduce((sum, r) => sum + r.total_pnl, 0),
                pnl_per_lot: 0
            };
            
            const totalContracts = sorted.reduce((sum, r) => {
                return sum + r.trades.reduce((tradeSum, trade) => tradeSum + (trade.contracts || 1), 0);
            }, 0);
            totals.pnl_per_lot = totalContracts > 0 ? totals.total_pnl / totalContracts : 0;
            
            const totalWinRate = totals.total_trades > 0 ? ((totals.profitable_trades / totals.total_trades) * 100).toFixed(1) : 0;
            const totalWinRateClass = totalWinRate >= 50 ? 'text-success' : 'text-danger';
            const totalPnlClass = totals.total_pnl >= 0 ? 'text-success' : 'text-danger';
            const totalPnlPerLotClass = totals.pnl_per_lot >= 0 ? 'text-success' : 'text-danger';
            
            html += `
                <tr class="table-dark fw-bold">
                    <td><strong>TOTAL</strong></td>
                    <td><strong>${totals.total_trades}</strong></td>
                    <td class="text-success"><strong>${totals.profitable_trades}</strong></td>
                    <td class="text-danger"><strong>${totals.unprofitable_trades}</strong></td>
                    <td class="${totalWinRateClass}"><strong>${totalWinRate}%</strong></td>
                    <td class="${totalPnlClass}"><strong>$${totals.total_pnl.toLocaleString()}</strong></td>
                    <td class="${totalPnlPerLotClass}"><strong>$${totals.pnl_per_lot.toFixed(2)}</strong></td>
                </tr>
            `;
            
            tbody.innerHTML = html;
            
            // Update sort indicators
            const keys = ['strategy', 'total_trades', 'profitable_trades', 'unprofitable_trades', 'win_rate', 'total_pnl', 'pnl_per_lot'];
            for (const k of keys) {
                const indicator = document.getElementById('sort-indicator-' + k);
                if (indicator) {
                    if (k === blackoutSortKey) {
                        indicator.textContent = blackoutSortAsc ? '▲' : '▼';
                    } else {
                        indicator.textContent = '';
                    }
                }
            }
        }

        // Blackout trades table sorting variables
        let blackoutTradesSortKey = 'date_opened';
        let blackoutTradesSortAsc = false;

        function sortBlackoutTradesTable(key) {
            if (!window.blackoutTrades) return;
            
            // Toggle sort direction if same key
            if (blackoutTradesSortKey === key) {
                blackoutTradesSortAsc = !blackoutTradesSortAsc;
            } else {
                blackoutTradesSortKey = key;
                blackoutTradesSortAsc = false; // Default to descending for most columns
            }
            
            // Sort the data
            const sorted = [...window.blackoutTrades].sort((a, b) => {
                let aVal = a[key];
                let bVal = b[key];
                
                // Handle numeric columns
                if (key === 'pnl') {
                    aVal = parseFloat(aVal) || 0;
                    bVal = parseFloat(bVal) || 0;
                }
                
                // Handle string columns
                if (key === 'strategy') {
                    aVal = aVal.toLowerCase();
                    bVal = bVal.toLowerCase();
                }
                
                // Handle date columns
                if (key === 'date_opened') {
                    if (aVal === 'N/A' && bVal === 'N/A') return 0;
                    if (aVal === 'N/A') return 1;
                    if (bVal === 'N/A') return -1;
                    // For dates, we want newest first by default (descending)
                    return blackoutTradesSortAsc ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
                }
                
                if (aVal < bVal) return blackoutTradesSortAsc ? -1 : 1;
                if (aVal > bVal) return blackoutTradesSortAsc ? 1 : -1;
                return 0;
            });
            
            // Re-render the table body
            const tbody = document.getElementById('blackoutTradesTableBody');
            if (!tbody) return;
            
            let html = '';
            sorted.forEach(trade => {
                const pnlClass = trade.pnl >= 0 ? 'text-success' : 'text-danger';
                
                html += `
                    <tr>
                        <td><strong>${trade.strategy}</strong></td>
                        <td>${trade.date_opened}</td>
                        <td class="${pnlClass}"><strong>$${trade.pnl.toLocaleString()}</strong></td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
            
            // Update sort indicators
            const keys = ['strategy', 'date_opened', 'pnl'];
            for (const k of keys) {
                const indicator = document.getElementById('sort-indicator-trades-' + k);
                if (indicator) {
                    if (k === blackoutTradesSortKey) {
                        indicator.textContent = blackoutTradesSortAsc ? '▲' : '▼';
                    } else {
                        indicator.textContent = '';
                    }
                }
            }
        }

        function loadCustomListsIntoDropdown() {
            fetch('/api/custom-blackout-lists')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const select = document.getElementById('dateListSelect');
                        if (select) {
                            // Remove existing custom list options (keep built-in ones)
                            const builtInOptions = Array.from(select.options).filter(option => 
                                ['FOMC Announcements', 'End of Month (EOM)', 'End of Quarter (EOQ)', 'Short Weeks'].includes(option.value)
                            );
                            
                            // Clear and re-add built-in options
                            select.innerHTML = '';
                            builtInOptions.forEach(option => select.appendChild(option));
                            
                            // Add custom list options
                            data.lists.forEach(list => {
                                const option = document.createElement('option');
                                option.value = list.list_name;
                                option.textContent = list.list_name;
                                select.appendChild(option);
                            });
                            
                            // Update date display after loading custom lists
                            updateDateListDisplay();
                        }
                    }
                })
                .catch(error => {
                    console.error('Error loading custom lists for dropdown:', error);
                });
        }

        // Custom Blackout List Management Functions
        function showCustomListManager() {
            const container = document.getElementById('chartContainer');
            
            container.innerHTML = `
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5>📅 Custom Blackout Date Lists</h5>
                        <button class="btn btn-outline-info btn-sm" onclick="loadChart('blackout_dates')">
                            <i class="fas fa-arrow-left"></i> Back to Analysis
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="customListsContainer">
                            <div class="text-center">
                                <div class="spinner-border" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-2">Loading custom lists...</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            loadCustomLists();
        }

        function loadCustomLists() {
            fetch('/api/custom-blackout-lists')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        renderCustomLists(data.lists);
                    } else {
                        document.getElementById('customListsContainer').innerHTML = `
                            <div class="alert alert-danger">
                                <i class="fas fa-exclamation-triangle"></i> Error loading custom lists: ${data.error}
                            </div>
                        `;
                    }
                })
                .catch(error => {
                    document.getElementById('customListsContainer').innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle"></i> Error loading custom lists: ${error.message}
                        </div>
                    `;
                });
        }

        function renderCustomLists(lists) {
            const container = document.getElementById('customListsContainer');
            
            if (lists.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-muted">
                        <i class="fas fa-calendar-times fa-3x mb-3"></i>
                        <h5>No Custom Lists</h5>
                        <p>Create your first custom blackout date list to get started.</p>
                        <button class="btn btn-primary" onclick="showCreateListForm()">
                            <i class="fas fa-plus"></i> Create New List
                        </button>
                    </div>
                `;
                return;
            }
            
            let html = '<div class="row">';
            lists.forEach(list => {
                // Format dates for display (show first few dates)
                const displayDates = list.dates.slice(0, 5);
                const moreDates = list.dates.length > 5 ? ` and ${list.dates.length - 5} more...` : '';
                const datesText = displayDates.join(', ') + moreDates;
                
                html += `
                    <div class="col-md-6 col-lg-4 mb-3">
                        <div class="card h-100">
                            <div class="card-body">
                                <h6 class="card-title">${escapeHtml(list.list_name)}</h6>
                                <p class="card-text text-muted small">${escapeHtml(list.description || 'No description')}</p>
                                <p class="card-text">
                                    <small class="text-muted">
                                        <i class="fas fa-calendar"></i> ${list.dates.length} dates
                                        <br>
                                        <i class="fas fa-clock"></i> Created: ${new Date(list.created_at).toLocaleDateString()}
                                    </small>
                                </p>
                                <div class="mt-2">
                                    <small class="text-muted"><strong>Dates:</strong></small>
                                    <div class="small" style="max-height: 60px; overflow-y: auto; background-color: #6c757d; padding: 5px; border-radius: 3px; margin-top: 2px; border: 1px solid #495057; color: #ffffff !important; font-weight: 500;">
                                        ${escapeHtml(datesText)}
                                    </div>
                                </div>
                            </div>
                            <div class="card-footer">
                                <div class="btn-group w-100" role="group">
                                    <button class="btn btn-primary btn-sm" onclick="editCustomList(${list.id}, '${escapeHtml(list.list_name)}', '${escapeHtml(list.description || '')}', ${JSON.stringify(list.dates).replace(/"/g, '&quot;')})">
                                        <i class="fas fa-edit"></i> Edit
                                    </button>
                                    <button class="btn btn-success btn-sm" onclick="useCustomList('${escapeHtml(list.list_name)}')">
                                        <i class="fas fa-chart-bar"></i> Use
                                    </button>
                                    <button class="btn btn-danger btn-sm" onclick="deleteCustomList(${list.id}, '${escapeHtml(list.list_name)}')">
                                        <i class="fas fa-trash"></i> Delete
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            
            container.innerHTML = html;
        }

        function showCreateListForm() {
            const container = document.getElementById('chartContainer');
            
            container.innerHTML = `
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5>📅 Create Custom Blackout Date List</h5>
                        <button class="btn btn-outline-secondary btn-sm" onclick="showCustomListManager()">
                            <i class="fas fa-arrow-left"></i> Back to Lists
                        </button>
                    </div>
                    <div class="card-body">
                        <form id="createListForm">
                            <div class="mb-3">
                                <label for="listName" class="form-label">List Name *</label>
                                <input type="text" class="form-control" id="listName" required 
                                       placeholder="e.g., Earnings Season, Holiday Periods">
                            </div>
                            
                            <div class="mb-3">
                                <label for="listDescription" class="form-label">Description</label>
                                <textarea class="form-control" id="listDescription" rows="2" 
                                          placeholder="Optional description of this date list"></textarea>
                            </div>
                            
                            <div class="mb-3">
                                <label for="datesInput" class="form-label">Dates *</label>
                                <textarea class="form-control" id="datesInput" rows="4" required
                                          placeholder="Enter dates in YYYY-MM-DD format, separated by commas&#10;Example: 2023-01-15, 2023-02-14, 2023-03-15"></textarea>
                                <div class="form-text">Enter dates in YYYY-MM-DD format, separated by commas</div>
                            </div>
                            
                            <div class="d-flex gap-2">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save"></i> Create List
                                </button>
                                <button type="button" class="btn btn-outline-secondary" onclick="showCustomListManager()">
                                    Cancel
                                </button>
                                <button type="button" class="btn btn-outline-info" onclick="loadChart('blackout_dates')">
                                    <i class="fas fa-arrow-left"></i> Back to Analysis
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            // Handle form submission
            document.getElementById('createListForm').addEventListener('submit', function(e) {
                e.preventDefault();
                createCustomList();
            });
        }

        function createCustomList() {
            const listName = document.getElementById('listName').value.trim();
            const description = document.getElementById('listDescription').value.trim();
            const datesText = document.getElementById('datesInput').value.trim();
            
            if (!listName) {
                alert('Please enter a list name');
                return;
            }
            
            if (!datesText) {
                alert('Please enter at least one date');
                return;
            }
            
            // Parse comma-separated dates
            const dates = datesText.split(',').map(d => d.trim()).filter(d => d);
            
            // Validate date format
            const dateRegex = /^\d{4}-\d{2}-\d{2}$/;
            const invalidDates = dates.filter(date => !dateRegex.test(date));
            
            if (invalidDates.length > 0) {
                alert(`Invalid date format(s): ${invalidDates.join(', ')}\nPlease use YYYY-MM-DD format`);
                return;
            }
            
            // Remove duplicates and sort
            const uniqueDates = [...new Set(dates)].sort();
            
            const data = {
                list_name: listName,
                description: description,
                dates: uniqueDates
            };
            
            fetch('/api/custom-blackout-lists', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showCustomListManager();
                } else {
                    alert('Error creating list: ' + data.error);
                }
            })
            .catch(error => {
                alert('Error creating list: ' + error.message);
            });
        }

        function editCustomList(listId, listName, description, dates) {
            const container = document.getElementById('chartContainer');
            
            // Convert dates array to comma-separated string
            const datesString = Array.isArray(dates) ? dates.join(', ') : dates;
            
            container.innerHTML = `
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5>📅 Edit Custom Blackout Date List</h5>
                        <button class="btn btn-outline-secondary btn-sm" onclick="showCustomListManager()">
                            <i class="fas fa-arrow-left"></i> Back to Lists
                        </button>
                    </div>
                    <div class="card-body">
                        <form id="editListForm">
                            <input type="hidden" id="editListId" value="${listId}">
                            
                            <div class="mb-3">
                                <label for="editListName" class="form-label">List Name *</label>
                                <input type="text" class="form-control" id="editListName" required 
                                       value="${escapeHtml(listName)}" placeholder="e.g., Earnings Season, Holiday Periods">
                            </div>
                            
                            <div class="mb-3">
                                <label for="editListDescription" class="form-label">Description</label>
                                <textarea class="form-control" id="editListDescription" rows="2" 
                                          placeholder="Optional description of this date list">${escapeHtml(description)}</textarea>
                            </div>
                            
                            <div class="mb-3">
                                <label for="editDatesInput" class="form-label">Dates *</label>
                                <textarea class="form-control" id="editDatesInput" rows="4" required
                                          placeholder="Enter dates in YYYY-MM-DD format, separated by commas&#10;Example: 2023-01-15, 2023-02-14, 2023-03-15">${escapeHtml(datesString)}</textarea>
                                <div class="form-text">Enter dates in YYYY-MM-DD format, separated by commas</div>
                            </div>
                            
                            <div class="d-flex gap-2">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save"></i> Update List
                                </button>
                                <button type="button" class="btn btn-outline-secondary" onclick="showCustomListManager()">
                                    Cancel
                                </button>
                                <button type="button" class="btn btn-outline-info" onclick="loadChart('blackout_dates')">
                                    <i class="fas fa-arrow-left"></i> Back to Analysis
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            // Handle form submission
            document.getElementById('editListForm').addEventListener('submit', function(e) {
                e.preventDefault();
                updateCustomList();
            });
        }

        function updateCustomList() {
            const listId = document.getElementById('editListId').value;
            const listName = document.getElementById('editListName').value.trim();
            const description = document.getElementById('editListDescription').value.trim();
            const datesText = document.getElementById('editDatesInput').value.trim();
            
            if (!listName) {
                alert('Please enter a list name');
                return;
            }
            
            if (!datesText) {
                alert('Please enter at least one date');
                return;
            }
            
            // Parse comma-separated dates
            const dates = datesText.split(',').map(d => d.trim()).filter(d => d);
            
            // Validate date format
            const dateRegex = /^\d{4}-\d{2}-\d{2}$/;
            const invalidDates = dates.filter(date => !dateRegex.test(date));
            
            if (invalidDates.length > 0) {
                alert(`Invalid date format(s): ${invalidDates.join(', ')}\nPlease use YYYY-MM-DD format`);
                return;
            }
            
            // Remove duplicates and sort
            const uniqueDates = [...new Set(dates)].sort();
            
            const data = {
                list_name: listName,
                description: description,
                dates: uniqueDates
            };
            
            fetch(`/api/custom-blackout-lists/${listId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showCustomListManager();
                } else {
                    alert('Error updating list: ' + data.error);
                }
            })
            .catch(error => {
                alert('Error updating list: ' + error.message);
            });
        }

        function useCustomList(listName) {
            // Go back to blackout dates analysis and select this list
            loadChart('blackout_dates');
            
            // Wait for the dropdown to be populated, then select the custom list
            setTimeout(() => {
                const select = document.getElementById('dateListSelect');
                if (select) {
                    select.value = listName;
                }
            }, 500);
        }

        // Load Live vs BT Analysis
        function loadLiveVsBTAnalysis() {
            console.log('Loading Live vs BT analysis...');
            
            const container = document.getElementById('chartContainer');
            const loading = document.getElementById('chartLoading');
            
            // Show file selection interface first
            container.innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-balance-scale"></i> Live vs Backtest Comparison</h5>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info mb-4">
                            <h6><i class="fas fa-info-circle"></i> What is Live vs Backtest Comparison?</h6>
                            <p class="mb-2">This tool compares your live trading performance with backtest results to identify execution differences and optimization opportunities.</p>
                            <p class="mb-2"><strong>Why is this useful?</strong></p>
                            <ul class="mb-2">
                                <li><strong>Execution Analysis:</strong> See how live trades performed vs backtest expectations</li>
                                <li><strong>Strategy Validation:</strong> Verify if backtest results translate to live performance</li>
                                <li><strong>Performance Gaps:</strong> Identify systematic differences between live and backtest</li>
                                <li><strong>Optimization:</strong> Find opportunities to improve live execution</li>
                            </ul>
                            <p class="mb-0"><strong>How it works:</strong> Select one backtest file and one live trading file. The system will match trades by date/time and strategy, then show side-by-side comparisons with P&L differences.</p>
                        </div>
                        
                        <div class="alert alert-warning">
                            <h6><i class="fas fa-exclamation-triangle"></i> Important Matching Rules:</h6>
                            <ul class="mb-0">
                                <li><strong>Strategy Names:</strong> Backtest strategy names must be a substring of live strategy names (e.g., "Iron Condor" matches "Iron Condor (Tasty)")</li>
                                <li><strong>Time Matching:</strong> Entry times can differ by up to 4 minutes 59 seconds between files</li>
                                <li><strong>File Types:</strong> Select one backtest file and one live trading file for comparison</li>
                                <li><strong>Date/Time Only:</strong> Use the checkbox to match trades based only on date/time, ignoring strategy names</li>
                            </ul>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <label class="form-label">Select Backtest File:</label>
                                <select class="form-select" id="backtestFileSelect">
                                    <option value="">Loading backtest files...</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Select Live Trading File:</label>
                                <select class="form-select" id="liveFileSelect">
                                    <option value="">Loading live trading files...</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="row mt-3">
                            <div class="col-12">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="matchOnlyDateTime" onchange="updateLiveVsBtSelection()">
                                    <label class="form-check-label" for="matchOnlyDateTime">
                                        <strong>Match only on date/time</strong> - Skip strategy name matching (useful when strategy names differ significantly)
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-4">
                            <button class="btn btn-primary" onclick="runLiveVsBTAnalysis()" id="runLiveVsBtBtn" disabled>
                                <i class="fas fa-balance-scale"></i> Run Live vs Backtest Analysis
                            </button>
                            <button class="btn btn-outline-secondary ms-2" onclick="clearLiveVsBtSelection()">
                                <i class="fas fa-times"></i> Clear Selection
                            </button>
                        </div>
                        
                        <div id="liveVsBtResults" class="mt-4" style="display: none;">
                            <!-- Results will be displayed here -->
                        </div>
                    </div>
                </div>
            `;
            
            // Show container and hide loading
            container.style.display = 'block';
            loading.style.display = 'none';
            
            // Load available files
            loadLiveVsBtFileSelection();
        }

        function displayLiveVsBTAnalysis(liveVsBtData) {
            const container = document.getElementById('liveVsBtContent');
            
            if (!liveVsBtData.available) {
                container.innerHTML = `
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> ${liveVsBtData.message}
                    </div>
                `;
                return;
            }
            
            if (!liveVsBtData.comparison_data || liveVsBtData.comparison_data.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i> No comparison data available.
                    </div>
                `;
                return;
            }
            
            // Create summary
            const summary = liveVsBtData.summary || {};
            const summaryHtml = `
                <div class="row mb-3">
                    <div class="col-12">
                        <div class="alert alert-info">
                            <h6><i class="fas fa-chart-bar"></i> Comparison Summary</h6>
                            <div class="row text-center">
                                <div class="col-md-2">
                                    <strong>${summary.total_trades || 0}</strong><br>
                                    <small>Total Trades</small>
                                </div>
                                <div class="col-md-2">
                                    <strong>${summary.matched_trades || 0}</strong><br>
                                    <small>Matched</small>
                                </div>
                                <div class="col-md-2">
                                    <strong>${summary.backtest_only || 0}</strong><br>
                                    <small>Backtest Only</small>
                                </div>
                                <div class="col-md-2">
                                    <strong>${summary.live_only || 0}</strong><br>
                                    <small>Live Only</small>
                                </div>
                                <div class="col-md-2">
                                    <strong>$${summary.avg_pnl_diff || 0}</strong><br>
                                    <small>Avg P&L Diff</small>
                                </div>
                                <div class="col-md-2">
                                    <strong>${summary.positive_diffs || 0}/${summary.negative_diffs || 0}</strong><br>
                                    <small>Better/Worse</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Create comparison table
            const tableHtml = `
                <div class="table-responsive">
                    <table class="table table-striped table-hover" id="liveVsBtTable">
                        <thead class="table-dark">
                            <tr>
                                <th>Entry Date/Time</th>
                                <th>BT Strategy</th>
                                <th>BT Contracts</th>
                                <th>BT P&L</th>
                                <th>BT Close Time</th>
                                <th>BT Reason</th>
                                <th>Live Strategy</th>
                                <th>Live Contracts</th>
                                <th>Live P&L</th>
                                <th>Live Close Time</th>
                                <th>Live Reason</th>
                                <th>P&L Diff</th>
                                <th>P&L Diff/Contract</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${liveVsBtData.comparison_data.map(trade => `
                                <tr>
                                    <td><strong>${trade.entry_datetime}</strong></td>
                                    <td>${trade.backtest ? trade.backtest.strategy : '-'}</td>
                                    <td>${trade.backtest ? trade.backtest.contracts : '-'}</td>
                                    <td>${trade.backtest ? `$${trade.backtest.pnl.toFixed(2)}` : '-'}</td>
                                    <td>${trade.backtest ? trade.backtest.close_datetime : '-'}</td>
                                    <td>${trade.backtest ? trade.backtest.reason_for_close : '-'}</td>
                                    <td>${trade.live ? trade.live.strategy : '-'}</td>
                                    <td>${trade.live ? trade.live.contracts : '-'}</td>
                                    <td>${trade.live ? `$${trade.live.pnl.toFixed(2)}` : '-'}</td>
                                    <td>${trade.live ? trade.live.close_datetime : '-'}</td>
                                    <td>${trade.live ? trade.live.reason_for_close : '-'}</td>
                                    <td>
                                        ${trade.pnl_diff !== null ? 
                                            `<span class="badge ${trade.pnl_diff > 0 ? 'bg-success' : trade.pnl_diff < 0 ? 'bg-danger' : 'bg-secondary'}">
                                                ${trade.pnl_diff > 0 ? '+' : ''}$${trade.pnl_diff.toFixed(2)}
                                            </span>` : 
                                            '<span class="text-muted">N/A</span>'
                                        }
                                    </td>
                                    <td>
                                        ${trade.pnl_diff !== null && trade.backtest && trade.live && trade.backtest.contracts > 0 && trade.live.contracts > 0 ? 
                                            `<span class="badge ${(trade.pnl_diff / Math.max(trade.backtest.contracts, trade.live.contracts)) > 0 ? 'bg-success' : (trade.pnl_diff / Math.max(trade.backtest.contracts, trade.live.contracts)) < 0 ? 'bg-danger' : 'bg-secondary'}">
                                                ${(trade.pnl_diff / Math.max(trade.backtest.contracts, trade.live.contracts)) > 0 ? '+' : ''}$${(trade.pnl_diff / Math.max(trade.backtest.contracts, trade.live.contracts)).toFixed(2)}
                                            </span>` : 
                                            '<span class="text-muted">N/A</span>'
                                        }
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            
            container.innerHTML = summaryHtml + tableHtml;
        }

        function displayLiveVsBTError(message) {
            const container = document.getElementById('liveVsBtContent');
            container.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle"></i> ${message}
                </div>
            `;
        }

        // Live vs BT file selection functions
        function loadLiveVsBtFileSelection() {
            // Load files for both backtest and live selection
            loadFilesForSelection('backtestFileSelect', 'backtest');
            loadFilesForSelection('liveFileSelect', 'live');
        }

        function loadFilesForSelection(selectId, type) {
            const select = document.getElementById(selectId);
            
            fetch('/api/saved-files')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.data && data.data.length > 0) {
                        // Filter files based on type
                        const filteredFiles = data.data.filter(file => {
                            if (type === 'backtest') {
                                return file.file_type === 'backtest';
                            } else if (type === 'live') {
                                return file.file_type === 'live';
                            }
                            return true;
                        });
                        
                        if (filteredFiles.length > 0) {
                            const optionsHtml = filteredFiles.map(file => {
                                const displayName = file.friendly_name || file.filename;
                                return `<option value="${file.filename}">${displayName}</option>`;
                            }).join('');
                            
                            select.innerHTML = `<option value="">Select a ${type} file...</option>` + optionsHtml;
                            
                            // Add event listener for selection changes
                            select.addEventListener('change', updateLiveVsBtSelection);
                        } else {
                            select.innerHTML = `<option value="">No ${type} files found</option>`;
                        }
                    } else {
                        select.innerHTML = `<option value="">No files available</option>`;
                    }
                })
                .catch(error => {
                    console.error('Error loading files:', error);
                    select.innerHTML = `<option value="">Error loading files</option>`;
                });
        }

        function updateLiveVsBtSelection() {
            const backtestSelect = document.getElementById('backtestFileSelect');
            const liveSelect = document.getElementById('liveFileSelect');
            const runBtn = document.getElementById('runLiveVsBtBtn');
            
            if (backtestSelect.value && liveSelect.value) {
                runBtn.disabled = false;
                runBtn.innerHTML = '<i class="fas fa-balance-scale"></i> Run Live vs Backtest Analysis';
            } else {
                runBtn.disabled = true;
                runBtn.innerHTML = '<i class="fas fa-balance-scale"></i> Select Both Files';
            }
        }

        function clearLiveVsBtSelection() {
            document.getElementById('backtestFileSelect').value = '';
            document.getElementById('liveFileSelect').value = '';
            updateLiveVsBtSelection();
            
            const resultsDiv = document.getElementById('liveVsBtResults');
            if (resultsDiv) {
                resultsDiv.style.display = 'none';
            }
        }

        function runLiveVsBTAnalysis() {
            const backtestSelect = document.getElementById('backtestFileSelect');
            const liveSelect = document.getElementById('liveFileSelect');
            const matchOnlyDateTime = document.getElementById('matchOnlyDateTime').checked;
            
            if (!backtestSelect.value || !liveSelect.value) {
                alert('Please select both a backtest file and a live trading file.');
                return;
            }
            
            const resultsDiv = document.getElementById('liveVsBtResults');
            resultsDiv.style.display = 'block';
            resultsDiv.innerHTML = `
                <div class="text-center">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="mt-2">Running Live vs BT analysis...</p>
                    <small class="text-muted">Comparing ${backtestSelect.value} with ${liveSelect.value}</small>
                    ${matchOnlyDateTime ? '<br><small class="text-info">Matching only on date/time (strategy names ignored)</small>' : ''}
                </div>
            `;
            
            // Call the API with selected files
            fetch('/api/portfolio/live-vs-bt-analysis', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    backtest_file: backtestSelect.value,
                    live_file: liveSelect.value,
                    match_only_datetime: matchOnlyDateTime
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayLiveVsBTAnalysisResults(data.data);
                } else {
                    displayLiveVsBTAnalysisError(data.message || data.error || 'Failed to run Live vs BT analysis');
                }
            })
            .catch(error => {
                console.error('Error running Live vs BT analysis:', error);
                displayLiveVsBTAnalysisError('Error running Live vs BT analysis: ' + error.message);
            });
        }

        function displayLiveVsBTAnalysisResults(liveVsBtData) {
            const container = document.getElementById('liveVsBtResults');
            
            if (!liveVsBtData.available) {
                container.innerHTML = `
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> ${liveVsBtData.message}
                    </div>
                `;
                return;
            }
            
            if (!liveVsBtData.comparison_data || liveVsBtData.comparison_data.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i> No comparison data available.
                    </div>
                `;
                return;
            }
            
            // Create summary
            const summary = liveVsBtData.summary || {};
            const summaryHtml = `
                <div class="row mb-3">
                    <div class="col-12">
                        <div class="alert alert-info">
                            <h6><i class="fas fa-chart-bar"></i> Comparison Summary</h6>
                            <div class="row text-center">
                                <div class="col-md-2">
                                    <strong>${summary.total_trades || 0}</strong><br>
                                    <small>Total Trades</small>
                                </div>
                                <div class="col-md-2">
                                    <strong>${summary.matched_trades || 0}</strong><br>
                                    <small>Matched</small>
                                </div>
                                <div class="col-md-2">
                                    <strong>${summary.backtest_only || 0}</strong><br>
                                    <small>Backtest Only</small>
                                </div>
                                <div class="col-md-2">
                                    <strong>${summary.live_only || 0}</strong><br>
                                    <small>Live Only</small>
                                </div>
                                <div class="col-md-2">
                                    <strong>$${summary.avg_pnl_diff || 0}</strong><br>
                                    <small>Avg P&L Diff</small>
                                </div>
                                <div class="col-md-2">
                                    <strong>${summary.positive_diffs || 0}/${summary.negative_diffs || 0}</strong><br>
                                    <small>Better/Worse</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Create comparison table
            const tableHtml = `
                <div class="table-responsive">
                    <table class="table table-striped table-hover" id="liveVsBtTable">
                        <thead class="table-dark">
                            <tr>
                                <th>Entry Date/Time</th>
                                <th>BT Strategy</th>
                                <th>BT Contracts</th>
                                <th>BT P&L</th>
                                <th>BT Close Time</th>
                                <th>BT Reason</th>
                                <th>Live Strategy</th>
                                <th>Live Contracts</th>
                                <th>Live P&L</th>
                                <th>Live Close Time</th>
                                <th>Live Reason</th>
                                <th>P&L Diff</th>
                                <th>P&L Diff/Contract</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${liveVsBtData.comparison_data.map(trade => `
                                <tr>
                                    <td><strong>${trade.entry_datetime}</strong></td>
                                    <td>${trade.backtest ? trade.backtest.strategy : '-'}</td>
                                    <td>${trade.backtest ? trade.backtest.contracts : '-'}</td>
                                    <td>${trade.backtest ? `$${trade.backtest.pnl.toFixed(2)}` : '-'}</td>
                                    <td>${trade.backtest ? trade.backtest.close_datetime : '-'}</td>
                                    <td>${trade.backtest ? trade.backtest.reason_for_close : '-'}</td>
                                    <td>${trade.live ? trade.live.strategy : '-'}</td>
                                    <td>${trade.live ? trade.live.contracts : '-'}</td>
                                    <td>${trade.live ? `$${trade.live.pnl.toFixed(2)}` : '-'}</td>
                                    <td>${trade.live ? trade.live.close_datetime : '-'}</td>
                                    <td>${trade.live ? trade.live.reason_for_close : '-'}</td>
                                    <td>
                                        ${trade.pnl_diff !== null ? 
                                            `<span class="badge ${trade.pnl_diff > 0 ? 'bg-success' : trade.pnl_diff < 0 ? 'bg-danger' : 'bg-secondary'}">
                                                ${trade.pnl_diff > 0 ? '+' : ''}$${trade.pnl_diff.toFixed(2)}
                                            </span>` : 
                                            '<span class="text-muted">N/A</span>'
                                        }
                                    </td>
                                    <td>
                                        ${trade.pnl_diff !== null && trade.backtest && trade.live && trade.backtest.contracts > 0 && trade.live.contracts > 0 ? 
                                            `<span class="badge ${(trade.pnl_diff / Math.max(trade.backtest.contracts, trade.live.contracts)) > 0 ? 'bg-success' : (trade.pnl_diff / Math.max(trade.backtest.contracts, trade.live.contracts)) < 0 ? 'bg-danger' : 'bg-secondary'}">
                                                ${(trade.pnl_diff / Math.max(trade.backtest.contracts, trade.live.contracts)) > 0 ? '+' : ''}$${(trade.pnl_diff / Math.max(trade.backtest.contracts, trade.live.contracts)).toFixed(2)}
                                            </span>` : 
                                            '<span class="text-muted">N/A</span>'
                                        }
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            
            container.innerHTML = summaryHtml + tableHtml;
            
            // Initialize table sorting
            initializeLiveVsBtTableSorting();
        }

        function initializeLiveVsBtTableSorting() {
            const table = document.getElementById('liveVsBtTable');
            if (!table) return;
            
            // Get the headers from the single row
            const headerRows = table.querySelectorAll('thead tr');
            const headers = headerRows[0].querySelectorAll('th');
            let sortDirection = {};
            
            headers.forEach((header, index) => {
                header.style.cursor = 'pointer';
                header.innerHTML += ' <i class="fas fa-sort text-muted"></i>';
                
                header.addEventListener('click', () => {
                    sortLiveVsBtTable(table, index, sortDirection);
                });
            });
            
            function sortLiveVsBtTable(table, columnIndex, sortDirection) {
                const tbody = table.querySelector('tbody');
                const rows = Array.from(tbody.querySelectorAll('tr'));
                
                // Determine sort direction
                const currentDirection = sortDirection[columnIndex] || 'asc';
                const newDirection = currentDirection === 'asc' ? 'desc' : 'asc';
                sortDirection[columnIndex] = newDirection;
                
                // Sort rows
                rows.sort((a, b) => {
                    const aCell = a.cells[columnIndex];
                    const bCell = b.cells[columnIndex];
                    
                    let aVal = aCell.textContent.trim();
                    let bVal = bCell.textContent.trim();
                    
                    // Handle numeric values (Contracts, P&L columns, P&L Diff, P&L Diff/Contract)
                    if (columnIndex === 2 || columnIndex === 3 || columnIndex === 7 || columnIndex === 8 || columnIndex === 11 || columnIndex === 12) {
                        aVal = parseFloat(aVal.replace(/[$,]/g, '')) || 0;
                        bVal = parseFloat(bVal.replace(/[$,]/g, '')) || 0;
                    }
                    // Handle date/time sorting for Entry Date/Time column
                    else if (columnIndex === 0) {
                        // Parse date/time for proper sorting
                        const aDate = new Date(aVal);
                        const bDate = new Date(bVal);
                        if (!isNaN(aDate.getTime()) && !isNaN(bDate.getTime())) {
                            aVal = aDate.getTime();
                            bVal = bDate.getTime();
                        }
                    }
                    
                    if (aVal < bVal) return newDirection === 'asc' ? -1 : 1;
                    if (aVal > bVal) return newDirection === 'asc' ? 1 : -1;
                    return 0;
                });
                
                // Update table
                rows.forEach(row => tbody.appendChild(row));
                
                // Update sort icons
                headers.forEach((header, index) => {
                    const icon = header.querySelector('.fa-sort');
                    if (index === columnIndex) {
                        icon.className = newDirection === 'asc' ? 'fas fa-sort-up' : 'fas fa-sort-down';
                    } else {
                        icon.className = 'fas fa-sort text-muted';
                    }
                });
            }
        }

        function displayLiveVsBTAnalysisError(message) {
            const container = document.getElementById('liveVsBtResults');
            container.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle"></i> ${message}
                </div>
            `;
        }

        function loadMEICAnalysis() {
            console.log('🔧 loadMEICAnalysis() called');
            const container = document.getElementById('chartContainer');
            const loading = document.getElementById('chartLoading');
            const meicContent = document.getElementById('meicAnalysisContent');
            const noTradesMessage = document.getElementById('meicNoTradesMessage');
            
            // Hide other content and show MEIC content
            container.style.display = 'none';
            loading.style.display = 'none';
            meicContent.style.display = 'block';
            
            // First check if MEIC trades exist
            checkMEICTrades();
        }
        
        function checkMEICTrades() {
            console.log('🔧 checkMEICTrades() called');
            fetch('/api/meic/stopout-statistics')
                .then(response => response.json())
                .then(data => {
                    console.log('🔧 MEIC stopout statistics response:', data);
                    const noTradesMessage = document.getElementById('meicNoTradesMessage');
                    const overviewSection = document.getElementById('meicOverviewStats').parentElement.parentElement.parentElement;
                    const heatmapSection = document.getElementById('meicHeatmapChart').parentElement.parentElement.parentElement;
                    
                    if (data.success && data.data && data.data.total_leg_groups > 0) {
                        console.log('🔧 Valid MEIC trades found, showing sections and loading data');
                        // Valid MEIC trades found - hide message and show all sections
                        noTradesMessage.style.display = 'none';
                        overviewSection.style.display = 'block';
                        heatmapSection.style.display = 'block';
                        
                        // Load MEIC data
                        loadMEICOverview();
                        loadMEICHeatmap();
                    } else {
                        console.log('🔧 No valid MEIC trades found, showing message');
                        console.log('🔧 Response data:', data);
                        // No valid MEIC trades found - show message and hide other sections
                        noTradesMessage.style.display = 'block';
                        overviewSection.style.display = 'none';
                        heatmapSection.style.display = 'none';
                    }
                })
                .catch(error => {
                    console.error('Error checking MEIC trades:', error);
                    // On error, show the no trades message
                    const noTradesMessage = document.getElementById('meicNoTradesMessage');
                    noTradesMessage.style.display = 'block';
                });
        }
        
        function loadMEICOverview() {
            // Don't load if already loading or if no data
            if (isLoadingData) {
                console.log('⏳ MEIC overview loading already in progress, skipping...');
                return;
            }
            
            const overviewContainer = document.getElementById('meicOverviewStats');
            overviewContainer.innerHTML = '<div class="text-center"><div class="spinner-border text-primary" role="status"></div><p class="mt-2">Loading MEIC overview statistics...</p></div>';
            
            // Set loading timeout for large datasets
            loadingTimeout = setTimeout(() => {
                if (isLoadingData) {
                    console.warn('⏰ MEIC overview loading timeout - dataset may be very large');
                    overviewContainer.innerHTML = '<div class="alert alert-warning"><i class="fas fa-clock"></i> Loading is taking longer than expected. Large datasets may require more time.</div>';
                }
            }, 30000); // 30 second timeout
            
            // Load both stopout statistics and summary statistics
            Promise.all([
                fetch('/api/meic/stopout-statistics').then(response => response.json()),
                fetch('/api/meic/time-heatmap').then(response => response.json())
            ])
            .then(([stopoutData, heatmapData]) => {
                // Clear loading timeout
                if (loadingTimeout) {
                    clearTimeout(loadingTimeout);
                    loadingTimeout = null;
                }
                
                if (stopoutData.success && heatmapData.success && stopoutData.data.total_leg_groups > 0) {
                    const stopoutStats = stopoutData.data;
                    const summaryStats = heatmapData.data.summary_stats;
                    
                    overviewContainer.innerHTML = `
                        <!-- Stopout Statistics -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h5 class="mb-3">Stopout Statistics</h5>
                                <div class="row">
                                    <div class="col-md-3">
                                        <div class="card text-center">
                                            <div class="card-body">
                                                <h5 class="card-title text-success">${stopoutStats.no_stopouts.percentage}%</h5>
                                                <p class="card-text">No Stopouts</p>
                                                <small class="text-muted">${stopoutStats.no_stopouts.count} trades</small>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="card text-center">
                                            <div class="card-body">
                                                <h5 class="card-title text-warning">${stopoutStats.puts_stopped.percentage}%</h5>
                                                <p class="card-text">Puts Stopped</p>
                                                <small class="text-muted">${stopoutStats.puts_stopped.count} trades</small>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="card text-center">
                                            <div class="card-body">
                                                <h5 class="card-title text-warning">${stopoutStats.calls_stopped.percentage}%</h5>
                                                <p class="card-text">Calls Stopped</p>
                                                <small class="text-muted">${stopoutStats.calls_stopped.count} trades</small>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="card text-center">
                                            <div class="card-body">
                                                <h5 class="card-title text-danger">${stopoutStats.both_stopped.percentage}%</h5>
                                                <p class="card-text">Both Stopped</p>
                                                <small class="text-muted">${stopoutStats.both_stopped.count} trades</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Performance & Trading Statistics -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h5 class="mb-3">Performance & Trading Statistics</h5>
                                <div class="row">
                                    <div class="col-md-2">
                                        <div class="card text-center">
                                            <div class="card-body">
                                                <h6 class="card-title">Total P&L</h6>
                                                <p class="card-text">$${summaryStats.total_pnl.toLocaleString()}</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                        <div class="card text-center">
                                            <div class="card-body">
                                                <h6 class="card-title">Avg P&L/Group</h6>
                                                <p class="card-text">$${summaryStats.avg_pnl_per_group.toLocaleString()}</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                        <div class="card text-center">
                                            <div class="card-body">
                                                <h6 class="card-title">Total Contracts</h6>
                                                <p class="card-text">${stopoutStats.total_contracts.toLocaleString()}</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                        <div class="card text-center">
                                            <div class="card-body">
                                                <h6 class="card-title">Total Commissions</h6>
                                                <p class="card-text">$${stopoutStats.total_commissions.toLocaleString()}</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                        <div class="card text-center">
                                            <div class="card-body">
                                                <h6 class="card-title">Best Day</h6>
                                                <p class="card-text">${summaryStats.best_day || 'N/A'}</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                        <div class="card text-center">
                                            <div class="card-body">
                                                <h6 class="card-title">Worst Day</h6>
                                                <p class="card-text">${summaryStats.worst_day || 'N/A'}</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Summary -->
                        <div class="row">
                            <div class="col-12">
                                <p class="text-muted"><strong>Total MEIC Trades:</strong> ${stopoutStats.total_leg_groups}</p>
                            </div>
                        </div>
                    `;
                    
                    // Mark loading as complete
                    onDataLoadComplete();
                } else {
                    overviewContainer.innerHTML = `<div class="alert alert-warning">Error loading MEIC overview data</div>`;
                    onDataLoadError('Failed to load MEIC overview data');
                }
            })
            .catch(error => {
                console.error('Error loading MEIC overview:', error);
                overviewContainer.innerHTML = `<div class="alert alert-danger">Error loading MEIC overview: ${error.message}</div>`;
                onDataLoadError(error);
            });
        }
        
        function loadMEICHeatmap(startDate = null, endDate = null) {
            console.log('🔧 loadMEICHeatmap() called with dates:', startDate, endDate);
            const heatmapContainer = document.getElementById('meicHeatmapChart');
            heatmapContainer.innerHTML = '<div class="text-center"><div class="spinner-border text-primary" role="status"></div><p class="mt-2">Loading MEIC heatmap...</p><small class="text-muted">Large datasets may take longer to process</small></div>';
            
            // Set loading timeout for large datasets
            const heatmapTimeout = setTimeout(() => {
                if (isLoadingData) {
                    console.warn('⏰ MEIC heatmap loading timeout - dataset may be very large');
                    heatmapContainer.innerHTML = '<div class="alert alert-warning"><i class="fas fa-clock"></i> Heatmap loading is taking longer than expected. Large datasets may require more time.</div>';
                }
            }, 45000); // 45 second timeout for heatmap
            
            // Build URL with date parameters
            let url = '/api/meic/time-heatmap';
            const params = new URLSearchParams();
            if (startDate) params.append('start_date', startDate);
            if (endDate) params.append('end_date', endDate);
            if (params.toString()) url += '?' + params.toString();
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    // Clear timeout
                    clearTimeout(heatmapTimeout);
                    
                    console.log('🔧 MEIC heatmap API response:', data);
                    if (data.success && data.data && data.data.summary_stats.total_leg_groups > 0) {
                        const heatmapData = data.data;
                        console.log('🔧 MEIC heatmap data:', heatmapData);
                        console.log('🔧 pnl_heatmap keys:', Object.keys(heatmapData.pnl_heatmap));
                        
                        // Initialize date sliders on first load
                        if (heatmapData.date_range && !meicDateRange) {
                            initializeMEICDateSliders(heatmapData.date_range);
                        }
                        
                        // Update trade count display
                        const tradeCount = heatmapData.summary_stats.total_leg_groups;
                        document.getElementById('meicTradeCount').textContent = tradeCount.toLocaleString();
                        
                        // Create the heatmap using Plotly
                        // Get all available days from the data and sort them properly
                        const availableDays = Object.keys(heatmapData.pnl_heatmap);
                        console.log('🔧 Available days from data:', availableDays);
                        
                        // Sort days in proper Monday-Friday order
                        const dayOrder = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
                        const orderedDays = availableDays.sort((a, b) => {
                            const aIndex = dayOrder.indexOf(a);
                            const bIndex = dayOrder.indexOf(b);
                            // If both are in dayOrder, sort by dayOrder index (Monday=0, Tuesday=1, etc.)
                            if (aIndex !== -1 && bIndex !== -1) return aIndex - bIndex;
                            // If only one is in dayOrder, prioritize it
                            if (aIndex !== -1) return -1;
                            if (bIndex !== -1) return 1;
                            // If neither is in dayOrder, sort alphabetically
                            return a.localeCompare(b);
                        });
                        console.log('🔧 Ordered days:', orderedDays);
                        
                        // Debug: Check if we have valid data
                        if (orderedDays.length === 0) {
                            console.error('🔧 No ordered days found');
                            heatmapContainer.innerHTML = '<div class="alert alert-warning">No MEIC data available - no days found</div>';
                            return;
                        }
                        
                        const firstDay = orderedDays[0];
                        const entryTimes = Object.keys(heatmapData.pnl_heatmap[firstDay] || {});
                        
                        // Sort entry times chronologically (earliest first)
                        entryTimes.sort((a, b) => {
                            // Convert time strings to comparable format
                            const timeA = a.split(':').map(Number);
                            const timeB = b.split(':').map(Number);
                            
                            // Compare hours first, then minutes, then seconds
                            if (timeA[0] !== timeB[0]) return timeA[0] - timeB[0];
                            if (timeA[1] !== timeB[1]) return timeA[1] - timeB[1];
                            return timeA[2] - timeB[2];
                        });
                        
                        // Reverse the array so earliest time appears at the top of the heatmap
                        entryTimes.reverse();
                        
                        console.log('🔧 Entry times for first day (sorted, earliest at top):', entryTimes);
                        
                        if (entryTimes.length === 0) {
                            console.error('🔧 No entry times found');
                            heatmapContainer.innerHTML = '<div class="alert alert-warning">No MEIC data available - no entry times found</div>';
                            return;
                        }
                        
                        // Create z data matrix - transpose for correct axis orientation
                        // Days should be columns (x-axis), Entry times should be rows (y-axis)
                        const zData = entryTimes.map(time => {
                            return orderedDays.map(day => {
                                const dayData = heatmapData.pnl_heatmap[day] || {};
                                return dayData[time] || 0;
                            });
                        });
                        
                        console.log('🔧 Z data matrix (transposed):', zData);
                        console.log('🔧 Days for x-axis:', orderedDays);
                        console.log('🔧 Entry times for y-axis:', entryTimes);
                        
                        const plotData = [{
                            z: zData,
                            x: orderedDays,
                            y: entryTimes,
                            type: 'heatmap',
                            colorscale: [
                                [0, 'rgb(220, 53, 69)'],    // Red for losses (negative values)
                                [0.5, 'rgb(255, 255, 255)'], // White for zero
                                [1, 'rgb(40, 167, 69)']     // Green for wins (positive values)
                            ],
                            zmid: 0,
                            text: zData,
                            texttemplate: '%{text:.0f}',
                            textfont: {size: 10},
                            hoverongaps: false,
                            hovertemplate: '<b>%{x}</b><br>Entry Time: %{y}<br>Total P&L: $%{z:.2f}<br><extra></extra>'
                        }];
                        
                        console.log('🔧 Plot data:', plotData);
                        
                        const layout = {
                            title: 'MEIC Performance Heatmap by Day of Week and Entry Time',
                            xaxis: { title: 'Day of Week' },
                            yaxis: { title: 'Entry Time' },
                            height: 500,
                            margin: { l: 120, r: 60, t: 80, b: 60 },  // Increased left margin for entry times
                            font: { size: 12 }
                        };
                        
                        console.log('🔧 About to render Plotly heatmap...');
                        
                        // Add timeout to catch hanging issues
                        const renderTimeout = setTimeout(() => {
                            console.error('🔧 Plotly rendering timed out');
                            heatmapContainer.innerHTML = '<div class="alert alert-warning">Heatmap rendering timed out. Please try again.</div>';
                        }, 10000); // 10 second timeout
                        
                        Plotly.newPlot(heatmapContainer, plotData, layout)
                            .then(() => {
                                clearTimeout(renderTimeout);
                                console.log('🔧 Plotly heatmap rendered successfully');
                                // Clear any loading content that might still be showing
                                const loadingElements = heatmapContainer.querySelectorAll('.spinner-border, .text-center');
                                loadingElements.forEach(el => el.remove());
                                
                                // Add daily P&L totals display
                                addDailyPnLTotals(heatmapData.daily_pnl_totals, orderedDays);
                            })
                            .catch(error => {
                                clearTimeout(renderTimeout);
                                console.error('🔧 Plotly rendering error:', error);
                                heatmapContainer.innerHTML = `<div class="alert alert-danger">Error rendering heatmap: ${error.message}</div>`;
                            });
                    } else {
                        console.log('🔧 MEIC heatmap API returned error:', data.error);
                        heatmapContainer.innerHTML = `<div class="alert alert-warning">${data.error}</div>`;
                    }
                })
                .catch(error => {
                    // Clear timeout
                    clearTimeout(heatmapTimeout);
                    
                    console.error('Error loading MEIC heatmap:', error);
                    heatmapContainer.innerHTML = `<div class="alert alert-danger">Error loading MEIC heatmap: ${error.message}</div>`;
                    onDataLoadError(error);
                });
        }

        // Global variables for date range
        let meicDateRange = null;
        let meicDateList = [];
        let meicCurrentStartDate = null;
        let meicCurrentEndDate = null;

        // Global loading state management
        let isLoadingData = false;
        let loadingTimeout = null;

        // Global state cleanup function
        function clearAllAppState() {
            console.log('🧹 Clearing all application state...');
            
            // Set loading state
            isLoadingData = true;
            
            // Clear any existing timeout
            if (loadingTimeout) {
                clearTimeout(loadingTimeout);
                loadingTimeout = null;
            }
            
            // Clear all global variables that store cached data
            currentChart = null;
            availableCharts = {};
            chartsLoadedSuccessfully = false;
            currentSimulationData = null;
            strategyCurrentPage = 1;
            currentPaginationData = null;
            currentTableData = null;
            currentPage = 1;
            currentSortColumn = null;
            currentSortDirection = 'desc';
            
            // Clear window-level cached data
            if (window.pnlByDayOfWeekData) window.pnlByDayOfWeekData = null;
            if (window.pnlByDayOfWeekChartData) window.pnlByDayOfWeekChartData = null;
            if (window.conflictsData) window.conflictsData = null;
            if (window.monthlyPnlData) window.monthlyPnlData = null;
            if (window.monthlyPnlSortKey) window.monthlyPnlSortKey = 'strategy';
            if (window.monthlyPnlSortAsc) window.monthlyPnlSortAsc = true;
            if (window.blackoutResults) window.blackoutResults = null;
            if (window.blackoutTrades) window.blackoutTrades = null;
            if (window.pendingFileUpload) window.pendingFileUpload = null;
            if (window.selectedFile) window.selectedFile = null;
            if (window.skipAutoLoadCumulativePnl) window.skipAutoLoadCumulativePnl = false;
            
            // Clear MEIC state
            meicDateRange = null;
            meicDateList = [];
            meicCurrentStartDate = null;
            meicCurrentEndDate = null;
            
            // Clear MEIC UI elements
            const meicOverviewContainer = document.getElementById('meicOverviewStats');
            const meicHeatmapContainer = document.getElementById('meicHeatmapChart');
            const meicNoTradesMessage = document.getElementById('meicNoTradesMessage');
            
            if (meicOverviewContainer) {
                meicOverviewContainer.innerHTML = '<div class="text-center"><div class="spinner-border text-primary" role="status"></div><p class="mt-2">Loading MEIC overview statistics...</p></div>';
            }
            
            if (meicHeatmapContainer) {
                meicHeatmapContainer.innerHTML = '<div class="text-center"><div class="spinner-border text-primary" role="status"></div><p class="mt-2">Loading MEIC heatmap...</p></div>';
            }
            
            if (meicNoTradesMessage) {
                meicNoTradesMessage.style.display = 'none';
            }
            
            // Clear any existing daily totals
            const existingTotals = document.getElementById('meicDailyTotals');
            if (existingTotals) {
                existingTotals.remove();
            }
            
            // Reset date sliders
            const startSlider = document.getElementById('meicStartDateSlider');
            const endSlider = document.getElementById('meicEndDateSlider');
            if (startSlider) startSlider.value = 0;
            if (endSlider) endSlider.value = 100;
            
            // Clear date displays
            const startDisplay = document.getElementById('meicStartDateDisplay');
            const endDisplay = document.getElementById('meicEndDateDisplay');
            if (startDisplay) startDisplay.textContent = 'All Dates';
            if (endDisplay) endDisplay.textContent = 'All Dates';
            
            // Hide recalculation notice
            hideRecalculationNotice();
            
            // Clear trade count
            const tradeCount = document.getElementById('meicTradeCount');
            if (tradeCount) tradeCount.textContent = 'Loading...';
            
            // Clear chart container to prevent stale data
            const chartContainer = document.getElementById('chartContainer');
            if (chartContainer) {
                chartContainer.innerHTML = '<div class="text-center text-muted"><h4>📊 Data loaded! Select a chart to view analytics</h4></div>';
            }
            
            // Force garbage collection if available
            if (window.gc) {
                window.gc();
            }
            
            console.log('🧹 Application state cleared');
        }

        // Function to handle loading completion
        function onDataLoadComplete() {
            isLoadingData = false;
            if (loadingTimeout) {
                clearTimeout(loadingTimeout);
                loadingTimeout = null;
            }
            console.log('✅ Data loading completed');
            
            // Hide any global loading indicators
            const globalLoader = document.getElementById('globalLoadingIndicator');
            if (globalLoader) {
                globalLoader.style.display = 'none';
            }
        }

        // Function to handle loading errors
        function onDataLoadError(error) {
            isLoadingData = false;
            if (loadingTimeout) {
                clearTimeout(loadingTimeout);
                loadingTimeout = null;
            }
            console.error('❌ Data loading error:', error);
            
            // Hide any global loading indicators
            const globalLoader = document.getElementById('globalLoadingIndicator');
            if (globalLoader) {
                globalLoader.style.display = 'none';
            }
        }

        function updateMEICDateLabels() {
            if (!meicDateRange || meicDateList.length === 0) return;
            
            const startSlider = document.getElementById('meicStartDateSlider');
            const endSlider = document.getElementById('meicEndDateSlider');
            
            // Ensure start is not after end
            if (parseInt(startSlider.value) >= parseInt(endSlider.value)) {
                if (startSlider.value == endSlider.value) {
                    endSlider.value = Math.min(parseInt(startSlider.value) + 1, 100);
                } else {
                    startSlider.value = Math.max(parseInt(endSlider.value) - 1, 0);
                }
            }
            
            // Convert slider values to dates
            const startIndex = Math.floor((parseInt(startSlider.value) / 100) * (meicDateList.length - 1));
            const endIndex = Math.floor((parseInt(endSlider.value) / 100) * (meicDateList.length - 1));
            
            const startDate = meicDateList[startIndex];
            const endDate = meicDateList[endIndex];
            
            // Update display
            document.getElementById('meicStartDateDisplay').textContent = startDate;
            document.getElementById('meicEndDateDisplay').textContent = endDate;
            
            // Show recalculation notice if dates have changed
            if (startDate !== meicCurrentStartDate || endDate !== meicCurrentEndDate) {
                showRecalculationNotice();
            }
        }

        function showRecalculationNotice() {
            document.getElementById('meicRecalculationNotice').style.display = 'block';
            document.getElementById('meicRecalculateBtn').classList.add('btn-warning');
            document.getElementById('meicRecalculateBtn').classList.remove('btn-primary');
        }

        function hideRecalculationNotice() {
            document.getElementById('meicRecalculationNotice').style.display = 'none';
            document.getElementById('meicRecalculateBtn').classList.remove('btn-warning');
            document.getElementById('meicRecalculateBtn').classList.add('btn-primary');
        }

        function recalculateMEICHeatmap() {
            const startSlider = document.getElementById('meicStartDateSlider');
            const endSlider = document.getElementById('meicEndDateSlider');
            
            // Convert slider values to dates
            const startIndex = Math.floor((parseInt(startSlider.value) / 100) * (meicDateList.length - 1));
            const endIndex = Math.floor((parseInt(endSlider.value) / 100) * (meicDateList.length - 1));
            
            const startDate = meicDateList[startIndex];
            const endDate = meicDateList[endIndex];
            
            // Update current dates
            meicCurrentStartDate = startDate;
            meicCurrentEndDate = endDate;
            
            // Hide recalculation notice
            hideRecalculationNotice();
            
            // Update heatmap
            loadMEICHeatmap(startDate, endDate);
        }

        function resetMEICDateRange() {
            document.getElementById('meicStartDateSlider').value = 0;
            document.getElementById('meicEndDateSlider').value = 100;
            document.getElementById('meicStartDateDisplay').textContent = 'All Dates';
            document.getElementById('meicEndDateDisplay').textContent = 'All Dates';
            
            // Reset current dates
            meicCurrentStartDate = null;
            meicCurrentEndDate = null;
            
            // Hide recalculation notice
            hideRecalculationNotice();
            
            // Update heatmap
            loadMEICHeatmap();
        }

        function initializeMEICDateSliders(dateRange) {
            if (!dateRange) return;
            
            meicDateRange = dateRange;
            
            // Generate list of dates between min and max
            const startDate = new Date(dateRange.min_date);
            const endDate = new Date(dateRange.max_date);
            meicDateList = [];
            
            for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                meicDateList.push(d.toISOString().split('T')[0]);
            }
            
            // Update slider labels
            document.getElementById('meicStartDateMin').textContent = dateRange.min_date;
            document.getElementById('meicStartDateMax').textContent = dateRange.max_date;
            document.getElementById('meicEndDateMin').textContent = dateRange.min_date;
            document.getElementById('meicEndDateMax').textContent = dateRange.max_date;
            
            // Set initial display
            document.getElementById('meicStartDateDisplay').textContent = 'All Dates';
            document.getElementById('meicEndDateDisplay').textContent = 'All Dates';
            
            // Initialize current dates to "All Dates" (null values)
            meicCurrentStartDate = null;
            meicCurrentEndDate = null;
            
            // Hide recalculation notice initially
            hideRecalculationNotice();
        }

        function addDailyPnLTotals(dailyPnLTotals, orderedDays) {
            // Remove any existing daily totals display
            const existingTotals = document.getElementById('meicDailyTotals');
            if (existingTotals) {
                existingTotals.remove();
            }
            
            // Create daily totals display
            const totalsContainer = document.createElement('div');
            totalsContainer.id = 'meicDailyTotals';
            totalsContainer.className = 'mt-3';
            
            let totalsHtml = '<div class="card border-light"><div class="card-body py-2"><h6 class="card-title mb-2"><i class="fas fa-calculator"></i> Daily P&L Totals</h6><div class="d-flex flex-wrap align-items-center gap-3">';
            
            // Calculate total P&L for color coding
            const totalPnL = Object.values(dailyPnLTotals).reduce((sum, pnl) => sum + pnl, 0);
            const maxPnL = Math.max(...Object.values(dailyPnLTotals));
            const minPnL = Math.min(...Object.values(dailyPnLTotals));
            
            orderedDays.forEach(day => {
                const pnl = dailyPnLTotals[day] || 0;
                let badgeClass = 'bg-secondary';
                let textClass = 'text-dark';
                
                if (pnl > 0) {
                    badgeClass = 'bg-success';
                    textClass = 'text-white';
                } else if (pnl < 0) {
                    badgeClass = 'bg-danger';
                    textClass = 'text-white';
                }
                
                totalsHtml += `
                    <div class="d-flex align-items-center">
                        <span class="badge ${badgeClass} me-2">${day.substring(0, 3)}</span>
                        <span class="${textClass} fw-bold">$${pnl.toLocaleString()}</span>
                    </div>
                `;
            });
            
            totalsHtml += '</div>';
            
            // Add summary
            const summaryClass = totalPnL >= 0 ? 'text-success' : 'text-danger';
            totalsHtml += `<div class="mt-2"><small class="text-muted">Total: </small><span class="${summaryClass} fw-bold">$${totalPnL.toLocaleString()}</span></div>`;
            totalsHtml += '</div></div>';
            
            totalsContainer.innerHTML = totalsHtml;
            
            // Insert after the heatmap
            const heatmapContainer = document.getElementById('meicHeatmapChart');
            heatmapContainer.appendChild(totalsContainer);
        }

        function loadPriceMovementChart() {
            const container = document.getElementById('chartContainer');
            const loading = document.getElementById('chartLoading');
            
            // Show loading
            loading.style.display = 'block';
            container.innerHTML = '';
            
            // Fetch price movement data to get min/max values
            fetch('/api/price-movement/range')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const { min_movement, max_movement } = data.data;
                        
                           // Round the min and max values to one decimal place
                           const roundedMin = Math.round(min_movement * 10) / 10;
                           const roundedMax = Math.round(max_movement * 10) / 10;
                           
                           // Create the UI
                           container.innerHTML = `
                               <div class="card">
                                   <div class="card-header">
                                       <h5>📈 Price Movement Analysis</h5>
                                   </div>
                                   <div class="card-body">
                                       <div class="alert alert-info mb-4">
                                           <h6><i class="fas fa-info-circle"></i> What is Price Movement Analysis?</h6>
                                           <p class="mb-2">This tool analyzes trading performance based on the percentage price movement of the underlying symbol between trade opening and closing times. Filter trades by price movement range to see how your strategies perform in different market conditions.</p>
                                           <p class="mb-0"><strong>Range:</strong> ${roundedMin}% to ${roundedMax}%</p>
                                       </div>

                                       <div class="row mb-4">
                                           <div class="col-md-8">
                                               <label for="priceMovementRange" class="form-label">
                                                   Price Movement Range (%):
                                                   <span id="priceMovementRangeValue">-1% to 1%</span>
                                               </label>
                                               <div class="range-slider-container">
                                                   <input type="range" class="form-range" id="priceMovementMin"
                                                          min="${roundedMin}" max="${roundedMax}"
                                                          value="${Math.max(roundedMin, -1.0)}" step="0.1">
                                                   <input type="range" class="form-range" id="priceMovementMax"
                                                          min="${roundedMin}" max="${roundedMax}"
                                                          value="${Math.min(roundedMax, 1.0)}" step="0.1">
                                               </div>
                                               <div class="d-flex justify-content-between">
                                                   <small class="text-muted">${roundedMin}%</small>
                                                   <small class="text-muted">${roundedMax}%</small>
                                               </div>
                                           </div>
                                           <div class="col-md-4">
                                               <button class="btn btn-primary" id="analyzePriceMovementBtn" onclick="runPriceMovementAnalysis()">
                                                   <i class="fas fa-chart-bar"></i> Analyze Price Movement
                                               </button>
                                           </div>
                                       </div>

                                       <div id="priceMovementResults" style="display: none;">
                                           <!-- Results will be populated here -->
                                       </div>
                                   </div>
                               </div>
                           `;
                        
                        // Set up range slider event listeners
                        setupPriceMovementRangeSlider();
                        
                    } else {
                        container.innerHTML = `
                            <div class="alert alert-danger">
                                <h5>Error Loading Price Movement Data</h5>
                                <p>${data.error || 'Failed to load price movement range data.'}</p>
                            </div>
                        `;
                    }
                })
                .catch(error => {
                    console.error('Error loading price movement data:', error);
                    container.innerHTML = `
                        <div class="alert alert-danger">
                            <h5>Error Loading Price Movement Data</h5>
                            <p>Failed to load price movement data: ${error.message}</p>
                        </div>
                    `;
                })
                .finally(() => {
                    loading.style.display = 'none';
                });
        }

        function setupPriceMovementRangeSlider() {
            const minSlider = document.getElementById('priceMovementMin');
            const maxSlider = document.getElementById('priceMovementMax');
            const valueDisplay = document.getElementById('priceMovementRangeValue');
            
            function updateDisplay() {
                const minVal = parseFloat(minSlider.value);
                const maxVal = parseFloat(maxSlider.value);
                valueDisplay.textContent = `${minVal.toFixed(2)}% to ${maxVal.toFixed(2)}%`;
            }
            
            function updateSliders() {
                const minVal = parseFloat(minSlider.value);
                const maxVal = parseFloat(maxSlider.value);
                
                // Ensure min doesn't exceed max
                if (minVal > maxVal) {
                    minSlider.value = maxVal;
                }
                // Ensure max doesn't go below min
                if (maxVal < minVal) {
                    maxSlider.value = minVal;
                }
                
                updateDisplay();
            }
            
            minSlider.addEventListener('input', updateSliders);
            maxSlider.addEventListener('input', updateSliders);
            
            // Initial display
            updateDisplay();
        }

        function runPriceMovementAnalysis() {
            const minMovement = parseFloat(document.getElementById('priceMovementMin').value);
            const maxMovement = parseFloat(document.getElementById('priceMovementMax').value);
            const resultsDiv = document.getElementById('priceMovementResults');
            
            // Show loading
            resultsDiv.innerHTML = `
                <div class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Analyzing price movement data...</p>
                </div>
            `;
            resultsDiv.style.display = 'block';
            
            // Fetch analysis results
            fetch('/api/price-movement/analysis', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    min_movement: minMovement,
                    max_movement: maxMovement
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayPriceMovementResults(data.data);
                } else {
                    resultsDiv.innerHTML = `
                        <div class="alert alert-danger">
                            <h5>Analysis Error</h5>
                            <p>${data.error || 'Failed to analyze price movement data.'}</p>
                        </div>
                    `;
                }
            })
            .catch(error => {
                console.error('Error analyzing price movement:', error);
                resultsDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <h5>Analysis Error</h5>
                        <p>Failed to analyze price movement data: ${error.message}</p>
                    </div>
                `;
            });
        }

        function displayPriceMovementResults(data) {
            const resultsDiv = document.getElementById('priceMovementResults');
            
            if (!data.strategies || data.strategies.length === 0) {
                resultsDiv.innerHTML = `
                    <div class="alert alert-warning">
                        <h5>No Trades Found</h5>
                        <p>No trades found within the specified price movement range.</p>
                    </div>
                `;
                return;
            }
            
            // Create summary table
            let tableHTML = `
                <div class="card">
                    <div class="card-header">
                        <h6>Strategy Performance by Price Movement Range</h6>
                        <small class="text-muted">Range: ${data.min_movement.toFixed(2)}% to ${data.max_movement.toFixed(2)}%</small>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover" id="priceMovementSummaryTable">
                                <thead class="table-dark">
                                    <tr>
                                        <th class="sortable" data-column="0" data-type="text">Strategy <i class="fas fa-sort"></i></th>
                                        <th class="sortable" data-column="1" data-type="number">Trade Count <i class="fas fa-sort"></i></th>
                                        <th class="sortable" data-column="2" data-type="currency">Total P&L <i class="fas fa-sort"></i></th>
                                        <th class="sortable" data-column="3" data-type="currency">Avg P&L <i class="fas fa-sort"></i></th>
                                        <th class="sortable" data-column="4" data-type="currency">Avg P&L/Lot <i class="fas fa-sort"></i></th>
                                        <th class="sortable" data-column="5" data-type="number">Win Rate <i class="fas fa-sort"></i></th>
                                        <th class="sortable" data-column="6" data-type="currency">Avg Win <i class="fas fa-sort"></i></th>
                                        <th class="sortable" data-column="7" data-type="currency">Avg Loss <i class="fas fa-sort"></i></th>
                                    </tr>
                                </thead>
                                <tbody>
            `;
            
            data.strategies.forEach(strategy => {
                const winRate = strategy.trade_count > 0 ? (strategy.wins / strategy.trade_count * 100).toFixed(1) : '0.0';
                const avgPnlPerLot = strategy.avg_pnl_per_lot || 0;
                tableHTML += `
                    <tr>
                        <td><strong>${strategy.name}</strong></td>
                        <td>${strategy.trade_count}</td>
                        <td class="${strategy.total_pnl >= 0 ? 'text-success' : 'text-danger'}">
                            $${strategy.total_pnl.toLocaleString()}
                        </td>
                        <td class="${strategy.avg_pnl >= 0 ? 'text-success' : 'text-danger'}">
                            $${strategy.avg_pnl.toLocaleString()}
                        </td>
                        <td class="${avgPnlPerLot >= 0 ? 'text-success' : 'text-danger'}">
                            $${avgPnlPerLot.toLocaleString()}
                        </td>
                        <td>${winRate}%</td>
                        <td class="text-success">$${strategy.avg_win.toLocaleString()}</td>
                        <td class="text-danger">$${strategy.avg_loss.toLocaleString()}</td>
                    </tr>
                `;
            });
            
            // Add totals row
            const totalTrades = data.strategies.reduce((sum, s) => sum + s.trade_count, 0);
            const totalPnl = data.strategies.reduce((sum, s) => sum + s.total_pnl, 0);
            const totalWins = data.strategies.reduce((sum, s) => sum + s.wins, 0);
            const overallWinRate = totalTrades > 0 ? (totalWins / totalTrades * 100).toFixed(1) : '0.0';
            
            // Calculate total contracts for avg P&L/lot calculation
            const totalContracts = data.strategies.reduce((sum, s) => sum + (s.total_contracts || 0), 0);
            const avgPnlPerLot = totalContracts > 0 ? totalPnl / totalContracts : 0;
            
            tableHTML += `
                                </tbody>
                                <tfoot class="table-secondary">
                                    <tr>
                                        <td><strong>Total</strong></td>
                                        <td><strong>${totalTrades}</strong></td>
                                        <td class="${totalPnl >= 0 ? 'text-success' : 'text-danger'}">
                                            <strong>$${totalPnl.toLocaleString()}</strong>
                                        </td>
                                        <td class="${totalPnl >= 0 ? 'text-success' : 'text-danger'}">
                                            <strong>$${totalTrades > 0 ? (totalPnl / totalTrades).toLocaleString() : '0'}</strong>
                                        </td>
                                        <td class="${avgPnlPerLot >= 0 ? 'text-success' : 'text-danger'}">
                                            <strong>$${avgPnlPerLot.toLocaleString()}</strong>
                                        </td>
                                        <td><strong>${overallWinRate}%</strong></td>
                                        <td>-</td>
                                        <td>-</td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>
            `;
            
            // Add individual trades table
            tableHTML += `
                <div class="card mt-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <div>
                            <h6>Individual Trades in Price Movement Range</h6>
                            <small class="text-muted">Range: ${data.min_movement.toFixed(2)}% to ${data.max_movement.toFixed(2)}%</small>
                        </div>
                        <div class="d-flex align-items-center gap-2">
                            <label for="strategyFilter" class="form-label mb-0 small">Filter by Strategy:</label>
                            <select class="form-select form-select-sm" id="strategyFilter" style="width: auto; min-width: 150px;" onchange="filterTradesByStrategy()">
                                <option value="">All Strategies</option>
                                ${data.strategies.map(strategy => `
                                    <option value="${strategy.name}">${strategy.name}</option>
                                `).join('')}
                            </select>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover" id="priceMovementTradesTable">
                                <thead class="table-dark">
                                    <tr>
                                        <th class="sortable" data-column="0" data-type="text">Strategy <i class="fas fa-sort"></i></th>
                                        <th class="sortable" data-column="1" data-type="date">Date Opened <i class="fas fa-sort"></i></th>
                                        <th class="sortable" data-column="2" data-type="time">Time Opened <i class="fas fa-sort"></i></th>
                                        <th class="sortable" data-column="3" data-type="date">Date Closed <i class="fas fa-sort"></i></th>
                                        <th class="sortable" data-column="4" data-type="time">Time Closed <i class="fas fa-sort"></i></th>
                                        <th class="sortable" data-column="5" data-type="currency">Opening Price <i class="fas fa-sort"></i></th>
                                        <th class="sortable" data-column="6" data-type="currency">Closing Price <i class="fas fa-sort"></i></th>
                                        <th class="sortable" data-column="7" data-type="number">Price Movement % <i class="fas fa-sort"></i></th>
                                        <th class="sortable" data-column="8" data-type="currency">P&L <i class="fas fa-sort"></i></th>
                                        <th class="sortable" data-column="9" data-type="number">Contracts <i class="fas fa-sort"></i></th>
                                        <th class="sortable" data-column="10" data-type="currency">P&L/Lot <i class="fas fa-sort"></i></th>
                                    </tr>
                                </thead>
                                <tbody id="priceMovementTradesTableBody">
                                    <!-- Individual trades will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
            
            resultsDiv.innerHTML = tableHTML;
            
            // Make the summary table sortable
            makeTableSortable('priceMovementSummaryTable');
            
            // Load individual trades data
            loadIndividualTradesForPriceMovement(data.min_movement, data.max_movement);
        }

        function loadIndividualTradesForPriceMovement(minMovement, maxMovement) {
            const tbody = document.getElementById('priceMovementTradesTableBody');
            if (!tbody) return;
            
            // Show loading
            tbody.innerHTML = `
                <tr>
                    <td colspan="11" class="text-center">
                        <div class="spinner-border spinner-border-sm" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        Loading individual trades...
                    </td>
                </tr>
            `;
            
            // Fetch individual trades data
            fetch('/api/price-movement/trades', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    min_movement: minMovement,
                    max_movement: maxMovement
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success && data.data.trades) {
                    displayIndividualTrades(data.data.trades);
                } else {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="11" class="text-center text-muted">
                                ${data.error || 'No individual trades data available'}
                            </td>
                        </tr>
                    `;
                }
            })
            .catch(error => {
                console.error('Error loading individual trades:', error);
                tbody.innerHTML = `
                    <tr>
                        <td colspan="11" class="text-center text-danger">
                            Error loading individual trades: ${error.message}
                        </td>
                    </tr>
                `;
            });
        }

        // Global variable to store all trades for filtering
        let allPriceMovementTrades = [];

        function displayIndividualTrades(trades) {
            const tbody = document.getElementById('priceMovementTradesTableBody');
            if (!tbody) return;
            
            // Store all trades globally for filtering
            allPriceMovementTrades = trades || [];
            
            if (!trades || trades.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="11" class="text-center text-muted">
                            No individual trades found in this price movement range
                        </td>
                    </tr>
                `;
                return;
            }
            
            // Sort trades by date closed (most recent first)
            trades.sort((a, b) => new Date(b.date_closed) - new Date(a.date_closed));
            
            renderTradesTable(trades);
            
            // Make the table sortable
            makeTableSortable('priceMovementTradesTable');
        }

        function renderTradesTable(trades) {
            const tbody = document.getElementById('priceMovementTradesTableBody');
            if (!tbody) return;
            
            let tableHTML = '';
            trades.forEach(trade => {
                const pnlClass = trade.pnl >= 0 ? 'text-success' : 'text-danger';
                const movementClass = trade.price_movement >= 0 ? 'text-success' : 'text-danger';
                
                tableHTML += `
                    <tr>
                        <td><strong>${trade.strategy_name}</strong></td>
                        <td>${trade.date_opened}</td>
                        <td>${trade.time_opened || 'N/A'}</td>
                        <td>${trade.date_closed}</td>
                        <td>${trade.time_closed || 'N/A'}</td>
                        <td>$${trade.opening_price.toFixed(2)}</td>
                        <td>$${trade.closing_price.toFixed(2)}</td>
                        <td class="${movementClass}">
                            <strong>${trade.price_movement >= 0 ? '+' : ''}${trade.price_movement.toFixed(2)}%</strong>
                        </td>
                        <td class="${pnlClass}">
                            <strong>$${trade.pnl.toLocaleString()}</strong>
                        </td>
                        <td>${trade.contracts}</td>
                        <td class="${pnlClass}">
                            <strong>$${trade.pnl_per_lot.toLocaleString()}</strong>
                        </td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = tableHTML;
        }

        function filterTradesByStrategy() {
            const strategyFilter = document.getElementById('strategyFilter');
            const selectedStrategy = strategyFilter ? strategyFilter.value : '';
            
            if (!selectedStrategy) {
                // Show all trades
                renderTradesTable(allPriceMovementTrades);
            } else {
                // Filter trades by selected strategy
                const filteredTrades = allPriceMovementTrades.filter(trade => 
                    trade.strategy_name === selectedStrategy
                );
                renderTradesTable(filteredTrades);
            }
        }

        function makeTableSortable(tableId) {
            const table = document.getElementById(tableId);
            if (!table) return;
            
            const headers = table.querySelectorAll('thead th');
            headers.forEach((header, index) => {
                header.style.cursor = 'pointer';
                header.addEventListener('click', () => {
                    sortTable(table, index);
                });
            });
        }

        function sortTable(table, columnIndex) {
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            const header = table.querySelector(`thead th[data-column="${columnIndex}"]`);
            const dataType = header ? header.getAttribute('data-type') : 'text';
            
            const isAscending = table.getAttribute('data-sort-direction') !== 'asc';
            table.setAttribute('data-sort-direction', isAscending ? 'asc' : 'desc');
            
            rows.sort((a, b) => {
                const aVal = a.cells[columnIndex].textContent.trim();
                const bVal = b.cells[columnIndex].textContent.trim();
                
                // Handle different data types
                switch (dataType) {
                    case 'number':
                    case 'currency':
                        const aNum = parseFloat(aVal.replace(/[$,%]/g, ''));
                        const bNum = parseFloat(bVal.replace(/[$,%]/g, ''));
                        return isAscending ? aNum - bNum : bNum - aNum;
                    
                    case 'date':
                        const aDate = new Date(aVal);
                        const bDate = new Date(bVal);
                        return isAscending ? aDate - bDate : bDate - aDate;
                    
                    case 'time':
                        // Handle time format (HH:MM:SS)
                        const aTime = aVal === 'N/A' ? '00:00:00' : aVal;
                        const bTime = bVal === 'N/A' ? '00:00:00' : bVal;
                        return isAscending ? aTime.localeCompare(bTime) : bTime.localeCompare(aTime);
                    
                    case 'text':
                    default:
                        return isAscending ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
                }
            });
            
            // Clear tbody and re-append sorted rows
            tbody.innerHTML = '';
            rows.forEach(row => tbody.appendChild(row));
            
            // Update sort icons
            const headers = table.querySelectorAll('thead th');
            headers.forEach((h, index) => {
                const icon = h.querySelector('i');
                if (icon) {
                    if (index === columnIndex) {
                        icon.className = isAscending ? 'fas fa-sort-up' : 'fas fa-sort-down';
                    } else {
                        icon.className = 'fas fa-sort';
                    }
                }
            });
        }

        function deleteCustomList(listId, listName) {
            if (confirm(`Are you sure you want to delete the list "${listName}"? This action cannot be undone.`)) {
                fetch(`/api/custom-blackout-lists/${listId}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        loadCustomLists();
                    } else {
                        alert('Error deleting list: ' + data.error);
                    }
                })
                .catch(error => {
                    alert('Error deleting list: ' + error.message);
                });
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function loadCrossFileCorrelationChart() {
            const container = document.getElementById('chartContainer');
            const loading = document.getElementById('chartLoading');
            
            // Show file selection interface first
            container.innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <h5>🔗 Cross-File Strategy Correlation Analysis</h5>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info mb-4">
                            <h6><i class="fas fa-info-circle"></i> What is Cross-File Strategy Correlation Analysis?</h6>
                            <p class="mb-2">This tool analyzes the correlation between trading strategies from different CSV files to help you identify diversification opportunities.</p>
                            <p class="mb-2"><strong>Why is this useful?</strong></p>
                            <ul class="mb-2">
                                <li><strong>Portfolio Diversification:</strong> Find strategies that move independently to reduce overall risk</li>
                                <li><strong>Strategy Selection:</strong> Identify which strategies from different files work well together</li>
                                <li><strong>Risk Management:</strong> Avoid combining highly correlated strategies that amplify losses</li>
                                <li><strong>Performance Optimization:</strong> Build portfolios with uncorrelated strategies for better risk-adjusted returns</li>
                            </ul>
                            <p class="mb-0"><strong>How it works:</strong> The analysis compares daily returns between strategies across your selected files during their overlapping time periods, then displays correlations in a heatmap matrix.</p>
                        </div>
                        
                        <p>Select which CSV files you want to compare for correlation analysis:</p>
                        
                        <div class="mb-3">
                            <label class="form-label">Select Files to Compare:</label>
                            <div id="fileSelectionList" class="border rounded p-3" style="max-height: 300px; overflow-y: auto;">
                                <div class="text-center">
                                    <div class="spinner-border spinner-border-sm" role="status">
                                        <span class="visually-hidden">Loading files...</span>
                                    </div>
                                    <p class="mt-2">Loading available files...</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="d-flex gap-3 align-items-end">
                            <div class="d-flex flex-column">
                                <label for="maxPairsInput" class="form-label mb-1" style="font-size: 0.9em;">Max Strategies:</label>
                                <input type="number" class="form-control form-control-sm" id="maxPairsInput" value="30" min="5" max="100" style="width: 80px;">
                            </div>
                            <div class="flex-grow-1">
                                <button class="btn btn-primary" onclick="runCrossFileCorrelation()">
                                    <i class="fas fa-chart-line"></i> Run Correlation Analysis
                                </button>
                                <button class="btn btn-outline-secondary ms-2" onclick="selectAllFiles()">
                                    <i class="fas fa-check-square"></i> Select All
                                </button>
                                <button class="btn btn-outline-secondary" onclick="deselectAllFiles()">
                                    <i class="fas fa-square"></i> Deselect All
                                </button>
                            </div>
                        </div>
                        <small class="text-muted">Maximum number of strategies to include in the correlation matrix</small>
                        
                        <div id="correlationResults" class="mt-4" style="display: none;">
                            <!-- Results will be displayed here -->
                        </div>
                    </div>
                </div>
            `;
            
            // Load available files
            loadAvailableFilesForCorrelation();
        }
        
        function loadAvailableFilesForCorrelation() {
            fetch('/api/saved-files')
            .then(response => response.json())
            .then(data => {
                if (data.success && data.data.length > 0) {
                    const fileList = document.getElementById('fileSelectionList');
                    fileList.innerHTML = '';
                    
                    data.data.forEach(file => {
                        const fileItem = document.createElement('div');
                        fileItem.className = 'form-check mb-2';
                        fileItem.innerHTML = `
                            <input class="form-check-input" type="checkbox" value="${file.filename}" id="file_${file.filename}">
                            <label class="form-check-label" for="file_${file.filename}">
                                <strong>${file.friendly_name}</strong>
                                <small class="text-muted d-block">${file.filename}</small>
                            </label>
                        `;
                        fileList.appendChild(fileItem);
                    });
                } else {
                    document.getElementById('fileSelectionList').innerHTML = `
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle"></i>
                            No CSV files found. Please upload some files first.
                        </div>
                    `;
                }
            })
            .catch(error => {
                document.getElementById('fileSelectionList').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-circle"></i>
                        Error loading files: ${error.message}
                    </div>
                `;
            });
        }
        
        function selectAllFiles() {
            const checkboxes = document.querySelectorAll('#fileSelectionList input[type="checkbox"]');
            checkboxes.forEach(checkbox => checkbox.checked = true);
        }
        
        function deselectAllFiles() {
            const checkboxes = document.querySelectorAll('#fileSelectionList input[type="checkbox"]');
            checkboxes.forEach(checkbox => checkbox.checked = false);
        }
        
        function runCrossFileCorrelation() {
            const selectedCheckboxes = document.querySelectorAll('#fileSelectionList input[type="checkbox"]:checked');
            const selectedFiles = Array.from(selectedCheckboxes).map(cb => cb.value);
            const maxPairs = parseInt(document.getElementById('maxPairsInput').value) || 30;
            
            if (selectedFiles.length < 2) {
                alert('Please select at least 2 files for correlation analysis.');
                return;
            }
            
            const loading = document.getElementById('chartLoading');
            const resultsDiv = document.getElementById('correlationResults');
            
            loading.style.display = 'block';
            resultsDiv.style.display = 'none';
            
            fetch('/api/cross-file-correlation', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    selected_files: selectedFiles,
                    max_pairs: maxPairs
                })
            })
            .then(response => response.json())
            .then(data => {
                loading.style.display = 'none';
                
                if (!data.success) {
                    resultsDiv.innerHTML = `<div class="alert alert-warning"><h5>Cross-File Correlation Analysis Error</h5><p>${data.error}</p></div>`;
                    resultsDiv.style.display = 'block';
                    return;
                }
                
                const analysisData = data.data;
                
                // Create correlation matrix heatmap
                const correlationMatrix = analysisData.correlation_matrix;
                const strategies = Object.keys(correlationMatrix);
                
                // Create Plotly heatmap
                const heatmapData = {
                    z: strategies.map(s1 => strategies.map(s2 => correlationMatrix[s1][s2])),
                    x: strategies.map(s => s.split('::')[1]), // Strategy name only
                    y: strategies.map(s => s.split('::')[1]), // Strategy name only
                    type: 'heatmap',
                    colorscale: [
                        [0, '#d62728'], // Red for negative correlation
                        [0.5, '#ffffff'], // White for zero correlation
                        [1, '#2ca02c']  // Green for positive correlation
                    ],
                    zmid: 0,
                    text: strategies.map(s1 => strategies.map(s2 => {
                        const correlation = correlationMatrix[s1][s2];
                        const file1 = s1.split('::')[0];
                        const file2 = s2.split('::')[0];
                        return `${s1.split('::')[1]}<br>${s2.split('::')[1]}<br>Correlation: ${correlation.toFixed(3)}<br>Files: ${file1} ↔ ${file2}`;
                    })),
                    texttemplate: '%{text}',
                    textfont: {size: 10},
                    hovertemplate: '<b>%{y}</b><br>vs<br><b>%{x}</b><br>Correlation: %{z:.3f}<br>%{customdata}<extra></extra>',
                    customdata: strategies.map(s1 => strategies.map(s2 => {
                        const file1 = s1.split('::')[0];
                        const file2 = s2.split('::')[0];
                        return `Files: ${file1} ↔ ${file2}`;
                    }))
                };
                
                const layout = {
                    title: {
                        text: 'Cross-File Strategy Correlation Matrix',
                        font: {size: 16}
                    },
                    xaxis: {
                        title: 'Strategy',
                        tickangle: -45,
                        tickfont: {size: 10},
                        automargin: true
                    },
                    yaxis: {
                        title: 'Strategy',
                        tickfont: {size: 10},
                        automargin: true
                    },
                    width: Math.max(800, strategies.length * 60),
                    height: Math.max(600, strategies.length * 50),
                    margin: {l: 200, r: 100, t: 100, b: 200},
                    autosize: true
                };
                
                const config = {
                    responsive: true,
                    displayModeBar: true,
                    modeBarButtonsToRemove: ['pan2d', 'lasso2d', 'select2d']
                };
                
                resultsDiv.innerHTML = `
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="fas fa-chart-line"></i> Analysis Results</h5>
                        </div>
                        <div class="card-body">
                            <div class="row mb-4">
                                <div class="col-md-3">
                                    <div class="card text-center">
                                        <div class="card-body">
                                            <h5 class="card-title text-primary">${analysisData.files_analyzed.length}</h5>
                                            <p class="card-text">Files Analyzed</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card text-center">
                                        <div class="card-body">
                                            <h5 class="card-title text-info">${strategies.length}</h5>
                                            <p class="card-text">Strategies</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card text-center">
                                        <div class="card-body">
                                            <h5 class="card-title text-success">${analysisData.common_date_range.days}</h5>
                                            <p class="card-text">Common Days</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card text-center">
                                        <div class="card-body">
                                            <h5 class="card-title text-warning">${analysisData.summary_stats.avg_correlation}</h5>
                                            <p class="card-text">Avg Correlation</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="alert alert-info mb-4">
                                <h6><i class="fas fa-info-circle"></i> Analysis Period</h6>
                                <p>Common date range: <strong>${analysisData.common_date_range.start}</strong> to <strong>${analysisData.common_date_range.end}</strong></p>
                                <small>Only strategies with at least 5 trades in this period are included.</small>
                            </div>
                            
                            <div id="correlationHeatmap" class="text-center"></div>
                            
                            
                            <div class="alert alert-light mt-3">
                                <h6><i class="fas fa-info-circle"></i> Interpretation Guide</h6>
                                <ul class="mb-0">
                                    <li><strong>Red cells:</strong> Negative correlation (strategies move in opposite directions)</li>
                                    <li><strong>White cells:</strong> No correlation (strategies move independently)</li>
                                    <li><strong>Green cells:</strong> Positive correlation (strategies move together)</li>
                                    <li><strong>Darker colors:</strong> Stronger correlation (closer to ±1)</li>
                                    <li><strong>Diagonal:</strong> Perfect correlation (strategy with itself = 1.0)</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                `;
                
                // Render the heatmap
                Plotly.newPlot('correlationHeatmap', [heatmapData], layout, config);
                resultsDiv.style.display = 'block';
            })
            .catch(error => {
                loading.style.display = 'none';
                resultsDiv.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
                resultsDiv.style.display = 'block';
            });
        }

        // Initialize Bootstrap tooltips on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🔧 DOMContentLoaded - Initializing Bootstrap tooltips...');
            // Initialize all Bootstrap tooltips
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            console.log('🔧 Found', tooltipTriggerList.length, 'Bootstrap tooltip elements on page load');
            var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                console.log('🔧 Initializing tooltip for:', tooltipTriggerEl);
                return new bootstrap.Tooltip(tooltipTriggerEl, {
                    html: true,
                    sanitize: false
                });
            });
            console.log('🔧 Initialized', tooltipList.length, 'Bootstrap tooltips on page load');
        });

    </script>

    <!-- Version Info Modal -->
    <div class="modal fade" id="versionModal" tabindex="-1" aria-labelledby="versionModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="versionModalLabel">
                        <i class="fas fa-info-circle"></i>
                        Build Information
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6><i class="fas fa-tag"></i> Version Information</h6>
                            <table class="table table-sm">
                                <tr>
                                    <td><strong>Version:</strong></td>
                                    <td><code>{{ version_info.version }}</code></td>
                                </tr>
                                <tr>
                                    <td><strong>Build Date:</strong></td>
                                    <td>{{ version_info.build_date }}</td>
                                </tr>
                                <tr>
                                    <td><strong>Build Time:</strong></td>
                                    <td>{{ version_info.build_time_short }}</td>
                                </tr>
                                <tr>
                                    <td><strong>Environment:</strong></td>
                                    <td>
                                        <span class="badge badge-{{ 'success' if version_info.environment == 'production' else 'info' if version_info.environment == 'staging' else 'secondary' }}">
                                            {{ version_info.environment.upper() }}
                                        </span>
                                    </td>
                                </tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <h6><i class="fab fa-git-alt"></i> Git Information</h6>
                            <table class="table table-sm">
                                <tr>
                                    <td><strong>Branch:</strong></td>
                                    <td><code>{{ version_info.git.branch }}</code></td>
                                </tr>
                                <tr>
                                    <td><strong>Commit:</strong></td>
                                    <td><code>{{ version_info.git.commit_short }}</code></td>
                                </tr>
                                <tr>
                                    <td><strong>Status:</strong></td>
                                    <td>
                                        <span class="badge badge-{{ 'warning' if version_info.git.is_dirty else 'success' }}">
                                            {{ 'Dirty' if version_info.git.is_dirty else 'Clean' }}
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td><strong>Python:</strong></td>
                                    <td><code>{{ version_info.python_version }}</code></td>
                                </tr>
                            </table>
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <h6><i class="fas fa-server"></i> Build Details</h6>
                        <table class="table table-sm">
                            <tr>
                                <td><strong>Build Host:</strong></td>
                                <td><code>{{ version_info.build_host }}</code></td>
                            </tr>
                            <tr>
                                <td><strong>Build User:</strong></td>
                                <td><code>{{ version_info.build_user }}</code></td>
                            </tr>
                            <tr>
                                <td><strong>Build Timestamp:</strong></td>
                                <td><code>{{ version_info.build_timestamp }}</code></td>
                            </tr>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="copyVersionInfo()">
                        <i class="fas fa-copy"></i> Copy Info
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- File Analysis Modal -->
    <div class="modal fade" id="fileAnalysisModal" tabindex="-1" aria-labelledby="fileAnalysisModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="fileAnalysisModalLabel">
                        <i class="fas fa-file-csv text-success"></i> File Analysis Results
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="fileAnalysisContent">
                        <!-- File analysis results will be populated here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-success" id="confirmUploadBtn" onclick="confirmFileUpload()">
                        <i class="fas fa-upload"></i> Upload File
                    </button>
                    <button type="button" class="btn btn-outline-secondary" onclick="cancelFileUpload()">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        function showVersionModal() {
            const modal = new bootstrap.Modal(document.getElementById('versionModal'));
            modal.show();
        }

        function copyVersionInfo() {
            const versionInfo = {
                version: '{{ version_info.version }}',
                build_date: '{{ version_info.build_date }}',
                build_time: '{{ version_info.build_time_short }}',
                environment: '{{ version_info.environment }}',
                git_branch: '{{ version_info.git.branch }}',
                git_commit: '{{ version_info.git.commit_short }}',
                git_status: '{{ "Dirty" if version_info.git.is_dirty else "Clean" }}',
                python_version: '{{ version_info.python_version }}',
                build_host: '{{ version_info.build_host }}',
                build_user: '{{ version_info.build_user }}'
            };

            const text = `Portfolio Strategy Analytics Build Info:
Version: ${versionInfo.version}
Build Date: ${versionInfo.build_date} ${versionInfo.build_time}
Environment: ${versionInfo.environment}
Git Branch: ${versionInfo.git_branch}
Git Commit: ${versionInfo.git_commit}
Git Status: ${versionInfo.git_status}
Python Version: ${versionInfo.python_version}
Build Host: ${versionInfo.build_host}
Build User: ${versionInfo.build_user}`;

            navigator.clipboard.writeText(text).then(() => {
                // Show success feedback
                const btn = event.target;
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-check"></i> Copied!';
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-success');
                
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.classList.remove('btn-success');
                    btn.classList.add('btn-primary');
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy version info:', err);
                alert('Failed to copy version info to clipboard');
            });
        }

        // File Analysis Modal Functions
        function showFileAnalysisModal(file, analysisData) {
            const modal = new bootstrap.Modal(document.getElementById('fileAnalysisModal'));
            const content = document.getElementById('fileAnalysisContent');
            
            // Store the file for later use
            window.pendingFileUpload = file;
            
            // Build the modal content
            let html = `
                <div class="row">
                    <div class="col-md-6">
                        <h6><i class="fas fa-file-csv text-primary"></i> File Information</h6>
                        <table class="table table-sm">
                            <tr>
                                <td><strong>Filename:</strong></td>
                                <td><code>${file.name}</code></td>
                            </tr>
                            <tr>
                                <td><strong>File Size:</strong></td>
                                <td>${(file.size / 1024).toFixed(1)} KB</td>
                            </tr>
                            <tr>
                                <td><strong>Total Lines:</strong></td>
                                <td><span class="badge bg-info">${analysisData.lineCount.toLocaleString()}</span></td>
                            </tr>
                            <tr>
                                <td><strong>Estimated Trades:</strong></td>
                                <td><span class="badge bg-primary">${analysisData.estimatedTradeCount.toLocaleString()}</span></td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6><i class="fas fa-chart-line text-success"></i> Analysis Summary</h6>
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i>
                            <strong>Trade Estimation:</strong> Based on non-empty lines minus header row.
                        </div>
            `;
            
            // Add warning if trade limit exceeded
            if (analysisData.warning) {
                html += `
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle"></i>
                            <strong>Performance Warning:</strong><br>
                            ${analysisData.warning}
                        </div>
                `;
            } else {
                html += `
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle"></i>
                            <strong>File Size OK:</strong> Within recommended limits for optimal performance.
                        </div>
                `;
            }
            
            html += `
                    </div>
                </div>
            `;
            
            // Add recommendations if needed
            if (analysisData.estimatedTradeCount > analysisData.maxTrades) {
                html += `
                    <div class="row mt-3">
                        <div class="col-12">
                            <h6><i class="fas fa-lightbulb text-warning"></i> Recommendations</h6>
                            <div class="alert alert-warning">
                                <ul class="mb-0">
                                    <li>Consider splitting this file into smaller chunks (${analysisData.maxTrades.toLocaleString()} trades or less)</li>
                                    <li>Large files may cause slower processing and chart rendering</li>
                                    <li>You can still proceed, but expect longer processing times</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            content.innerHTML = html;
            modal.show();
        }

        function confirmFileUpload() {
            if (window.pendingFileUpload) {
                // Close the modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('fileAnalysisModal'));
                modal.hide();
                
                // Proceed with upload
                handleFileUpload(window.pendingFileUpload);
                
                // Clear the pending file
                window.pendingFileUpload = null;
            }
        }

        function cancelFileUpload() {
            // Close the modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('fileAnalysisModal'));
            modal.hide();
            
            // Clear the pending file and reset upload area
            window.pendingFileUpload = null;
            window.selectedFile = null;
            document.getElementById('fileInput').value = '';
            document.getElementById('selectedFileInfo').style.display = 'none';
            document.getElementById('uploadContent').style.display = '';
            document.getElementById('uploadFileBtn').style.display = 'none';
            document.getElementById('initialCapitalGroup').style.display = 'none';
        }
    </script>
</body>
</html> 